<!DOCTYPE html>
<html lang="ru" class="no-swipe-navigation">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="MobileOptimized" content="176" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="robots" content="noindex,nofollow" />
    <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
    <script src="https://yookassa.ru/checkout-widget/v1/checkout-widget.js"></script>
    <title>FitTracker AI</title>
    <style>
        :root {
            /* Яркая палитра необрутализма */
            --neobrut-black: #000000;
            --neobrut-white: #FFFFFF;
            --neobrut-orange: #FF6B35;
            --neobrut-red: #FF006E;
            --neobrut-yellow: #FFBE0B;
            --neobrut-blue: #3A86FF;
            --neobrut-green: #06FFB4;
            --neobrut-purple: #8338EC;
            --neobrut-pink: #FF4081;
            --neobrut-gray: #495057;
            --neobrut-lightgray: #F8F9FA;
            --neobrut-darkgray: #212529;
            --neobrut-cream: #FFFDE7;
            --success-green: #00F5A0;
            --warning-yellow: #FFD23F;
            --bg-grid: #F1F3F5;
            --accent-blue: #4ECDC4;
            --accent-purple: #C77DFF;
            --accent-coral: #FF6B9D;
            /* Новая цветовая схема для активности */
            --lime-green: #D4ED4A;
            --light-green: #98D98E;
            --medium-green: #3CB371;
            --swamp-green: #2F5233;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--neobrut-lightgray);
            color: var(--neobrut-darkgray);
            min-height: 100vh;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overflow-x: hidden;
            width: 100%;
        }

        /* Предотвращение свайп-навигации в мобильных браузерах */
        html.no-swipe-navigation,
        html.no-swipe-navigation body {
            overscroll-behavior-x: none;
            touch-action: pan-y pinch-zoom;
        }

        /* Глобальное скрытие scrollbar для всех элементов */
        *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Глобальный фон на весь экран */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('fantasy-bg-new.jpg') center/cover no-repeat;
            z-index: -1;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        /* Верхняя секция с прокруткой тренировок */
        .workout-section {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-bottom: 4px solid var(--neobrut-black);
            padding: 0;
            position: relative;
            box-shadow: 8px 8px 0 var(--neobrut-black);
            flex-shrink: 0;
            flex-basis: var(--workout-basis, auto);
            overflow-y: auto;
            min-height: 50px;
            transition: box-shadow 0.15s ease, backdrop-filter 0.15s ease;
        }

        /* Оптимизация при перетаскивании */
        .workout-section.dragging {
            backdrop-filter: none;
            box-shadow: none;
            will-change: height;
            contain: layout style;
            transition: none;
            z-index: 1;
            overflow-y: hidden;
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            pointer-events: none; /* Отключаем события внутри при перетаскивании */
        }

        /* Включаем pointer-events только для самого элемента */
        .workout-section.dragging > * {
            pointer-events: auto;
        }

        /* Оптимизация только для тяжелых элементов, не для всех */
        .workout-section.dragging .strip-progress-circle,
        .workout-section.dragging .ai-comment-text {
            will-change: contents;
        }

        /* Исключаем галочку чекбокса из общего transform dragging, чтобы scale(0) работал */
        .workout-section.dragging .checkbox-checkmark {
            transform: translate(-50%, -50%) scale(0) !important;
        }

        .workout-section.dragging .todo-checkbox input:checked ~ .checkbox-checkmark {
            transform: translate(-50%, -50%) rotate(-45deg) scale(1) !important;
        }

        .workout-section.dragging .todo-checkbox input:checked ~ .checkbox-visual {
            transform: rotate(-5deg) !important;
        }

        /* Оптимизация для activity-section при перетаскивании */
        body.dragging-mode .activity-section {
            contain: layout style;
            will-change: height;
            pointer-events: none;
        }

        body.dragging-mode .activity-section > * {
            pointer-events: auto;
        }

        .workout-header {
            padding: 0;
            display: none; /* Скрываем пустой header */
        }

        .workout-title {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
        }

        .workout-counter {
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 8px;
            color: var(--neobrut-black);
            transform: rotate(-2deg);
        }

        /* Todo-список в стиле необрутализма */

        /* Todo-список в стиле необрутализма */
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Убираем синюю подсветку для всех интерактивных элементов */
        .todo-list * {
            outline: none !important;
        }

        .todo-list *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Отключаем выделение текста при клике */
        .todo-item,
        .todo-subitem,
        .todo-text,
        .todo-expand,
        .todo-checkbox {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Дополнительно отключаем подсветку при клике на мобильных */
        @media (hover: none) and (pointer: coarse) {
            .todo-item:active,
            .todo-subitem:active,
            .todo-expand:active {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--neobrut-lightgray);
            border: 3px solid var(--neobrut-black);
            box-shadow: 5px 5px 0 var(--neobrut-black);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .todo-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0 var(--neobrut-black);
        }

        .todo-item.completed {
            opacity: 0.7;
            background: var(--success-green);
        }

        .todo-checkbox {
            position: relative;
            width: 24px;
            height: 24px;
            margin-right: 15px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .todo-checkbox input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .checkbox-visual {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .todo-checkbox input:checked ~ .checkbox-visual {
            background: var(--neobrut-yellow);
            transform: rotate(-5deg);
        }

        .checkbox-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 14px;
            height: 10px;
            border-left: 3px solid var(--neobrut-black);
            border-bottom: 3px solid var(--neobrut-black);
            transition: transform 0.2s;
        }

        .todo-checkbox input:checked ~ .checkbox-checkmark {
            transform: translate(-50%, -50%) rotate(-45deg) scale(1);
        }

        .todo-text {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            user-select: none;
            cursor: pointer;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Исключаем время из зачеркивания */
        .todo-item.completed .todo-text .task-time-inline {
            text-decoration: none !important;
            display: inline-block;
        }

        .task-time {
            font-size: 11px;
            color: var(--accent-blue);
            margin-left: 8px;
            white-space: nowrap;
            font-weight: 500;
        }

        .task-time-inline {
            font-size: 13px;
            color: var(--neobrut-black);
            opacity: 0.9;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Подпункты */
        .todo-sublist {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            display: none; /* Скрыты по умолчанию */
        }

        .todo-sublist.expanded {
            display: block;
        }

        .todo-subitem {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-gray);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
            font-size: 14px;
        }

        .todo-subitem:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-subitem .todo-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            margin-top: 1px;
        }

        .todo-subitem .checkbox-visual {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .todo-subitem .checkbox-checkmark {
            width: 10px;
            height: 8px;
            border-width: 2px;
        }

        .todo-subitem .todo-text {
            font-size: 14px;
            font-weight: 500;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .todo-subitem.completed {
            opacity: 0.7;
            background: var(--success-green) !important;
        }

        .todo-subitem.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Маркер для подпунктов */
        .todo-bullet {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--neobrut-gray);
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            margin-top: 6px;
        }

        /* Кнопка раскрытия */
        .todo-expand {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            margin-left: 10px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .todo-expand:hover {
            transform: scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-expand:active {
            transform: scale(0.95) rotate(180deg);
        }

        .todo-expand svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .todo-expand.expanded svg {
            transform: rotate(180deg);
        }

        /* Обертка для текста с кнопкой */
        .todo-text-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Сдвинутый влево текст без чекбокса */
        .todo-text-shifted {
            justify-content: flex-start;
            margin-left: 0;
        }

        .todo-text-shifted .todo-text {
            flex: 1;
            cursor: pointer;
        }

        /* Сообщение об отсутствии заданий */
        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            font-size: 20px;
            font-weight: 700;
            color: var(--neobrut-gray);
            background: var(--neobrut-lightgray);
            border: 3px dashed var(--neobrut-gray);
            border-radius: 12px;
        }

        /* Мобильная адаптация режима задач */
        @media (max-width: 768px) {
            .workout-section.show-todos #todo-content {
                padding: 10px;
                height: 190px; /* Финальная высота для лучшего отображения */
            }

            .workout-section.show-todos .workout-title {
                font-size: 20px;
            }

            .workout-section.show-todos .todo-item {
                margin-bottom: 10px;
                padding: 8px;
            }

            .workout-section.show-todos .todo-text {
                font-size: 14px;
            }
        }

        /* Режим отображения задач в верхней секции */
        .workout-section.show-todos {
            /* Секция остается того же размера, что и с каруселью */
            display: flex;
            flex-direction: column;
            padding: 0; /* Убираем вертикальные отступы */
        }

        .workout-section.show-todos .workout-header {
            background: var(--neobrut-yellow);
            border-bottom: 5px solid var(--neobrut-black);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 0 var(--neobrut-black);
            flex-shrink: 0;
        }

        .workout-section.show-todos .workout-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 60px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            transform: rotate(-5deg);
        }

        .workout-section.show-todos .workout-title {
            font-size: 24px;
        }

        /* Базовые стили для контента задач */
        #todo-content {
            display: none;
            overflow-y: auto;
        }

        /* Переопределяем display для режима задач (большая специфичность) */
        .workout-section.show-todos #todo-content {
            display: block !important;
            padding: 15px;
            background: var(--neobrut-white);
            overflow-y: auto;
            overflow-x: hidden;
            height: 190px; /* Финальная высота для лучшего отображения */
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
            /* Убираем flex чтобы height работал */
            flex: none;
        }

        /* Уменьшаем размер элементов задач в компактном режиме */
        .workout-section.show-todos .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .workout-section.show-todos .todo-text {
            font-size: 16px;
        }

        .workout-section.show-todos .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
        }

        .workout-section.show-todos .checkbox-visual {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .workout-section.show-todos .checkbox-checkmark {
            width: 12px;
            height: 10px;
            border-width: 2px;
        }

        .todos-back-btn {
            width: 40px;
            height: 40px;
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.2s;
            transform: rotate(0deg);
        }

        .todos-back-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--neobrut-orange);
        }

        .todos-back-btn:active {
            transform: rotate(90deg) scale(0.95) translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Overlay модальное окно для задач */
        .todo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .todo-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .todo-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .todo-modal-header {
            background: var(--neobrut-yellow);
            padding: 7.5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .todo-modal-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin: 0;
        }

        .todo-modal-close {
            width: 20px;
            height: 20px;
            background: var(--neobrut-red);
            border: 1.5px solid var(--neobrut-black);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
            transition: all 0.2s;
        }

        .todo-modal-close:hover {
            transform: scale(1.1);
            background: var(--neobrut-orange);
        }

        .todo-modal-close:active {
            transform: scale(0.95) translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .todo-modal-content {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        /* Убираем масштабирование - оно вызывает layout shift при ресайзе */

        .todo-modal-content .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        /* Стили для будущих дней (только просмотр) */
        .todo-modal-content .todo-item.future-day-item {
            opacity: 0.6;
            border-color: #999;
            box-shadow: 3px 3px 0 #666;
        }

        .todo-modal-content .todo-text-wrapper.future-day .todo-text {
            cursor: default;
            color: #888;
        }

        .todo-modal-content .todo-checkbox.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .todo-modal-content .todo-checkbox.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        .todo-modal-content .todo-text {
            font-size: 16px;
            line-height: 1.3;
        }

        .todo-modal-content .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
            border-width: 3px;
            border-radius: 6px;
        }

        .todo-modal-content .todo-checkbox::after {
            top: -3px;
            left: 3px;
            width: 8px;
            height: 15px;
            border-width: 3px;
            border-radius: 2px;
        }

        .todo-modal-content .subtask-list {
            margin-left: 32px;
            margin-top: 8px;
        }

        .todo-modal-content .subtask-item {
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 14px;
            border-width: 2px;
            border-radius: 8px;
        }

        .todo-modal-content .todo-expand {
            width: 14px;
            height: 14px;
            margin-left: 5px;
            border-width: 1.5px;
            border-radius: 4px;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
        }

        .todo-modal-content .chevron {
            width: 0;
            height: 0;
            border-left: 4px solid var(--neobrut-black);
            border-top: 2.5px solid transparent;
            border-bottom: 2.5px solid transparent;
            margin-top: 3px;
            transition: transform 0.2s;
        }

        .todo-modal-content .todo-bullet {
            width: 4px;
            height: 4px;
            margin-right: 4px;
            margin-top: 3px;
        }

        /* ===== КАРТОЧКА УПРАЖНЕНИЯ ===== */
        .exercise-card {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 200;
            display: flex;
            flex-direction: column;
            /* Скрыта по умолчанию - не перехватывает клики и не видна */
            visibility: hidden;
            pointer-events: none;
            opacity: 0;
            /* GPU-ускорение: translate3d создаёт отдельный слой */
            transform: translate3d(100%, 0, 0);
            /* Плавная spring-анимация на CPU (cubic-bezier) */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        visibility 0s linear 0.4s,
                        opacity 0s linear 0.4s;
        }

        .exercise-card.show {
            /* Видима и интерактивна когда открыта */
            visibility: visible;
            pointer-events: auto;
            opacity: 1;
            transform: translate3d(0, 0, 0);
            /* will-change только когда карточка открыта - для оптимизации анимации */
            will-change: transform;
            /* Показываем сразу без задержки */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        opacity 0.3s ease;
        }

        .exercise-card.hide {
            transform: translate3d(-100%, 0, 0);
        }

        /* Отключаем GPU-слои у дочерних элементов, когда карточка скрыта */
        .exercise-card:not(.show) .exercise-check-btn,
        .exercise-card:not(.show) .exercise-check-svg,
        .exercise-card:not(.show) .exercise-check-icon,
        .exercise-card:not(.show) .exercise-card-header,
        .exercise-card:not(.show) .exercise-repost-btn,
        .exercise-card:not(.show) .repost-send-icon,
        .exercise-card:not(.show) .repost-ai-icon {
            transform: none !important;
            will-change: auto !important;
        }

        /* Фиксируем позицию иконок, когда карточка видна */
        .exercise-card.show .repost-send-icon,
        .exercise-card.show .repost-ai-icon {
            transform: translate(-50%, -50%) !important;
        }

        .exercise-card-header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--neobrut-black);
            /* 3D объём через многослойные тени (GPU) */
            box-shadow:
                0 4px 0 var(--neobrut-black),
                0 6px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
            /* Фиксируем слой для оптимизации */
            transform: translate3d(0, 0, 0);
        }

        .exercise-card-title {
            font-size: 13px;
            font-weight: 900;
            color: var(--neobrut-white);
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .exercise-card-close {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Многослойные тени для 3D эффекта */
            box-shadow:
                3px 3px 0 var(--neobrut-black),
                0 4px 8px rgba(0, 0, 0, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            /* GPU-ускорённые трансформации */
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            flex-shrink: 0;
            will-change: transform;
        }

        .exercise-card-close:hover {
            /* Только трансформация, без layout изменений */
            transform: translate3d(0, -1px, 0) scale(1.05);
            background: linear-gradient(135deg, #ff8c00 0%, #ff7b00 100%);
            box-shadow:
                4px 4px 0 var(--neobrut-black),
                0 6px 12px rgba(0, 0, 0, 0.25),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .exercise-card-close:active {
            /* Нажатие - сдвиг вниз и уменьшение */
            transform: translate3d(1px, 2px, 0) scale(0.95);
            box-shadow:
                1px 1px 0 var(--neobrut-black),
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .exercise-card-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            /* Оптимизация скролла через GPU */
            transform: translate3d(0, 0, 0);
        }

        .exercise-text {
            font-size: 17px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            line-height: 1.6;
            /* Анимация появления текста */
            animation: textFadeIn 0.3s ease-out;
            /* Подсвечка для глубины */
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .exercise-video-button {
            margin-top: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }

        .video-button-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-play-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            color: var(--neobrut-darkgray);
        }

        .video-button-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--neobrut-darkgray);
        }

        .exercise-video-overlay {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            will-change: opacity;
        }

        .exercise-video-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .exercise-video-container {
            width: 100vw;
            aspect-ratio: 24 / 15;
            background: var(--neobrut-black);
            border: 4px solid var(--neobrut-white);
            border-bottom: none;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
            cursor: default;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .exercise-video-overlay.show .exercise-video-container {
            transform: translateY(0);
        }

        .exercise-video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: var(--neobrut-black);
        }

        @keyframes textFadeIn {
            from {
                opacity: 0;
                transform: translate3d(0, 10px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .exercise-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-top: 3px solid var(--neobrut-black);
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            /* Внутренняя тень для углубления */
            box-shadow:
                inset 0 4px 8px rgba(0, 0, 0, 0.05),
                0 -4px 12px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
            transform: translate3d(0, 0, 0);
        }

        .exercise-dots {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .exercise-dot {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%);
            border-radius: 50%;
            /* GPU-ускорённая трансформация */
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
                        background 0.3s ease,
                        box-shadow 0.3s ease;
            /* Лёгкая тень для объёма */
            box-shadow:
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.1);
            will-change: transform;
        }

        .exercise-dot.active {
            /* Увеличение активной точки через transform */
            transform: translate3d(0, 0, 0) scale(1.6);
            background: linear-gradient(135deg, #ffffff 0%, #f1f3f5 100%);
            border: 3px solid var(--neobrut-black);
            /* Более яркая тень для акцента */
            box-shadow:
                inset 0 -3px 6px rgba(0, 0, 0, 0.15),
                inset 0 3px 6px rgba(255, 255, 255, 0.8),
                0 0 0 4px rgba(74, 144, 226, 0.15),
                0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .exercise-dot.completed {
            background: linear-gradient(135deg, #00f5a0 0%, #00d47a 100%);
            box-shadow:
                inset 0 -2px 4px rgba(0, 0, 0, 0.15),
                inset 0 2px 4px rgba(255, 255, 255, 0.4),
                0 2px 6px rgba(0, 245, 160, 0.4);
            /* Анимация завершения */
            animation: dotPulse 0.4s ease-out;
        }

        @keyframes dotPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Кнопка-галочка с круговым прогрессом */
        .exercise-check-btn {
            width: 44px;
            height: 44px;
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
            /* Оптимизация: создаём отдельный слой */
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        .exercise-check-svg {
            width: 100%;
            height: 100%;
            /* GPU-ускорённый transform */
            transform: rotate(-90deg) translate3d(0, 0, 0);
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.15));
        }

        .exercise-check-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 3.5;
        }

        .exercise-check-progress {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 3.5;
            stroke-linecap: round;
            /* Плавная анимация прогресса */
            transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .exercise-check-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            /* GPU-ускорённый центрирование */
            transform: translate3d(-50%, -50%, 0);
            font-size: 20px;
            font-weight: 900;
            color: var(--neobrut-black);
            pointer-events: none;
            /* Плавная анимация цвета и масштаба */
            transition: color 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .exercise-check-btn.completed .exercise-check-icon {
            color: var(--success-green);
            transform: translate3d(-50%, -50%, 0) scale(1.2);
            /* Тень для зелёной галочки */
            filter: drop-shadow(0 0 8px rgba(0, 245, 160, 0.6));
        }

        /* Hover эффект для кнопки галочки */
        .exercise-check-btn:hover {
            transform: translate3d(0, -2px, 0) scale(1.05);
        }

        .exercise-check-btn:active {
            transform: translate3d(0, 1px, 0) scale(0.95);
        }

        /* Кнопка репоста упражнения в AI */
        .exercise-repost-btn {
            width: 36px !important;
            height: 36px !important;
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate3d(0, 0, 0);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.1s;
        }

        .exercise-repost-btn:hover {
            transform: translate3d(-1px, -2px, 0);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .exercise-repost-btn:active {
            transform: translate3d(1px, 1px, 0);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .exercise-repost-btn img {
            position: absolute;
            width: 18px;
            height: 18px;
            object-fit: contain;
        }

        .repost-send-icon {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1 !important;
            width: 38px !important;
            height: 38px !important;
        }

        .repost-ai-icon {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2 !important;
            width: 14px !important;
            height: 14px !important;
        }

        .exercise-repost-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--neobrut-gray);
        }

        /* Индикатор количества упражнений (например, 2/5) */
        .exercise-counter {
            font-size: 11px;
            font-weight: 800;
            color: var(--neobrut-white);
            opacity: 0.95;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            /* Внутренняя тень для глубины */
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* ===== КОНЕЦ КАРТОЧКИ УПРАЖНЕНИЯ ===== */

        /* ===== СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА ИТОГОВ (Summary) - БРУТАЛЬНЫЙ СТИЛЬ КАРУСЕЛЬ ===== */

        /* Затемнённый фон */
        .summary-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: summaryFadeIn 0.3s ease forwards;
        }

        @keyframes summaryFadeIn {
            to { opacity: 1; }
        }

        @keyframes summaryFadeOut {
            to { opacity: 0; }
        }

        @keyframes summarySlideUp {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Основной контейнер модального окна */
        .summary-fullscreen-modal {
            width: 92%;
            max-width: 600px;
            height: auto;
            max-height: 95%;
            background: #f5f5dc;
            border: 3px solid var(--neobrut-black);
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: summarySlideUp 0.4s ease forwards;
            position: relative;
        }

        .summary-fullscreen-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: var(--neobrut-yellow);
            border-bottom: 3px solid var(--neobrut-black);
            z-index: 0;
        }

        /* Заголовок модального окна */
        .summary-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--neobrut-yellow);
            border-bottom: 3px solid var(--neobrut-black);
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .summary-modal-title {
            font-size: 16px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-modal-close {
            width: 28px;
            height: 28px;
            background: var(--neobrut-red);
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 0 var(--neobrut-black);
            transition: all 0.1s ease;
            flex-shrink: 0;
        }

        .summary-modal-close:hover {
            background: var(--neobrut-orange);
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .summary-modal-close:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* Контейнер карусели */
        .summary-carousel-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: transparent;
            z-index: 1;
        }

        /* Трек карусели */
        .summary-carousel-track {
            display: flex;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Слайд карусели */
        .summary-carousel-slide {
            min-width: 100%;
            height: 100%;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            animation: slideFadeIn 0.5s ease-out;
        }

        @keyframes slideFadeIn {
            from {
                opacity: 0;
                transform: scale(0.92) translateY(15px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Кастомный скроллбар для слайдов */
        .summary-carousel-slide::-webkit-scrollbar {
            width: 4px;
        }

        .summary-carousel-slide::-webkit-scrollbar-track {
            background: transparent;
        }

        .summary-carousel-slide::-webkit-scrollbar-thumb {
            background: var(--neobrut-black);
            border-radius: 2px;
        }

        /* Индикаторы слайдов (точки) */
        .summary-carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 14px 16px;
            background: var(--neobrut-white);
            border-top: 3px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .summary-carousel-dot {
            width: 10px;
            height: 10px;
            background: #e0e0e0;
            border: 2px solid var(--neobrut-black);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .summary-carousel-dot.active {
            width: 32px;
            border-radius: 5px;
            background: var(--neobrut-yellow);
        }

        /* Кнопки навигации */
        .summary-carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 900;
            color: var(--neobrut-black);
            box-shadow: 2px 2px 0 var(--neobrut-black);
            transition: all 0.1s ease;
            z-index: 10;
        }

        .summary-carousel-nav:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .summary-carousel-nav:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .summary-carousel-nav.prev {
            left: 12px;
        }

        .summary-carousel-nav.next {
            right: 12px;
        }

        /* ===== Стили слайдов ===== */

        /* Слайд 1: Главный процент */
        .summary-hero-slide {
            align-items: center;
            justify-content: center;
            padding: 40px 20px 20px;
        }

        .summary-glass-card {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
            box-shadow: 6px 6px 0 var(--neobrut-black);
        }

        .summary-percent {
            font-size: 72px;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
            letter-spacing: -4px;
        }

        .summary-percent.excellent {
            color: #16a34a;
        }

        .summary-percent.good {
            color: #ca8a04;
        }

        .summary-percent.fair {
            color: #dc2626;
        }

        .summary-subtitle {
            font-size: 12px;
            color: #666;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 10px;
            font-weight: 700;
        }

        .summary-emoji {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Слайд 2: Метрики */
        .summary-metrics-slide {
            padding-top: 80px;
        }

        .summary-metrics-title {
            font-size: 11px;
            color: var(--neobrut-black);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 700;
        }

        .summary-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .summary-metric-card {
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .summary-metric-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
            margin-bottom: 6px;
        }

        .summary-metric-value span {
            font-size: 14px;
            color: #888;
        }

        .summary-metric-label {
            font-size: 10px;
            color: #666;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 4px;
            font-weight: 600;
        }

        /* Слайд 3: Дни */
        .summary-days-slide {
            padding-top: 50px;
        }

        .summary-days-title {
            font-size: 11px;
            color: var(--neobrut-black);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 16px;
            padding-left: 4px;
            font-weight: 700;
        }

        .summary-days-card {
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .summary-day {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .summary-day:last-child {
            border-bottom: none;
        }

        .summary-day-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--neobrut-black);
            width: 60px;
        }

        .summary-day-bar-bg {
            flex: 1;
            height: 8px;
            background: #e8e8e8;
            border-radius: 4px;
            margin: 0 12px;
            border: 1px solid var(--neobrut-black);
        }

        .summary-day-bar-fill {
            height: 100%;
            background: var(--neobrut-yellow);
            border-radius: 3px;
        }

        .summary-day-percent {
            font-size: 13px;
            font-weight: 800;
            color: var(--neobrut-black);
            width: 38px;
            text-align: right;
        }

        /* Слайд 4: Достижения */
        .summary-achievements-slide {
            padding-top: 70px;
        }

        .summary-achievement-card {
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 24px 20px;
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .summary-achievement-icon {
            font-size: 44px;
            margin-bottom: 10px;
        }

        .summary-achievement-title {
            font-size: 10px;
            color: #666;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .summary-achievement-value {
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-black);
        }

        .summary-achievement-desc {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            font-weight: 500;
        }

        /* Слайд 5: Период тренировки */
        .summary-period-slide {
            padding-top: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .summary-period-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .summary-period-title {
            font-size: 14px;
            color: #666;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .summary-period-dates {
            font-size: 18px;
            font-weight: 800;
            color: var(--neobrut-black);
            margin-bottom: 24px;
            text-align: center;
        }

        /* Слайд 7: Мотивация */
        .summary-motivation-slide {
            padding-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .summary-motivation-emoji {
            font-size: 72px;
            margin-bottom: 16px;
        }

        .summary-motivation-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin-bottom: 12px;
            text-align: center;
        }

        .summary-motivation-message {
            font-size: 14px;
            color: #666;
            text-align: center;
            max-width: 280px;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .summary-motivation-stats {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .summary-motivation-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .summary-motivation-stat .stat-value {
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
        }

        .summary-motivation-stat .stat-label {
            font-size: 10px;
            color: #666;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 4px;
            font-weight: 600;
        }

        /* Карточка статистики с прогресс-баром */
        .summary-stat-card {
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .summary-stat-label {
            font-size: 11px;
            color: #666;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .summary-stat-bar-bg {
            height: 12px;
            background: #e8e8e8;
            border-radius: 6px;
            border: 1px solid var(--neobrut-black);
            overflow: hidden;
            position: relative;
        }

        .summary-stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neobrut-yellow), #ffd700);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .summary-stat-value {
            font-size: 20px;
            font-weight: 900;
            color: var(--neobrut-black);
            text-align: center;
            margin-top: 8px;
        }

        /* Кнопка завершения */
        .summary-finish-btn {
            width: calc(100% - 32px);
            margin: 10px 16px 16px;
            padding: 16px;
            background: var(--neobrut-red);
            color: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            transition: all 0.1s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-finish-btn:hover {
            background: #dc2626;
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0 var(--neobrut-black);
        }

        .summary-finish-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* ===== СЛАЙДЫ ДНЕЙ (МИНИМАЛИЗМ) ===== */

        .summary-day-slide {
            position: relative;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100%;
        }

        .summary-day-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .summary-day-number {
            font-size: 11px;
            color: #666;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: 600;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .summary-day-name {
            font-size: 28px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin-top: 6px;
            letter-spacing: -1px;
            text-align: center;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .summary-day-percent {
            font-size: 88px;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
            letter-spacing: -4px;
            margin-bottom: 32px;
            text-align: center;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .summary-day-stats {
            display: flex;
            gap: 14px;
            margin-bottom: 24px;
        }

        .summary-day-stat {
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 14px;
            padding: 18px 28px;
            text-align: center;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            min-width: 100px;
        }

        .summary-day-stat-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .summary-day-stat-value span {
            font-size: 16px;
            color: #888;
        }

        .summary-day-stat-label {
            font-size: 9px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 6px;
            font-weight: 600;
        }

        .summary-day-time {
            text-align: center;
            margin-top: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        /* Недельные слайды */
        .summary-week-slide {
            padding-top: 40px;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100%;
            transition: transform 0.15s ease;
        }

        .summary-week-slide:active {
            transform: scale(0.98);
        }

        .summary-week-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .summary-week-emoji {
            font-size: 36px;
            margin-bottom: 4px;
        }

        .summary-week-name {
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-black);
            letter-spacing: -0.5px;
        }

        .summary-week-dates {
            font-size: 13px;
            color: #666;
            margin-top: 2px;
            font-weight: 500;
        }

        .summary-week-percent {
            font-size: 56px;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -2px;
            margin-bottom: 16px;
            text-align: center;
        }

        .summary-week-percent.excellent {
            color: var(--success-green);
        }

        .summary-week-percent.good {
            color: var(--neobrut-blue);
        }

        .summary-week-percent.fair {
            color: var(--neobrut-orange);
        }

        .summary-week-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .summary-week-stat {
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 10px;
            padding: 10px 16px;
            text-align: center;
            box-shadow: 2px 2px 0 var(--neobrut-black);
            min-width: 75px;
        }

        .summary-week-stat-value {
            font-size: 18px;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
        }

        .summary-week-stat-label {
            font-size: 8px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 3px;
            font-weight: 600;
        }

        .summary-week-best {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            border: 2px solid var(--neobrut-black);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 700;
            color: var(--neobrut-black);
            box-shadow: 2px 2px 0 var(--neobrut-black);
            margin-bottom: 12px;
        }

        .summary-week-hint {
            font-size: 11px;
            color: #888;
            text-align: center;
            margin-top: auto;
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
        }

        /* Информация о неделе - правый верхний угол */
        .summary-day-week-info {
            position: absolute;
            top: 18px;
            right: 16px;
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 5;
        }

        /* Кнопка назад - левый верхний угол */
        .summary-day-back-top {
            position: absolute;
            top: calc(18px - 8px - 1px);
            left: 16px;
            font-size: 12px;
            color: var(--neobrut-blue);
            cursor: pointer;
            padding: 8px 14px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 8px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.15s ease;
            font-weight: 600;
            z-index: 5;
        }

        .summary-day-back-top:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .summary-day-back-top:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Day 8 Widget Special Styling */
        .summary-day-widget {
            background: linear-gradient(135deg, #ffd9b3 0%, #ffe8cc 50%, #fff0e0 100%) !important;
            border: 3px solid var(--neobrut-black) !important;
        }

        .summary-widget-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .summary-icon {
            font-size: 16px;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .summary-day-widget .task-progress-container {
            margin-top: auto;
        }

        /* Поздравительный экран */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: celebrationFadeIn 0.5s ease;
        }

        @keyframes celebrationFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .celebration-content {
            text-align: center;
            color: white;
            animation: celebrationScale 0.8s ease;
        }

        @keyframes celebrationScale {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .celebration-emoji {
            font-size: 80px;
            margin-bottom: 20px;
            animation: celebrationBounce 1s ease infinite;
        }

        @keyframes celebrationBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .celebration-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .celebration-subtitle {
            font-size: 24px;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .celebration-message {
            font-size: 18px;
            max-width: 400px;
            margin: 0 auto 30px;
            opacity: 0.8;
        }

        .celebration-button {
            background: white;
            color: #764ba2;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-top: 20px;
        }

        .celebration-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        /* Конфетти эффект */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: fixed;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Стили для списка функций в поздравительном окне подписки (необрутализм) */
        .celebration-features {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin: 20px auto;
            max-width: 340px;
            max-height: 45vh;
            overflow-y: auto;
            text-align: left;
            padding-right: 5px;
        }

        .celebration-features::-webkit-scrollbar {
            width: 8px;
        }

        .celebration-features::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .celebration-features::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .celebration-feature {
            font-size: 0.85rem;
            padding: 0.6rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 0.95);
            animation: celebrationFeatureSlide 0.3s ease forwards;
            opacity: 0;
            transform: translateX(-10px);
        }

        .celebration-feature:last-child {
            border-bottom: none;
        }

        .celebration-feature::before {
            content: '✓';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--success-green);
            border: 2px solid var(--neobrut-black);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 900;
            flex-shrink: 0;
            margin-top: 2px;
            color: var(--neobrut-black);
        }

        /* Задержка анимации для каждой функции (первые 6, потом быстро) */
        .celebration-feature:nth-child(1) { animation-delay: 0.05s; }
        .celebration-feature:nth-child(2) { animation-delay: 0.08s; }
        .celebration-feature:nth-child(3) { animation-delay: 0.11s; }
        .celebration-feature:nth-child(4) { animation-delay: 0.14s; }
        .celebration-feature:nth-child(5) { animation-delay: 0.17s; }
        .celebration-feature:nth-child(6) { animation-delay: 0.20s; }
        .celebration-feature:nth-child(n+7) { animation-delay: 0.25s; }
        .celebration-feature:nth-child(n+13) { animation-delay: 0.30s; }
        .celebration-feature:nth-child(n+19) { animation-delay: 0.35s; }

        @keyframes celebrationFeatureSlide {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* Горизонтальный разделитель с кнопкой */
        .divider {
            height: 4px;
            background: var(--neobrut-black);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .divider-button {
            width: 60px;
            height: 20px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            cursor: pointer;
            transition: background 0.2s ease, box-shadow 0.2s ease;
            z-index: 1;
            will-change: transform;
            touch-action: none;
        }

        .divider-button:hover {
            transform: translate(-50%, -50%) scale(1.05);
            background: var(--neobrut-orange);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .divider-button:active {
            transform: translate(-50%, -50%) scale(0.95);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Нижняя секция с активностью */
        .activity-section {
            padding: 5px;
            background: linear-gradient(
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.3)
            );
            display: flex;
            flex-direction: column;
            flex: 1;
            box-shadow: 0 -4px 0 var(--neobrut-black);
            min-height: 0;
            position: relative;
        }

        /* Вертикальная сетка активности */
        .activity-grid-vertical {
            background: rgba(255, 255, 255, 0.7);
            border: 4px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 6px 6px 0 var(--neobrut-black);
            margin-top: 0;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            height: 100%;
            pointer-events: auto;
        }

        /* Мобильная адаптация */
        @media (max-width: 480px) {
            .activity-grid-vertical {
                padding: 12px;
                min-height: 200px;
                height: 100%;
                margin-top: 0;
            }
        }

        /* Слайдер для календарей */
        .activity-slider {
            display: flex;
            gap: 0;
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            pointer-events: auto;
        }

        .calendar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease-out;
            pointer-events: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .calendar-container:nth-child(1) {
            transform: translateX(-100%);
        }

        .calendar-container:nth-child(2) {
            transform: translateX(0);
            z-index: 1;
        }

        .calendar-container:nth-child(3) {
            transform: translateX(100%);
        }

        .calendar-container.empty-calendar {
            opacity: 0.3;
        }

        .calendar-container.empty-calendar .calendar-months {
            pointer-events: none;
        }

        /* Секция заданий */
        .calendar-container.tasks-calendar {
            overflow: hidden;
        }

        .tasks-container {
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-content: start;
        }

        /* Виджет дня задачи */
        .task-day-widget {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: space-between;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
            min-height: 130px;
            position: relative;
        }

        .task-day-widget:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--neobrut-black);
        }

        .task-day-widget:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Выделяем текущий день в виджетах задач */
        .task-day-widget.current {
            transform: translateY(-6px) !important;
            box-shadow:
                10px 10px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0,0,0,0.1) !important;
            border-width: 4px !important;
            opacity: 1 !important;
        }

        .task-day-widget.current:hover {
            transform: translate(-2px, -8px) !important;
            box-shadow:
                12px 12px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0,0,0,0.1) !important;
        }

        .task-day-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .task-day-name {
            font-size: 14px;
            font-weight: 900;
            color: var(--neobrut-black);
            text-transform: uppercase;
        }

        .task-day-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--neobrut-gray);
        }

        /* Контейнер круга сложности */
        .task-difficulty-container {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .task-difficulty-label {
            font-size: 8px;
            font-weight: 700;
            color: var(--neobrut-gray);
        }

        /* SVG круг сложности */
        .task-difficulty-circle {
            width: 28px;
            height: 28px;
            position: relative;
        }

        .task-difficulty-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .task-difficulty-circle .circle-bg {
            fill: none;
            stroke: var(--bg-grid);
            stroke-width: 4;
        }

        .task-difficulty-circle .circle-progress {
            fill: none;
            stroke: var(--neobrut-orange);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        /* Контейнер прогресса выполнения */
        .task-progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            margin-top: auto;
        }

        .task-progress-percentage {
            font-size: 18px;
            font-weight: 900;
            color: var(--neobrut-black);
        }

        .task-progress-circle {
            width: 32px;
            height: 32px;
        }

        .task-progress-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .task-progress-circle .progress-circle-bg {
            fill: none;
            stroke: var(--bg-grid);
            stroke-width: 3;
        }

        .task-progress-circle .progress-circle-fill {
            fill: none;
            stroke: var(--success-green);
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .calendar-wrapper {
            overflow: visible;
            height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .calendar-months {
            height: 100%;
            overflow-y: visible;
            overflow-x: visible;
        }

        .calendar-month {
            margin-bottom: 12px;
        }

        .calendar-month-header {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 6px;
            color: var(--neobrut-black);
            background: rgba(255, 190, 11, 0.8);
            border: 3px solid var(--neobrut-black);
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: inline-block;
            transform: rotate(-1deg);
        }

        .calendar-week {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            overflow: visible;
            width: 100%;
        }

        .calendar-weekday {
            font-size: 10px;
            font-weight: 700;
            color: var(--neobrut-gray);
            flex: 1;
            text-align: center;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .activity-cell {
            flex: 1;
            height: 18px;
            min-width: 0;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            cursor: default;
            transition: all 0.2s;
            position: relative;
            touch-action: manipulation;
        }

        /* Эффекты для ячеек с активностью */
        .activity-cell:not(.empty) {
            cursor: pointer;
        }

        .activity-cell:not(.empty):hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            z-index: 10;
        }

        .activity-cell:not(.empty):active {
            transform: translateY(0) scale(0.98);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .activity-cell.empty {
            background: transparent;
            border-color: transparent;
            cursor: default;
        }

        .activity-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        /* Уровни активности - Зеленая градация */
        .activity-cell[data-activity="none"] {
            background: var(--neobrut-lightgray);
        }

        .activity-cell[data-activity="low"] {
            background: var(--lime-green);
        }

        .activity-cell[data-activity="medium"] {
            background: var(--light-green);
        }

        .activity-cell[data-activity="high"] {
            background: var(--medium-green);
        }

        .activity-cell[data-activity="max"] {
            background: var(--swamp-green);
        }

        .activity-cell .date-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 700;
            color: var(--neobrut-black);
            opacity: 0.7;
        }

        /* Делаем текущий день постоянно выпирающим (3D-эффект) */
        .activity-cell.today {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border: 2px solid var(--neobrut-black);
            z-index: 10;
        }

        /* Для текущего дня убираем эффекты наведения и нажатия */
        .activity-cell.today:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .activity-cell.today:active {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        /* Исключаем пустые ячейки из 3D-эффекта */
        .activity-cell.today.empty {
            transform: none;
            box-shadow: none;
            border: 2px solid transparent;
        }

        /* Нижняя панель с элементами управления */
        .year-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reset-btn {
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            padding: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            color: var(--neobrut-white);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 0 var(--neobrut-black);
            background: #FF0040;
        }

        .reset-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .year-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .current-year {
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            background: var(--neobrut-blue);
            padding: 8px 16px;
            border: 3px solid var(--neobrut-black);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        /* Контейнер для GitHub-стиль таблицы */
        .contribution-graph {
            font-size: 10px;
            color: #57606a;
            position: relative;
        }

        /* Стили для SVG элементов - GitHub стиль */
        .contribution-calendar {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .calendar-graph {
            padding: 5px 0 0;
            text-align: center;
        }

        .calendar-graph svg {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Месяцы */
        .month-label {
            font-size: 10px;
            fill: var(--neobrut-gray);
            font-weight: 600;
        }

        /* Дни недели */
        .day-label {
            font-size: 9px;
            fill: var(--neobrut-gray);
            font-weight: 500;
            text-anchor: start;
        }

        /* Ячейки активности */
        .contribution-day {
            shape-rendering: geometricPrecision;
            stroke: rgba(27, 31, 35, 0.04);
            stroke-width: 1px;
            rx: 2;
            ry: 2;
        }

        .contribution-day:hover {
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 2px;
        }

        /* Уровни активности - Яркие цвета необрутализма */
        .contribution-day[data-level="0"] {
            fill: var(--neobrut-lightgray);
            stroke: var(--neobrut-gray);
        }

        .contribution-day[data-level="1"] {
            fill: var(--warning-yellow);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="2"] {
            fill: var(--neobrut-orange);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="3"] {
            fill: var(--neobrut-pink);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="4"] {
            fill: var(--accent-purple);
            stroke: var(--neobrut-black);
        }

        /* Сегодняшний день */
        .contribution-day.today {
            stroke: var(--neobrut-orange);
            stroke-width: 2px;
        }

        /* Tooltip */
        .tip {
            position: absolute;
            z-index: 100;
            font-size: 11px;
            line-height: 1.4;
            font-weight: 400;
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 5px 8px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tip.show {
            opacity: 1;
        }

        /* Мобильная оптимизация для очень маленьких экранов */
        @media (max-width: 390px) {
            .workout-title {
                font-size: 20px;
            }

            .activity-title {
                font-size: 18px;
            }
        }

        /* Анимация появления */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-section,
        .activity-section {
            animation: slideIn 0.5s ease-out;
        }

        .activity-section {
            animation-delay: 0.1s;
        }

        /* Tooltip для дня активности */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(45, 52, 54, 0.2);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--neobrut-darkgray);
        }

        .day-cell:hover .tooltip {
            opacity: 1;
        }

        /* AI Chat Modal стили */
        .ai-chat-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .ai-chat-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .ai-chat-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-header {
            background: var(--neobrut-white);
            padding: 25px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            cursor: grab;
            touch-action: pan-y;
        }

        .ai-chat-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-chat-header:active {
            cursor: grabbing;
        }

        .ai-chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            margin: 0;
        }

        .ai-chat-close,
        .ai-chat-clear {
            width: 30px;
            height: 30px;
            background: var(--neobrut-white);
            border: 1px solid var(--neobrut-gray);
            border-radius: 4px;
            font-size: 16px;
            font-weight: 400;
            color: var(--neobrut-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-chat-clear:hover {
            background: var(--neobrut-red);
            color: white;
            border-color: var(--neobrut-black);
        }

        .ai-chat-close {
            display: none; /* Скрываем кнопку закрытия */
        }

        .ai-chat-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            background: var(--neobrut-white);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            animation: messageSlide 0.2s ease-out;
        }

        .message:last-child {
            border-bottom: none;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--neobrut-darkgray);
            word-wrap: break-word;
        }

        .user-message {
            background: rgba(78, 205, 196, 0.1);
        }

        .user-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.5);
        }

        .ai-message .message-content {
            color: #333;
        }

        .message-content p {
            margin: 0;
        }

        /* Стили для форматированного AI контента */
        .ai-message .message-content h3 {
            color: var(--accent-blue);
            margin: 12px 0 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .ai-message .message-content strong {
            color: var(--neobrut-darkgray);
            font-weight: 600;
        }

        .ai-message .message-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item {
            margin: 8px 0 8px 20px;
            position: relative;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-size: 1.2em;
            top: -2px;
        }

        .ai-message .message-content span[style*="font-size: 1.2em"] {
            vertical-align: middle;
            font-size: 1em !important;
        }

        .chat-input-container {
            display: flex;
            padding: 16px 20px;
            background: var(--neobrut-white);
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 400;
            background: var(--neobrut-white);
            outline: none;
            margin-right: 12px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--neobrut-gray);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-send {
            width: auto;
            min-width: 60px;
            height: 36px;
            background: var(--neobrut-black);
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0 16px;
        }

        .chat-send:hover {
            background: #333;
        }

        .chat-send:active {
            background: #000;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }

        /* Typing Indicator Styles */
        .typing-indicator {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dots .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ===== НЕОБРУТАЛИСТИЧЕСКИЙ ЧАТ В СЛАЙДЕРЕ ===== */

        /* Контейнер чата в календаре */
        .calendar-container.chat-calendar {
            background: transparent;
        }

        .calendar-container.chat-calendar .calendar-wrapper {
            background: transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-wrapper {
            padding: 0;
            overflow: hidden;
        }

        /* Сообщения чата */
        .chat-wrapper .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px 12px 12px;
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-wrapper .message {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 14px;
            animation: messageSlideIn 0.2s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateX(-10px) rotate(-2deg);
            }
            to {
                opacity: 1;
                transform: translateX(0) rotate(0);
            }
        }

        .chat-wrapper .message.user-message {
            background: var(--neobrut-blue);
            transform: rotate(0deg);
            align-self: flex-end;
        }

        .chat-wrapper .message.user-message .message-content {
            color: var(--neobrut-white);
        }

        .chat-wrapper .message.ai-message {
            background: var(--neobrut-white);
            transform: rotate(0deg);
        }

        .chat-wrapper .message.ai-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .chat-wrapper .message-content {
            font-size: 13px;
            line-height: 1.4;
        }

        .chat-wrapper .message-content p {
            margin: 0;
        }

        /* Стили для форматированного контента AI */
        .chat-wrapper .ai-message .message-content h3 {
            color: var(--neobrut-purple);
            margin: 8px 0 6px;
            font-weight: 800;
            font-size: 14px;
        }

        .chat-wrapper .ai-message .message-content strong {
            color: var(--neobrut-black);
            font-weight: 700;
        }

        .chat-wrapper .ai-message .message-content .ai-list-item {
            margin: 6px 0 6px 16px;
            position: relative;
            line-height: 1.4;
        }

        .chat-wrapper .ai-message .message-content .ai-list-item:before {
            content: "▸";
            position: absolute;
            left: -12px;
            color: var(--neobrut-orange);
            font-weight: 900;
        }

        /* Typing indicator */
        .chat-wrapper .typing-indicator {
            background: var(--neobrut-cream);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            width: fit-content;
        }

        .chat-wrapper .typing-dots .dot {
            background-color: var(--neobrut-black);
            border: 1px solid var(--neobrut-black);
        }

        /* Индикатор репоста над полем ввода чата */
        .chat-repost-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            margin: 0 12px 8px 12px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .repost-close-btn {
            width: 24px;
            height: 24px;
            min-width: 24px;
            background: var(--neobrut-black);
            color: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            flex-shrink: 0;
            transition: all 0.1s;
        }

        .repost-close-btn:hover {
            background: var(--neobrut-red);
            transform: translate(-1px, -1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .repost-close-btn:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        .repost-indicator-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .repost-indicator-text {
            flex: 1;
            font-size: 13px;
            font-weight: 700;
            color: var(--neobrut-black);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Область ввода */
        .chat-input-area {
            background: transparent;
            border-top: 4px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .chat-input-row {
            display: flex;
            gap: 8px;
            padding: 8px 12px 12px;
        }

        .chat-input-neobrut {
            flex: 1;
            padding: 10px 14px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-darkgray);
            outline: none;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.1s;
        }

        .chat-input-neobrut:focus {
            box-shadow: 4px 4px 0 var(--neobrut-black);
            transform: translate(-1px, -1px);
        }

        .chat-input-neobrut::placeholder {
            color: var(--neobrut-gray);
        }

        .chat-send-neobrut {
            width: 42px;
            height: 42px;
            background: var(--neobrut-black);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .chat-send-neobrut:hover {
            background: var(--neobrut-blue);
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .chat-send-neobrut:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .chat-send-neobrut span {
            display: block;
            transform: translateX(2px);
        }

        /* Скроллбар для сообщений */
        .chat-wrapper .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-wrapper .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-wrapper .chat-messages::-webkit-scrollbar-thumb {
            background: var(--neobrut-black);
            border-radius: 3px;
        }

        /* ===== КОНЕЦ НЕОБРУТАЛИСТИЧЕСКОГО ЧАТА ===== */

        /* ===== TOAST "НОВЫЙ ЧАТ" ===== */
        .new-chat-toast {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 8px 14px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), transform 0.3s ease-out;
            white-space: nowrap;
            pointer-events: none;
        }

        .new-chat-toast.show {
            opacity: 1;
            pointer-events: auto;
        }

        .new-chat-toast.show.shake {
            animation: toastShakeHint 0.6s ease-in-out;
        }

        .new-chat-toast.swiping {
            transition: none;
        }

        .new-chat-toast.hiding {
            transform: translateX(calc(-50% + 400px)) !important;
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out !important;
        }

        /* Подёргивание вправо как hint для свайпа */
        @keyframes toastShakeHint {
            0%, 100% { transform: translateX(-50%); }
            20% { transform: translateX(calc(-50% + 8px)); }
            40% { transform: translateX(calc(-50% - 4px)); }
            60% { transform: translateX(calc(-50% + 4px)); }
            80% { transform: translateX(calc(-50% - 2px)); }
        }

        .new-chat-toast-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--neobrut-black);
        }

        .new-chat-toast-btn {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--neobrut-black);
            background: var(--success-green);
            font-size: 11px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 0 var(--neobrut-black);
            transition: all 0.1s;
            flex-shrink: 0;
        }

        .new-chat-toast-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .new-chat-toast-btn:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        /* SVG таймер вокруг toast */
        .new-chat-timer-svg {
            position: absolute;
            top: -4px;
            left: -4px;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .new-chat-toast.show .new-chat-timer-svg {
            opacity: 1;
        }

        .new-chat-timer-rect {
            fill: none;
            stroke: var(--swamp-green);
            stroke-width: 6;
        }

        .new-chat-timer-rect.active {
            animation: svgTimerCountdown 10s linear forwards;
        }

        @keyframes svgTimerCountdown {
            from { stroke-dashoffset: var(--perimeter); }
            to { stroke-dashoffset: 0; }
        }

        /* ===== STREAK АНИМАЦИЯ (как в Duolingo) ===== */
        .streak-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
        }

        .streak-overlay.show {
            animation: fadeIn 0.3s ease forwards;
        }

        .streak-overlay.hide {
            animation: fadeOut 0.5s ease forwards;
        }

        .streak-fire {
            font-size: 120px;
            line-height: 1;
            animation: fireScale 0.6s ease-out forwards;
            filter: drop-shadow(0 0 30px rgba(255, 150, 50, 0.8));
        }

        .streak-fire.glow {
            animation: fireScale 0.6s ease-out forwards, fireGlow 0.8s ease-in-out 0.6s 3;
        }

        .streak-number {
            font-size: 72px;
            font-weight: 900;
            color: var(--neobrut-black);
            text-shadow: 4px 4px 0 var(--neobrut-yellow);
            margin-top: 10px;
            opacity: 0;
            animation: numberSlide 0.5s ease-out 0.3s forwards;
        }

        .streak-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--neobrut-darkgray);
            margin-top: 5px;
            opacity: 0;
            animation: textSlide 0.5s ease-out 0.4s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fireScale {
            0% { transform: scale(0) rotate(-10deg); }
            50% { transform: scale(1.3) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes fireGlow {
            0%, 100% { filter: drop-shadow(0 0 30px rgba(255, 150, 50, 0.8)); }
            50% { filter: drop-shadow(0 0 60px rgba(255, 100, 0, 1)); }
        }

        @keyframes numberSlide {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes textSlide {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* ===== КОНЕЦ STREAK АНИМАЦИИ ===== */

        /* ===== DASHBOARD STRIP (Верхняя панель) ===== */
        .dashboard-strip {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: transparent;
            height: 100%;
            overflow-y: auto;
        }

        .strip-main {
            background: linear-gradient(135deg, var(--neobrut-orange), var(--neobrut-red));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .strip-day-info {
            color: var(--neobrut-white);
        }

        .strip-day {
            font-size: 11px;
            font-weight: 700;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .strip-date {
            font-size: 24px;
            font-weight: 900;
            line-height: 1;
            margin-top: 2px;
        }

        .strip-streak {
            text-align: right;
        }

        .streak-icon {
            font-size: 28px;
            line-height: 1;
        }

        .streak-count {
            font-size: 13px;
            font-weight: 900;
            color: var(--neobrut-white);
        }

        .strip-progress {
            background: linear-gradient(135deg, var(--neobrut-blue), var(--neobrut-purple));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .strip-progress-content {
            flex: 1;
        }

        .strip-progress-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .strip-progress-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--neobrut-white);
            line-height: 1;
        }

        .strip-progress-sub {
            font-size: 13px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
        }

        .strip-progress-chart {
            flex-shrink: 0;
        }

        /* ===== AI COMMENT BLOCK ===== */
        .ai-comment {
            background: linear-gradient(135deg, var(--neobrut-purple), var(--neobrut-blue));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 14px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .ai-comment:hover {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0 var(--neobrut-black);
        }

        .ai-comment:active {
            transform: translate(1px, 1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .ai-comment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
            pointer-events: none;
        }

        .ai-comment-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--neobrut-white);
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        /* Typing cursor effect */
        .ai-comment-text.typing::after {
            content: '';
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--neobrut-white);
            margin-left: 2px;
            animation: blink-cursor 0.8s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink-cursor {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Dark gray blinking dots */
        .ai-comment-typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 4px;
        }

        .ai-comment-typing-dot {
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: typing-blink 1.4s infinite ease-in-out both;
        }

        .ai-comment-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-comment-typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .ai-comment-typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typing-blink {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }
            40% { transform: scale(1); opacity: 0.5; }
        }

        .ai-comment-loading {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
        }

        .ai-comment-loading-dot {
            width: 7px;
            height: 7px;
            background: var(--neobrut-white);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .ai-comment-loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-comment-loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .ai-comment-loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ===== NAVIGATION BUTTONS ===== */
        .nav-buttons-container {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .nav-button {
            flex: 1;
            aspect-ratio: 1 / 1;
            max-height: 65px;
            background: var(--neobrut-white);
            border: 4px solid var(--neobrut-black);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 5px 5px 0 var(--neobrut-black);
            position: relative;
            overflow: hidden;
        }

        .nav-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0 var(--neobrut-black);
            background: var(--neobrut-cream);
        }

        .nav-button:active {
            transform: translate(3px, 3px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .nav-button.active {
            background: var(--success-green);
            box-shadow: 5px 5px 0 var(--neobrut-black);
            transform: translate(-1px, -1px);
        }

        .nav-button.active:hover {
            background: var(--success-green);
            box-shadow: 6px 6px 0 var(--neobrut-black);
        }

        /* PNG иконка чата */
        .nav-icon-img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }

        /* SVG иконки */
        .nav-button svg {
            width: 65%;
            height: 65%;
        }

        .nav-button.active svg {
            filter: brightness(0) invert(1);
        }

        /* Для активной кнопки задач - галочки остаются белыми */
        .nav-button.active svg path[stroke="white"] {
            stroke: white;
            filter: none;
        }

        .nav-button.shake {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        /* Activity colors for calendar icon - более яркие необруталистические */
        .activity-block-low { fill: var(--neobrut-green); }
        .activity-block-medium { fill: var(--neobrut-blue); }
        .activity-block-high { fill: var(--neobrut-purple); }

        /* Task colors - более яркие необруталистические */
        .task-cube-done { fill: var(--neobrut-green); }
        .task-cube-pending { stroke: var(--neobrut-black); stroke-width: 2; fill: var(--neobrut-lightgray); }
        .task-checkmark { fill: var(--neobrut-white); }

        /* ===== ФИКСИРОВАННОЕ СООТНОШЕНИЕ ЭКРАНА ===== */
        body {
            height: 100vh;
            overflow: hidden;
        }

        .workout-section {
            height: 40%;
            overflow-y: auto;
        }

        .activity-section {
            height: 60%;
            overflow: hidden;
        }

        /* ===== ПРИВЕТСТВЕННЫЙ ЭКРАН (Welcome Screen) ===== */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: url('fantasy-bg-new.jpg') center/cover no-repeat;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.6s ease-out, visibility 0.6s ease-out;
        }

        .welcome-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        .welcome-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .clear-cache-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border: 2px solid var(--neobrut-black);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            font-size: 20px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .clear-cache-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        .clear-cache-btn:active {
            transform: scale(0.95);
        }

        .welcome-content {
            position: relative;
            z-index: 1;
            text-align: center;
            color: var(--neobrut-black);
            animation: welcomeFadeIn 1.2s ease-out;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 8vh 20px 4vh;
        }

        @keyframes welcomeFadeIn {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-title {
            font-size: clamp(2rem, 8vw, 3.5rem);
            font-weight: 900;
            letter-spacing: -0.03em;
            margin: 0 0 1rem 0;
            color: var(--neobrut-black);
            text-transform: uppercase;
        }

        .welcome-tagline {
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: var(--neobrut-black);
            letter-spacing: 0.02em;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0px var(--neobrut-black);
            padding: 0.5rem 1rem;
            display: inline-block;
        }

        .welcome-pulse {
            margin-top: auto;
            position: relative;
            width: 60px;
            height: 60px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-pulse::before {
            display: none;
        }

        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: pulseExpand 4s ease-out infinite;
            background: transparent;
        }

        .pulse-ring:nth-child(1) {
            animation-delay: 0s;
        }

        .pulse-ring:nth-child(2) {
            animation-delay: 1.2s;
        }

        .pulse-ring:nth-child(3) {
            animation-delay: 2.4s;
        }

        @keyframes pulseExpand {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(20);
                opacity: 0;
            }
        }

        @keyframes pulseScale {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* ===== КРУГЛАЯ АНИМАЦИЯ ЗАГРУЗКИ (Loading Spinner) ===== */
        .welcome-loading {
            display: none;
            width: 60px;
            height: 60px;
            margin: auto auto 1rem;
            position: relative;
        }

        .welcome-loading.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            width: 100%;
            height: 100%;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--neobrut-black);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .welcome-hint {
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            font-weight: 700;
            margin: 0;
            color: var(--neobrut-black);
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0px var(--neobrut-black);
            padding: 0.5rem 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            animation: hintBounce 1.5s ease-in-out infinite;
        }

        @keyframes hintBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-4px);
            }
        }

        /* ===== PRICING BLOCK (Welcome Screen Step 2) ===== */
        .pricing-block {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-out;
        }

        .pricing-block.show {
            display: block;
            opacity: 1;
        }

        .pricing-card {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 6px 6px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 0.9rem 1.1rem;
            max-width: 340px;
            margin: 0 auto;
            animation: pricingSlideUp 0.5s ease-out;
        }

        @keyframes pricingSlideUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pricing-title {
            font-size: 1.05rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin: 0 0 0.25rem 0;
            color: var(--neobrut-black);
        }

        .pricing-tagline {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--neobrut-gray);
            margin: 0 0 0.6rem 0;
        }

        .pricing-description {
            font-size: 0.78rem;
            line-height: 1.4;
            color: var(--neobrut-darkgray);
            margin: 0 0 0.6rem 0;
            text-align: left;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 0 0 0.7rem 0;
            text-align: left;
        }

        .pricing-features li {
            font-size: 0.75rem;
            padding: 0.25rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.35rem;
        }

        .pricing-features li::before {
            content: '✓';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--success-green);
            border: 2px solid var(--neobrut-black);
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 900;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .pricing-price {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.15rem;
            margin: 0.7rem 0;
            padding: 0.5rem;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .pricing-price-amount {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--neobrut-black);
            line-height: 1;
        }

        .pricing-price-currency {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--neobrut-black);
        }

        .pricing-price-period {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--neobrut-darkgray);
        }

        .pricing-buy-btn {
            width: 100%;
            padding: 0.65rem;
            font-size: 0.9rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--neobrut-white);
            background: var(--neobrut-green);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .pricing-buy-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0 var(--neobrut-black);
        }

        .pricing-buy-btn:active {
            transform: translate(1px, 1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        /* "Show more" link button */
        .pricing-show-more {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--neobrut-blue);
            background: none;
            border: none;
            padding: 0;
            margin: 0.3rem 0 0 0;
            cursor: pointer;
            text-decoration: underline;
            text-align: left;
            width: fit-content;
        }

        .pricing-show-more:hover {
            color: var(--neobrut-purple);
        }

        /* ===== FEATURES MODAL ===== */
        .features-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .features-modal.show {
            display: flex;
            opacity: 1;
        }

        .features-modal-content {
            background: var(--neobrut-white);
            border: 4px solid var(--neobrut-black);
            box-shadow: 10px 10px 0 var(--neobrut-black);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 340px;
            max-height: 80vh;
            overflow-y: auto;
            animation: featuresSlideUp 0.4s ease-out;
        }

        @keyframes featuresSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .features-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--neobrut-black);
        }

        .features-modal-title {
            font-size: 1.2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin: 0;
            color: var(--neobrut-black);
        }

        .features-modal-close {
            width: 32px;
            height: 32px;
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .features-modal-close:hover {
            transform: scale(1.1);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .features-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .features-modal-list li {
            font-size: 0.85rem;
            padding: 0.6rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            border-bottom: 1px dashed var(--neobrut-gray);
        }

        .features-modal-list li:last-child {
            border-bottom: none;
        }

        .features-modal-list li::before {
            content: '✓';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--success-green);
            border: 2px solid var(--neobrut-black);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 900;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Hide initial content when pricing is shown */
        .welcome-content.has-pricing .welcome-pulse,
        .welcome-content.has-pricing .welcome-loading,
        .welcome-content.has-pricing .welcome-hint {
            display: none;
        }

        /* ===== EMAIL MODAL (Purchase) ===== */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .email-modal.show {
            display: flex;
            animation: emailModalFadeIn 0.2s ease-out;
        }

        @keyframes emailModalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .email-modal-content {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 8px 8px 0 var(--neobrut-black);
            border-radius: 12px;
            max-width: 360px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: emailModalSlideUp 0.3s ease-out;
        }

        @keyframes emailModalSlideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .email-modal-header {
            padding: 1rem;
            border-bottom: 2px solid var(--neobrut-black);
            background: var(--neobrut-yellow);
        }

        .email-modal-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--neobrut-black);
        }

        .email-modal-body {
            padding: 1rem;
        }

        .email-modal-body-hidden {
            display: none;
        }

        .email-modal-description {
            margin: 0 0 0.8rem 0;
            font-size: 0.85rem;
            color: var(--neobrut-darkgray);
            text-align: center;
        }

        .email-modal-input {
            width: 100%;
            padding: 0.7rem;
            font-size: 0.9rem;
            font-family: inherit;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            background: var(--neobrut-white);
            box-sizing: border-box;
            transition: all 0.15s ease;
        }

        .email-modal-input:focus {
            outline: none;
            border-color: var(--neobrut-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .email-modal-input.error {
            border-color: var(--neobrut-red);
            background: #fef2f2;
        }

        .email-modal-error {
            margin: 0.5rem 0 0 0;
            font-size: 0.75rem;
            color: #dc2626;
            min-height: 1rem;
            text-align: center;
        }

        .email-modal-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .email-modal-btn {
            flex: 1;
            padding: 0.7rem;
            font-size: 0.85rem;
            font-family: inherit;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .email-modal-btn-cancel {
            background: var(--neobrut-gray);
            color: var(--neobrut-black);
        }

        .email-modal-btn-cancel:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .email-modal-btn-cancel:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .email-modal-btn-confirm {
            background: var(--neobrut-green);
            color: var(--neobrut-white);
        }

        .email-modal-btn-confirm:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .email-modal-btn-confirm:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .email-modal-btn-close {
            background: var(--neobrut-blue);
            color: var(--neobrut-white);
        }

        .email-modal-btn-close:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .email-modal-btn-retry {
            background: var(--neobrut-orange);
            color: var(--neobrut-white);
        }

        .email-modal-btn-retry:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .email-modal-btn-refresh {
            background: var(--neobrut-purple);
            color: var(--neobrut-white);
            padding: 0.8rem 1.2rem;
            font-size: 1.5rem;
            min-width: 60px;
        }

        .email-modal-btn-refresh:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .email-modal-btn-refresh:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .payment-refresh-hint {
            margin-top: 1.5rem;
            padding: 0.8rem;
            font-size: 0.85rem;
            color: var(--neobrut-darkgray);
            text-align: center;
            line-height: 1.4;
        }

        /* Loading state */
        .email-modal-loading {
            text-align: center;
            padding: 1rem 0;
        }

        .email-modal-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 1rem;
            border: 4px solid var(--neobrut-gray);
            border-top-color: var(--neobrut-green);
            border-radius: 50%;
            animation: emailModalSpin 0.8s linear infinite;
        }

        @keyframes emailModalSpin {
            to {
                transform: rotate(360deg);
            }
        }

        .email-modal-loading p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--neobrut-darkgray);
        }

        /* Success state */
        .email-modal-success {
            text-align: center;
            padding: 0.5rem 0;
        }

        .email-modal-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--neobrut-black);
            border-radius: 50%;
            font-size: 1.8rem;
            font-weight: 900;
        }

        .email-modal-icon-success {
            background: var(--success-green);
            color: var(--neobrut-white);
        }

        .email-modal-success h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--neobrut-black);
        }

        .email-modal-success p {
            margin: 0.3rem 0;
            font-size: 0.85rem;
            color: var(--neobrut-darkgray);
        }

        .email-modal-email-display {
            font-weight: 600;
            color: var(--neobrut-black);
            padding: 0.5rem;
            background: var(--neobrut-yellow);
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        /* Error state */
        .email-modal-error-content {
            text-align: center;
            padding: 0.5rem 0;
        }

        .email-modal-icon-error {
            background: #dc2626;
            color: var(--neobrut-white);
        }

        .email-modal-error-content h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--neobrut-black);
        }

        .email-modal-error-content p {
            margin: 0.3rem 0;
            font-size: 0.85rem;
            color: var(--neobrut-darkgray);
        }

        .email-modal-body-payment {
            padding: 1.5rem;
        }

        #payment-form {
            width: 100%;
            min-height: 400px;
        }

        /* ЮКасса логотип */
        .email-modal-yookassa-logo {
            margin: 1.5rem 0;
            text-align: center;
        }

        .yookassa-banner {
            max-width: 200px;
            height: auto;
            transform: scale(1.6);
        }

        /* Текст соглашения с политикой конфиденциальности */
        .email-modal-agreement {
            margin: 1rem 0 0.5rem 0;
            text-align: center;
        }

        .email-modal-agreement-text {
            margin: 0;
            font-size: clamp(0.65rem, 2.5vw, 0.85rem);
            color: var(--neobrut-darkgray);
            line-height: 1.4;
        }

        .email-modal-help-link {
            margin: 0.5rem 0 0 0;
            font-size: clamp(0.65rem, 2.5vw, 0.85rem);
        }

        .email-modal-privacy-link {
            color: var(--neobrut-blue);
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }

        .email-modal-privacy-link:hover {
            text-decoration-style: solid;
        }

    </style>
</head>

<body>
    <!-- Приветственный экран (Welcome Screen) -->
    <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-content" id="welcome-content">
            <h1 class="welcome-title">FitTracker AI</h1>
            <p class="welcome-tagline">Твой умный помощник в фитнесе</p>
            <div class="welcome-pulse" id="welcome-pulse">
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
            </div>
            <div class="welcome-loading" id="welcome-loading">
                <div class="loading-spinner"></div>
            </div>
            <p class="welcome-hint">Коснись экрана, чтобы начать</p>

            <!-- Pricing Block (shown on tap) -->
            <div class="pricing-block" id="pricing-block">
                <div class="pricing-card">
                    <h2 class="pricing-title">Начни своё преобразование</h2>
                    <p class="pricing-tagline">28-дневная программа тренировок</p>

                    <p class="pricing-description">
                        Эффективная фитнес-программа для тех, кто хочет привести себя в форму за короткий срок. Каждая тренировка разработана так, чтобы дать максимальный результат за минимальное время.
                    </p>

                    <ul class="pricing-features">
                        <li>318 упражнений, из них 84 с видео-демонстрациями</li>
                        <li>28 полноценных тренировочных дней</li>
                        <li>Умный помощник для вопросов и советов 24/7</li>
                        <li>Календарь активности и прогресса</li>
                        <li>Мотивационная система серий</li>
                        <li>Итоговая статистика по проделанной работе</li>
                    </ul>

                    <button class="pricing-show-more" id="pricing-show-more">Показать больше</button>

                    <div class="pricing-price">
                        <span class="pricing-price-amount">3 900</span>
                        <span class="pricing-price-currency">₽</span>
                        <span class="pricing-price-period">/единоразово</span>
                    </div>

                    <button class="pricing-buy-btn" id="pricing-buy-btn">Продолжить</button>
                </div>
            </div>
        </div>
        <!-- Кнопка сброса кэша (для тестирования) -->
        <button class="clear-cache-btn" id="clear-cache-btn" title="Сбросить кэш подписки">🔄</button>
    </div>

    <!-- Features Modal -->
    <div class="features-modal" id="features-modal">
        <div class="features-modal-content">
            <div class="features-modal-header">
                <h3 class="features-modal-title">Все возможности</h3>
                <button class="features-modal-close" id="features-modal-close">×</button>
            </div>
            <ul class="features-modal-list">
                <li>159 упражнений в программе</li>
                <li>42 упражнения с видео-демонстрациями</li>
                <li>28 полноценных тренировочных дней</li>
                <li>AI-коуч с персональными комментариями к прогрессу</li>
                <li>Карточки упражнений с адаптивным свайпом</li>
                <li>Круговой прогресс выполнения упражнений</li>
                <li>GitHub-календарь активности на весь год</li>
                <li>Анимированная система серий с огнём</li>
                <li>Итоговая статистика с круговыми диаграммами</li>
                <li>Пересылка упражнений в AI-чат для вопросов</li>
                <li>Изменяемый размер панелей (drag-to-resize)</li>
                <li>Трёхпозиционный слайдер с навигацией</li>
                <li>Два чат-интерфейса (overlay и slider)</li>
                <li>Автосохранение прогресса после каждого действия</li>
                <li>Telegram Mini App с haptic feedback</li>
                <li>Адаптивный интерфейс для всех устройств</li>
                <li>Анимированные переходы между экранами</li>
                <li>Persistence в localStorage без сервера</li>
                <li>SVG-графика для визуализации прогресса</li>
                <li>Асинхронные API вызовы с OpenRouter</li>
                <li>Тач-события для мобильной навигации</li>
                <li>CSS transitions с GPU acceleration</li>
                <li>Debounced scroll handlers для производительности</li>
                <li>requestAnimationFrame для плавных анимаций</li>
            </ul>
        </div>
    </div>

    <!-- Email Modal (Purchase) -->
    <div class="email-modal" id="email-modal">
        <div class="email-modal-content">
            <div class="email-modal-header">
                <h3 class="email-modal-title">Оформление покупки</h3>
            </div>

            <div class="email-modal-body" id="email-modal-body-input">
                <p class="email-modal-description">Введите email для получения чека:</p>
                <input type="email" class="email-modal-input" id="email-modal-input" placeholder="example@mail.com" autocomplete="email">

                <!-- Логотип ЮКассы -->
                <div class="email-modal-yookassa-logo">
                    <img src="YUkassa-banner.jpg" alt="ЮКасса" class="yookassa-banner">
                </div>

                <!-- Текст соглашения с политикой конфиденциальности -->
                <div class="email-modal-agreement">
                    <p class="email-modal-agreement-text">Продолжая, вы соглашаетесь с <a href="https://telegra.ph/POLITIKA-KONFIDENCIALNOSTI-02-04-54" target="_blank" class="email-modal-privacy-link">политикой конфиденциальности</a></p>
                    <p class="email-modal-help-link"><a href="#" id="email-modal-help-link" class="email-modal-privacy-link">нужна помощь?</a></p>
                </div>

                <p class="email-modal-error" id="email-modal-error"></p>
                <div class="email-modal-buttons">
                    <button class="email-modal-btn email-modal-btn-cancel" id="email-modal-cancel">Отмена</button>
                    <button class="email-modal-btn email-modal-btn-confirm" id="email-modal-confirm">Перейти к оплате</button>
                </div>
            </div>

            <div class="email-modal-body email-modal-body-hidden" id="email-modal-body-loading">
                <div class="email-modal-loading">
                    <div class="email-modal-spinner"></div>
                    <p>Обработка покупки...</p>
                </div>
            </div>

            <div class="email-modal-body email-modal-body-hidden email-modal-body-payment" id="email-modal-body-payment">
                <div id="payment-form"></div>
            </div>

            <div class="email-modal-body email-modal-body-hidden" id="email-modal-body-success">
                <div class="email-modal-success">
                    <div class="email-modal-icon email-modal-icon-success">✓</div>
                    <h4>Покупка успешна!</h4>
                    <p>Спасибо за покупку!</p>
                    <p class="email-modal-email-display" id="email-modal-email-display"></p>
                </div>
                <div class="email-modal-buttons">
                    <button class="email-modal-btn email-modal-btn-close" id="email-modal-close-success">Закрыть</button>
                </div>
            </div>

            <div class="email-modal-body email-modal-body-hidden" id="email-modal-body-error">
                <div class="email-modal-error-content">
                    <div class="email-modal-icon email-modal-icon-error">✕</div>
                    <h4>Ошибка</h4>
                    <p id="email-modal-error-text"></p>
                </div>
                <div class="email-modal-buttons">
                    <button class="email-modal-btn email-modal-btn-retry" id="email-modal-retry">Попробовать снова</button>
                    <button class="email-modal-btn email-modal-btn-cancel" id="email-modal-cancel-error">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Верхняя панель с прогрессом (Dashboard Strip) -->
    <div class="workout-section">
        <div class="dashboard-strip" id="dashboard-strip">
            <!-- Дата и серия -->
            <div class="strip-main">
                <div class="strip-day-info">
                    <div class="strip-day" id="strip-day">Загрузка...</div>
                    <div class="strip-date" id="strip-date">День 1</div>
                </div>
                <div class="strip-streak">
                    <div class="streak-icon">🔥</div>
                    <div class="streak-count" id="streak-count">0 дней</div>
                </div>
            </div>

            <!-- Прогресс -->
            <div class="strip-progress">
                <div class="strip-progress-content">
                    <div class="strip-progress-label">Сегодня</div>
                    <div class="strip-progress-value" id="strip-progress-value">0%</div>
                    <div class="strip-progress-sub" id="strip-progress-sub">День 1 из 7</div>
                </div>
                <div class="strip-progress-chart">
                    <svg width="50" height="50" viewBox="0 0 36 36">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <path id="strip-progress-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#fff" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>

            <!-- AI Комментарий -->
            <div class="ai-comment" id="ai-comment">
                <div class="ai-comment-text" id="ai-comment-text">
                    <img src="https://img.icons8.com/?size=100&id=4KY3tfAid4dZ&format=png&color=000000" alt="ChatGPT" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                    <span id="ai-comment-span">Загрузка AI комментария...</span>
                </div>
            </div>

            <!-- Навигационные кнопки -->
            <div class="nav-buttons-container">
                <!-- Кнопка чата -->
                <button class="nav-button" id="nav-chat" data-slide="0" title="AI Чат">
                    <img src="https://img.icons8.com/?size=100&id=4KY3tfAid4dZ&format=png&color=000000" alt="ChatGPT" class="nav-icon-img">
                </button>

                <!-- Кнопка календаря активности -->
                <button class="nav-button active" id="nav-calendar" data-slide="1" title="Календарь активности">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="8" width="6" height="6" rx="1" class="activity-block-low"/>
                        <rect x="10" y="8" width="6" height="6" rx="1" class="activity-block-medium"/>
                        <rect x="18" y="8" width="6" height="6" rx="1" class="activity-block-high"/>
                        <rect x="2" y="16" width="6" height="6" rx="1" class="activity-block-high"/>
                        <rect x="10" y="16" width="6" height="6" rx="1" class="activity-block-low"/>
                        <rect x="18" y="16" width="6" height="6" rx="1" class="activity-block-medium"/>
                    </svg>
                </button>

                <!-- Кнопка задач -->
                <button class="nav-button" id="nav-tasks" data-slide="2" title="Задания">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <!-- Левый верхний куб - выполнен -->
                        <rect x="2" y="2" width="9" height="9" rx="2" class="task-cube-done"/>
                        <path d="M4.5 6.5L6.5 8.5L8.5 5.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- Правый верхний куб - выполнен -->
                        <rect x="13" y="2" width="9" height="9" rx="2" class="task-cube-done"/>
                        <path d="M15.5 6.5L17.5 8.5L19.5 5.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- Левый нижний куб - выполнен -->
                        <rect x="2" y="13" width="9" height="9" rx="2" class="task-cube-done"/>
                        <path d="M4.5 17.5L6.5 19.5L8.5 16.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- Правый нижний куб - не выполнен -->
                        <rect x="13" y="13" width="9" height="9" rx="2" class="task-cube-pending"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Overlay модальное окно для задач -->
        <div class="todo-overlay" id="todo-overlay">
            <div class="todo-modal">
                <div class="todo-modal-header">
                    <h1 class="todo-modal-title" id="todo-modal-title">День 1 - Задания</h1>
                    <button class="todo-modal-close" id="todo-modal-close">×</button>
                </div>
                <div class="todo-modal-content" id="todo-modal-content">
                    <!-- Задачи будут вставлены сюда -->
                </div>

                <!-- Карточка упражнения -->
                <div class="exercise-card" id="exercise-card">
                    <div class="exercise-card-header">
                        <h1 class="exercise-card-title" id="exercise-card-title">Задание - Упражнение 1/5</h1>
                        <span class="exercise-counter" id="exercise-counter">1/5</span>
                        <button class="exercise-card-close" id="exercise-card-close">×</button>
                    </div>
                    <div class="exercise-card-content">
                        <div class="exercise-text" id="exercise-text">
                            Текст упражнения...
                        </div>
                        <div class="exercise-video-button" id="exercise-video-button" style="display: none;">
                            <div class="video-button-content">
                                <svg class="video-play-icon" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" fill="currentColor"/>
                                    <polygon points="10,8 16,12 10,16" fill="white"/>
                                </svg>
                                <span class="video-button-text">Техника упражнения</span>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-card-footer">
                        <div class="exercise-dots" id="exercise-dots">
                            <!-- Точки будут добавлены динамически -->
                        </div>
                        <div class="exercise-repost-btn" id="exercise-repost-btn" title="Переслать в AI">
                            <img src="https://img.icons8.com/?size=100&id=2Gttw0aekoFr&format=png&color=000000"
                                 class="repost-send-icon" alt="Send">
                            <img src="https://img.icons8.com/?size=100&id=4KY3tfAid4dZ&format=png&color=000000"
                                 class="repost-ai-icon" alt="AI">
                        </div>
                        <div class="exercise-check-btn" id="exercise-check-btn">
                            <svg class="exercise-check-svg" viewBox="0 0 36 36">
                                <defs>
                                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#00f5a0"/>
                                        <stop offset="100%" stop-color="#00d47a"/>
                                    </linearGradient>
                                </defs>
                                <circle class="exercise-check-bg" cx="18" cy="18" r="15"></circle>
                                <circle class="exercise-check-progress" cx="18" cy="18" r="15"
                                        stroke-dasharray="94.2" stroke-dashoffset="94.2"></circle>
                            </svg>
                            <span class="exercise-check-icon" id="exercise-check-icon">✓</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Видео-оверлей для техники упражнения -->
    <div class="exercise-video-overlay" id="exercise-video-overlay">
        <div class="exercise-video-container" id="exercise-video-container">
            <video class="exercise-video-player" id="exercise-video-player" playsinline loop autoplay muted>
                <source src="отжимание.mp4" type="video/mp4">
                Ваш браузер не поддерживает видео.
            </video>
        </div>
    </div>

    <!-- Горизонтальная линия-разделитель с кнопкой -->
    <div class="divider">
        <div class="divider-button"></div>
    </div>

    <!-- Нижняя секция с активностью -->
    <div class="activity-section">
        <!-- Вертикальный календарь активности -->
        <div class="activity-grid-vertical">
            <div class="activity-slider">
                <!-- AI Чат слева -->
                <div class="calendar-container chat-calendar">
                    <div class="calendar-wrapper chat-wrapper">
                        <!-- Toast "Новый чат" -->
                        <div class="new-chat-toast" id="new-chat-toast">
                            <svg class="new-chat-timer-svg" id="new-chat-timer-svg">
                                <rect class="new-chat-timer-rect" id="new-chat-timer-rect" x="0" y="0" width="100%" height="100%" rx="14" ry="14"/>
                            </svg>
                            <span class="new-chat-toast-text">Начать новый чат?</span>
                            <button class="new-chat-toast-btn" id="new-chat-toast-btn">✓</button>
                        </div>

                        <div class="chat-messages" id="slider-chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input-area">
                            <div class="chat-repost-indicator" id="chat-repost-indicator" style="display: none;">
                                <button class="repost-close-btn" id="repost-close-btn" title="Удалить">×</button>
                                <img src="https://img.icons8.com/?size=100&id=4KY3tfAid4dZ&format=png&color=000000"
                                     class="repost-indicator-icon" alt="AI">
                                <span class="repost-indicator-text" id="repost-indicator-text"></span>
                            </div>
                            <div class="chat-input-row">
                                <input type="text" class="chat-input-neobrut" id="slider-chat-input" placeholder="Спроси меня что угодно...">
                                <button class="chat-send-neobrut" id="slider-chat-send">
                                    <span>→</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Основной календарь -->
                <div class="calendar-container">
                    <div class="calendar-wrapper">
                        <div class="calendar-months" id="calendar-months">
                            <!-- Месяцы генерируются JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Секция заданий -->
                <div class="calendar-container tasks-calendar">
                    <div class="calendar-wrapper">
                        <div class="tasks-container" id="tasks-container">
                            <!-- Виджеты дней генерируются JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tooltip для активности -->
            <div class="tip" id="activity-tooltip"></div>


            <!-- Overlay модальное окно для AI чата -->
            <div class="ai-chat-overlay" id="ai-chat-overlay">
                <div class="ai-chat-modal">
                    <div class="ai-chat-header">
                        <h1 class="ai-chat-title">AI Ассистент</h1>
                        <div class="ai-chat-controls">
                            <button class="ai-chat-clear" id="ai-chat-clear" title="Очистить историю">🗑️</button>
                            <button class="ai-chat-close" id="ai-chat-close">×</button>
                        </div>
                    </div>
                    <div class="ai-chat-content">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Введите ваше сообщение...">
                            <button class="chat-send" id="chat-send">Отправить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>

    <script>
        // FitTracker AI v2.0 - 28-дневная программа
        console.log('🏋️ FitTracker AI v2.1 загружен (28 дней)');

        // === Supabase Edge Function for AI Chat ===
        const AI_CHAT_EDGE_FUNCTION_URL = 'https://venkgteszgtpjethpftj.supabase.co/functions/v1/Ai-chat';
        const AI_COMMENT_EDGE_FUNCTION_URL = 'https://venkgteszgtpjethpftj.supabase.co/functions/v1/ai-comment';

        // Supabase Anon Key (same as used in purchase.js and supabase.js)
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlbmtndGVzemd0cGpldGhwZnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNTczMDAsImV4cCI6MjA4NDgzMzMwMH0.vxPSCs5M7N7i0J0wGtH1eZqTDNEF3LonlZU3TFvSAwc';

        // Chat history constants
        const CHAT_HISTORY_KEY = 'fitTrackerChatHistory';
        const MAX_CHAT_HISTORY = 15;
        const USER_MESSAGES_FOR_NEW_CHAT = 10; // Показывать toast после каждого N-го сообщения пользователя
        const NEW_CHAT_TOAST_DURATION = 10000; // 10 секунд

        // Функция для экранирования HTML (защита от XSS)
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Инициализация приложения
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0 = Январь, 11 = Декабрь
        let activityData = {};
        let selectedWorkout = 1;
        let todoData = {}; // Хранение состояния todo-списков

        // Переменные слайдера
        let currentSlide = 1; // 0 = чат слева, 1 = календарь по центру, 2 = задания справа
        let calendarContainers = null; // Будет инициализирован в setupEventListeners

        // Переменные для карточки упражнения
        let currentTask = null; // Текущая задача с упражнениями
        let currentExerciseIndex = 0; // Индекс текущего упражнения
        let exerciseCardVisible = false; // Видна ли карточка упражнения
        let activeRepost = null; // Активный репост: { taskId, exerciseId, day, taskName, exerciseText }

        // Получить общее количество тренировочных дней (исключая пустые/итоговые)
        function getTotalWorkoutDays() {
            const days = Object.keys(todoData).map(Number).sort((a, b) => a - b);
            // Исключаем пустые дни (день итогов)
            const daysWithTasks = days.filter(day => {
                const tasks = todoData[day];
                return tasks && tasks.length > 0;
            });
            return daysWithTasks.length > 0 ? Math.max(...daysWithTasks) : 7;
        }

        // Инициализация todo-списков с упражнениями
        function initializeTodoLists() {
            todoData = {
                1: [
                    {
                        id: 'task-1',
                        text: 'Утренняя растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-1-1', text: 'Наклоны головы в стороны - 5 раз в каждую сторону', completed: false },
                            { id: 'ex-1-2', text: 'Круговые движения плечами - 10 раз вперёд, 10 назад', completed: false },
                            { id: 'ex-1-3', text: 'Наклоны туловища в стороны - 10 раз в каждую сторону', completed: false },
                            { id: 'ex-1-4', text: 'Растяжка задней поверхности бедра - 20 секунд на ногу', completed: false }
                        ]
                    },
                    {
                        id: 'task-2',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-2-1', text: 'Отжимания - 1 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-2-2', text: 'Отжимания - 2 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-2-3', text: 'Отжимания - 3 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-2-4', text: 'Отдых между подходами - 1 минута', isRest: true, completed: false },
                            { id: 'ex-2-5', text: 'Отжимания - 4 подход: макс. количество раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-3',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-3-1', text: 'Классические скручивания - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-3-2', text: 'Подъём ног лёжа - 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-3-3', text: 'Планка - 30 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-3-4', text: 'Боковая планка - 20 секунд каждую сторону', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-4',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-4-1', text: 'Приседания - 1 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-4-2', text: 'Приседания - 2 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-4-3', text: 'Отдых - 1 минута', isRest: true, completed: false },
                            { id: 'ex-4-4', text: 'Приседания - 3 подход: макс. количество раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-5',
                        text: 'Ходьба',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-5-1', text: 'Прогулка на свежем воздухе - 20 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-6',
                        text: 'Здоровый завтрак',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-6-1', text: 'Съесть белковый завтрак (яйца, творог или омлет)', completed: false },
                            { id: 'ex-6-2', text: 'Выпить стакан воды', completed: false },
                            { id: 'ex-6-3', text: 'Добавить овощи или фрукты', completed: false }
                        ]
                    }
                ],
                2: [
                    {
                        id: 'task-7',
                        text: 'Утренняя зарядка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-7-1', text: 'Разминка плеч - круговые движения 10 раз', completed: false },
                            { id: 'ex-7-2', text: 'Разминка ног - махи ногой 10 раз каждой', completed: false },
                            { id: 'ex-7-3', text: 'Разминка таза - вращения тазом 10 раз', completed: false },
                            { id: 'ex-7-4', text: 'Лёгкая растяжка всего тела - 1 минута', completed: false }
                        ]
                    },
                    {
                        id: 'task-8',
                        text: 'Тяга гантелей',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-8-1', text: 'Тяга гантелей в наклоне - 1 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-8-2', text: 'Тяга гантелей в наклоне - 2 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-8-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-8-4', text: 'Тяга гантелей в наклоне - 3 подход: 8 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-9',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-9-1', text: 'Скручивания с поворотом - 15 раз каждую сторону', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-9-2', text: 'Велосипед - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-9-3', text: 'Обратные скручивания - 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-9-4', text: 'Планка - 40 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-10',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-10-1', text: 'Выпады вперёд - 10 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-10-2', text: 'Выпады назад - 8 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-10-3', text: 'Отдых - 1 минута', isRest: true, completed: false },
                            { id: 'ex-10-4', text: 'Боковые выпады - 8 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-11',
                        text: 'Бег трусцой',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-11-1', text: 'Разминка перед бегом - 3 минуты', completed: false },
                            { id: 'ex-11-2', text: 'Бег - 15 минут в умеренном темпе', completed: false },
                            { id: 'ex-11-3', text: 'Заминка - ходьба 3 минуты', completed: false }
                        ]
                    },
                    {
                        id: 'task-12',
                        text: 'Растяжка после тренировки',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-12-1', text: 'Растяжка квадрицепса - 30 секунд каждая нога', completed: false },
                            { id: 'ex-12-2', text: 'Растяжка бицепса бедра - 30 секунд каждая нога', completed: false },
                            { id: 'ex-12-3', text: 'Растяжка икр - 20 секунд каждая нога', completed: false }
                        ]
                    }
                ],
                3: [
                    {
                        id: 'task-13',
                        text: 'Разогрев перед тренировкой',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-13-1', text: 'Лёгкий jog на месте - 2 минуты', completed: false },
                            { id: 'ex-13-2', text: 'Вращения руками - 15 раз вперёд, 15 назад', completed: false },
                            { id: 'ex-13-3', text: 'Махи ногами - 10 раз каждой ногой', completed: false },
                            { id: 'ex-13-4', text: 'Разогрев суставов - 1 минута', completed: false }
                        ]
                    },
                    {
                        id: 'task-14',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-14-1', text: 'Растяжка шеи - по 10 секунд в каждую сторону', completed: false },
                            { id: 'ex-14-2', text: 'Растяжка плеч - 20 секунд', completed: false },
                            { id: 'ex-14-3', text: 'Растяжка спины - поза кошка 30 секунд', completed: false },
                            { id: 'ex-14-4', text: 'Растяжка бёдер - бабочка 30 секунд', completed: false }
                        ]
                    },
                    {
                        id: 'task-15',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-15-1', text: 'Широкие отжимания - 1 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-15-2', text: 'Обычные отжимания - 2 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-15-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-15-4', text: 'Узкие отжимания - 3 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-15-5', text: 'Отжимания с хлопком - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-16',
                        text: 'Обратные отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-16-1', text: 'Обратные отжимания от стула - 1 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-16-2', text: 'Обратные отжимания от стула - 2 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-16-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-16-4', text: 'Обратные отжимания от пола - 3 подход: 8 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-17',
                        text: 'Пресс с весом',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-17-1', text: 'Скручивания с весом - 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-17-2', text: 'Русский твист с весом - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-17-3', text: 'Планка с весом - 45 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-17-4', text: 'Боковая планка с весом - 25 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-18',
                        text: 'Кардио финиши',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-18-1', text: 'Бёрпи - 3 подхода по 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-18-2', text: 'Отдых между подходами - 60 секунд', isRest: true, completed: false },
                            { id: 'ex-18-3', text: 'Скалолаз - 3 подхода по 20 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    }
                ],
                4: [
                    {
                        id: 'task-19',
                        text: 'Разогрев',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-19-1', text: 'Прыжки на месте - 1 минута', completed: false },
                            { id: 'ex-19-2', text: 'Вращения туловища - 20 раз', completed: false },
                            { id: 'ex-19-3', text: 'Махи ногами - 15 раз каждой ногой', completed: false }
                        ]
                    },
                    {
                        id: 'task-20',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-20-1', text: 'Классические приседания - 1 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-20-2', text: 'Приседания с широкой постановкой - 2 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-20-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-20-4', text: 'Приседания плие - 3 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-20-5', text: 'Приседания на одной ноге - 6 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-21',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-21-1', text: 'Классическая планка - 45 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-21-2', text: 'Боковая планка левая - 30 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-21-3', text: 'Боковая планка правая - 30 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-21-4', text: 'Планка с подъёмом ноги - 20 секунд каждая нога', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-22',
                        text: 'Выпады с весом',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-22-1', text: 'Выпады с гантелями - 10 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-22-2', text: 'Обратные выпады - 12 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-22-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-22-4', text: 'Болгарские выпады - 8 раз каждую ногу', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-23',
                        text: 'Ягодичные упражнения',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-23-1', text: 'Ягодичный мост - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-23-2', text: 'Ягодичный мост с одной ногой - 10 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-23-3', text: 'Махи ногой назад стоя - 15 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-24',
                        text: 'Растяжка ног',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-24-1', text: 'Растяжка квадрицепса - 30 секунд каждая нога', completed: false },
                            { id: 'ex-24-2', text: 'Растяжка приводящих мышц - 30 секунд', completed: false },
                            { id: 'ex-24-3', text: 'Растяжка икроножных мышц - 30 секунд', completed: false }
                        ]
                    }
                ],
                5: [
                    {
                        id: 'task-25',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-25-1', text: 'Прогулка на свежем воздухе - 30 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-26',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-26-1', text: 'Разминка - ходьба 5 минут', completed: false },
                            { id: 'ex-26-2', text: 'Бег в умеренном темпе - 20 минут', completed: false },
                            { id: 'ex-26-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-26-4', text: 'Интервальный бег - 5×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-26-5', text: 'Заминка - ходьба 5 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-27',
                        text: 'Гигиеничес процедуры',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-27-1', text: 'Контрастный душ - 3 цикла горячая/холодная вода', completed: false },
                            { id: 'ex-27-2', text: 'Чистка зубов и уход за полостью рта', completed: false },
                            { id: 'ex-27-3', text: 'Увлажнение кожи', completed: false }
                        ]
                    },
                    {
                        id: 'task-28',
                        text: 'Отжимания на время',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-28-1', text: 'Отжимания за 60 секунд - максимальное количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-28-2', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-28-3', text: 'Отжимания за 45 секунд - максимальное количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-28-4', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-28-5', text: 'Отжимания за 30 секунд - максимальное количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-29',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-29-1', text: 'Альпинист - 3 подхода по 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-29-2', text: 'Ножницы - 3 подхода по 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-29-3', text: 'Планка - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-30',
                        text: 'Растяжка и восстановление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-30-1', text: 'Полная растяжка тела - 5 минут', completed: false },
                            { id: 'ex-30-2', text: 'Дыхательные упражнения - 2 минуты', completed: false }
                        ]
                    }
                ],
                6: [
                    {
                        id: 'task-31',
                        text: 'Утренняя йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-31-1', text: 'Приветствие солнцу - 3 раунда', completed: false },
                            { id: 'ex-31-2', text: 'Поза собаки мордой вниз - 30 секунд', completed: false },
                            { id: 'ex-31-3', text: 'Поза warrior - 30 секунд каждая сторона', completed: false },
                            { id: 'ex-31-4', text: 'Поза треугольника - 30 секунд каждая сторона', completed: false },
                            { id: 'ex-31-5', text: 'Поза дерева - 20 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-32',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-32-1', text: 'Дыхание 4-7-8 - 5 минут', completed: false },
                            { id: 'ex-32-2', text: 'Сканирование тела - 5 минут', completed: false },
                            { id: 'ex-32-3', text: 'Созерцание - 5 минут тишины', completed: false }
                        ]
                    },
                    {
                        id: 'task-33',
                        text: 'Лёгкая тренировка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-33-1', text: 'Разогрев - 3 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-33-2', text: 'Отжимания - 2 подхода по 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-33-3', text: 'Приседания - 2 подхода по 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-33-4', text: 'Планка - 45 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-34',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-34-1', text: 'Прогулка в парке - 40 минут', completed: false },
                            { id: 'ex-34-2', text: 'Во время прогулки: делайте глубокие вдохи', completed: false }
                        ]
                    },
                    {
                        id: 'task-35',
                        text: 'Растяжка перед сном',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-35-1', text: 'Растяжка шеи и плеч - 2 минуты', completed: false },
                            { id: 'ex-35-2', text: 'Растяжка спины - поза ребёнка 1 минута', completed: false },
                            { id: 'ex-35-3', text: 'Растяжка ног - лёжа на спине 2 минуты', completed: false }
                        ]
                    }
                ],
                7: [
                    {
                        id: 'task-36',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-36-1', text: 'Лёгкая jog - 10 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-37',
                        text: 'Финальный тест',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-37-1', text: 'Отжимания - макс. количество за 2 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-37-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-37-3', text: 'Приседания - макс. количество за 2 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-37-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-37-5', text: 'Планка - максимальное время', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-38',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-38-1', text: 'Длительная прогулка - 45-60 минут', completed: false },
                            { id: 'ex-38-2', text: 'Наслаждайтесь природой, не спешите', completed: false }
                        ]
                    },
                    {
                        id: 'task-39',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-39-1', text: 'Почитайте книгу - 20 минут', completed: false },
                            { id: 'ex-39-2', text: 'Запишите главную мысль из прочитанного', completed: false }
                        ]
                    },
                    {
                        id: 'task-40',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-40-1', text: 'Подведите итоги недели', completed: false },
                            { id: 'ex-40-2', text: 'Запланируйте цели на следующую неделю', completed: false }
                        ]
                    },
                    {
                        id: 'task-41',
                        text: 'Растяжка и расслабление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-41-1', text: 'Полная растяжка всего тела - 10 минут', completed: false },
                            { id: 'ex-41-2', text: 'Медитация на благодарность - 5 минут', completed: false }
                        ]
                    }
                ],
                8: [
                    {
                        id: 'task-42',
                        text: 'Утренняя растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-42-1', text: 'Наклоны головы - 10 раз в каждую сторону', completed: false },
                            { id: 'ex-42-2', text: 'Круговые движения плечами - 15 раз вперёд, 15 назад', completed: false },
                            { id: 'ex-42-3', text: 'Растяжка грудных мышц - 30 секунд', completed: false },
                            { id: 'ex-42-4', text: 'Растяжка трицепса - 20 секунд каждая рука', completed: false }
                        ]
                    },
                    {
                        id: 'task-43',
                        text: 'Отжимания продвинутые',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-43-1', text: 'Алмазные отжимания - 1 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-43-2', text: 'Отжимания с широкой постановкой - 2 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-43-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-43-4', text: 'Отжимания с поднятами ногами - 3 подход: 8 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-43-5', text: 'Плиометрические отжимания - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-44',
                        text: 'Пресс интенсивный',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-44-1', text: 'Скручивания с ногами на весу - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-44-2', text: 'Подъём коленей к груди лёжа - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-44-3', text: 'Планка - 45 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-44-4', text: 'Боковая планка с подъёмом ноги - 25 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-45',
                        text: 'Приседания с весом',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-45-1', text: 'Приседания плие - 1 подход: 18 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-45-2', text: 'Приседания на одной ноге - 2 подход: 10 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-45-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-45-4', text: 'Прыжковые приседания - 3 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-46',
                        text: 'Кардио',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-46-1', text: 'Разогрев - ходьба 3 минуты', completed: false },
                            { id: 'ex-46-2', text: 'Бег в быстром темпе - 20 минут', completed: false },
                            { id: 'ex-46-3', text: 'Заминка - растяжка 5 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-47',
                        text: 'Растяжка и восстановление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-47-1', text: 'Растяжка всего тела - 10 минут', completed: false },
                            { id: 'ex-47-2', text: 'Дыхательные упражнения - 3 минуты', completed: false }
                        ]
                    }
                ],
                9: [
                    {
                        id: 'task-48',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-48-1', text: 'Прогулка на свежем воздухе - 25 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-49',
                        text: 'Тяга в наклоне',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-49-1', text: 'Тяга гантелей в наклоне - 1 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-49-2', text: 'Тяга гантелей в наклоне - 2 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-49-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-49-4', text: 'Тяга штанги в наклоне - 3 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-50',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-50-1', text: 'Русские скручивания - 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-50-2', text: 'Подъём ног лёжа - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-50-3', text: 'Планка - 50 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-50-4', text: 'Велосипед - 30 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-51',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-51-1', text: 'Выпады с гантелями - 12 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-51-2', text: 'Болгарские выпады - 10 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-51-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-51-4', text: 'Боковые выпады с прыжком - 8 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-52',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-52-1', text: 'Разминка - 5 минут', completed: false },
                            { id: 'ex-52-2', text: 'Интервальный бег - 10×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-52-3', text: 'Заминка - 5 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-53',
                        text: 'Фиксация прогресса',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-53-1', text: 'Запишите результаты тренировки', completed: false },
                            { id: 'ex-53-2', text: 'Сфотографируйте прогресс', completed: false },
                            { id: 'ex-53-3', text: 'Планирование на следующую неделю', completed: false }
                        ]
                    }
                ],
                10: [
                    {
                        id: 'task-54',
                        text: 'Разогрев',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-54-1', text: 'Прыжки на месте - 2 минуты', completed: false },
                            { id: 'ex-54-2', text: 'Вращения туловища - 25 раз', completed: false },
                            { id: 'ex-54-3', text: 'Махи ногами - 20 раз каждой ногой', completed: false }
                        ]
                    },
                    {
                        id: 'task-55',
                        text: 'Отжимания на время',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-55-1', text: 'Отжимания за 60 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-55-2', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-55-3', text: 'Отжимания за 45 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-55-4', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-55-5', text: 'Отжимания за 30 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-56',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-56-1', text: 'Альпинист - 4 подхода по 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-56-2', text: 'Ножницы - 4 подхода по 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-56-3', text: 'Планка - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-57',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-57-1', text: 'Классические приседания - 1 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-57-2', text: 'Приседания с широкой постановкой - 2 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-57-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-57-4', text: 'Приседания плие - 3 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-57-5', text: 'Прыжки из приседа - 15 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-58',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-58-1', text: 'Классическая планка - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-58-2', text: 'Боковая планка левая - 40 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-58-3', text: 'Боковая планка правая - 40 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-58-4', text: 'Планка с подъёмом руки и ноги - 30 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-59',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-59-1', text: 'Растяжка квадрицепса - 40 секунд каждая нога', completed: false },
                            { id: 'ex-59-2', text: 'Растяжка приводящих мышц - 40 секунд', completed: false },
                            { id: 'ex-59-3', text: 'Растяжка икроножных мышц - 40 секунд', completed: false }
                        ]
                    }
                ],
                11: [
                    {
                        id: 'task-60',
                        text: 'Йога на утро',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-60-1', text: 'Приветствие солнцу - 5 раундов', completed: false },
                            { id: 'ex-60-2', text: 'Поза собаки мордой вниз - 45 секунд', completed: false },
                            { id: 'ex-60-3', text: 'Поза warrior - 45 секунд каждая сторона', completed: false },
                            { id: 'ex-60-4', text: 'Поза треугольника - 45 секунд каждая сторона', completed: false },
                            { id: 'ex-60-5', text: 'Поза дерева - 30 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-61',
                        text: 'Жим лёжа',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-61-1', text: 'Отжимания - 1 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-61-2', text: 'Отжимания - 2 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-61-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-61-4', text: 'Алмазные отжимания - 3 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-62',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-62-1', text: 'Скручивания с поворотом - 20 раз каждую сторону', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-62-2', text: 'Велосипед - 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-62-3', text: 'Обратные скручивания - 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-62-4', text: 'Планка - 55 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-63',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-63-1', text: 'Выпады вперёд - 12 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-63-2', text: 'Обратные выпады - 10 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-63-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-63-4', text: 'Боковые выпады - 10 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-64',
                        text: 'Беговая тренировка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-64-1', text: 'Разминка - ходьба 5 минут', completed: false },
                            { id: 'ex-64-2', text: 'Бег в умеренном темпе - 25 минут', completed: false },
                            { id: 'ex-64-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-64-4', text: 'Интервальный бег - 6×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-64-5', text: 'Заминка - ходьба 5 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-65',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-65-1', text: 'Растяжка ног - 5 минут', completed: false },
                            { id: 'ex-65-2', text: 'Растяжка спины - 3 минуты', completed: false }
                        ]
                    }
                ],
                12: [
                    {
                        id: 'task-66',
                        text: 'Утренняя йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-66-1', text: 'Приветствие солнцу - 4 раунда', completed: false },
                            { id: 'ex-66-2', text: 'Поза собаки мордой вниз - 35 секунд', completed: false },
                            { id: 'ex-66-3', text: 'Поза warrior - 35 секунд каждая сторона', completed: false },
                            { id: 'ex-66-4', text: 'Поза треугольника - 35 секунд каждая сторона', completed: false },
                            { id: 'ex-66-5', text: 'Поза дерева - 25 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-67',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-67-1', text: 'Дыхание 4-7-8 - 7 минут', completed: false },
                            { id: 'ex-67-2', text: 'Сканирование тела - 7 минут', completed: false },
                            { id: 'ex-67-3', text: 'Созерцание - 7 минут тишины', completed: false }
                        ]
                    },
                    {
                        id: 'task-68',
                        text: 'Силовая тренировка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-68-1', text: 'Разогрев - 4 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-68-2', text: 'Отжимания - 3 подхода по 18 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-68-3', text: 'Приседания - 3 подхода по 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-68-4', text: 'Планка - 50 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-69',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-69-1', text: 'Прогулка в парке - 45 минут', completed: false },
                            { id: 'ex-69-2', text: 'Во время прогулки: глубокие вдохи', completed: false }
                        ]
                    },
                    {
                        id: 'task-70',
                        text: 'Растяжка перед сном',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-70-1', text: 'Растяжка шеи и плеч - 3 минуты', completed: false },
                            { id: 'ex-70-2', text: 'Растяжка спины - поза ребёнка 90 секунд', completed: false },
                            { id: 'ex-70-3', text: 'Растяжка ног - лёжа на спине 3 минуты', completed: false }
                        ]
                    }
                ],
                13: [
                    {
                        id: 'task-71',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-71-1', text: 'Лёгкий jog - 12 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-72',
                        text: 'Финальный тест',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-72-1', text: 'Отжимания - макс. количество за 2 минут', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-72-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-72-3', text: 'Приседания - макс. количество за 2 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-72-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-72-5', text: 'Планка - максимальное время', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-73',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-73-1', text: 'Длительная прогулка - 50 минут', completed: false },
                            { id: 'ex-73-2', text: 'Наслаждайтесь природой', completed: false }
                        ]
                    },
                    {
                        id: 'task-74',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-74-1', text: 'Почитайте книгу - 25 минут', completed: false },
                            { id: 'ex-74-2', text: 'Запишите главную мысль', completed: false }
                        ]
                    },
                    {
                        id: 'task-75',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-75-1', text: 'Проанализируйте прогресс за 2 недели', completed: false },
                            { id: 'ex-75-2', text: 'Запланируйте цели на следующий период', completed: false }
                        ]
                    },
                    {
                        id: 'task-76',
                        text: 'Растяжка и расслабление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-76-1', text: 'Полная растяжка всего тела - 12 минут', completed: false },
                            { id: 'ex-76-2', text: 'Медитация на благодарность - 7 минут', completed: false }
                        ]
                    }
                ],
                14: [
                    {
                        id: 'task-77',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-77-1', text: 'Лёгкая jog - 15 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-78',
                        text: 'Финальный челлендж',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-78-1', text: 'Отжимания - макс. количество за 2.5 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-78-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-78-3', text: 'Приседания - макс. количество за 2.5 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-78-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-78-5', text: 'Планка - максимальное время + 10 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-79',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-79-1', text: 'Длительная прогулка - 60 минут', completed: false },
                            { id: 'ex-79-2', text: 'Сфотографируйте красивые места', completed: false }
                        ]
                    },
                    {
                        id: 'task-80',
                        text: 'Рефлексия',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-80-1', text: 'Запишите достижения за 2 недели', completed: false },
                            { id: 'ex-80-2', text: 'Что бы улучшить?', completed: false }
                        ]
                    },
                    {
                        id: 'task-81',
                        text: 'Планирование будущего',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-81-1', text: 'Подведите итоги 2-недельной программы', completed: false },
                            { id: 'ex-81-2', text: 'Запланируйте следующие шаги', completed: false }
                        ]
                    },
                    {
                        id: 'task-82',
                        text: 'Растяжка и расслабление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-82-1', text: 'Полная растяжка всего тела - 15 минут', completed: false },
                            { id: 'ex-82-2', text: 'Медитация на благодарность - 10 минут', completed: false }
                        ]
                    }
                ],
                15: [
                    {
                        id: 'task-83',
                        text: 'Утренняя растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-83-1', text: 'Наклоны головы - 12 раз в каждую сторону', completed: false },
                            { id: 'ex-83-2', text: 'Круговые движения плечами - 20 раз вперёд, 20 назад', completed: false },
                            { id: 'ex-83-3', text: 'Растяжка грудных мышц - 40 секунд', completed: false },
                            { id: 'ex-83-4', text: 'Растяжка бицепса - 30 секунд каждая рука', completed: false }
                        ]
                    },
                    {
                        id: 'task-84',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-84-1', text: 'Классические отжимания - 1 подход: 18 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-84-2', text: 'Широкие отжимания - 2 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-84-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-84-4', text: 'Алмазные отжимания - 3 подход: 10 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-84-5', text: 'Отжимания с хлопком - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-85',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-85-1', text: 'Скручивания с ногами на весу - 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-85-2', text: 'Русский твист - 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-85-3', text: 'Планка - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-85-4', text: 'Боковая планка с подъёмом ноги - 30 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-86',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-86-1', text: 'Классические приседания - 1 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-86-2', text: 'Приседания плие - 2 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-86-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-86-4', text: 'Приседания на одной ноге - 3 подход: 12 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-87',
                        text: 'Кардио',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-87-1', text: 'Разогрев - ходьба 4 минуты', completed: false },
                            { id: 'ex-87-2', text: 'Бег в быстром темпе - 25 минут', completed: false },
                            { id: 'ex-87-3', text: 'Заминка - растяжка 6 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-88',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-88-1', text: 'Растяжка всего тела - 12 минут', completed: false },
                            { id: 'ex-88-2', text: 'Дыхательные упражнения - 4 минуты', completed: false }
                        ]
                    }
                ],
                16: [
                    {
                        id: 'task-89',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-89-1', text: 'Прогулка на свежем воздухе - 30 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-90',
                        text: 'Тяга',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-90-1', text: 'Тяга гантелей в наклоне - 1 подход: 18 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-90-2', text: 'Тяга гантелей в наклоне - 2 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-90-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-90-4', text: 'Тяга штанги в наклоне - 3 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-91',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-91-1', text: 'Альпинист - 5 подходов по 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-91-2', text: 'Ножницы - 5 подходов по 35 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-91-3', text: 'Планка - 70 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-92',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-92-1', text: 'Выпады с гантелями - 15 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-92-2', text: 'Болгарские выпады - 12 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-92-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-92-4', text: 'Боковые выпады с прыжком - 10 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-93',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-93-1', text: 'Разминка - 6 минут', completed: false },
                            { id: 'ex-93-2', text: 'Интервальный бег - 12×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-93-3', text: 'Заминка - 6 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-94',
                        text: 'Фиксация прогресса',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-94-1', text: 'Запишите результаты тренировки', completed: false },
                            { id: 'ex-94-2', text: 'Сфотографируйте прогресс', completed: false },
                            { id: 'ex-94-3', text: 'Планирование на следующую неделю', completed: false }
                        ]
                    }
                ],
                17: [
                    {
                        id: 'task-95',
                        text: 'Разогрев',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-95-1', text: 'Прыжки на месте - 3 минуты', completed: false },
                            { id: 'ex-95-2', text: 'Вращения туловища - 30 раз', completed: false },
                            { id: 'ex-95-3', text: 'Махи ногами - 25 раз каждой ногой', completed: false }
                        ]
                    },
                    {
                        id: 'task-96',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-96-1', text: 'Отжимания за 60 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-96-2', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-96-3', text: 'Отжимания за 45 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-96-4', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-96-5', text: 'Отжимания за 30 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-97',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-97-1', text: 'Альпинист - 5 подходов по 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-97-2', text: 'Ножницы - 5 подходов по 35 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-97-3', text: 'Планка - 75 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-98',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-98-1', text: 'Классические приседания - 1 подход: 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-98-2', text: 'Приседания с широкой постановкой - 2 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-98-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-98-4', text: 'Приседания плие - 3 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-98-5', text: 'Прыжки из приседа - 20 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-99',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-99-1', text: 'Классическая планка - 75 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-99-2', text: 'Боковая планка левая - 50 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-99-3', text: 'Боковая планка правая - 50 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-99-4', text: 'Планка с подъёмом руки и ноги - 40 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-100',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-100-1', text: 'Растяжка квадрицепса - 50 секунд каждая нога', completed: false },
                            { id: 'ex-100-2', text: 'Растяжка приводящих мышц - 50 секунд', completed: false },
                            { id: 'ex-100-3', text: 'Растяжка икроножных мышц - 50 секунд', completed: false }
                        ]
                    }
                ],
                18: [
                    {
                        id: 'task-101',
                        text: 'Йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-101-1', text: 'Приветствие солнцу - 6 раундов', completed: false },
                            { id: 'ex-101-2', text: 'Поза собаки мордой вниз - 60 секунд', completed: false },
                            { id: 'ex-101-3', text: 'Поза warrior - 60 секунд каждая сторона', completed: false },
                            { id: 'ex-101-4', text: 'Поза треугольника - 60 секунд каждая сторона', completed: false },
                            { id: 'ex-101-5', text: 'Поза дерева - 40 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-102',
                        text: 'Жим',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-102-1', text: 'Отжимания - 1 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-102-2', text: 'Отжимания - 2 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-102-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-102-4', text: 'Алмазные отжимания - 3 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-103',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-103-1', text: 'Скручивания с поворотом - 25 раз каждую сторону', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-103-2', text: 'Велосипед - 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-103-3', text: 'Обратные скручивания - 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-103-4', text: 'Планка - 70 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-104',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-104-1', text: 'Выпады вперёд - 15 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-104-2', text: 'Обратные выпады - 12 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-104-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-104-4', text: 'Боковые выпады - 12 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-105',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-105-1', text: 'Разминка - ходьба 6 минут', completed: false },
                            { id: 'ex-105-2', text: 'Бег в умеренном темпе - 30 минут', completed: false },
                            { id: 'ex-105-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-105-4', text: 'Интервальный бег - 8×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-105-5', text: 'Заминка - ходьба 6 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-106',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-106-1', text: 'Растяжка ног - 6 минут', completed: false },
                            { id: 'ex-106-2', text: 'Растяжка спины - 4 минуты', completed: false }
                        ]
                    }
                ],
                19: [
                    {
                        id: 'task-107',
                        text: 'Утренняя йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-107-1', text: 'Приветствие солнцу - 5 раундов', completed: false },
                            { id: 'ex-107-2', text: 'Поза собаки мордой вниз - 40 секунд', completed: false },
                            { id: 'ex-107-3', text: 'Поза warrior - 40 секунд каждая сторона', completed: false },
                            { id: 'ex-107-4', text: 'Поза треугольника - 40 секунд каждая сторона', completed: false },
                            { id: 'ex-107-5', text: 'Поза дерева - 30 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-108',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-108-1', text: 'Дыхание 4-7-8 - 10 минут', completed: false },
                            { id: 'ex-108-2', text: 'Сканирование тела - 10 минут', completed: false },
                            { id: 'ex-108-3', text: 'Созерцание - 10 минут тишины', completed: false }
                        ]
                    },
                    {
                        id: 'task-109',
                        text: 'Силовая',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-109-1', text: 'Разогрев - 5 минут', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-109-2', text: 'Отжимания - 4 подхода по 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-109-3', text: 'Приседания - 4 подхода по 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-109-4', text: 'Планка - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-110',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-110-1', text: 'Прогулка в парке - 50 минут', completed: false },
                            { id: 'ex-110-2', text: 'Во время прогулки: глубокие вдохи', completed: false }
                        ]
                    },
                    {
                        id: 'task-111',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-111-1', text: 'Растяжка шеи и плеч - 4 минуты', completed: false },
                            { id: 'ex-111-2', text: 'Растяжка спины - поза ребёнка 2 минуты', completed: false },
                            { id: 'ex-111-3', text: 'Растяжка ног - лёжа на спине 4 минуты', completed: false }
                        ]
                    }
                ],
                20: [
                    {
                        id: 'task-112',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-112-1', text: 'Лёгкий jog - 15 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-113',
                        text: 'Финальный',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-113-1', text: 'Отжимания - макс. количество за 2.5 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-113-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-113-3', text: 'Приседания - макс. количество за 2.5 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-113-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-113-5', text: 'Планка - максимальное время', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-114',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-114-1', text: 'Длительная прогулка - 55 минут', completed: false },
                            { id: 'ex-114-2', text: 'Наслаждайтесь природой', completed: false }
                        ]
                    },
                    {
                        id: 'task-115',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-115-1', text: 'Почитайте книгу - 30 минут', completed: false },
                            { id: 'ex-115-2', text: 'Запишите главную мысль', completed: false }
                        ]
                    },
                    {
                        id: 'task-116',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-116-1', text: 'Проанализируйте прогресс за 3 недели', completed: false },
                            { id: 'ex-116-2', text: 'Запланируйте цели на следующий период', completed: false }
                        ]
                    },
                    {
                        id: 'task-117',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-117-1', text: 'Полная растяжка всего тела - 15 минут', completed: false },
                            { id: 'ex-117-2', text: 'Медитация на благодарность - 10 минут', completed: false }
                        ]
                    }
                ],
                21: [
                    {
                        id: 'task-118',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-118-1', text: 'Лёгкая jog - 18 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-119',
                        text: 'Финальный челлендж',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-119-1', text: 'Отжимания - макс. количество за 3 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-119-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-119-3', text: 'Приседания - макс. количество за 3 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-119-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-119-5', text: 'Планка - максимальное время + 15 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-120',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-120-1', text: 'Длительная прогулка - 65 минут', completed: false },
                            { id: 'ex-120-2', text: 'Сфотографируйте красивые места', completed: false }
                        ]
                    },
                    {
                        id: 'task-121',
                        text: 'Рефлексия',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-121-1', text: 'Запишите достижения за 3 недели', completed: false },
                            { id: 'ex-121-2', text: 'Что бы улучшить?', completed: false }
                        ]
                    },
                    {
                        id: 'task-122',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-122-1', text: 'Подведите итоги 3-недельной программы', completed: false },
                            { id: 'ex-122-2', text: 'Запланируйте следующие шаги', completed: false }
                        ]
                    },
                    {
                        id: 'task-123',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-123-1', text: 'Полная растяжка всего тела - 18 минут', completed: false },
                            { id: 'ex-123-2', text: 'Медитация на благодарность - 12 минут', completed: false }
                        ]
                    }
                ],
                22: [
                    {
                        id: 'task-124',
                        text: 'Утренняя растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-124-1', text: 'Наклоны головы - 15 раз в каждую сторону', completed: false },
                            { id: 'ex-124-2', text: 'Круговые движения плечами - 25 раз вперёд, 25 назад', completed: false },
                            { id: 'ex-124-3', text: 'Растяжка грудных мышц - 50 секунд', completed: false },
                            { id: 'ex-124-4', text: 'Растяжка трицепса - 40 секунд каждая рука', completed: false }
                        ]
                    },
                    {
                        id: 'task-125',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-125-1', text: 'Алмазные отжимания - 1 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-125-2', text: 'Отжимания с широкой постановкой - 2 подход: 18 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-125-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-125-4', text: 'Отжимания с поднятами ногами - 3 подход: 12 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-125-5', text: 'Плиометрические отжимания - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-126',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-126-1', text: 'Скручивания с ногами на весу - 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-126-2', text: 'Подъём коленей к груди лёжа - 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-126-3', text: 'Планка - 80 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-126-4', text: 'Боковая планка с подъёмом ноги - 35 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-127',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-127-1', text: 'Приседания плие - 1 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-127-2', text: 'Приседания на одной ноге - 2 подход: 15 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-127-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-127-4', text: 'Прыжковые приседания - 3 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-128',
                        text: 'Кардио',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-128-1', text: 'Разогрев - ходьба 5 минут', completed: false },
                            { id: 'ex-128-2', text: 'Бег в быстром темпе - 30 минут', completed: false },
                            { id: 'ex-128-3', text: 'Заминка - растяжка 7 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-129',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-129-1', text: 'Растяжка всего тела - 15 минут', completed: false },
                            { id: 'ex-129-2', text: 'Дыхательные упражнения - 5 минут', completed: false }
                        ]
                    }
                ],
                23: [
                    {
                        id: 'task-130',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-130-1', text: 'Прогулка на свежем воздухе - 35 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-131',
                        text: 'Тяга',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-131-1', text: 'Тяга гантелей в наклоне - 1 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-131-2', text: 'Тяга гантелей в наклоне - 2 подход: 18 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-131-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-131-4', text: 'Тяга штанги в наклоне - 3 подход: 15 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-132',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-132-1', text: 'Альпинист - 6 подходов по 35 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-132-2', text: 'Ножницы - 6 подходов по 40 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-132-3', text: 'Планка - 90 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-133',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-133-1', text: 'Выпады с гантелями - 18 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-133-2', text: 'Болгарские выпады - 15 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-133-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-133-4', text: 'Боковые выпады с прыжком - 12 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-134',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-134-1', text: 'Разминка - 7 минут', completed: false },
                            { id: 'ex-134-2', text: 'Интервальный бег - 15×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-134-3', text: 'Заминка - 7 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-135',
                        text: 'Фиксация прогресса',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-135-1', text: 'Запишите результаты тренировки', completed: false },
                            { id: 'ex-135-2', text: 'Сфотографируйте прогресс', completed: false },
                            { id: 'ex-135-3', text: 'Планирование на финальную неделю', completed: false }
                        ]
                    }
                ],
                24: [
                    {
                        id: 'task-136',
                        text: 'Разогрев',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-136-1', text: 'Прыжки на месте - 4 минуты', completed: false },
                            { id: 'ex-136-2', text: 'Вращения туловища - 35 раз', completed: false },
                            { id: 'ex-136-3', text: 'Махи ногами - 30 раз каждой ногой', completed: false }
                        ]
                    },
                    {
                        id: 'task-137',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-137-1', text: 'Отжимания за 90 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-137-2', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-137-3', text: 'Отжимания за 60 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-137-4', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-137-5', text: 'Отжимания за 45 секунд - макс. количество', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-138',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-138-1', text: 'Альпинист - 6 подходов по 40 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-138-2', text: 'Ножницы - 6 подходов по 45 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-138-3', text: 'Планка - 100 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-139',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-139-1', text: 'Классические приседания - 1 подход: 35 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-139-2', text: 'Приседания с широкой постановкой - 2 подход: 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-139-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-139-4', text: 'Приседания плие - 3 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-139-5', text: 'Прыжки из приседа - 25 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-140',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-140-1', text: 'Классическая планка - 100 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-140-2', text: 'Боковая планка левая - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-140-3', text: 'Боковая планка правая - 60 секунд', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-140-4', text: 'Планка с подъёмом руки и ноги - 50 секунд каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-141',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-141-1', text: 'Растяжка квадрицепса - 60 секунд каждая нога', completed: false },
                            { id: 'ex-141-2', text: 'Растяжка приводящих мышц - 60 секунд', completed: false },
                            { id: 'ex-141-3', text: 'Растяжка икроножных мышц - 60 секунд', completed: false }
                        ]
                    }
                ],
                25: [
                    {
                        id: 'task-142',
                        text: 'Йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-142-1', text: 'Приветствие солнцу - 7 раундов', completed: false },
                            { id: 'ex-142-2', text: 'Поза собаки мордой вниз - 75 секунд', completed: false },
                            { id: 'ex-142-3', text: 'Поза warrior - 75 секунд каждая сторона', completed: false },
                            { id: 'ex-142-4', text: 'Поза треугольника - 75 секунд каждая сторона', completed: false },
                            { id: 'ex-142-5', text: 'Поза дерева - 50 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-143',
                        text: 'Жим',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-143-1', text: 'Отжимания - 1 подход: 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-143-2', text: 'Отжимания - 2 подход: 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-143-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-143-4', text: 'Алмазные отжимания - 3 подход: 20 раз', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-144',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-144-1', text: 'Скручивания с поворотом - 30 раз каждую сторону', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-144-2', text: 'Велосипед - 35 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-144-3', text: 'Обратные скручивания - 30 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-144-4', text: 'Планка - 90 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-145',
                        text: 'Выпadas',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-145-1', text: 'Выпады вперёд - 18 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-145-2', text: 'Обратные выпады - 15 раз каждая нога', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-145-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-145-4', text: 'Боковые выпады - 15 раз каждая сторона', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-146',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-146-1', text: 'Разминка - ходьба 7 минут', completed: false },
                            { id: 'ex-146-2', text: 'Бег в умеренном темпе - 35 минут', completed: false },
                            { id: 'ex-146-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-146-4', text: 'Интервальный бег - 10×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-146-5', text: 'Заминка - ходьба 7 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-147',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-147-1', text: 'Растяжка ног - 8 минут', completed: false },
                            { id: 'ex-147-2', text: 'Растяжка спины - 5 минут', completed: false }
                        ]
                    }
                ],
                26: [
                    {
                        id: 'task-148',
                        text: 'Утренняя йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-148-1', text: 'Приветствие солнцу - 6 раундов', completed: false },
                            { id: 'ex-148-2', text: 'Поза собаки мордой вниз - 50 секунд', completed: false },
                            { id: 'ex-148-3', text: 'Поза warrior - 50 секунд каждая сторона', completed: false },
                            { id: 'ex-148-4', text: 'Поза треугольника - 50 секунд каждая сторона', completed: false },
                            { id: 'ex-148-5', text: 'Поза дерева - 40 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-149',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-149-1', text: 'Дыхание 4-7-8 - 12 минут', completed: false },
                            { id: 'ex-149-2', text: 'Сканирование тела - 12 минут', completed: false },
                            { id: 'ex-149-3', text: 'Созерцание - 12 минут тишины', completed: false }
                        ]
                    },
                    {
                        id: 'task-150',
                        text: 'Силовая',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-150-1', text: 'Разогрев - 6 минут', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-150-2', text: 'Отжимания - 5 подходов по 25 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-150-3', text: 'Приседания - 5 подходов по 35 раз', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-150-4', text: 'Планка - 75 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-151',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-151-1', text: 'Прогулка в парке - 60 минут', completed: false },
                            { id: 'ex-151-2', text: 'Во время прогулки: глубокие вдохи', completed: false }
                        ]
                    },
                    {
                        id: 'task-152',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-152-1', text: 'Растяжка шеи и плеч - 5 минут', completed: false },
                            { id: 'ex-152-2', text: 'Растяжка спины - поза ребёнка 3 минуты', completed: false },
                            { id: 'ex-152-3', text: 'Растяжка ног - лёжа на спине 5 минут', completed: false }
                        ]
                    }
                ],
                27: [
                    {
                        id: 'task-153',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-153-1', text: 'Лёгкий jog - 20 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-154',
                        text: 'Финальный',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-154-1', text: 'Отжимания - макс. количество за 3 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-154-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-154-3', text: 'Приседания - макс. количество за 3 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-154-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-154-5', text: 'Планка - максимальное время + 20 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-155',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-155-1', text: 'Длительная прогулка - 70 минут', completed: false },
                            { id: 'ex-155-2', text: 'Наслаждайтесь природой', completed: false }
                        ]
                    },
                    {
                        id: 'task-156',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-156-1', text: 'Почитайте книгу - 35 минут', completed: false },
                            { id: 'ex-156-2', text: 'Запишите главную мысль', completed: false }
                        ]
                    },
                    {
                        id: 'task-157',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-157-1', text: 'Проанализируйте прогресс за 4 недели', completed: false },
                            { id: 'ex-157-2', text: 'Запланируйте финальный рывок', completed: false }
                        ]
                    },
                    {
                        id: 'task-158',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-158-1', text: 'Полная растяжка всего тела - 20 минут', completed: false },
                            { id: 'ex-158-2', text: 'Медитация на благодарность - 15 минут', completed: false }
                        ]
                    }
                ],
                28: [
                    {
                        id: 'task-159',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-159-1', text: 'Лёгкая jog - 25 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-160',
                        text: 'Финальный челлендж',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-160-1', text: 'Отжимания - макс. количество за 4 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-160-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-160-3', text: 'Приседания - макс. количество за 4 минуты', completed: false, videoUrl: 'отжимание.mp4' },
                            { id: 'ex-160-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-160-5', text: 'Планка - максимальное время + 30 секунд', completed: false, videoUrl: 'отжимание.mp4' }
                        ]
                    },
                    {
                        id: 'task-161',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-161-1', text: 'Длительная прогулка - 90 минут', completed: false },
                            { id: 'ex-161-2', text: 'Сфотографируйте красивые места', completed: false }
                        ]
                    },
                    {
                        id: 'task-162',
                        text: 'Рефлексия',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-162-1', text: 'Запишите достижения за 4 недели', completed: false },
                            { id: 'ex-162-2', text: 'Что бы улучшить в будущем?', completed: false }
                        ]
                    },
                    {
                        id: 'task-163',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-163-1', text: 'Подведите итоги 4-недельной программы', completed: false },
                            { id: 'ex-163-2', text: 'Запланируйте продолжение тренировок', completed: false }
                        ]
                    },
                    {
                        id: 'task-164',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-164-1', text: 'Полная растяжка всего тела - 25 минут', completed: false },
                            { id: 'ex-164-2', text: 'Медитация на благодарность - 20 минут', completed: false }
                        ]
                    }
                ],
                29: []  // День итогов - пустой, специальная обработка
            };

            // Загружаем сохраненные состояния из localStorage
            loadTodoStates();
        }


        // Дополнительные метаданные приложения
        const METADATA_PREFIX = "NGZjODJkMmQ2NTM4MGM0MWZl";

        // Загрузка состояний todo из localStorage с упражнениями
        function loadTodoStates() {
            let saved = localStorage.getItem('fitTrackerTodos');

            // Авто-восстановление: если основные данные пусты, но есть бэкапы
            if (!saved || saved === '{}' || saved === '[]') {
                const backup = getLatestBackup();
                if (backup) {
                    console.log('Основные данные пусты, восстанавливаем из последнего бэкапа...');
                    restoreFromBackup(backup);
                    saved = backup; // Используем восстановленные данные
                }
            }

            if (saved) {
                try {
                    const states = JSON.parse(saved);
                    Object.keys(states).forEach(day => {
                        if (todoData[day]) {
                            todoData[day].forEach(task => {
                                const taskState = states[day] && states[day][task.id];
                                if (taskState) {
                                    task.completed = taskState.completed || false;
                                    task.completedAt = taskState.completedAt || null;
                                    // Загружаем состояние упражнений
                                    if (task.exercises && taskState.exercises) {
                                        task.exercises.forEach(ex => {
                                            const exState = taskState.exercises[ex.id];
                                            if (exState) {
                                                ex.completed = exState.completed || false;
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    });
                    console.log('Состояния todo и упражнений загружены из localStorage');
                } catch (e) {
                    console.error('Error loading todo states:', e);
                }
            }
        }

        // Сохранение состояний todo в localStorage с упражнениями
        function saveTodoStates() {
            const states = {};
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    states[day] = {};
                    todoData[day].forEach(task => {
                        const taskState = {
                            completed: task.completed || false,
                            completedAt: task.completedAt || null
                        };
                        // Сохраняем состояние упражнений
                        if (task.exercises) {
                            taskState.exercises = {};
                            task.exercises.forEach(ex => {
                                taskState.exercises[ex.id] = {
                                    completed: ex.completed || false
                                };
                            });
                        }
                        states[day][task.id] = taskState;
                    });
                }
            });
            localStorage.setItem('fitTrackerTodos', JSON.stringify(states));

            // Создаём автоматический бэкап
            createBackup();

            // Проверяем: если Day 28 только что завершён полностью - показываем праздник
            const day28Tasks = todoData[28] || [];
            const day28Complete = day28Tasks.length > 0 && day28Tasks.every(t => t.completed);
            const celebrationShown = localStorage.getItem('fitTrackerCelebrationShown');

            if (day28Complete && !celebrationShown) {
                // Небольшая задержка чтобы сохранить состояние первым
                setTimeout(() => {
                    showCompletionCelebration();
                }, 500);
            }
        }

        // ========== СИСТЕМА БЭКАПОВ ==========

        // Получить список всех бэкапов, отсортированных по дате (новые первыми)
        function getAllBackups() {
            const backups = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('fitTrackerBackup_')) {
                    const timestamp = key.replace('fitTrackerBackup_', '');
                    backups.push({ key, timestamp });
                }
            }
            return backups.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
        }

        // Получить последний бэкап
        function getLatestBackup() {
            const backups = getAllBackups();
            if (backups.length === 0) return null;
            const latestKey = backups[0].key;
            return localStorage.getItem(latestKey);
        }

        // Восстановить данные из бэкапа
        function restoreFromBackup(backupData) {
            if (!backupData) return false;

            try {
                localStorage.setItem('fitTrackerTodos', backupData);
                console.log('Данные восстановлены из бэкапа');
                return true;
            } catch (e) {
                console.error('Ошибка восстановления из бэкапа:', e);
                return false;
            }
        }

        // Удалить старые бэкапы, оставив только указанное количество
        function cleanupOldBackups(keepCount) {
            const backups = getAllBackups();

            if (backups.length <= keepCount) return;

            // Удаляем самые старые бэкапы
            backups
                .slice(keepCount)
                .forEach(backup => localStorage.removeItem(backup.key));

            console.log(`Удалено ${backups.length - keepCount} старых бэкапов`);
        }

        // Создать бэкап текущего состояния
        function createBackup() {
            const states = localStorage.getItem('fitTrackerTodos');
            if (!states) return;

            // Создаём ключ с временной меткой: YYYY-MM-DD_HH-MM
            const now = new Date();
            const timestamp = now.toISOString()
                .slice(0, 16)
                .replace('T', '_')
                .replace(':', '-');

            const backupKey = `fitTrackerBackup_${timestamp}`;
            localStorage.setItem(backupKey, states);

            // Храним только последние 10 бэкапов
            cleanupOldBackups(10);

            console.log(`Бэкап создан: ${backupKey}`);
        }

        // ========== КОНЕЦ СИСТЕМЫ БЭКАПОВ ==========

        // Проверка, все ли упражнения в задаче выполнены
        function areAllExercisesCompleted(task) {
            if (!task.exercises || task.exercises.length === 0) return true;
            // Учитываем только упражнения, которые не являются отдыхом (или все, если все отдых)
            const activeExercises = task.exercises.filter(ex => !ex.isRest);
            if (activeExercises.length === 0) return true; // Все упражнения - отдых
            return activeExercises.every(ex => ex.completed);
        }

        // Получить количество выполненных упражнений (без учёта отдыха)
        function getCompletedExerciseCount(task) {
            if (!task.exercises) return 0;
            return task.exercises.filter(ex => !ex.isRest && ex.completed).length;
        }

        // Получить общее количество упражнений (без учёта отдыха)
        function getTotalExerciseCount(task) {
            if (!task.exercises) return 0;
            return task.exercises.filter(ex => !ex.isRest).length;
        }

        // Создание HTML для todo-списка с новой логикой
        function createTodoHtml(todos, isLockedDay = false) {
            if (!todos || todos.length === 0) {
                return '<div class="no-tasks">Задания не найдены</div>';
            }

            let html = '<ul class="todo-list">';

            todos.forEach(task => {
                const taskCompletedClass = task.completed ? 'completed' : '';
                const allExercisesCompleted = areAllExercisesCompleted(task);
                const hasExercises = task.exercises && task.exercises.length > 0;

                // Если задача уже выполнена или все упражнения выполнены, показываем чекбокс
                // Иначе показываем только текст задачи
                let taskContent = '';

                if (task.completed || allExercisesCompleted || !hasExercises) {
                    // Показываем чекбокс (для заблокированных дней отключаем интерактивность)
                    taskContent = `
                        <div class="todo-checkbox ${isLockedDay ? 'disabled' : ''}">
                            <input type="checkbox"
                                   id="${task.id}"
                                   data-task-id="${task.id}"
                                   ${task.completed ? 'checked' : ''}
                                   ${isLockedDay ? 'disabled' : ''}
                                   onchange="toggleTask('${task.id}')">
                            <div class="checkbox-visual"></div>
                            <div class="checkbox-checkmark"></div>
                        </div>
                        <div class="todo-text-wrapper ${isLockedDay ? 'future-day' : ''}">
                            <div class="todo-text" ${!isLockedDay ? "onclick=\"toggleTask('" + task.id + "')\"" : ''}>
                                ${task.text}${task.completed && task.completedAt ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Показываем только текст без чекбокса (текст сдвинут влево)
                    // Для заблокированных дней убираем onclick для открытия упражнений
                    taskContent = `
                        <div class="todo-text-wrapper todo-text-shifted ${isLockedDay ? 'future-day' : ''}">
                            <div class="todo-text" ${!isLockedDay ? "onclick=\"openExerciseCard('" + task.id + "')\"" : ''}>
                                ${task.text}
                            </div>
                        </div>
                    `;
                }

                html += `
                    <li class="todo-item ${taskCompletedClass} ${isLockedDay ? 'future-day-item' : ''}">
                        ${taskContent}
                    </li>
                `;
            });

            html += '</ul>';
            return html;
        }

        // ===== ФУНКЦИИ КАРТОЧКИ УПРАЖНЕНИЯ =====

        // Найти задачу по ID во всех днях
        function findTaskById(taskId) {
            for (let day = 1; day <= 28; day++) {
                if (todoData[day]) {
                    const task = todoData[day].find(t => t.id === taskId);
                    if (task) return task;
                }
            }
            return null;
        }

        // Найти день (1-28) для задачи по ID
        function findDayForTask(taskId) {
            for (let day = 1; day <= 28; day++) {
                if (todoData[day]) {
                    const task = todoData[day].find(t => t.id === taskId);
                    if (task) return day;
                }
            }
            return null;
        }

        // Открыть карточку упражнения
        function openExerciseCard(taskId) {
            const task = findTaskById(taskId);
            if (!task || !task.exercises || task.exercises.length === 0) {
                console.error('Задача не найдена или не имеет упражнений');
                return;
            }

            currentTask = task;
            currentExerciseIndex = 0;
            exerciseCardVisible = true;

            renderExerciseCard();

            // Показать карточку с анимацией
            const exerciseCard = document.getElementById('exercise-card');
            exerciseCard.classList.add('show');
            exerciseCard.classList.remove('hide');

            // Настроить свайп навигацию
            setupExerciseCardSwipe();

            // Обновить состояние кнопки репоста
            updateRepostButton();
        }

        // Закрыть карточку упражнения
        function closeExerciseCard() {
            const exerciseCard = document.getElementById('exercise-card');
            exerciseCard.classList.remove('show');
            exerciseCard.classList.add('hide');

            setTimeout(() => {
                exerciseCardVisible = false;
                currentTask = null;
                currentExerciseIndex = 0;
            }, 250);

            // Перерендерить список задач чтобы обновить отображение
            setTimeout(() => {
                // Проверяем, что selectedWorkout валиден и существует в todoData
                if (!selectedWorkout || !todoData[selectedWorkout]) {
                    console.log('closeExerciseCard: selectedWorkout не валиден или отсутствует в todoData, пропускаем перерендер');
                    return;
                }

                // Проверяем, заблокирован ли день (не текущий)
                const currentWorkoutDay = getCurrentWorkoutDay();
                const isLockedDay = selectedWorkout !== currentWorkoutDay;
                const todoHtml = createTodoHtml(todoData[selectedWorkout], isLockedDay);
                document.getElementById('todo-modal-content').innerHTML = todoHtml;
            }, 300);
        }

        // Открыть видео с техникой упражнения
        function openExerciseVideo() {
            console.log('openExerciseVideo called', { currentTask, currentExerciseIndex });
            if (!currentTask || !currentTask.exercises || currentExerciseIndex < 0) {
                console.log('No currentTask or invalid exercise index');
                return;
            }

            const currentExercise = currentTask.exercises[currentExerciseIndex];
            if (!currentExercise || !currentExercise.videoUrl) {
                console.log('No currentExercise or no videoUrl');
                return;
            }

            const videoOverlay = document.getElementById('exercise-video-overlay');
            const videoPlayer = document.getElementById('exercise-video-player');

            console.log('Elements found:', { videoOverlay, videoPlayer, videoUrl: currentExercise.videoUrl });

            // Устанавливаем источник видео
            videoPlayer.src = currentExercise.videoUrl;
            videoPlayer.load();

            // Показываем оверлей
            videoOverlay.classList.add('show');

            // Запускаем воспроизведение с небольшой задержкой для плавности
            requestAnimationFrame(() => {
                videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
            });
        }

        // Закрыть видео с техникой упражнения
        function closeExerciseVideo() {
            const videoOverlay = document.getElementById('exercise-video-overlay');
            const videoPlayer = document.getElementById('exercise-video-player');

            // Останавливаем видео
            videoPlayer.pause();
            videoPlayer.currentTime = 0;

            // Скрываем оверлей
            videoOverlay.classList.remove('show');
        }

        // Отрендерить карточку упражнения
        function renderExerciseCard() {
            if (!currentTask) return;

            const exercise = currentTask.exercises[currentExerciseIndex];
            if (!exercise) return;

            // Заголовок: "Задание - Упражнение X/Y"
            const totalExercises = currentTask.exercises.length;
            document.getElementById('exercise-card-title').textContent =
                `${currentTask.text} - ${currentExerciseIndex + 1}/${totalExercises}`;
            document.getElementById('exercise-counter').textContent =
                `${currentExerciseIndex + 1}/${totalExercises}`;

            // Текст упражнения
            document.getElementById('exercise-text').textContent = exercise.text;

            // Показываем кнопку видео если у упражнения есть videoUrl
            const videoButton = document.getElementById('exercise-video-button');
            videoButton.style.display = exercise.videoUrl ? 'inline-flex' : 'none';

            // Обновить точки
            renderExerciseDots();

            // Обновить кнопку-галочку
            updateExerciseCheckButton();
        }

        // Отрендерить точки упражнений
        function renderExerciseDots() {
            const dotsContainer = document.getElementById('exercise-dots');
            dotsContainer.innerHTML = '';

            currentTask.exercises.forEach((ex, index) => {
                const dot = document.createElement('div');
                dot.className = 'exercise-dot';

                if (index === currentExerciseIndex) {
                    dot.classList.add('active');
                }

                if (ex.completed) {
                    dot.classList.add('completed');
                }

                dotsContainer.appendChild(dot);
            });
        }

        // Обновить кнопку-галочку
        function updateExerciseCheckButton() {
            const exercise = currentTask.exercises[currentExerciseIndex];
            const checkBtn = document.getElementById('exercise-check-btn');
            const checkIcon = document.getElementById('exercise-check-icon');
            const progressCircle = checkBtn.querySelector('.exercise-check-progress');

            const totalExercises = getTotalExerciseCount(currentTask);
            const completedCount = getCompletedExerciseCount(currentTask);

            // Вычислить процент прогресса
            const progress = totalExercises > 0 ? (completedCount / totalExercises) * 100 : 0;
            const circumference = 2 * Math.PI * 15; // r = 15
            const offset = circumference - (progress / 100) * circumference;

            progressCircle.style.strokeDashoffset = offset;

            if (exercise.completed) {
                checkBtn.classList.add('completed');
                checkIcon.textContent = '✓';
            } else {
                checkBtn.classList.remove('completed');
                checkIcon.textContent = '✓';
            }

            // Обновить состояние кнопки репоста
            updateRepostButton();
        }

        // Переключить статус выполнения упражнения
        function toggleExercise() {
            if (!currentTask) return;

            const exercise = currentTask.exercises[currentExerciseIndex];
            exercise.completed = !exercise.completed;

            // Установить дату начала программы при первом выполнении упражнения
            if (exercise.completed && !getStartDate()) {
                setStartDate(new Date());
                console.log('Установлена дата начала программы при первом выполнении упражнения');
                // Обновляем виджеты дней, чтобы выделить текущий день
                renderTaskDayWidgets();
            }

            // Сохранить прогресс
            saveTodoStates();

            // Обновить отображение
            updateExerciseCheckButton();
            renderExerciseDots();

            // Обновляем виджеты дней для показа прогресса
            renderTaskDayWidgets();

            // Если упражнение выполнено, перейти к следующему
            if (exercise.completed && !areAllExercisesCompleted(currentTask)) {
                setTimeout(() => {
                    nextExercise();
                }, 300);
            }

            // Если все упражнения выполнены, закрыть карточку
            if (areAllExercisesCompleted(currentTask)) {
                setTimeout(() => {
                    closeExerciseCard();
                }, 500);
            }
        }

        // ===== ФУНКЦИИ РЕПОСТА УПРАЖНЕНИЙ В AI =====

        // Переслать упражнение в AI
        function repostExercise() {
            if (!currentTask) return;
            const exercise = currentTask.exercises[currentExerciseIndex];
            if (!exercise) return;

            const day = findDayForTask(currentTask.id);
            if (!day) return;

            // Сохраняем информацию о репосте (только 1 активный)
            activeRepost = {
                taskId: currentTask.id,
                exerciseId: exercise.id,
                day: day,
                taskName: currentTask.text,
                exerciseText: exercise.text,
                exerciseIndex: currentExerciseIndex + 1,  // номер упражнения (1-based)
                totalExercises: currentTask.exercises.length  // общее количество
            };

            localStorage.setItem('fitTrackerActiveRepost', JSON.stringify(activeRepost));
            updateRepostIndicator();
            updateRepostButton();
            switchSlide(0);

            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        // Удалить активный репост
        function clearRepost() {
            activeRepost = null;
            localStorage.removeItem('fitTrackerActiveRepost');
            updateRepostIndicator();
            updateRepostButton();

            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
            }
        }

        // Обновить индикатор репоста в чате
        function updateRepostIndicator() {
            const indicator = document.getElementById('chat-repost-indicator');
            const text = document.getElementById('repost-indicator-text');

            if (!activeRepost) {
                indicator.style.display = 'none';
                return;
            }

            // Формат: "День 1 • Разминка • 1/3"
            const exerciseNumber = activeRepost.exerciseIndex || 1;
            const totalExercises = activeRepost.totalExercises || 1;
            text.textContent = `День ${activeRepost.day} • ${activeRepost.taskName} • ${exerciseNumber}/${totalExercises}`;
            indicator.style.display = 'flex';
        }

        // Обновить состояние кнопки репоста
        function updateRepostButton() {
            const repostBtn = document.getElementById('exercise-repost-btn');
            if (!repostBtn || !currentTask) return;

            const exercise = currentTask.exercises[currentExerciseIndex];
            const isCurrentReposted = activeRepost &&
                activeRepost.taskId === currentTask.id &&
                activeRepost.exerciseId === exercise.id;

            if (isCurrentReposted) {
                repostBtn.classList.add('disabled');
                repostBtn.title = 'Уже переслано';
            } else {
                repostBtn.classList.remove('disabled');
                repostBtn.title = 'Переслать в AI';
            }
        }

        // Загрузить сохраненный репост при старте
        function loadActiveRepost() {
            const saved = localStorage.getItem('fitTrackerActiveRepost');
            if (saved) {
                try {
                    activeRepost = JSON.parse(saved);
                    updateRepostIndicator();
                } catch (e) {
                    console.error('Error loading active repost:', e);
                    activeRepost = null;
                }
            }
        }

        // Перейти к следующему упражнению
        function nextExercise() {
            if (!currentTask) return;

            if (currentExerciseIndex < currentTask.exercises.length - 1) {
                currentExerciseIndex++;
                renderExerciseCard();
                updateRepostButton();
            }
        }

        // Перейти к предыдущему упражнению
        function prevExercise() {
            if (!currentTask) return;

            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
                renderExerciseCard();
                updateRepostButton();
            }
        }

        // Глобальные переменные для свайпа (объявлены один раз)
        let exerciseSwipeState = {
            startX: 0,
            currentX: 0,
            isDragging: false,
            hasSwiped: false // Флаг, чтобы предотвратить множественные свайпы за один жест
        };

        // Настроить свайп навигацию для карточки упражнения
        function setupExerciseCardSwipe() {
            const exerciseCard = document.getElementById('exercise-card');
            const SWIPE_THRESHOLD = 50;

            // Сброс состояния при открытии новой карточки
            exerciseSwipeState = {
                startX: 0,
                currentX: 0,
                isDragging: false,
                hasSwiped: false
            };

            const handleTouchStart = (e) => {
                // Игнорируем если кликнули на кнопки или интерактивные элементы
                if (e.target.closest('.exercise-card-close') || e.target.closest('.exercise-check-btn') || e.target.closest('.exercise-repost-btn')) {
                    return;
                }
                exerciseSwipeState.startX = e.touches[0].clientX;
                exerciseSwipeState.currentX = exerciseSwipeState.startX;
                exerciseSwipeState.isDragging = true;
                exerciseSwipeState.hasSwiped = false;
            };

            const handleTouchMove = (e) => {
                if (!exerciseSwipeState.isDragging) return;
                exerciseSwipeState.currentX = e.touches[0].clientX;
            };

            const handleTouchEnd = () => {
                if (!exerciseSwipeState.isDragging) return;

                const diff = exerciseSwipeState.currentX - exerciseSwipeState.startX;

                // Проверяем: порог пройден И ещё не было свайпа в этом жесте
                if (Math.abs(diff) > SWIPE_THRESHOLD && !exerciseSwipeState.hasSwiped) {
                    exerciseSwipeState.hasSwiped = true; // Блокируем повторные свайпы

                    if (diff < 0) {
                        nextExercise(); // Свайп влево - следующее
                    } else {
                        prevExercise(); // Свайп вправо - предыдущее
                    }
                }

                exerciseSwipeState.isDragging = false;
            };

            const handleMouseDown = (e) => {
                // Игнорируем если кликнули на кнопки или интерактивные элементы
                if (e.target.closest('.exercise-card-close') || e.target.closest('.exercise-check-btn') || e.target.closest('.exercise-repost-btn')) {
                    return;
                }
                exerciseSwipeState.startX = e.clientX;
                exerciseSwipeState.currentX = exerciseSwipeState.startX;
                exerciseSwipeState.isDragging = true;
                exerciseSwipeState.hasSwiped = false;
            };

            const handleMouseMove = (e) => {
                if (!exerciseSwipeState.isDragging) return;
                exerciseSwipeState.currentX = e.clientX;
            };

            const handleMouseUp = () => {
                if (!exerciseSwipeState.isDragging) return;

                const diff = exerciseSwipeState.currentX - exerciseSwipeState.startX;

                // Проверяем: порог пройден И ещё не было свайпа в этом жесте
                if (Math.abs(diff) > SWIPE_THRESHOLD && !exerciseSwipeState.hasSwiped) {
                    exerciseSwipeState.hasSwiped = true; // Блокируем повторные свайпы

                    if (diff < 0) {
                        nextExercise(); // Свайп влево - следующее
                    } else {
                        prevExercise(); // Свайп вправо - предыдущее
                    }
                }

                exerciseSwipeState.isDragging = false;
            };

            // Клонируем ноду чтобы удалить ВСЕ обработчики событий
            const newExerciseCard = exerciseCard.cloneNode(true);
            exerciseCard.parentNode.replaceChild(newExerciseCard, exerciseCard);

            // Получаем обновлённую ссылку
            const updatedExerciseCard = document.getElementById('exercise-card');

            // Добавляем обработчики свайпа на чистый элемент
            updatedExerciseCard.addEventListener('touchstart', handleTouchStart, { passive: true });
            updatedExerciseCard.addEventListener('touchmove', handleTouchMove, { passive: true });
            updatedExerciseCard.addEventListener('touchend', handleTouchEnd);
            updatedExerciseCard.addEventListener('mousedown', handleMouseDown);
            updatedExerciseCard.addEventListener('mousemove', handleMouseMove);
            updatedExerciseCard.addEventListener('mouseup', handleMouseUp);

            // Восстанавливаем обработчики кнопок после клонирования
            const exerciseCardClose = document.getElementById('exercise-card-close');
            const exerciseCheckBtn = document.getElementById('exercise-check-btn');
            const exerciseRepostBtn = document.getElementById('exercise-repost-btn');
            const exerciseVideoButton = document.getElementById('exercise-video-button');

            exerciseCardClose.addEventListener('click', closeExerciseCard);
            exerciseCheckBtn.addEventListener('click', toggleExercise);
            exerciseRepostBtn.addEventListener('click', repostExercise);
            exerciseVideoButton.addEventListener('click', openExerciseVideo);
        }

        // ===== КОНЕЦ ФУНКЦИЙ КАРТОЧКИ УПРАЖНЕНИЯ =====

        // ===== СИНХРОНИЗАЦИЯ ДАТ =====

        // Получить дату начала программы (когда выполнена первая задача)
        function getStartDate() {
            const saved = localStorage.getItem('fitTrackerStartDate');
            if (saved) {
                return new Date(saved);
            }
            return null;
        }

        // Установить дату начала программы
        function setStartDate(date) {
            localStorage.setItem('fitTrackerStartDate', date.toISOString());
            console.log('Установлена дата начала программы:', date.toLocaleDateString('ru-RU'));
        }

        // Получить название дня недели для тренировочного дня
        function getWorkoutDayName(workoutDay) {
            // Day 29 - это специальный день итогов
            if (workoutDay === 29) {
                return 'Итоги';
            }

            const startDate = getStartDate();
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];

            if (!startDate) {
                // Если дата начала не установлена, возвращаем просто "День X"
                return `День ${workoutDay}`;
            }

            // Вычисляем дату для этого тренировочного дня
            const dayOffset = workoutDay - 1;
            const workoutDate = new Date(startDate);
            workoutDate.setDate(startDate.getDate() + dayOffset);

            // Получаем день недели
            return dayNames[workoutDate.getDay()];
        }

        // Получить текущий день тренировки на основе календарной даты
        function getCurrentWorkoutDay() {
            const startDate = getStartDate();
            if (!startDate) {
                return 1; // По умолчанию День 1, если стартовая дата не установлена
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);

            // Вычисляем разницу в днях
            const diffTime = today - start;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // День тренировки = смещение + 1
            const workoutDay = diffDays + 1;

            // Минимум 1 день, без верхнего ограничения (для day 15+ и итогов)
            return Math.max(workoutDay, 1);
        }

        // Проверить доступен ли блок итогов
        function isSummaryAccessible() {
            const currentDay = getCurrentWorkoutDay();
            if (currentDay > getTotalWorkoutDays()) return true;

            const day28Tasks = todoData[28] || [];
            return day28Tasks.length > 0 && day28Tasks.every(t => t.completed);
        }

        // Получение даты для дня тренировки (на основе стартовой даты)
        function getWorkoutDate(workoutDay) {
            const startDate = getStartDate();

            if (!startDate) {
                // Если стартовая дата не установлена, используем старую логику
                const today = new Date();
                const dayOffset = workoutDay - 1;
                const workoutDate = new Date(today);
                workoutDate.setDate(today.getDate() + dayOffset);
                console.log(`День ${workoutDay} -> ${workoutDate.toLocaleDateString('ru-RU')} (смещение: ${dayOffset} дней)`);
                return workoutDate;
            }

            // Новая логика: День 1 = startDate, День 2 = startDate + 1 день, и т.д.
            const dayOffset = workoutDay - 1;
            const workoutDate = new Date(startDate);
            workoutDate.setDate(startDate.getDate() + dayOffset);

            console.log(`День ${workoutDay} -> ${workoutDate.toLocaleDateString('ru-RU')} (от ${startDate.toLocaleDateString('ru-RU')}, смещение: ${dayOffset} дней)`);

            return workoutDate;
        }

        // Проверка и запись активности на основе процентов выполнения
        function checkAndRecordActivity() {
            const currentWorkoutDay = getCurrentWorkoutDay();

            // Проверяем, есть ли todo для текущего дня тренировки
            if (todoData[currentWorkoutDay]) {
                // Получаем правильную дату для дня тренировки
                const workoutDate = getWorkoutDate(currentWorkoutDay);

                // Рассчитываем общий процент выполнения для текущего дня
                const percentage = calculateCompletionPercentage(currentWorkoutDay);
                console.log(`День ${currentWorkoutDay}: процент выполнения = ${percentage}%`);

                // Определяем уровень активности на основе процента
                let activityLevel = 'none';
                if (percentage >= 100) {
                    activityLevel = 'max';
                } else if (percentage >= 75) {
                    activityLevel = 'high';
                } else if (percentage >= 50) {
                    activityLevel = 'medium';
                } else if (percentage >= 25) {
                    activityLevel = 'low';
                }

                // Обновляем активность для правильной даты
                const dateKey = formatDateKey(workoutDate);
                const oldActivity = activityData[dateKey] || 'none';

                console.log(`Активность на ${workoutDate.toLocaleDateString('ru-RU')}: ${oldActivity} -> ${activityLevel}`);

                // Сохраняем текущую серию ДО обновления активности
                const oldStreak = calculateStreak();

                // Обновляем только если активность изменилась
                if (oldActivity !== activityLevel) {
                    activityData[dateKey] = activityLevel;
                    saveActivityData();

                    // Обновляем календарь, если он показывает год даты тренировки
                    if (currentYear === workoutDate.getFullYear()) {
                        renderActivityGrid();

                        // Добавляем анимацию при увеличении активности
                        if (activityLevel !== 'none' && oldActivity === 'none') {
                            const targetCell = document.querySelector(`[data-date="${dateKey}"]`);
                            if (targetCell) {
                                // Сначала обновляем data-activity для применения нового цвета
                                targetCell.dataset.activity = activityLevel;
                                // Затем добавляем анимацию
                                targetCell.style.transform = 'translateY(-10px) scale(1.2) rotate(5deg)';

                                setTimeout(() => {
                                    targetCell.style.transform = '';
                                }, 300);
                            }
                        }
                    }

                    // Проверяем, увеличилась ли серия ПОСЛЕ обновления активности
                    const newStreak = calculateStreak();
                    if (newStreak > oldStreak && newStreak > 0) {
                        // Показываем анимацию увеличения серии
                        showStreakAnimationForIncrease(newStreak);
                    }
                }
            }
        }

        // Расчёт текущей серии (streak) на основе данных календаря активности
        function calculateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayKey = formatDateKey(today);

            let streak = 0;
            let checkDate = new Date(today);
            let checkedToday = false;

            // Проверяем сегодняшнюю активность
            const todayActivity = activityData[todayKey];
            if (todayActivity && todayActivity !== 'none') {
                streak++;
                checkedToday = true;
            }

            // Если сегодня нет активности, проверяем вчерашний день
            // Если вчера была активность - streak продолжается
            if (!checkedToday) {
                checkDate.setDate(checkDate.getDate() - 1);
                const yesterdayKey = formatDateKey(checkDate);
                const yesterdayActivity = activityData[yesterdayKey];

                if (!yesterdayActivity || yesterdayActivity === 'none') {
                    // Если вчера тоже не было активности - streak = 0
                    return 0;
                }
                // Вчера была активность - засчитываем её и продолжаем считать дальше назад
                streak++;
            }

            // Считаем подряд идущие дни назад от проверенной даты
            while (true) {
                checkDate.setDate(checkDate.getDate() - 1);
                const dateKey = formatDateKey(checkDate);
                const activity = activityData[dateKey];

                if (activity && activity !== 'none') {
                    streak++;
                } else {
                    break;
                }

                // Ограничиваем чтобы не уйти в бесконечность
                if (streak > 3650) break;
            }

            return streak;
        }

        // Подсчёт недельной статистики для итогов
        function calculateWeeklySummary() {
            let totalTasks = 0, completedTasks = 0;
            let totalExercises = 0, completedExercises = 0;
            const dayBreakdown = [];

            for (let day = 1; day <= 28; day++) {
                const tasks = todoData[day] || [];
                const dayTasks = tasks.length;
                const dayCompleted = tasks.filter(t => t.completed).length;
                const dayPercent = dayTasks > 0 ? Math.round((dayCompleted / dayTasks) * 100) : 0;

                totalTasks += dayTasks;
                completedTasks += dayCompleted;

                // Считаем упражнения (исключая отдых)
                let dayExTotal = 0, dayExCompleted = 0;
                tasks.forEach(task => {
                    if (task.exercises) {
                        const active = task.exercises.filter(ex => !ex.isRest);
                        dayExTotal += active.length;
                        dayExCompleted += active.filter(ex => ex.completed).length;
                    }
                });

                totalExercises += dayExTotal;
                completedExercises += dayExCompleted;

                dayBreakdown.push({
                    day: day,
                    percent: dayPercent
                });
            }

            const overallPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const bestDay = dayBreakdown.reduce((best, d) => d.percent > best.percent ? d : best, dayBreakdown[0]);

            // Считаем серию в пределах 28-дневной тренировки
            let workoutStreak = 0;
            let currentStreak = 0;
            for (let day = 1; day <= 28; day++) {
                const tasks = todoData[day] || [];
                const hasActivity = tasks.some(t => t.completed);
                if (hasActivity) {
                    currentStreak++;
                    workoutStreak = Math.max(workoutStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }

            // Считаем пройденные дни по дате (независимо от активности)
            const currentWorkoutDay = getCurrentWorkoutDay();
            const totalDays = getTotalWorkoutDays();
            const completedDays = Math.max(0, Math.min(currentWorkoutDay - 1, totalDays));
            const daysProgressPercent = Math.round((completedDays / totalDays) * 100);

            return {
                totalTasks,
                completedTasks,
                totalExercises,
                completedExercises,
                overallPercent,
                bestDay,
                streak: workoutStreak,
                dayBreakdown,
                completedDays,
                daysProgressPercent
            };
        }

        // Группировка дней по неделям для итогов
        function groupDaysByWeeks(summary) {
            console.log('groupDaysByWeeks called, todoData keys:', Object.keys(todoData));
            console.log('summary.dayBreakdown:', summary.dayBreakdown);

            const weeks = [
                { name: 'Неделя 1', days: [], startDay: 1, endDay: 7, emoji: '1️⃣' },
                { name: 'Неделя 2', days: [], startDay: 8, endDay: 14, emoji: '2️⃣' },
                { name: 'Неделя 3', days: [], startDay: 15, endDay: 21, emoji: '3️⃣' },
                { name: 'Неделя 4', days: [], startDay: 22, endDay: 28, emoji: '4️⃣' }
            ];

            // Распределяем дни по неделям
            summary.dayBreakdown.forEach(day => {
                const weekIndex = Math.floor((day.day - 1) / 7);
                if (weekIndex >= 0 && weekIndex < weeks.length) {
                    weeks[weekIndex].days.push(day);
                }
            });

            // Вычисляем агрегированную статистику по каждой неделе
            weeks.forEach(week => {
                let weekTotalTasks = 0, weekCompletedTasks = 0;
                let weekTotalExercises = 0, weekCompletedExercises = 0;

                // Считаем статистику заново для каждого дня недели
                for (let dayNum = week.startDay; dayNum <= week.endDay; dayNum++) {
                    const tasks = todoData[dayNum] || [];
                    const dayTasks = tasks.length;
                    const dayCompleted = tasks.filter(t => t.completed).length;

                    weekTotalTasks += dayTasks;
                    weekCompletedTasks += dayCompleted;

                    // Считаем упражнения (исключая отдых)
                    tasks.forEach(task => {
                        if (task.exercises) {
                            const active = task.exercises.filter(ex => !ex.isRest);
                            weekTotalExercises += active.length;
                            weekCompletedExercises += active.filter(ex => ex.completed).length;
                        }
                    });
                }

                week.totalTasks = weekTotalTasks;
                week.completedTasks = weekCompletedTasks;
                week.totalExercises = weekTotalExercises;
                week.completedExercises = weekCompletedExercises;
                week.percent = weekTotalTasks > 0 ? Math.round(weekCompletedTasks / weekTotalTasks * 100) : 0;

                // Находим лучший день недели
                week.bestDay = week.days.length > 0 ? week.days.reduce((best, d) => d.percent > (best?.percent || 0) ? d : best, null) : null;

                console.log(`${week.name}: tasks=${week.totalTasks}, completed=${week.completedTasks}, exercises=${week.totalExercises}, percent=${week.percent}`);
            });

            console.log('Final weeks:', weeks);
            return weeks;
        }

        // Показ анимации streak (как в Duolingo)
        function showStreakAnimation() {
            const today = new Date();
            const todayKey = formatDateKey(today);

            // Миграция: очищаем старый ключ если есть
            if (localStorage.getItem('fitTrackerStreakLastShown')) {
                localStorage.removeItem('fitTrackerStreakLastShown');
            }

            // Вычисляем текущий streak
            const streak = calculateStreak();

            // Получаем последний показанный streak
            const lastShownStreak = localStorage.getItem('fitTrackerLastStreak');

            // Показываем только если streak увеличился или если это первый запуск с серией
            if (streak === 0) {
                return;
            }

            if (lastShownStreak !== null && parseInt(lastShownStreak) >= streak) {
                return; // Серия не увеличилась
            }

            // Создаём элементы анимации
            const overlay = document.createElement('div');
            overlay.className = 'streak-overlay';

            const fire = document.createElement('div');
            fire.className = 'streak-fire glow';
            fire.textContent = '🔥';

            const number = document.createElement('div');
            number.className = 'streak-number';
            number.textContent = streak;

            const text = document.createElement('div');
            text.className = 'streak-text';
            const dayWord = streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней');
            text.textContent = `${dayWord} подряд!`;

            overlay.appendChild(fire);
            overlay.appendChild(number);
            overlay.appendChild(text);
            document.body.appendChild(overlay);

            // Показываем анимацию
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });

            // Вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                setTimeout(() => {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }, 300);
            }

            // Скрываем и удаляем через 2.5 секунды
            setTimeout(() => {
                overlay.classList.remove('show');
                overlay.classList.add('hide');
            }, 2500);

            // Удаляем из DOM после анимации
            setTimeout(() => {
                overlay.remove();
            }, 3000);

            // Сохраняем текущий streak, чтобы не показывать анимацию для той же серии
            localStorage.setItem('fitTrackerLastStreak', streak.toString());
        }

        // Создать HTML для модального окна итогов
        function createSummaryHtml(summary) {
            // Группируем дни по неделям
            const weeks = groupDaysByWeeks(summary);

            // Определяем класс результата
            const resultClass = summary.overallPercent >= 75 ? 'excellent' : summary.overallPercent >= 50 ? 'good' : 'fair';

            // Создаём HTML для дней (слайд 2)
            const daysHtml = summary.dayBreakdown.map(d => {
                const percentClass = d.percent >= 75 ? 'high' : d.percent >= 50 ? 'medium' : 'low';
                return `
                    <div class="summary-day-item" data-percent="${d.percent}">
                        <div class="summary-day-item-header">
                            <span class="summary-day-name">День ${d.day}</span>
                            <span class="summary-day-percent ${percentClass}">${d.percent}%</span>
                        </div>
                        <div class="summary-day-bar-bg">
                            <div class="summary-day-bar-fill" style="width: ${d.percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Определяем emoji на основе результата
            const resultEmoji = summary.overallPercent >= 90 ? '🏆' :
                              summary.overallPercent >= 75 ? '🎯' :
                              summary.overallPercent >= 50 ? '💪' : '👊';

            // Вычисляем дополнительную статистику
            const avgTasksPerDay = summary.completedDays > 0 ? Math.round(summary.completedTasks / summary.completedDays * 10) / 10 : 0;
            const avgExercisesPerDay = summary.completedDays > 0 ? Math.round(summary.completedExercises / summary.completedDays * 10) / 10 : 0;
            const remainingTasks = summary.totalTasks - summary.completedTasks;
            const remainingExercises = summary.totalExercises - summary.completedExercises;
            const completionRate = summary.totalTasks > 0 ? Math.round(summary.completedTasks / summary.totalTasks * 100) : 0;

            // Получаем даты периода
            let periodText = '';
            let periodDates = '';
            const startDate = getStartDate();
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 27);
                const options = { day: 'numeric', month: 'long' };
                periodDates = `${startDate.toLocaleDateString('ru-RU', options)} — ${endDate.toLocaleDateString('ru-RU', options)}`;
                periodText = 'Твоя программа';
            } else {
                periodDates = '28 дней активности';
                periodText = 'Период';
            }

            // Определяем мотивационное сообщение
            let motivationalEmoji = '';
            let motivationalTitle = '';
            let motivationalMessage = '';
            if (summary.overallPercent >= 90) {
                motivationalEmoji = '🏆';
                motivationalTitle = 'Превосходно!';
                motivationalMessage = 'Ты показал невероятный результат! Так держать!';
            } else if (summary.overallPercent >= 75) {
                motivationalEmoji = '🎯';
                motivationalTitle = 'Отлично!';
                motivationalMessage = 'Очень хороший результат! Продолжай в том же духе!';
            } else if (summary.overallPercent >= 50) {
                motivationalEmoji = '💪';
                motivationalTitle = 'Хороший старт!';
                motivationalMessage = 'Неплохой результат! Есть куда расти!';
            } else {
                motivationalEmoji = '👊';
                motivationalTitle = 'Начало пути!';
                motivationalMessage = 'Главное — не сдаваться! Продолжай тренироваться!';
            }

            // Вспомогательная функция для подсчёта упражнений дня
            const getDayExercises = (dayNum) => {
                const tasks = todoData[dayNum] || [];
                let total = 0, completed = 0;
                tasks.forEach(task => {
                    if (task.exercises) {
                        const active = task.exercises.filter(ex => !ex.isRest);
                        total += active.length;
                        completed += active.filter(ex => ex.completed).length;
                    }
                });
                return { total, completed };
            };

            // Возвращаем HTML карусели (11 слайдов)
            return `
                <!-- Слайд 1: Главный процент (Hero) -->
                <div class="summary-carousel-slide summary-hero-slide">
                    <div class="summary-glass-card">
                        <div class="summary-emoji">${resultEmoji}</div>
                        <div class="summary-percent ${resultClass}" data-counter="${summary.overallPercent}" data-suffix="%">0</div>
                        <div class="summary-subtitle">выполнено</div>
                    </div>
                </div>

                <!-- Слайд 2: Метрики (Metrics Grid) -->
                <div class="summary-carousel-slide summary-metrics-slide">
                    <div class="summary-metrics-title">Твои результаты</div>
                    <div class="summary-metrics-grid">
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${summary.completedTasks}" data-suffix="/${summary.totalTasks}">0</div>
                            <div class="summary-metric-label">Задачи</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${summary.completedExercises}" data-suffix="/${summary.totalExercises}">0</div>
                            <div class="summary-metric-label">Упражнения</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${summary.streak}" data-suffix="">0</div>
                            <div class="summary-metric-label">Дней подряд</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${summary.completedDays}" data-suffix="/${getTotalWorkoutDays()}">0</div>
                            <div class="summary-metric-label">Пройдено</div>
                        </div>
                    </div>
                </div>

                <!-- Слайд 3: Детальная статистика -->
                <div class="summary-carousel-slide summary-metrics-slide">
                    <div class="summary-metrics-title">Детальная статистика</div>
                    <div class="summary-metrics-grid">
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${Math.round(avgTasksPerDay * 10) / 10}" data-suffix="">0</div>
                            <div class="summary-metric-label">Задач/день</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${Math.round(avgExercisesPerDay * 10) / 10}" data-suffix="">0</div>
                            <div class="summary-metric-label">Упр./день</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${remainingTasks}" data-suffix="">0</div>
                            <div class="summary-metric-label">Осталось задач</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${remainingExercises}" data-suffix="">0</div>
                            <div class="summary-metric-label">Осталось упр.</div>
                        </div>
                    </div>
                    <div class="summary-stat-card">
                        <div class="summary-stat-label">Твоё выполнение</div>
                        <div class="summary-stat-bar-bg">
                            <div class="summary-stat-bar-fill" style="width: ${completionRate}%"></div>
                        </div>
                        <div class="summary-stat-value" data-counter="${completionRate}" data-suffix="%">0</div>
                    </div>
                </div>

                <!-- Слайд 4: Период тренировки -->
                <div class="summary-carousel-slide summary-period-slide">
                    <div class="summary-period-icon">📅</div>
                    <div class="summary-period-title">${periodText}</div>
                    <div class="summary-period-dates">${periodDates}</div>
                    <div class="summary-metrics-grid">
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${summary.completedDays}" data-suffix="">0</div>
                            <div class="summary-metric-label">Активных дней</div>
                        </div>
                        <div class="summary-metric-card">
                            <div class="summary-metric-value" data-counter="${7 - summary.completedDays}" data-suffix="">0</div>
                            <div class="summary-metric-label">Выходных</div>
                        </div>
                    </div>
                </div>

                <!-- Слайды 5-8: Недели (кликабельные) -->
                ${weeks.map((week, index) => {
                    const weekClass = week.percent >= 75 ? 'excellent' : week.percent >= 50 ? 'good' : 'fair';
                    const completedDays = week.days.filter(d => d.percent > 0).length;
                    const bestDayPercent = week.bestDay ? week.bestDay.percent : 0;

                    return `
                        <div class="summary-carousel-slide summary-week-slide" data-week="${index}" style="cursor: pointer;">
                            <div class="summary-week-header">
                                <div class="summary-week-emoji">${week.emoji}</div>
                                <div class="summary-week-name">${week.name}</div>
                                <div class="summary-week-dates">Дни ${week.startDay}-${week.endDay}</div>
                            </div>

                            <div class="summary-week-percent ${weekClass}" data-counter="${week.percent}" data-suffix="%">0</div>

                            <div class="summary-week-stats">
                                <div class="summary-week-stat">
                                    <div class="summary-week-stat-value" data-counter="${week.completedTasks}" data-suffix="/${week.totalTasks}">0</div>
                                    <div class="summary-week-stat-label">Задачи</div>
                                </div>
                                <div class="summary-week-stat">
                                    <div class="summary-week-stat-value" data-counter="${week.completedExercises}" data-suffix="/${week.totalExercises}">0</div>
                                    <div class="summary-week-stat-label">Упражнения</div>
                                </div>
                                <div class="summary-week-stat">
                                    <div class="summary-week-stat-value" data-counter="${completedDays}" data-suffix="/7">0</div>
                                    <div class="summary-week-stat-label">Дней</div>
                                </div>
                            </div>

                            <div class="summary-week-best">
                                🏆 Лучший: ${bestDayPercent}%
                            </div>

                            <div class="summary-week-hint">
                                Нажмите чтобы посмотреть детали
                            </div>
                        </div>
                    `;
                }).join('')}

                <!-- Слайд 9: Завершающий (Финал) -->
                <div class="summary-carousel-slide summary-motivation-slide">
                    <div class="summary-motivation-emoji">${motivationalEmoji}</div>
                    <div class="summary-motivation-title">${motivationalTitle}</div>
                    <div class="summary-motivation-message">${motivationalMessage}</div>
                    <div class="summary-motivation-stats">
                        <div class="summary-motivation-stat">
                            <span class="stat-value" data-counter="${summary.overallPercent}" data-suffix="%">0</span>
                            <span class="stat-label">выполнено</span>
                        </div>
                        <div class="summary-motivation-stat">
                            <span class="stat-value" data-counter="${summary.completedDays}" data-suffix="/${getTotalWorkoutDays()}">0</span>
                            <span class="stat-label">дней</span>
                        </div>
                        <div class="summary-motivation-stat">
                            <span class="stat-value" data-counter="${summary.streak}" data-suffix="">0</span>
                            <span class="stat-label">серия</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== ФУНКЦИИ АНИМАЦИИ ДЛЯ КАРУСЕЛИ =====

        // Анимация счётчика чисел
        function animateCounter(element, targetValue, suffix = '', duration = 1200) {
            const startTime = performance.now();
            const startValue = 0;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // easeOutCubic

                const currentValue = Math.round(startValue + (targetValue - startValue) * eased);
                element.textContent = currentValue + suffix;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Анимация появления слайда
        function animateSlideIn(slide) {
            // Перезапускаем CSS анимацию появления
            slide.style.animation = 'none';
            slide.offsetHeight; // trigger reflow
            slide.style.animation = 'slideFadeIn 0.5s ease-out';

            // Анимируем счётчики
            const counters = slide.querySelectorAll('[data-counter]');
            counters.forEach((counter, index) => {
                const target = parseInt(counter.dataset.counter) || 0;
                const suffix = counter.dataset.suffix || '';
                // Задержка для каждого счётчика
                setTimeout(() => {
                    animateCounter(counter, target, suffix, 1000);
                }, index * 100);
            });

            // Анимируем прогресс-бары
            const bars = slide.querySelectorAll('.summary-day-bar-fill, .summary-stat-bar-fill');
            bars.forEach(bar => {
                const targetWidth = bar.style.width;
                bar.style.width = '0%';
                requestAnimationFrame(() => {
                    bar.style.transition = 'width 0.8s ease-out';
                    bar.style.width = targetWidth;
                });
            });
        }

        // Функция закрытия и возврата в бота
        function closeToBot() {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                closeWorkoutModal();
            }
        }

        // Показ анимации streak при увеличении серии (без проверки localStorage)
        function showStreakAnimationForIncrease(streak) {
            const overlay = document.createElement('div');
            overlay.className = 'streak-overlay';

            const fire = document.createElement('div');
            fire.className = 'streak-fire glow';
            fire.textContent = '🔥';

            const number = document.createElement('div');
            number.className = 'streak-number';
            number.textContent = streak;

            const text = document.createElement('div');
            text.className = 'streak-text';
            const dayWord = streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней');
            text.textContent = `${dayWord} подряд!`;

            overlay.appendChild(fire);
            overlay.appendChild(number);
            overlay.appendChild(text);
            document.body.appendChild(overlay);

            // Показываем анимацию
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });

            // Вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                setTimeout(() => {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }, 300);
            }

            // Скрываем и удаляем через 2.5 секунды
            setTimeout(() => {
                overlay.classList.remove('show');
                overlay.classList.add('hide');
            }, 2500);

            // Удаляем из DOM после анимации
            setTimeout(() => {
                overlay.remove();
            }, 3000);

            // Обновляем lastStreak в localStorage
            localStorage.setItem('fitTrackerLastStreak', streak.toString());
        }

        // Переключение состояния задачи
        function toggleTask(taskId) {
            // Ищем задачу по ID
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.id === taskId) {
                            const now = new Date();

                            if (!task.completed) {
                                // Задача только что выполнена - записываем время
                                task.completed = true;
                                task.completedAt = now.toISOString();

                                // Если это первая выполненная задача - сохраняем дату начала программы
                                if (!getStartDate()) {
                                    setStartDate(now);
                                    console.log('Первая задача выполнена! Установлена дата начала программы.');
                                }

                                // Слабая вибрация как фидбек
                                if (window.Telegram?.WebApp?.HapticFeedback) {
                                    Telegram.WebApp.HapticFeedback.selectionChanged();
                                }
                            } else {
                                // Задача отменена - убираем время выполнения
                                task.completed = false;
                                task.completedAt = null;
                            }

                            const checkbox = document.getElementById(taskId);
                            if (checkbox) {
                                checkbox.checked = task.completed;

                                // Обновляем текст задачи с временем
                                const todoText = checkbox.closest('.todo-item').querySelector('.todo-text');
                                if (todoText) {
                                    // Безопасно устанавливаем текст задачи
                                    todoText.textContent = task.text;

                                    // Добавляем время выполнения через createElement
                                    if (task.completed && task.completedAt) {
                                        const timeSpan = document.createElement('span');
                                        timeSpan.className = 'task-time-inline';
                                        timeSpan.textContent = ' ' + new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
                                        todoText.appendChild(timeSpan);
                                    }
                                }

                                const todoItem = checkbox.closest('.todo-item');
                                if (todoItem) {
                                    todoItem.classList.toggle('completed', task.completed);
                                }
                            }
                        }
                    });
                }
            });

            // Сохраняем состояния
            saveTodoStates();

            // Обновляем виджеты дней для показа прогресса
            renderTaskDayWidgets();

            // Проверяем процент выполнения и записываем активность
            checkAndRecordActivity();

            // Обновляем dashboard strip
            updateDashboardStrip();

            // Обновляем AI комментарий если нужно
            updateAIComment();
        }

        // Переключение видимости подпунктов

        // ===== DASHBOARD STRIP ФУНКЦИИ =====

        // Обновление dashboard strip с актуальными данными
        function updateDashboardStrip() {
            const today = new Date();
            const streak = calculateStreak();
            // Используем выбранный день тренировки вместо текущего
            const displayDay = selectedWorkout;
            let percentage = calculateCompletionPercentage(displayDay);

            // Для дня 8 и выше показываем недельный процент вместо 0%
            if (displayDay > getTotalWorkoutDays()) {
                const weeklySummary = calculateWeeklySummary();
                percentage = weeklySummary.overallPercent;
            }

            // Обновляем дату - показываем только день тренировки, а не календарную дату
            document.getElementById('strip-day').textContent = '';

            // Для дня 8 и выше показываем "Итоги", иначе "День X"
            if (displayDay > getTotalWorkoutDays()) {
                document.getElementById('strip-date').textContent = 'Итоги';
            } else {
                document.getElementById('strip-date').textContent = `День ${displayDay}`;
            }

            // Обновляем серию
            document.getElementById('streak-count').textContent = `${streak} ${streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней')}`;

            // Обновляем прогресс
            document.getElementById('strip-progress-value').textContent = `${percentage}%`;

            // Для дня больше общего количества показываем "Итоги недели", иначе "День X из Y"
            if (displayDay > getTotalWorkoutDays()) {
                document.getElementById('strip-progress-sub').textContent = 'Итоги недели';
            } else {
                document.getElementById('strip-progress-sub').textContent = `День ${displayDay} из ${getTotalWorkoutDays()}`;
            }

            // Обновляем круговой прогресс
            const progressCircle = document.getElementById('strip-progress-circle');
            progressCircle.setAttribute('stroke-dasharray', `${percentage}, 100`);
        }

        // ===== AI КОММЕНТАРИЙ ФУНКЦИИ =====

        let lastAICommentUpdate = null;
        let lastAICommentPercentage = -1;
        const AI_COMMENT_UPDATE_INTERVAL = 15 * 60 * 1000; // 15 минут
        const AI_COMMENT_PERCENTAGE_THRESHOLDS = [0, 25, 50, 75, 100];

        // Проверка нужно ли обновить AI комментарий
        function shouldUpdateAIComment(percentage) {
            const now = Date.now();

            // Если еще не было обновления - обновляем
            if (!lastAICommentUpdate) return true;

            // Если прошло 15+ минут - обновляем
            if (now - lastAICommentUpdate > AI_COMMENT_UPDATE_INTERVAL) return true;

            // Если процент изменился до порогового значения - обновляем
            for (const threshold of AI_COMMENT_PERCENTAGE_THRESHOLDS) {
                if (percentage >= threshold && lastAICommentPercentage < threshold) {
                    return true;
                }
            }

            return false;
        }

        // Функция анимации печати текста
        let typingTimeout = null;
        function typeTextWithAnimation(element, text, speed = 30) {
            // Ищем span внутри элемента для текста
            const textSpan = element.querySelector('#ai-comment-span') || element;

            // Очищаем предыдущую анимацию
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            textSpan.textContent = '';
            textSpan.classList.add('typing');

            let index = 0;

            function type() {
                if (index < text.length) {
                    textSpan.textContent = text.substring(0, index + 1);
                    index++;
                    typingTimeout = setTimeout(type, speed);
                } else {
                    textSpan.classList.remove('typing');
                    textSpan.textContent = text;
                }
            }

            type();
        }

        // Ручное обновление AI комментария по клику
        async function refreshAIComment() {
            const commentElement = document.getElementById('ai-comment-text');
            const currentWorkoutDay = getCurrentWorkoutDay();
            const percentage = calculateCompletionPercentage(currentWorkoutDay);
            const streak = calculateStreak();

            // Показываем индикатор загрузки
            commentElement.innerHTML = `
                <div class="ai-comment-loading">
                    <span>Анализирую прогресс</span>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                </div>
            `;

            try {
                // Генерируем новый комментарий
                const comment = await generateAICommentForDashboard(percentage, streak);

                // Анимируем появление текста
                typeTextWithAnimation(commentElement, comment, 25);

                // Обновляем время и процент
                lastAICommentUpdate = Date.now();
                lastAICommentPercentage = percentage;

                // Кешируем в localStorage
                localStorage.setItem('fitTrackerAIComment', JSON.stringify({
                    comment,
                    timestamp: lastAICommentUpdate,
                    percentage: lastAICommentPercentage
                }));

                // Вибрация
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.selectionChanged();
                }
            } catch (error) {
                console.error('Error refreshing AI comment:', error);
                commentElement.textContent = getFallbackComment(percentage, streak);
            }
        }

        // Генерация AI комментария для dashboard
        async function updateAIComment(skipAnimation = false) {
            const displayDay = selectedWorkout;
            const percentage = calculateCompletionPercentage(displayDay);
            const streak = calculateStreak();

            // Проверяем нужно ли обновлять
            if (!shouldUpdateAIComment(percentage) && !skipAnimation) {
                return; // Используем закешированный комментарий
            }

            // Показываем индикатор загрузки (с иконкой)
            const commentElement = document.getElementById('ai-comment-text');
            commentElement.innerHTML = `
                <img src="https://img.icons8.com/?size=100&id=4KY3tfAid4dZ&format=png&color=000000" alt="ChatGPT" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                <span id="ai-comment-span" class="ai-comment-loading">
                    <span style="margin-right: 4px;">Анализирую прогресс</span>
                    <span class="ai-comment-loading-dot"></span>
                    <span class="ai-comment-loading-dot"></span>
                    <span class="ai-comment-loading-dot"></span>
                </span>
            `;

            // Генерируем комментарий
            const comment = await generateAICommentForDashboard(percentage, streak);

            // Анимируем появление текста
            typeTextWithAnimation(commentElement, comment, 25);

            // Сохраняем время обновления и процент
            lastAICommentUpdate = Date.now();
            lastAICommentPercentage = percentage;

            // Кешируем в localStorage
            localStorage.setItem('fitTrackerAIComment', JSON.stringify({
                comment,
                timestamp: lastAICommentUpdate,
                percentage: lastAICommentPercentage
            }));
        }

        // Генерация AI комментария через Edge Function
        async function generateAICommentForDashboard(percentage, streak) {
            const displayDay = selectedWorkout;

            let dayContext, percentContext, completedContext, remainingContext, isProgramCompleted;

            if (displayDay > getTotalWorkoutDays()) {
                // Для дня больше общего количества (Итоги) используем недельную статистику
                const weeklySummary = calculateWeeklySummary();
                dayContext = 'Итоги недели';
                percentContext = weeklySummary.overallPercent;
                completedContext = `${weeklySummary.completedTasks}/${weeklySummary.totalTasks}`;
                remainingContext = weeklySummary.totalTasks - weeklySummary.completedTasks;
                isProgramCompleted = true;
            } else {
                // Для тренировочных дней используем дневную статистику
                const todos = todoData[displayDay] || [];
                const completedCount = todos.filter(t => t.completed).length;
                const totalCount = todos.length;
                dayContext = `${displayDay} из ${getTotalWorkoutDays()}`;
                percentContext = percentage;
                completedContext = `${completedCount}/${totalCount}`;
                remainingContext = totalCount - completedCount;
                isProgramCompleted = false;
            }

            try {
                // Вызов Supabase Edge Function для AI комментария
                const response = await fetch(AI_COMMENT_EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'x-client-info': 'supabase-js/2.39.7',
                        'X-Telegram-Init-Data': window.Telegram?.WebApp?.initData || ''
                    },
                    body: JSON.stringify({
                        percentage: percentContext,
                        streak: streak,
                        dayContext: dayContext,
                        completedContext: completedContext,
                        remainingContext: remainingContext,
                        isProgramCompleted: isProgramCompleted,
                        totalDays: getTotalWorkoutDays()
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Edge Function Error:', errorData);
                    throw new Error(`Edge Function Error: ${response.status}`);
                }

                const result = await response.json();

                if (result.error) {
                    console.error('AI Comment Error:', result.error);
                    throw new Error(result.error);
                }

                return result.comment || getFallbackComment(percentContext, streak, isProgramCompleted);
            } catch (error) {
                console.error('AI Comment error:', error);
                return getFallbackComment(percentContext, streak, isProgramCompleted);
            }
        }

        // Fallback комментарии если API недоступен
        function getFallbackComment(percentage, streak, isProgramCompleted = false) {
            if (isProgramCompleted) {
                const completedComments = [
                    `Программа завершена! ${percentage}% — отличная работа! 🏆`,
                    `Поздравляю с окончанием! ${streak} дней серии — ты чемпион! 🎉`,
                    `Все позади! ${percentage}% выполнено — гордится! 💪`,
                    `Финиш! Ты прошёл весь курс — невероятно! ⭐`
                ];
                return completedComments[Math.floor(Math.random() * completedComments.length)];
            }

            const comments = [
                { min: 0, max: 24, text: `Начинаем с вдоха! ${streak > 0 ? streak + ' дней серии — отличный старт!' : 'Первый шаг самый важный!'}` },
                { min: 25, max: 49, text: `Хороший старт! ${percentage}% выполнено, продолжайте! 💪` },
                { min: 50, max: 74, text: `Половина позади! ${streak} дней подряд — отличная дисциплина! 🔥` },
                { min: 75, max: 99, text: `Почти у цели! ${percentage}% — финиш прям впереди! 🚀` },
                { min: 100, max: 100, text: `Отлично! Все задачи выполнены! ${streak} дней серии — невероятно! 🏆` }
            ];

            const comment = comments.find(c => percentage >= c.min && percentage <= c.max);
            return comment ? comment.text : comments[0].text;
        }

        // Загрузка закешированного AI комментария
        function loadCachedAIComment() {
            const cached = localStorage.getItem('fitTrackerAIComment');
            if (cached) {
                try {
                    const { comment, timestamp, percentage } = JSON.parse(cached);
                    const commentElement = document.getElementById('ai-comment-text');
                    if (commentElement) {
                        commentElement.innerHTML = `
                            <img src="https://img.icons8.com/?size=100&id=4KY3tfAid4dZ&format=png&color=000000" alt="ChatGPT" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                            <span id="ai-comment-span"></span>
                        `;
                        // Безопасно устанавливаем текст комментария
                        const span = commentElement.querySelector('#ai-comment-span');
                        if (span) {
                            span.textContent = comment;
                        }
                    }
                    lastAICommentUpdate = timestamp;
                    lastAICommentPercentage = percentage;
                } catch (e) {
                    console.error('Error loading cached AI comment:', e);
                }
            }
        }

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            initializeApp();
        });

            async function initializeApp() {
            // === ПРОВЕРКА ПОДПИСКИ ПРИ ЗАГРУЗКЕ ===
            const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
            const telegramId = user?.id;

            // Проверяем статус подписки
            let isSubscribed = false;
            if (telegramId && typeof checkSubscriptionStatus === 'function') {
                isSubscribed = await checkSubscriptionStatus(telegramId);
            }

            // Сохраняем статус глобально
            window.isSubscribed = isSubscribed;

            console.log('📊 Статус подписки при загрузке:', isSubscribed ? 'АКТИВНА' : 'НЕАКТИВНА');

            loadActivityData();
            loadActiveRepost();
            initializeTodoLists();

            // Проверяем наличие сохраненной истории чата и показываем toast
            const savedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
            if (savedHistory) {
                try {
                    const history = JSON.parse(savedHistory);
                    if (history && history.length > 0) {
                        // Загружаем историю
                        chatHistory = history;

                        // Подсчитываем сообщения пользователя
                        userMessageCount = countUserMessages();

                        // Восстанавливаем сообщения в UI
                        const overlayMessages = document.getElementById('chat-messages');
                        const sliderMessages = document.getElementById('slider-chat-messages');

                        if (overlayMessages) overlayMessages.innerHTML = '';
                        if (sliderMessages) sliderMessages.innerHTML = '';

                        chatHistory.forEach(msg => {
                            addMessageToContainer('chat-messages', msg.content, msg.role === 'user');
                            addMessageToContainer('slider-chat-messages', msg.content, msg.role === 'user');
                        });

                        // Устанавливаем флаг для показа toast при открытии чата
                        if (userMessageCount >= 1) {
                            pendingNewChatToast = true;
                        }
                    }
                } catch (e) {
                    console.error('Ошибка проверки истории чата:', e);
                }
            }

            // Устанавливаем выбранный день тренировки на основе текущей календарной даты
            selectedWorkout = getCurrentWorkoutDay();

            renderActivityGrid();
            renderTaskDayWidgets();
            setupEventListeners();
            setupModalListeners();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();

            // Показываем streak анимацию при первом входе за день
            showStreakAnimation();

            // Обновляем dashboard strip
            updateDashboardStrip();

            // Загружаем закешированный AI комментарий и генерируем новый если нужно
            loadCachedAIComment();
            updateAIComment();
        }

        // Сброс всей активности (для перехода на новую систему)
        function resetAllActivity() {
            activityData = {};
            localStorage.removeItem('fitTrackerActivity');
            // saveActivityData(); // Не нужно, мы и так удаляем из localStorage
        }

        // Загрузка данных активности
        function loadActivityData() {
            const saved = localStorage.getItem('fitTrackerActivity');
            if (saved) {
                try {
                    activityData = JSON.parse(saved);
                    // Миграция старых числовых значений в новые текстовые
                    const migrationMap = { 0: 'none', 30: 'low', 60: 'medium', 90: 'high', 120: 'max' };
                    let migrated = false;
                    Object.keys(activityData).forEach(key => {
                        if (typeof activityData[key] === 'number') {
                            activityData[key] = migrationMap[activityData[key]] || 'none';
                            migrated = true;
                        }
                    });
                    if (migrated) {
                        saveActivityData();
                    }
                } catch (e) {
                    activityData = {};
                }
            }
        }

        // Сохранение данных активности
        function saveActivityData() {
            localStorage.setItem('fitTrackerActivity', JSON.stringify(activityData));
        }

        // Генерация виджетов дней для секции заданий
        function renderTaskDayWidgets() {
            const tasksContainer = document.getElementById('tasks-container');
            if (!tasksContainer) return;

            tasksContainer.innerHTML = '';

            // Сложности для каждого дня (в процентах)
            const dayDifficulties = {
                1: 70,
                2: 65,
                3: 80,
                4: 60,
                5: 70,
                6: 72,
                7: 53,
                8: 75,
                9: 68,
                10: 82,
                11: 65,
                12: 70,
                13: 78,
                14: 58,
                15: 72,
                16: 80,
                17: 65,
                18: 75,
                19: 70,
                20: 85,
                21: 60,
                22: 78,
                23: 68,
                24: 82,
                25: 75,
                26: 70,
                27: 80,
                28: 65
            };

            // Получаем текущий день тренировки один раз перед циклом
            const currentWorkoutDay = getCurrentWorkoutDay();

            // Перебираем дни 1-29 (29 - это день итогов)
            for (let day = 1; day <= 29; day++) {
                // Day 29 - специальный виджет итогов (всегда виден)
                if (day === 29) {
                    const widget = document.createElement('div');
                    widget.className = 'task-day-widget summary-day-widget';
                    widget.dataset.day = day;

                    // Вычисляем прогресс прошедших дней
                    const completedDays = Math.max(0, Math.min(currentWorkoutDay - 1, 28));
                    const daysProgressPercent = Math.round((completedDays / 28) * 100);

                    // Параметры кругового прогресса
                    const progressRadius = 14;
                    const progressCircumference = 2 * Math.PI * progressRadius;
                    const progressOffset = progressCircumference - (daysProgressPercent / 100) * progressCircumference;

                    widget.innerHTML = `
                        <div class="summary-widget-content">
                            <div class="summary-icon">⭐</div>
                            <div class="task-day-label">Итоги</div>
                        </div>
                        <div class="task-progress-container">
                            <div class="task-progress-percentage">${daysProgressPercent}%</div>
                            <div class="task-progress-circle">
                                <svg viewBox="0 0 36 36">
                                    <circle class="progress-circle-bg" cx="18" cy="18" r="${progressRadius}"></circle>
                                    <circle class="progress-circle-fill" cx="18" cy="18" r="${progressRadius}"
                                            stroke-dasharray="${progressCircumference}"
                                            stroke-dashoffset="${progressOffset}"></circle>
                                </svg>
                            </div>
                        </div>
                    `;

                    // При клике проверяем доступность
                    widget.addEventListener('click', () => {
                        openWorkoutModal(day);
                    });

                    tasksContainer.appendChild(widget);
                    continue;
                }

                // Обычные дни 1-28
                const difficulty = dayDifficulties[day] || 50;
                const widget = document.createElement('div');
                widget.className = 'task-day-widget';
                widget.dataset.day = day;

                // Выделяем текущий день
                if (day === currentWorkoutDay) {
                    widget.classList.add('current');
                }

                // Вычисляем параметры SVG круга сложности
                const radius = 16;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (difficulty / 100) * circumference;

                // Вычисляем процент выполнения дня
                const completionPercentage = calculateCompletionPercentage(day);
                const progressRadius = 14;
                const progressCircumference = 2 * Math.PI * progressRadius;
                const progressOffset = progressCircumference - (completionPercentage / 100) * progressCircumference;

                widget.innerHTML = `
                    <div class="task-day-info">
                        <div class="task-day-name">${getWorkoutDayName(day)}</div>
                        <div class="task-day-label">День ${day}</div>
                    </div>
                    <div class="task-difficulty-container">
                        <div class="task-difficulty-label">Сложность</div>
                        <div class="task-difficulty-circle">
                            <svg viewBox="0 0 40 40">
                                <circle class="circle-bg" cx="20" cy="20" r="${radius}"></circle>
                                <circle class="circle-progress" cx="20" cy="20" r="${radius}"
                                        stroke-dasharray="${circumference}"
                                        stroke-dashoffset="${offset}"></circle>
                            </svg>
                        </div>
                    </div>
                    <div class="task-progress-container">
                        <div class="task-progress-percentage">${completionPercentage}%</div>
                        <div class="task-progress-circle">
                            <svg viewBox="0 0 36 36">
                                <circle class="progress-circle-bg" cx="18" cy="18" r="${progressRadius}"></circle>
                                <circle class="progress-circle-fill" cx="18" cy="18" r="${progressRadius}"
                                        stroke-dasharray="${progressCircumference}"
                                        stroke-dashoffset="${progressOffset}"></circle>
                            </svg>
                        </div>
                    </div>
                `;

                // При клике открываем модальное окно с задачами
                widget.addEventListener('click', () => {
                    selectedWorkout = day;
                    openWorkoutModal({ day });
                });

                tasksContainer.appendChild(widget);
            }
        }


        // ===== НОВЫЕ ФУНКЦИИ ДЛЯ ПРОЦЕНТНОЙ СИСТЕМЫ =====

        // Расчет процента выполнения для отдельной задачи
        
        // Расчет общего процента выполнения для дня
        function calculateCompletionPercentage(day) {
            const tasks = todoData[day];
            if (!tasks || tasks.length === 0) return 0;

            const completedTasks = tasks.filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / tasks.length) * 100);

            console.log(`День ${day}: ${completedTasks}/${tasks.length} задач выполнено = ${percentage}%`);
            return percentage;
        }

        // Обновление состояния родительской задачи на основе подзадач
        function updateParentTaskCompletion(taskId) {
            // Ищем родительскую задачу, содержащую эту подзадачу
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.subtasks) {
                            const subtask = task.subtasks.find(st => st.id === taskId);
                            if (subtask) {
                                // Обновляем состояние родительской задачи
                                const percentage = getTaskCompletionPercentage(task);
                                const newCompletedState = percentage === 100;

                                // Обновляем состояние в данных
                                task.completed = newCompletedState;
                                console.log(`Родительская задача "${task.text}" ${newCompletedState ? 'активирована' : 'деактивирована'} через подзадачи`);

                                // Обновляем UI родительской задачи
                                const parentCheckbox = document.getElementById(task.id);
                                if (parentCheckbox) {
                                    parentCheckbox.checked = newCompletedState;
                                    const todoItem = parentCheckbox.closest('.todo-item');
                                    if (todoItem) {
                                        todoItem.classList.toggle('completed', newCompletedState);
                                    }
                                }
                            }
                        }
                    });
                }
            });
            // Сохраняем обновленные состояния
            saveTodoStates();

            // Обновляем виджеты дней для показа прогресса
            renderTaskDayWidgets();
        }

        
        // ===== КОНЕЦ НОВЫХ ФУНКЦИЙ =====

        // Проверка выполнения тренировки
        function checkWorkoutCompleted(day) {
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 7 : today.getDay(); // Воскресенье = 7
            return day <= currentDay && getActivityForDate(new Date()) !== 'none';
        }

        // Рендеринг вертикального календаря активности
        function renderActivityGrid(isForward = true) {
            const container = document.getElementById('calendar-months');
            const tooltip = document.getElementById('activity-tooltip');
            const calendarWrapper = document.querySelector('.calendar-wrapper');

            // Если контейнер не пустой, анимируем смену года
            if (container.children.length > 0) {
                // Анимируем исчезновение
                calendarWrapper.style.transform = isForward ? 'translateX(-50px)' : 'translateX(50px)';
                calendarWrapper.style.opacity = '0';

                setTimeout(() => {
                    renderCalendarContent(container, tooltip, calendarWrapper, isForward);
                }, 150);
            } else {
                renderCalendarContent(container, tooltip, calendarWrapper, isForward);
            }
        }

        // Функция для рендеринга контента календаря
        function renderCalendarContent(container, tooltip, calendarWrapper, isForward) {
            // Очищаем контейнер
            container.innerHTML = '';

            const today = new Date();
            const todayKey = formatDateKey(today);

            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const weekDays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

            // Генерируем месяцы
            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(currentYear, month, 1);
                const lastDay = new Date(currentYear, month + 1, 0);
                const numDays = lastDay.getDate();

                // Создаем контейнер для месяца
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                // Добавляем ID для текущего месяца
                if (month === today.getMonth() && currentYear === today.getFullYear()) {
                    monthDiv.id = 'current-month';
                }

                // Заголовок месяца
                const monthHeader = document.createElement('div');
                monthHeader.className = 'calendar-month-header';
                monthHeader.style.cursor = 'pointer';
                monthHeader.textContent = monthNames[month];
                monthHeader.addEventListener('click', () => {
                    if (confirm('Сбросить ВЕСЬ прогресс?\n\nВся активность и все выполненные задачи будут удалены.')) {
                        resetAllProgress();
                    }
                });
                monthDiv.appendChild(monthHeader);

                // Создаем заголовки дней недели
                const weekHeader = document.createElement('div');
                weekHeader.className = 'calendar-week';

                for (let i = 0; i < 7; i++) {
                    const dayLabel = document.createElement('div');
                    dayLabel.className = 'calendar-weekday';
                    dayLabel.textContent = weekDays[i];
                    weekHeader.appendChild(dayLabel);
                }
                monthDiv.appendChild(weekHeader);

                // Определяем день недели первого дня месяца
                let firstDayOfWeek = firstDay.getDay();
                firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // ПН=0, ВСК=6

                // Создаем ячейки дней
                let currentDay = 1;
                let weekDiv;

                while (currentDay <= numDays) {
                    weekDiv = document.createElement('div');
                    weekDiv.className = 'calendar-week';

                    // Заполняем неделю
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const cell = document.createElement('div');

                        if (currentDay === 1 && dayOfWeek < firstDayOfWeek) {
                            // Пустые ячейки до начала месяца
                            cell.className = 'activity-cell empty';
                        } else if (currentDay <= numDays) {
                            // Ячейка с днем
                            const currentDate = new Date(currentYear, month, currentDay);
                            const dateKey = formatDateKey(currentDate);
                            const activity = getActivityForDate(currentDate);

                            cell.className = 'activity-cell';
                            cell.dataset.date = dateKey;
                            cell.dataset.activity = activity;

                            if (dateKey === todayKey) {
                                cell.classList.add('today');
                            }

                            // Добавляем номер дня
                            const dateNumber = document.createElement('span');
                            dateNumber.className = 'date-number';
                            dateNumber.textContent = currentDay;
                            cell.appendChild(dateNumber);

                            // Обработчики событий
                            cell.addEventListener('mouseenter', (e) => {
                                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                                const dateString = currentDate.toLocaleDateString('ru-RU', options);
                                const activityLabels = {
                                    'none': 'нет активности',
                                    'low': 'минимальная активность',
                                    'medium': 'средняя активность',
                                    'high': 'высокая активность',
                                    'max': 'максимальная активность'
                                };
                                const activityText = activityLabels[activity] || 'нет активности';
                                tooltip.innerHTML = `
                                    <strong>${dateString}</strong><br>
                                    ${activityText}${dateKey === todayKey ? '<br><em>(Сегодня)</em>' : ''}
                                `;
                                tooltip.classList.add('show');

                                const rect = e.target.getBoundingClientRect();
                                const containerRect = e.target.closest('.activity-grid-vertical').getBoundingClientRect();
                                tooltip.style.left = (rect.left - containerRect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                                tooltip.style.top = (rect.top - containerRect.top - tooltip.offsetHeight - 10) + 'px';
                            });

                            cell.addEventListener('mouseleave', () => {
                                tooltip.classList.remove('show');
                            });

                            currentDay++;
                        } else {
                            // Пустые ячейки в конце месяца
                            cell.className = 'activity-cell empty';
                        }

                        weekDiv.appendChild(cell);
                    }

                    monthDiv.appendChild(weekDiv);
                }

                container.appendChild(monthDiv);
            }

            // Анимируем появление
            if (calendarWrapper) {
                calendarWrapper.style.transform = 'translateX(0)';
                calendarWrapper.style.opacity = '1';
            }

            // Прокручиваем к текущему месяцу с задержкой
            setTimeout(() => {
                const currentMonthElement = document.getElementById('current-month');
                if (currentMonthElement) {
                    currentMonthElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 300); // Небольшая задержка для завершения анимации
        }

        
        // Получение активности для даты
        function getActivityForDate(date) {
            const key = formatDateKey(date);
            return activityData[key] || 'none';
        }

        // Функция для сброса активности за определенную дату
        function resetActivityForDate(date) {
            const dateKey = formatDateKey(date);

            // Удаляем активность за эту дату
            delete activityData[dateKey];
            saveActivityData();

            // Сбрасываем todos для дней тренировок, которые соответствуют этой дате
            Object.keys(todoData).forEach(day => {
                const workoutDate = getWorkoutDate(parseInt(day));
                if (formatDateKey(workoutDate) === dateKey) {
                    // Сбрасываем все задачи для этого дня
                    todoData[day].forEach(task => {
                        task.completed = false;
                        // Сбрасываем все подзадачи
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                    saveTodoStates();

                    // Обновляем виджеты дней для показа прогресса
                    renderTaskDayWidgets();

                    // Если режим задач открыт для этого дня, обновляем его
                    const workoutSection = document.querySelector('.workout-section');
                    if (workoutSection.classList.contains('show-todos') && selectedWorkout === day) {
                        const todoContent = document.getElementById('todo-content');
                        const currentWorkoutDay = getCurrentWorkoutDay();
                        const isLockedDay = day !== currentWorkoutDay;
                        todoContent.innerHTML = createTodoHtml(todoData[day], isLockedDay);
                    }
                }
            });

            // Перерисовываем календарь
            renderActivityGrid();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();
        }

        // Функция для полного сброса всего прогресса
        function resetAllProgress() {
            // Очищаем всю активность
            activityData = {};
            saveActivityData();

            // Сбрасываем все задачи
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        task.completed = false;
                        task.completedAt = null;
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                }
            });
            saveTodoStates();

            // Обновляем виджеты дней для показа прогресса
            renderTaskDayWidgets();

            // Перерисовываем UI
            renderActivityGrid();

            // Обновляем модалку если открыта
            const todoContent = document.getElementById('todo-content');
            if (todoContent && selectedWorkout) {
                const currentWorkoutDay = getCurrentWorkoutDay();
                const isLockedDay = selectedWorkout !== currentWorkoutDay;
                todoContent.innerHTML = createTodoHtml(todoData[selectedWorkout] || [], isLockedDay);
            }

            // Вибрация подтверждения
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        // Форматирование ключа даты
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Форматирование даты для отображения
        function formatDate(date) {
            return `${date.getDate()} ${['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][date.getMonth()]}`;
        }

  
  
        // Функции для режима отображения задач
        function openWorkoutModal(workout) {
            // Получаем номер дня (поддерживает как старый формат {day}, так и просто число)
            const dayNumber = typeof workout === 'object' ? workout.day : workout;

            // Day 29 - это специальные итоги, маршрутизируем на другую функцию
            if (dayNumber === 29) {
                openSummaryModal();
                return;
            }

            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalContent = document.getElementById('todo-modal-content');
            const todoModalTitle = document.getElementById('todo-modal-title');

            // Проверяем, заблокирован ли день (не текущий)
            const currentWorkoutDay = getCurrentWorkoutDay();
            const isLockedDay = dayNumber !== currentWorkoutDay;

            // Устанавливаем заголовок с динамическим названием дня
            const dayName = getWorkoutDayName(dayNumber);
            todoModalTitle.textContent = `День ${dayNumber} (${dayName}) - Задания`;

            // Отображаем todo-список для этого дня
            const dayTodos = todoData[dayNumber];
            todoModalContent.innerHTML = createTodoHtml(dayTodos, isLockedDay);

            // Показываем overlay с анимацией
            todoOverlay.style.display = 'block';
            setTimeout(() => {
                todoOverlay.classList.add('show');
            }, 10);

            // Запоминаем текущий выбранный день
            selectedWorkout = dayNumber;
        }

        function closeWorkoutModal() {
            const todoOverlay = document.getElementById('todo-overlay');

            // Восстанавливаем видимость кнопки закрытия
            const closeBtn = todoOverlay.querySelector('.todo-modal-close');
            if (closeBtn) {
                closeBtn.style.display = '';
            }

            // Скрываем overlay с анимацией
            todoOverlay.classList.remove('show');
            setTimeout(() => {
                todoOverlay.style.display = 'none';
            }, 300);
        }

        // Открыть модальное окно итогов
        function openSummaryModal() {
            if (!isSummaryAccessible()) {
                alert('Итоги будут доступны после завершения всех задач Day 28 или на 29-й день активности');
                return;
            }

            const summary = calculateWeeklySummary();
            const summaryHtml = createSummaryHtml(summary);

            // Создаём полноэкранное модальное окно
            const overlay = document.createElement('div');
            overlay.className = 'summary-fullscreen-overlay';
            overlay.id = 'summary-fullscreen-overlay';

            overlay.innerHTML = `
                <div class="summary-fullscreen-modal">
                    <div class="summary-carousel-container">
                        <div class="summary-carousel-track" id="summary-carousel-track">
                            ${summaryHtml}
                        </div>
                    </div>
                    <div class="summary-carousel-dots" id="summary-carousel-dots">
                        <!-- Точки будут добавлены через JS -->
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Инициализируем карусель
            summaryCarousel.init();

            // Сохраняем данные о неделях для drill-down
            const weeks = groupDaysByWeeks(summary);
            summaryCarousel.weeksData = weeks;

            // Вибрация при открытии
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }

            // Запоминаем текущий выбранный день как 29 (Итоги)
            selectedWorkout = 29;
        }

        // Функция закрытия модального окна итогов
        function closeSummaryModal() {
            const overlay = document.getElementById('summary-fullscreen-overlay');
            if (overlay) {
                overlay.style.animation = 'summaryFadeOut 0.3s ease forwards';
                setTimeout(() => {
                    overlay.remove();
                    summaryCarousel.destroy();
                }, 300);
            }
        }

        // Объект для управления каруселью
        const summaryCarousel = {
            currentIndex: 0,
            totalSlides: 9,
            track: null,
            dots: null,
            overlay: null,
            weeksData: null, // Сохраняем данные о неделях для drill-down
            originalSlidesHtml: null, // Сохраняем оригинальные слайды
            inWeekView: true, // Режим: true = недели, false = дни недели
            savedWeekIndex: null, // Сохраняем индекс недели для возврата на тот же слайд

            init() {
                this.track = document.getElementById('summary-carousel-track');
                this.dots = document.getElementById('summary-carousel-dots');
                this.overlay = document.getElementById('summary-fullscreen-overlay');
                this.totalSlides = this.track.children.length;
                this.currentIndex = 0;

                // Создаём точки
                this.createDots();

                // Настраиваем свайп
                this.setupSwipe();

                // Добавляем обработчики кликов на недельные слайды
                this.setupWeekClickHandlers();

                // Обновляем отображение
                this.update();

                // Закрытие по клику на фон
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        closeSummaryModal();
                    }
                });
            },

            destroy() {
                // Удаляем обработчики событий при закрытии
                if (this.overlay) {
                    this.overlay.ontouchstart = null;
                    this.overlay.ontouchmove = null;
                    this.overlay.ontouchend = null;
                    this.overlay.onmousedown = null;
                    this.overlay.onmousemove = null;
                    this.overlay.onmouseup = null;
                    this.overlay.onmouseleave = null;
                }
            },

            createDots() {
                this.dots.innerHTML = '';
                for (let i = 0; i < this.totalSlides; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'summary-carousel-dot';
                    if (i === 0) dot.classList.add('active');
                    dot.onclick = () => this.goTo(i);
                    this.dots.appendChild(dot);
                }
            },

            update() {
                // Обновляем позицию трека
                this.track.style.transform = `translateX(-${this.currentIndex * 100}%)`;

                // Запускаем анимации на текущем слайде
                const currentSlide = this.track.children[this.currentIndex];
                if (currentSlide) {
                    requestAnimationFrame(() => {
                        animateSlideIn(currentSlide);
                    });
                }

                // Обновляем точки
                const dots = this.dots.querySelectorAll('.summary-carousel-dot');
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === this.currentIndex);
                });
            },

            next() {
                this.currentIndex = (this.currentIndex + 1) % this.totalSlides;
                this.update();
            },

            prev() {
                this.currentIndex = (this.currentIndex - 1 + this.totalSlides) % this.totalSlides;
                this.update();
            },

            goTo(index) {
                this.currentIndex = index;
                this.update();
            },

            setupSwipe() {
                let startX = 0;
                let startY = 0;
                let startTime = 0;
                const threshold = 25; // минимальное расстояние для свайпа (более чувствительный)

                // Touch события - на весь overlay
                this.overlay.ontouchstart = (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                };

                this.overlay.ontouchmove = (e) => {
                    // Предотвращаем скролл при горизонтальном свайпе
                    const diffX = e.touches[0].clientX - startX;
                    const diffY = e.touches[0].clientY - startY;
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        e.preventDefault();
                    }
                };

                this.overlay.ontouchend = (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = endX - startX;
                    const diffY = endY - startY;

                    // Проверяем, что свайп горизонтальный и достаточно длинный
                    if (Math.abs(diffX) > threshold && Math.abs(diffY) < Math.abs(diffX)) {
                        if (diffX > 0) {
                            this.prev();
                        } else {
                            this.next();
                        }
                    }
                };

                // Mouse события (для desktop) - на весь overlay
                let isDragging = false;

                this.overlay.onmousedown = (e) => {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startTime = Date.now();
                    this.overlay.style.cursor = 'grabbing';
                };

                this.overlay.onmousemove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                };

                this.overlay.onmouseup = (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    this.overlay.style.cursor = '';

                    const diffX = e.clientX - startX;
                    const diffY = e.clientY - startY;

                    if (Math.abs(diffX) > threshold && Math.abs(diffY) < Math.abs(diffX)) {
                        if (diffX > 0) {
                            this.prev();
                        } else {
                            this.next();
                        }
                    }
                };

                this.overlay.onmouseleave = () => {
                    isDragging = false;
                    this.overlay.style.cursor = '';
                };
            },

            // Добавить обработчики кликов на недельные слайды
            setupWeekClickHandlers() {
                const weekSlides = this.track.querySelectorAll('.summary-week-slide');
                weekSlides.forEach((slide, index) => {
                    slide.addEventListener('click', (e) => {
                        // Предотвращаем срабатывание если dragged
                        if (this.isDragging) return;

                        const weekIndex = parseInt(slide.dataset.week);
                        if (!isNaN(weekIndex)) {
                            this.openWeekDetails(weekIndex);
                        }
                    });
                });
            },

            // Открыть детали недели
            openWeekDetails(weekIndex) {
                if (!this.weeksData) return;

                const week = this.weeksData[weekIndex];
                if (!week) return;

                // Сохраняем индекс текущей недели для возврата
                this.savedWeekIndex = weekIndex;

                // Сохраняем оригинальные слайды
                if (!this.originalSlidesHtml) {
                    this.originalSlidesHtml = this.track.innerHTML;
                }

                // Генерируем HTML для дней недели
                const weekDaysHtml = this.generateWeekDaysHtml(week);

                // Заменяем слайды в треке
                this.track.innerHTML = weekDaysHtml;

                // Обновляем количество слайдов (дней в неделе)
                this.totalSlides = week.days.length;

                // Обновляем состояние
                this.inWeekView = false;
                this.currentIndex = 0;

                // Пересоздаём точки для дней недели
                this.createDots();

                // Обновляем отображение
                this.update();
            },

            // Вернуться к неделям
            backToWeeks() {
                if (!this.originalSlidesHtml) return;

                // Восстанавливаем оригинальные слайды недель
                this.track.innerHTML = this.originalSlidesHtml;

                // Восстанавливаем количество слайдов (9: 4 общих + 4 недели + 1 финальный)
                this.totalSlides = this.track.children.length;

                // Восстанавливаем индекс СЛАЙДА недели (недели начинаются со слайда 4: Hero=0, Metrics=1, Detailed=2, Period=3, Week1=4, Week2=5, Week3=6, Week4=7)
                this.currentIndex = this.savedWeekIndex !== null ? this.savedWeekIndex + 4 : 4;

                // Обновляем состояние
                this.inWeekView = true;

                // Пересоздаём точки
                this.createDots();

                // Добавляем обработчики кликов на недели снова
                this.setupWeekClickHandlers();

                // Обновляем отображение
                this.update();
            },

            // Сгенерировать HTML для дней недели
            generateWeekDaysHtml(week) {
                const summary = calculateWeeklySummary();

                let html = '';

                // Генерируем слайд для каждого дня недели
                week.days.forEach(dayData => {
                    const dayNum = dayData.day;
                    const tasks = todoData[dayNum] || [];
                    const completedTasks = tasks.filter(t => t.completed);

                    // Считаем упражнения
                    let totalEx = 0, completedEx = 0;
                    tasks.forEach(task => {
                        if (task.exercises) {
                            const active = task.exercises.filter(ex => !ex.isRest);
                            totalEx += active.length;
                            completedEx += active.filter(ex => ex.completed).length;
                        }
                    });

                    const percentClass = dayData.percent >= 75 ? 'excellent' : dayData.percent >= 50 ? 'good' : 'fair';

                    html += `
                        <div class="summary-carousel-slide summary-day-slide">
                            <div class="summary-day-header">
                                <div class="summary-day-number">ДЕНЬ ${dayNum}</div>
                                <div class="summary-day-name">${getWorkoutDayName(dayNum)}</div>
                                <div class="summary-day-week-info">${week.emoji} ${week.name}</div>
                            </div>

                            <!-- Кнопка назад - левый верхний угол -->
                            <div class="summary-day-back-top" onclick="summaryCarousel.backToWeeks()">← Назад к неделям</div>

                            <div class="summary-day-percent ${percentClass}" data-counter="${dayData.percent}" data-suffix="%">0</div>

                            <div class="summary-day-stats">
                                <div class="summary-day-stat">
                                    <div class="summary-day-stat-value" data-counter="${completedTasks.length}" data-suffix="/${tasks.length}">0</div>
                                    <div class="summary-day-stat-label">Задачи</div>
                                </div>
                                <div class="summary-day-stat">
                                    <div class="summary-day-stat-value" data-counter="${completedEx}" data-suffix="/${totalEx}">0</div>
                                    <div class="summary-day-stat-label">Упражнения</div>
                                </div>
                            </div>

                            <div class="summary-day-percent-bar">
                                <div class="summary-day-bar-bg">
                                    <div class="summary-day-bar-fill" style="width: ${dayData.percent}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                return html;
            }
        };

        // Показать поздравительный экран после завершения Day 28
        function showCompletionCelebration() {
            // Проверяем, не показывали ли уже праздник
            const celebrationShown = localStorage.getItem('fitTrackerCelebrationShown');
            if (celebrationShown) return;

            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.id = 'celebration-overlay';

            overlay.innerHTML = `
                <div class="celebration-content">
                    <div class="celebration-emoji">🎉</div>
                    <div class="celebration-title">ПОЗДРАВЛЯЕМ!</div>
                    <div class="celebration-subtitle">Вы завершили неделю!</div>
                    <div class="celebration-message">
                        Отличная работа! Теперь доступны итоги вашей тренировочной недели.
                    </div>
                    <button class="celebration-button" onclick="closeCelebration()">
                        Посмотреть итоги
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);

            // Создаём конфетти
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    overlay.appendChild(confetti);
                }, i * 50);
            }

            // Сохраняем флаг, что показали праздник
            localStorage.setItem('fitTrackerCelebrationShown', 'true');
        }

        // Закрыть поздравительный экран
        function closeCelebration() {
            const overlay = document.getElementById('celebration-overlay');
            if (overlay) {
                overlay.style.animation = 'celebrationFadeIn 0.3s ease reverse';
                setTimeout(() => {
                    overlay.remove();
                    // Открываем итоги
                    openSummaryModal();
                }, 300);
            }
        }

        // Показать поздравительный экран после покупки подписки
        function showSubscriptionCelebration() {
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay subscription-celebration';
            overlay.id = 'subscription-celebration-overlay';

            overlay.innerHTML = `
                <div class="celebration-content">
                    <div class="celebration-title">ПОЗДРАВЛЯЕМ!</div>
                    <div class="celebration-subtitle">Подписка активирована</div>
                    <div class="celebration-message">
                        Добро пожаловать! Теперь вам доступны все возможности программы.
                    </div>
                    <div class="celebration-features">
                        <div class="celebration-feature">159 упражнений в программе</div>
                        <div class="celebration-feature">42 упражнения с видео-демонстрациями</div>
                        <div class="celebration-feature">28 полноценных тренировочных дней</div>
                        <div class="celebration-feature">AI-коуч с персональными комментариями к прогрессу</div>
                        <div class="celebration-feature">Карточки упражнений с адаптивным свайпом</div>
                        <div class="celebration-feature">Круговой прогресс выполнения упражнений</div>
                        <div class="celebration-feature">GitHub-календарь активности на весь год</div>
                        <div class="celebration-feature">Анимированная система серий с огнём</div>
                        <div class="celebration-feature">Итоговая статистика с круговыми диаграммами</div>
                        <div class="celebration-feature">Пересылка упражнений в AI-чат для вопросов</div>
                        <div class="celebration-feature">Изменяемый размер панелей (drag-to-resize)</div>
                        <div class="celebration-feature">Трёхпозиционный слайдер с навигацией</div>
                        <div class="celebration-feature">Два чат-интерфейса (overlay и slider)</div>
                        <div class="celebration-feature">Автосохранение прогресса после каждого действия</div>
                        <div class="celebration-feature">Telegram Mini App с haptic feedback</div>
                        <div class="celebration-feature">Адаптивный интерфейс для всех устройств</div>
                        <div class="celebration-feature">Анимированные переходы между экранами</div>
                        <div class="celebration-feature">Persistence в localStorage без сервера</div>
                        <div class="celebration-feature">SVG-графика для визуализации прогресса</div>
                        <div class="celebration-feature">Асинхронные API вызовы с OpenRouter</div>
                        <div class="celebration-feature">Тач-события для мобильной навигации</div>
                        <div class="celebration-feature">CSS transitions с GPU acceleration</div>
                        <div class="celebration-feature">Debounced scroll handlers для производительности</div>
                        <div class="celebration-feature">requestAnimationFrame для плавных анимаций</div>
                    </div>
                    <button class="celebration-button" onclick="closeSubscriptionCelebration()">
                        Начать тренировку
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);

            // Создаём конфетти
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    overlay.appendChild(confetti);
                }, i * 50);
            }

            // Haptic feedback
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        // Закрыть поздравительный экран подписки
        function closeSubscriptionCelebration() {
            const overlay = document.getElementById('subscription-celebration-overlay');
            if (overlay) {
                overlay.style.animation = 'celebrationFadeIn 0.3s ease reverse';
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            }

            // Haptic feedback
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }

        // Добавим обработчики для модального окна
        function setupModalListeners() {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalClose = document.getElementById('todo-modal-close');
            const exerciseCardClose = document.getElementById('exercise-card-close');
            const exerciseCheckBtn = document.getElementById('exercise-check-btn');

            // Закрытие по клику на крестик (сначала закрываем карточку упражнения, потом модальное окно)
            todoModalClose.addEventListener('click', () => {
                if (exerciseCardVisible) {
                    closeExerciseCard();
                } else {
                    closeWorkoutModal();
                }
            });

            // Закрытие карточки упражнения по её кресту
            exerciseCardClose.addEventListener('click', closeExerciseCard);

            // Кнопка-галочка для завершения упражнения
            exerciseCheckBtn.addEventListener('click', toggleExercise);

            // Кнопка репоста упражнения в AI
            const exerciseRepostBtn = document.getElementById('exercise-repost-btn');
            if (exerciseRepostBtn) {
                exerciseRepostBtn.addEventListener('click', repostExercise);
            }

            // Кнопка закрытия репоста в чате
            const repostCloseBtn = document.getElementById('repost-close-btn');
            if (repostCloseBtn) {
                repostCloseBtn.addEventListener('click', clearRepost);
            }

            // Закрытие по клику на заголовок (только если это не кнопка)
            const todoModalHeader = document.querySelector('.todo-modal-header');
            todoModalHeader.addEventListener('click', (e) => {
                if (e.target === todoModalHeader) {
                    if (exerciseCardVisible) {
                        closeExerciseCard();
                    } else {
                        closeWorkoutModal();
                    }
                }
            });

            // Закрытие по клавише Escape
            document.addEventListener('keydown', (e) => {
                const todoOverlay = document.getElementById('todo-overlay');
                if (e.key === 'Escape' && todoOverlay.classList.contains('show')) {
                    if (exerciseCardVisible) {
                        closeExerciseCard();
                    } else {
                        closeWorkoutModal();
                    }
                }
                // Также закрываем видео по Escape
                const videoOverlay = document.getElementById('exercise-video-overlay');
                if (e.key === 'Escape' && videoOverlay.classList.contains('show')) {
                    closeExerciseVideo();
                }
            });

            // Закрытие видео по клику на фон
            const videoOverlay = document.getElementById('exercise-video-overlay');
            const videoContainer = document.getElementById('exercise-video-container');
            if (videoOverlay && videoContainer) {
                // Закрытие при клике на фон
                videoOverlay.addEventListener('click', closeExerciseVideo);
                // Предотвращение закрытия при клике на контейнер с видео
                videoContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        // Установка обработчиков событий
        function setupEventListeners() {
            // Настройка toast для нового чата
            setupToastSwipe();

            // Клик на AI комментарий для обновления
            const aiCommentElement = document.getElementById('ai-comment');
            if (aiCommentElement) {
                aiCommentElement.addEventListener('click', () => {
                    refreshAIComment();
                });
            }

            // Прокрутка с клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && selectedWorkout > 1) {
                    selectWorkout(selectedWorkout - 1);
                } else if (e.key === 'ArrowRight' && selectedWorkout < 7) {
                    selectWorkout(selectedWorkout + 1);
                }
            });

            // ===== СЛАЙДЕР: ЧАТ (0) - КАЛЕНДАРЬ (1) - ЗАДАНИЯ (2) =====
            // Инициализируем глобальные переменные слайдера
            calendarContainers = document.querySelectorAll('.calendar-container');
            const activitySlider = document.querySelector('.activity-slider');

            // Функция для переключения слайдов
            // Глобальная функция для доступа из repostExercise
            window.switchSlide = function(targetSlide) {
                if (targetSlide < 0 || targetSlide > 2) return;
                if (!calendarContainers || calendarContainers.length === 0) return;

                currentSlide = targetSlide;
                calendarContainers.forEach((container, index) => {
                    const offset = index - currentSlide;
                    // Добавляем transition для плавной анимации (если не в процессе panning)
                    container.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    container.style.transform = `translateX(${offset * 110}%)`;
                    container.style.zIndex = index === currentSlide ? '2' : '1';
                });

                // Фокус на поле ввода при открытии чата
                if (currentSlide === 0) {
                    setTimeout(() => {
                        const chatInput = document.getElementById('slider-chat-input');
                        if (chatInput) chatInput.focus();
                    }, 300);
                }
            }

            // Инициализация начальных стилей для контейнеров
            calendarContainers.forEach((container, index) => {
                const offset = index - currentSlide;
                container.style.transform = `translateX(${offset * 110}%)`;
                container.style.zIndex = index === currentSlide ? '2' : '1';
            });

            // ===== НАВИГАЦИОННЫЕ КНОПКИ =====
            const navButtons = document.querySelectorAll('.nav-button');

            // Функция для обновления активного состояния кнопок
            function updateNavButtonsActive() {
                navButtons.forEach(btn => {
                    const slideIndex = parseInt(btn.dataset.slide);
                    if (slideIndex === currentSlide) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            // Инициализация активного состояния
            updateNavButtonsActive();

            // Обработчики кликов для навигационных кнопок
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetSlide = parseInt(button.dataset.slide);

                    // Если уже на этом слайде - вибрация и shake анимация
                    if (targetSlide === currentSlide) {
                        // Вибрация
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        }

                        // Shake анимация
                        button.classList.add('shake');
                        setTimeout(() => {
                            button.classList.remove('shake');
                        }, 300);
                    } else {
                        // Переключение слайда
                        switchSlide(targetSlide);
                        // Обновляем активное состояние кнопок
                        updateNavButtonsActive();
                    }
                });
            });

            // Обновляем функцию switchSlide для обновления кнопок
            const originalSwitchSlide = switchSlide;
            switchSlide = function(targetSlide) {
                originalSwitchSlide(targetSlide);
                updateNavButtonsActive();

                // Показываем toast при открытии чата
                if (targetSlide === 0 && pendingNewChatToast) {
                    setTimeout(() => {
                        showNewChatToast();
                        pendingNewChatToast = false; // Сбрасываем флаг после показа
                    }, 300);
                }
            };

            // Элементы, с которых НЕ должен начинаться свайп
            const noSwipeElements = new Set([
                'chat-input-neobrut',
                'chat-send-neobrut'
            ]);

            // Проверка - можно ли свайпать с этого элемента
            function canSwipeFrom(target) {
                if (noSwipeElements.has(target.className)) {
                    return false;
                }
                let parent = target.parentElement;
                while (parent) {
                    if (noSwipeElements.has(parent.className)) {
                        return false;
                    }
                    if (parent.classList && parent.classList.contains('activity-cell')) {
                        return false;
                    }
                    parent = parent.parentElement;
                }
                return true;
            }

            // ===== PAN GESTURE (интерактивный свайп) =====
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            let isPanning = false;
            let currentTranslate = 0; // Текущее смещение в пикселях
            const SNAP_THRESHOLD = 120; // Порог для переключения (в пикселях)
            const FAST_SWIPE_TIME = 300; // Порог времени для быстрого свайпа (мс)

            activitySlider.addEventListener('touchstart', (e) => {
                if (!canSwipeFrom(e.target)) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isPanning = false;
                currentTranslate = 0;
                // Убираем transition для мгновенного отклика
                calendarContainers.forEach(container => {
                    container.style.transition = 'none';
                });
            }, { passive: true });

            activitySlider.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const deltaX = currentX - touchStartX;
                const deltaY = currentY - touchStartY;

                // Если вертикальное движение больше горизонтального - это скролл, игнорируем
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    return;
                }

                // Ограничиваем pan по краям
                const canGoLeft = currentSlide < 2;
                const canGoRight = currentSlide > 0;

                // Блокируем pan если пытаемся выйти за границы
                if ((deltaX > 0 && !canGoRight) || (deltaX < 0 && !canGoLeft)) {
                    return;
                }

                if (Math.abs(deltaX) > 5) {
                    isPanning = true;
                    e.preventDefault();
                }

                if (isPanning) {
                    currentTranslate = deltaX;
                    // Применяем трансформацию в реальном времени
                    calendarContainers.forEach((container, index) => {
                        const baseOffset = index - currentSlide;
                        const baseTranslate = baseOffset * 110; // в процентах
                        const viewportWidth = window.innerWidth;
                        const panPercent = (currentTranslate / viewportWidth) * 100;

                        container.style.transform = `translateX(calc(${baseTranslate}% + ${panPercent}%))`;
                    });
                }
            }, { passive: false });

            activitySlider.addEventListener('touchend', (e) => {
                if (!isPanning) {
                    touchStartX = 0;
                    touchStartY = 0;
                    return;
                }

                // Возвращаем transition для плавной анимации
                calendarContainers.forEach(container => {
                    container.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                });

                const diff = currentTranslate;
                const swipeTime = Date.now() - touchStartTime;
                touchStartX = 0;
                touchStartY = 0;
                isPanning = false;

                // Быстрый свайп (< 0.3 сек) → переключаем всегда
                // Медленный свайп (>= 0.3 сек) → проверяем порог расстояния
                const isFastSwipe = swipeTime < FAST_SWIPE_TIME;
                const passedThreshold = Math.abs(diff) > SNAP_THRESHOLD;

                if (isFastSwipe || passedThreshold) {
                    if (diff < 0) {
                        // Pan влево → следующий слайд
                        if (currentSlide < 2) switchSlide(currentSlide + 1);
                        else switchSlide(currentSlide); // Возврат на место
                    } else {
                        // Pan вправо → предыдущий слайд
                        if (currentSlide > 0) switchSlide(currentSlide - 1);
                        else switchSlide(currentSlide); // Возврат на место
                    }
                } else {
                    // Не дошли до порога и не быстрый свайп - возвращаемся на текущий слайд
                    switchSlide(currentSlide);
                }
            });

            // Свайп мышью для десктопа (традиционный)
            let mouseStartX = 0;
            let mouseStartTime = 0;
            let mouseIsDown = false;
            let mouseIsSwiping = false;
            const MOUSE_SNAP_THRESHOLD = 50; // Порог для переключения мышью

            activitySlider.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('activity-cell') ||
                    e.target.closest('.activity-cell') ||
                    e.target.classList.contains('chat-input-neobrut') ||
                    e.target.closest('.chat-input-neobrut')) {
                    return;
                }
                mouseStartX = e.clientX;
                mouseStartTime = Date.now();
                mouseIsDown = true;
                mouseIsSwiping = false;
            });

            activitySlider.addEventListener('mousemove', (e) => {
                if (!mouseIsDown) return;
                const deltaX = Math.abs(e.clientX - mouseStartX);
                if (deltaX > 10) {
                    mouseIsSwiping = true;
                }
            });

            activitySlider.addEventListener('mouseup', (e) => {
                if (!mouseIsDown) return;
                if (mouseIsSwiping) {
                    const diff = mouseStartX - e.clientX;
                    const swipeTime = Date.now() - mouseStartTime;
                    const isFastSwipe = swipeTime < FAST_SWIPE_TIME;
                    const passedThreshold = Math.abs(diff) > MOUSE_SNAP_THRESHOLD;

                    // Быстрый свайп (< 0.3 сек) → переключаем всегда
                    // Медленный свайп (>= 0.3 сек) → проверяем порог расстояния
                    if (isFastSwipe || passedThreshold) {
                        if (diff > 0) {
                            if (currentSlide < 2) switchSlide(currentSlide + 1);
                        } else {
                            if (currentSlide > 0) switchSlide(currentSlide - 1);
                        }
                    }
                }
                mouseIsDown = false;
                mouseIsSwiping = false;
            });

            activitySlider.addEventListener('mouseleave', () => {
                mouseIsDown = false;
                mouseIsSwiping = false;
            });

            // Устанавливаем обработчики для модального окна
            setupModalListeners();
        }

        // AI Chat функции
        let chatHistory = [];
        let userMessageCount = 0; // Счётчик сообщений пользователя для показа toast
        let toastTimer = null; // Таймер для автозакрытия toast
        let pendingNewChatToast = false; // Флаг что нужно показать toast при открытии чата
        let conversationContext = {
            userName: null,
            userLevel: 'beginner',
            lastWorkoutDay: null,
            totalWorkouts: 0,
            currentStreak: 0
        };

        // Функции для сохранения и загрузки истории чата
        function saveChatHistory() {
            try {
                localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
            } catch (e) {
                console.error('Ошибка сохранения истории чата:', e);
            }
        }

        function loadChatHistory() {
            try {
                const saved = localStorage.getItem(CHAT_HISTORY_KEY);
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    return true;
                }
            } catch (e) {
                console.error('Ошибка загрузки истории чата:', e);
            }
            return false;
        }

        // ===== ФУНКЦИИ ДЛЯ TOAST "НОВЫЙ ЧАТ" =====

        // Подсчёт сообщений пользователя в истории
        function countUserMessages() {
            return chatHistory.filter(msg => msg.role === 'user').length;
        }

        // Показать toast с предложением начать новый чат
        let toastTimeout = null;

        function showNewChatToast() {
            const toast = document.getElementById('new-chat-toast');
            const svg = document.getElementById('new-chat-timer-svg');
            const rect = document.getElementById('new-chat-timer-rect');
            if (!toast) return;

            // Очищаем предыдущий таймер если есть
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }

            // Показываем toast
            toast.classList.remove('hiding', 'shake');
            void toast.offsetWidth;
            toast.classList.add('show');

            // Добавляем shake через 3 секунды
            setTimeout(() => {
                toast.classList.add('shake');
            }, 3000);

            // Настраиваем SVG таймер после появления
            setTimeout(() => {
                if (svg && rect) {
                    const width = toast.offsetWidth;
                    const height = toast.offsetHeight;
                    svg.setAttribute('viewBox', `0 0 ${width + 8} ${height + 8}`);
                    rect.setAttribute('x', '2');
                    rect.setAttribute('y', '2');
                    rect.setAttribute('width', width + 4);
                    rect.setAttribute('height', height + 4);

                    const perimeter = 2 * (width + height + 8);
                    rect.style.setProperty('--perimeter', perimeter);
                    rect.style.strokeDasharray = perimeter;
                    rect.style.strokeDashoffset = perimeter;

                    requestAnimationFrame(() => {
                        rect.classList.add('active');
                    });
                }
            }, 50);

            // Автоматически скрываем через 10 секунд
            toastTimeout = setTimeout(() => {
                hideNewChatToast();
            }, NEW_CHAT_TOAST_DURATION);
        }

        function hideNewChatToast() {
            const toast = document.getElementById('new-chat-toast');
            const rect = document.getElementById('new-chat-timer-rect');
            if (!toast) return;

            // Останавливаем анимацию таймера
            if (rect) {
                rect.classList.remove('active');
            }

            // Очищаем таймеры
            if (toastTimeout) {
                clearTimeout(toastTimeout);
                toastTimeout = null;
            }

            // Сбрасываем inline стили перед анимацией скрытия
            toast.style.transform = '';

            // Анимация скрытия со свайпом вправо
            toast.classList.add('hiding');
            setTimeout(() => {
                toast.classList.remove('show', 'hiding');
            }, 300);
        }

        // Начать новый чат
        function startNewChat() {
            // Скрываем toast
            hideNewChatToast();

            // Очищаем историю
            chatHistory = [];
            userMessageCount = 0; // Сбрасываем счётчик
            saveChatHistory();

            // Очищаем UI
            const overlayMessages = document.getElementById('chat-messages');
            const sliderMessages = document.getElementById('slider-chat-messages');

            if (overlayMessages) overlayMessages.innerHTML = '';
            if (sliderMessages) sliderMessages.innerHTML = '';

            // Добавляем приветственное сообщение
            const welcomeMessage = `
                <div class="message">
                    <div class="message-content">
                        <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                    </div>
                </div>
            `;
            if (overlayMessages) overlayMessages.innerHTML = welcomeMessage;
            if (sliderMessages) sliderMessages.innerHTML = welcomeMessage;
        }

        // Настройка свайпа для toast
        function setupToastSwipe() {
            const toast = document.getElementById('new-chat-toast');
            if (!toast) return;

            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            // Touch события
            toast.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                toast.classList.add('swiping');
            }, { passive: true });

            toast.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                toast.style.transform = `translateX(calc(-50% + ${diff}px))`;
            }, { passive: true });

            toast.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                toast.classList.remove('swiping');

                const diff = currentX - startX;
                const threshold = 50; // Порог для свайпа

                if (Math.abs(diff) > threshold) {
                    // Свайп detected - закрываем toast
                    hideNewChatToast();
                } else {
                    // Возвращаем на место
                    toast.style.transform = '';
                }

                startX = 0;
                currentX = 0;
            }, { passive: true });

            // Mouse события для desktop
            toast.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                toast.classList.add('swiping');
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                currentX = e.clientX;
                const diff = currentX - startX;
                toast.style.transform = `translateX(calc(-50% + ${diff}px))`;
            });

            document.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                toast.classList.remove('swiping');

                const diff = currentX - startX;
                const threshold = 50;

                if (Math.abs(diff) > threshold) {
                    hideNewChatToast();
                } else {
                    toast.style.transform = '';
                }

                startX = 0;
                currentX = 0;
            });

            // Кнопка для запуска нового чата
            const toastBtn = document.getElementById('new-chat-toast-btn');
            if (toastBtn) {
                toastBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    startNewChat();
                });
            }
        }

        function openAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.classList.add('show');
                // Фокус на поле ввода
                const chatInput = document.getElementById('chat-input');
                chatInput.focus();

                // Прогрев AI - быстрый запрос для инициализации
                if (chatHistory.length === 2) { // Только при первом открытии
                    generateAIResponse("👋").catch(() => {}); // Silent fail
                }
            }, 10);
        }

        function closeAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        // Переменные для свайпа закрытия чата
        let chatTouchStartY = 0;
        let chatTouchEndY = 0;
        let chatIsSwipingDown = false;
        const chatSwipeThreshold = 80; // Минимальная дистанция свайпа
        const chatHeaderHeightRatio = 0.2; // 20% высоты чата - зона свайпа

        // Универсальная функция для добавления сообщения в оба контейнера
        function addMessageToContainer(containerId, content, isUser = false) {
            const messagesContainer = document.getElementById(containerId);
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message ai-message';

            // Для AI сообщений применяем форматирование (уже безопасное),
            // для пользовательских сообщений экранируем и оборачиваем в параграф
            const safeContent = isUser ? `<p>${escapeHtml(content)}</p>` : formatAIResponse(content);

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${safeContent}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Прокрутка к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessage(content, isUser = false) {
            // Добавляем в overlay чат
            addMessageToContainer('chat-messages', content, isUser);
            // Добавляем в slider чат
            addMessageToContainer('slider-chat-messages', content, isUser);

            // Сохраняем в историю в формате OpenRouter
            chatHistory.push({
                role: isUser ? 'user' : 'assistant',
                content: content
            });

            // Если это сообщение пользователя - проверяем счётчик
            if (isUser) {
                userMessageCount++;

                // Показываем toast после каждого N-го сообщения пользователя
                if (userMessageCount % USER_MESSAGES_FOR_NEW_CHAT === 0) {
                    showNewChatToast();
                }
            }

            // Ограничиваем историю последними 15 сообщениями
            if (chatHistory.length > MAX_CHAT_HISTORY) {
                chatHistory = chatHistory.slice(-MAX_CHAT_HISTORY);
            }

            // Сохраняем историю в localStorage
            saveChatHistory();
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Функция для отправки сообщения из slider чата
        async function sendSliderMessage() {
            const chatInput = document.getElementById('slider-chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendSliderMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Форматирование ответа AI - убираем HTML и оставляем чистый текст
        function formatAIResponse(text) {
            // Убираем все HTML-теги из ответа AI
            let cleanText = text
                // Заменяем HTML-теги на переносы строк или пробелы
                .replace(/<\/p>/gi, '\n\n')
                .replace(/<\/div>/gi, '\n')
                .replace(/<\/li>/gi, '\n')
                .replace(/<li>/gi, '• ')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/h[1-6]>/gi, '\n\n')
                // Убираем все остальные HTML-теги
                .replace(/<[^>]+>/g, '')
                // Убираем множественные переносы строк
                .replace(/\n{3,}/g, '\n\n')
                // Убираем &nbsp; и другие HTML-сущности
                .replace(/&nbsp;/g, ' ')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"')
                // Обрабатываем markdown **жирный**
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                // Обрабатываем заголовки #
                .replace(/^#{1,3}\s+(.+)$/gm, '<strong>$1</strong>')
                .trim();

            // Экранируем HTML для безопасности
            cleanText = escapeHtml(cleanText);

            // Разбиваем на параграфы
            return cleanText
                .split('\n\n')
                .map(p => p.trim())
                .filter(p => p.length > 0)
                .map(p => `<p style="margin: 10px 0; line-height: 1.6;">${p}</p>`)
                .join('\n');
        }

        async function generateAIResponse(userMessage) {
            const currentWorkoutDay = getCurrentWorkoutDay();
            const today = new Date();
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const dayName = dayNames[today.getDay()];
            const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const monthName = monthNames[today.getMonth()];
            const totalDays = getTotalWorkoutDays();
            const workoutDayInfo = currentWorkoutDay > totalDays
                ? 'тренировочный день: подведение итогов'
                : `тренировочный день: ${currentWorkoutDay}/${totalDays}`;
            const dateString = `${dayName}, ${today.getDate()} ${monthName} ${today.getFullYear()}, ${workoutDayInfo}`;

            try {
                // Добавляем индикатор набора текста
                showTypingIndicator();

                // Подготовка контекста для Edge Function
                const userContext = {
                    dateString: dateString,
                    currentWorkoutDay: currentWorkoutDay,
                    workoutDayName: getWorkoutDayName(currentWorkoutDay),
                    todoData: {
                        summaries: Object.keys(todoData).map(day => {
                            const dayNum = parseInt(day);
                            const tasks = todoData[day] || [];
                            const completed = tasks.filter(t => t.completed).length;
                            return `День ${dayNum} (${getWorkoutDayName(dayNum)}): ${completed}/${tasks.length} выполнено`;
                        }).join('\n'),
                        details: Object.keys(todoData).map(day => {
                            const dayNum = parseInt(day);
                            const tasks = todoData[day] || [];
                            if (tasks.length === 0) return `\n--- День ${dayNum} (${getWorkoutDayName(dayNum)}) ---\nНет задач`;
                            return `\n--- День ${dayNum} (${getWorkoutDayName(dayNum)}) ---` +
                                tasks.map((t, taskIndex) => {
                                    let taskStr = `\n${t.completed ? '✅' : '⏳'} Задание ${taskIndex + 1}: ${t.text}`;
                                    if (t.exercises && t.exercises.length > 0) {
                                        taskStr += '\n   Упражнения:';
                                        t.exercises.forEach((ex, exIndex) => {
                                            taskStr += `\n      ${exIndex + 1}. ${ex.completed ? '✅' : '⏳'} ${ex.videoUrl ? '🎥 ' : ''}${ex.text}${ex.isRest ? ' (отдых)' : ''}`;
                                        });
                                    }
                                    return taskStr;
                                }).join('\n');
                        }).join('\n')
                    },
                    activeRepost: activeRepost ? {
                        day: activeRepost.day,
                        workoutDayName: getWorkoutDayName(activeRepost.day),
                        taskName: activeRepost.taskName,
                        exerciseText: activeRepost.exerciseText
                    } : null,
                    completionPercentage: currentWorkoutDay > totalDays
                        ? calculateWeeklySummary().overallPercent
                        : calculateCompletionPercentage(currentWorkoutDay),
                    activeDaysCount: Object.keys(activityData).filter(date => activityData[date] && activityData[date] !== 'none').length
                };

                // Вызов Supabase Edge Function
                const response = await fetch(AI_CHAT_EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'x-client-info': 'supabase-js/2.39.7',
                        'X-Telegram-Init-Data': window.Telegram?.WebApp?.initData || ''
                    },
                    body: JSON.stringify({
                        userMessage: userMessage,
                        userContext: userContext,
                        chatHistory: chatHistory
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Edge Function Error:', errorData);
                    throw new Error(`Edge Function Error: ${response.status} - ${errorData.error || response.statusText}`);
                }

                const result = await response.json();

                if (result.error) {
                    console.error('AI Chat Error:', result.error);
                    throw new Error(result.error);
                }

                const aiMessage = result.response || "Извините, произошла ошибка. Попробуйте еще раз.";

                hideTypingIndicator();
                return formatAIResponse(aiMessage.trim());
            } catch (error) {
                console.error('AI API Error:', error);
                hideTypingIndicator();
                // Fallback ответы при ошибке API
                const fallbackResponses = [
                    "Произошла ошибка подключения. Давайте я помогу своими силами!",
                    "Не удалось связаться с AI. Попробуйте еще раз через минуту.",
                    "Кажется, проблема с соединением. Продолжайте тренироваться, а я скоро вернусь!"
                ];
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }
        }

        function showTypingIndicator() {
            // Показываем в обоих контейнерах
            ['chat-messages', 'slider-chat-messages'].forEach(containerId => {
                const messagesContainer = document.getElementById(containerId);
                if (!messagesContainer) return;

                // Удаляем существующий индикатор если есть
                const existing = messagesContainer.querySelector('.typing-indicator');
                if (existing) existing.remove();

                const typingDiv = document.createElement('div');
                typingDiv.className = 'message typing-indicator';
                typingDiv.id = `typing-indicator-${containerId}`;
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="typing-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function hideTypingIndicator() {
            // Удаляем из обоих контейнеров
            ['chat-messages', 'slider-chat-messages'].forEach(containerId => {
                const typingIndicator = document.getElementById(`typing-indicator-${containerId}`);
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            });
        }

        // Дополнительные функции AI чата

        // Очистка истории чата
        function clearChatHistory() {
            chatHistory = [];
            const welcomeMessage = `
                <div class="message">
                    <div class="message-content">
                        <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                    </div>
                </div>
            `;

            // Очищаем оба контейнера
            const overlayMessages = document.getElementById('chat-messages');
            const sliderMessages = document.getElementById('slider-chat-messages');

            if (overlayMessages) overlayMessages.innerHTML = welcomeMessage;
            if (sliderMessages) sliderMessages.innerHTML = welcomeMessage;
        }

        // Функция для получения умного совета на основе прогресса
        async function getSmartTip() {
            const currentWorkoutDay = getCurrentWorkoutDay();
            const completion = calculateCompletionPercentage(currentWorkoutDay);
            let tipType = 'general';

            if (completion === 100) {
                tipType = 'motivation';
            } else if (completion > 50) {
                tipType = 'encouragement';
            } else if (completion > 0) {
                tipType = 'continuation';
            } else {
                tipType = 'start';
            }

            const prompt = `Дай короткий мотивирующий совет (${tipType}) для дня ${currentWorkoutDay}. Максимально 50 слов.`;
            return await generateAIResponse(prompt);
        }

        // Инициализация AI чата
        document.addEventListener('DOMContentLoaded', () => {
            // ===== Обработчики для OVERLAY чата (старый) =====
            const aiChatClose = document.getElementById('ai-chat-close');
            if (aiChatClose) {
                aiChatClose.addEventListener('click', closeAIChat);
            }

            // Обработчик очистки чата
            const aiChatClear = document.getElementById('ai-chat-clear');
            if (aiChatClear) {
                aiChatClear.addEventListener('click', () => {
                    if (confirm('Очистить всю историю чата?')) {
                        clearChatHistory();
                    }
                });
            }

            // Обработчик отправки сообщения для overlay чата
            const chatSend = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');

            if (chatSend) {
                chatSend.addEventListener('click', sendMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // ===== Обработчики для SLIDER чата =====
            const sliderChatSend = document.getElementById('slider-chat-send');
            const sliderChatInput = document.getElementById('slider-chat-input');

            if (sliderChatSend) {
                sliderChatSend.addEventListener('click', sendSliderMessage);
            }

            if (sliderChatInput) {
                sliderChatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendSliderMessage();
                    }
                });
            }

            // Обработчики свайпа для закрытия чата
            const aiChatOverlay = document.getElementById('ai-chat-overlay');
            if (aiChatOverlay) {
                aiChatOverlay.addEventListener('touchstart', (e) => {
                    const chatHeader = e.target.closest('.ai-chat-header');
                    if (chatHeader) {
                        chatTouchStartY = e.touches[0].clientY;
                        chatIsSwipingDown = false;
                    }
                }, { passive: true });

                aiChatOverlay.addEventListener('touchmove', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchY = e.touches[0].clientY;
                    const deltaY = touchY - chatTouchStartY;

                    // Проверяем, что свайп вниз
                    if (deltaY > 20) {
                        chatIsSwipingDown = true;

                        // Применяем трансформацию для визуальной обратной связи
                        const transform = Math.min(deltaY * 0.5, 100);
                        aiChatOverlay.style.transform = `translateY(${transform}px)`;
                        aiChatOverlay.style.opacity = 1 - (deltaY / 300);

                        // Предотвращаем скролл сообщений во время свайпа
                        e.preventDefault();
                    }
                }, { passive: false });

                aiChatOverlay.addEventListener('touchend', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchEndY = e.changedTouches[0].clientY;
                    const deltaY = touchEndY - chatTouchStartY;

                    // Сбрасываем стили
                    aiChatOverlay.style.transform = '';
                    aiChatOverlay.style.opacity = '';

                    // Проверяем, достаточно ли сильный свайп вниз для закрытия
                    if (deltaY > chatSwipeThreshold && chatIsSwipingDown) {
                        closeAIChat();
                    }

                    // Сбрасываем переменные
                    chatTouchStartY = 0;
                    chatTouchEndY = 0;
                    chatIsSwipingDown = false;
                }, { passive: true });
            }
        });

        // Функционал перетаскивания разделителя с плавной интерполяцией
        let isDragging = false;
        let startY = 0;
        let startTopHeight = 0;
        let rafId = null;
        let currentY = 0;

        // Переменные для плавной интерполяции (lerp)
        let targetHeight = 0;
        let currentHeight = 0;
        const lerpFactor = 0.18; // Плавное отставание для минимизации лагов

        // Кэшированные измерения для производительности
        let cachedMeasurements = {
            minTopHeight: 60,
            minBottomHeight: 200,
            dividerHeight: 0,
            viewportHeight: 0
        };

        const dividerButton = document.querySelector('.divider-button');
        const workoutSection = document.querySelector('.workout-section');
        const activitySection = document.querySelector('.activity-section');
        const divider = document.querySelector('.divider');

        // Кэшируем dayLabels (делаем один раз при инициализации)
        let cachedDayLabels = null;
        let hasCalendarChecked = false;

        // Устанавливаем начальную высоту после загрузки страницы
        setTimeout(() => {
            const viewportHeight = window.innerHeight;
            const baseHeight = 160;
            const additionalHeight = viewportHeight * 0.05;
            const initialHeight = baseHeight + additionalHeight;
            currentHeight = initialHeight;
            targetHeight = initialHeight;
            workoutSection.style.setProperty('--workout-basis', initialHeight + 'px');
        }, 100);

        // Кэшируем измерения при начале перетаскивания
        function cacheMeasurements() {
            cachedMeasurements.viewportHeight = window.innerHeight;
            cachedMeasurements.dividerHeight = divider.getBoundingClientRect().height;

            if (!hasCalendarChecked) {
                cachedDayLabels = document.querySelectorAll('.calendar-weekday, .day-label');
                hasCalendarChecked = true;
            }

            if (cachedDayLabels && cachedDayLabels.length > 0) {
                cachedMeasurements.minBottomHeight = cachedMeasurements.viewportHeight * 0.40;
            } else {
                const activityHeader = activitySection.querySelector('.activity-header');
                const headerHeight = activityHeader ? activityHeader.getBoundingClientRect().height : 60;
                cachedMeasurements.minBottomHeight = headerHeight + 250;
            }
        }

        // Вычисляем целевую высоту с ограничениями
        function calculateTargetHeight(clientY) {
            const deltaY = clientY - startY;
            let height = startTopHeight + deltaY;
            height = Math.max(cachedMeasurements.minTopHeight, height);
            height = Math.min(
                cachedMeasurements.viewportHeight - cachedMeasurements.dividerHeight - cachedMeasurements.minBottomHeight,
                height
            );
            return height;
        }

        // Плавная интерполяция (lerp)
        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }

        // Функция обновления через RAF (работает на 60fps автоматически)
        function updateFrame() {
            // Плавно двигаем текущую высоту к цели
            currentHeight = lerp(currentHeight, targetHeight, lerpFactor);

            // Применяем текущую высоту
            workoutSection.style.setProperty('--workout-basis', currentHeight + 'px');

            // Продолжаем цикл пока перетаскиваем
            if (isDragging) {
                rafId = requestAnimationFrame(updateFrame);
            }
        }

        // Обновляем целевую позицию
        function updateSizes(clientY) {
            currentY = clientY;
            targetHeight = calculateTargetHeight(clientY);
        }

        // Обработчики для мыши
        dividerButton.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            currentY = e.clientY;
            startTopHeight = workoutSection.getBoundingClientRect().height;
            currentHeight = startTopHeight;
            targetHeight = startTopHeight;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            document.body.classList.add('dragging-mode');
            workoutSection.classList.add('dragging');
            cacheMeasurements();
            // Запускаем постоянный цикл
            rafId = requestAnimationFrame(updateFrame);
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSizes(e.clientY);
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                document.body.classList.remove('dragging-mode');
                workoutSection.classList.remove('dragging');
                // Финальное обновление до точной позиции
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
                // Плавно доводим до конечной позиции
                const finishAnimation = () => {
                    const diff = Math.abs(targetHeight - currentHeight);
                    if (diff > 0.5) {
                        currentHeight = lerp(currentHeight, targetHeight, 0.2);
                        workoutSection.style.setProperty('--workout-basis', currentHeight + 'px');
                        requestAnimationFrame(finishAnimation);
                    } else {
                        workoutSection.style.setProperty('--workout-basis', targetHeight + 'px');
                    }
                };
                finishAnimation();
            }
        });

        // Обработчики для touch (мобильные устройства)
        dividerButton.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            currentY = e.touches[0].clientY;
            startTopHeight = workoutSection.getBoundingClientRect().height;
            currentHeight = startTopHeight;
            targetHeight = startTopHeight;
            document.body.classList.add('dragging-mode');
            workoutSection.classList.add('dragging');
            cacheMeasurements();
            // Запускаем постоянный цикл
            rafId = requestAnimationFrame(updateFrame);
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            updateSizes(e.touches[0].clientY);
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
                document.body.classList.remove('dragging-mode');
                workoutSection.classList.remove('dragging');
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
                // Финальная доводка
                const finishAnimation = () => {
                    const diff = Math.abs(targetHeight - currentHeight);
                    if (diff > 0.5) {
                        currentHeight = lerp(currentHeight, targetHeight, 0.2);
                        workoutSection.style.setProperty('--workout-basis', currentHeight + 'px');
                        requestAnimationFrame(finishAnimation);
                    } else {
                        workoutSection.style.setProperty('--workout-basis', targetHeight + 'px');
                    }
                };
                finishAnimation();
            }
        });

        // Предотвращаем выделение текста при клике на кнопку
        dividerButton.addEventListener('selectstart', (e) => {
            e.preventDefault();
        });

        // ===== ПРИВЕТСТВЕННЫЙ ЭКРАН (Welcome Screen) =====
        const welcomeScreen = document.getElementById('welcome-screen');
        const welcomeContent = document.getElementById('welcome-content');
        const welcomePulse = document.getElementById('welcome-pulse');
        const welcomeLoading = document.getElementById('welcome-loading');
        const pricingBlock = document.getElementById('pricing-block');
        const pricingBuyBtn = document.getElementById('pricing-buy-btn');
        const clearCacheBtn = document.getElementById('clear-cache-btn');

        // Обработчик кнопки сброса кэша (для тестирования)
        if (clearCacheBtn) {
            function clearCache() {
                localStorage.removeItem('fitTrackerSubscriptionCache');
                localStorage.removeItem('fitTrackerCelebrationShown');
                localStorage.removeItem('fitTrackerJustPurchased');
                window.hasSubscription = null;
                window.isSubscribed = undefined;
                console.log('🗑️ Кэш подписки и поздравления очищен');
                location.reload();
            }

            clearCacheBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                clearCache();
            });

            clearCacheBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                clearCache();
            });
        }

        // Состояние: показан ли pricing block
        let pricingShown = false;

        // Функция показа pricing block
        function showPricingBlock() {
            if (!welcomeContent || !pricingBlock) return;

            pricingShown = true;
            welcomeContent.classList.add('has-pricing');
            pricingBlock.classList.add('show');

            // Haptic feedback
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }
        }

        // Функция закрытия приветственного экрана
        function closeWelcomeScreen() {
            if (!welcomeScreen) return;

            // Добавляем класс для плавного исчезновения
            welcomeScreen.classList.add('hidden');

            // После завершения анимации скрываем элемент
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
            }, 600); // Соответствует transition duration

            // Telegram haptic feedback
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }

        // Обработчик клика/тапа на приветственном экране (показать pricing или закрыть)
        if (welcomeScreen && !pricingShown) {
            // Флаг что подписка проверяется (для предотвращения повторных кликов)
            let subscriptionCheckInProgress = false;

            // Функция для обработки клика с проверкой подписки
            async function handleWelcomeScreenClick(e) {
                // Если клик на pricing buy button - не обрабатываем здесь
                if (e.target === pricingBuyBtn || pricingBuyBtn?.contains(e.target)) {
                    return;
                }

                // Если уже проверяем подписку - игнорируем повторные клики
                if (subscriptionCheckInProgress) {
                    console.log('⏳ Проверка подписки уже выполняется...');
                    return;
                }

                // Показываем анимацию загрузки при первом клике
                if (welcomePulse && welcomeLoading) {
                    welcomePulse.style.display = 'none';
                    welcomeLoading.classList.add('active');
                }

                // Если статус подписки ещё не известен (undefined), проверяем его сейчас
                if (window.isSubscribed === undefined) {
                    subscriptionCheckInProgress = true;
                    console.log('🔍 Статус подписки неизвестен, выполняем проверку...');

                    const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
                    const telegramId = user?.id;

                    if (telegramId && typeof checkSubscriptionStatus === 'function') {
                        try {
                            const isSubscribed = await checkSubscriptionStatus(telegramId);
                            window.isSubscribed = isSubscribed;
                            console.log('📊 Статус подписки при клике:', isSubscribed ? 'АКТИВНА' : 'НЕАКТИВНА');
                        } catch (error) {
                            console.error('❌ Ошибка проверки подписки:', error);
                            window.isSubscribed = false;
                        }
                    } else {
                        window.isSubscribed = false;
                    }

                    subscriptionCheckInProgress = false;
                }

                // Если подписка уже есть - проверяем флаг поздравления
                if (window.isSubscribed) {
                    console.log('✅ Подписка активна, открываем главный экран');

                    // Проверяем, не показывали ли уже поздравление
                    const celebrationAlreadyShown = localStorage.getItem('fitTrackerCelebrationShown');
                    console.log('🔍 celebrationAlreadyShown:', celebrationAlreadyShown);

                    if (celebrationAlreadyShown) {
                        console.log('⏭️ Поздравление уже было показано ранее, пропускаем');
                        // Удаляем старый флаг "только что куплено" если остался
                        localStorage.removeItem('fitTrackerJustPurchased');
                        closeWelcomeScreen();
                        return;
                    }

                    // Проверяем флаг "только что куплено"
                    const justPurchasedFlag = localStorage.getItem('fitTrackerJustPurchased');
                    console.log('🔍 justPurchasedFlag:', justPurchasedFlag);

                    if (justPurchasedFlag) {
                        try {
                            const flagData = JSON.parse(justPurchasedFlag);
                            console.log('📦 flagData:', flagData);
                            // Проверяем, что флаг принадлежит текущему пользователю
                            const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
                            console.log('👤 Current user telegramId:', user?.id);
                            console.log('🆔 Flag telegramId:', flagData.telegramId);

                            if (flagData.telegramId === user?.id) {
                                // Удаляем флаг "только что куплено"
                                localStorage.removeItem('fitTrackerJustPurchased');
                                // Устанавливаем флаг что поздравление показано
                                localStorage.setItem('fitTrackerCelebrationShown', 'true');
                                console.log('🎉 Показываем поздравительное окно подписки (первый и последний раз)');
                                // Закрываем welcome screen и показываем поздравление
                                closeWelcomeScreen();
                                setTimeout(() => {
                                    showSubscriptionCelebration();
                                }, 600);
                                return;
                            } else {
                                console.log('❌ TelegramId не совпадает, пропускаем поздравление');
                            }
                        } catch (e) {
                            console.error('❌ Ошибка чтения fitTrackerJustPurchased:', e);
                            localStorage.removeItem('fitTrackerJustPurchased');
                        }
                    } else {
                        console.log('❌ Флаг fitTrackerJustPurchased не найден');
                    }

                    // Обычное закрытие без поздравления
                    console.log('🚪 Обычное закрытие welcome screen без поздравления');
                    closeWelcomeScreen();
                    return;
                }

                // Если подписки нет - показываем pricing block
                if (!pricingShown) {
                    showPricingBlock();
                }
            }

            // Поддержка как клика мышкой, так и тача
            welcomeScreen.addEventListener('click', handleWelcomeScreenClick);
            welcomeScreen.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleWelcomeScreenClick(e);
                e.stopPropagation();
            });
        }

        // Обработчик кнопки "Перейти к оплате" - обрабатывается в purchase.js

        // ===== FEATURES MODAL =====
        const featuresModal = document.getElementById('features-modal');
        const featuresModalClose = document.getElementById('features-modal-close');
        const pricingShowMore = document.getElementById('pricing-show-more');

        // Открытие модального окна
        function openFeaturesModal() {
            if (!featuresModal) return;
            featuresModal.classList.add('show');
            // Haptic feedback
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }

        // Закрытие модального окна
        function closeFeaturesModal() {
            if (!featuresModal) return;
            featuresModal.classList.remove('show');
        }

        // Обработчик кнопки "Показать больше"
        if (pricingShowMore) {
            pricingShowMore.addEventListener('click', (e) => {
                e.stopPropagation();
                openFeaturesModal();
            });
            pricingShowMore.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openFeaturesModal();
            });
        }

        // Обработчик закрытия модального окна
        if (featuresModalClose) {
            featuresModalClose.addEventListener('click', closeFeaturesModal);
            featuresModalClose.addEventListener('touchend', (e) => {
                e.preventDefault();
                closeFeaturesModal();
            });
        }

        // Закрытие по клику вне контента
        if (featuresModal) {
            featuresModal.addEventListener('click', (e) => {
                if (e.target === featuresModal) {
                    closeFeaturesModal();
                }
            });
        }

    </script>

    <!-- Подключение Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js?v=99"></script>
    <script src="purchase.js?v=102"></script>
</body>

</html>