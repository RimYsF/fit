<!DOCTYPE html>
<html lang="ru" class="no-swipe-navigation">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="MobileOptimized" content="176" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="robots" content="noindex,nofollow" />
    <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
    <title>FitTracker AI</title>
    <style>
        :root {
            /* Яркая палитра необрутализма */
            --neobrut-black: #000000;
            --neobrut-white: #FFFFFF;
            --neobrut-orange: #FF6B35;
            --neobrut-red: #FF006E;
            --neobrut-yellow: #FFBE0B;
            --neobrut-blue: #3A86FF;
            --neobrut-green: #06FFB4;
            --neobrut-purple: #8338EC;
            --neobrut-pink: #FF4081;
            --neobrut-gray: #495057;
            --neobrut-lightgray: #F8F9FA;
            --neobrut-darkgray: #212529;
            --neobrut-cream: #FFFDE7;
            --success-green: #00F5A0;
            --warning-yellow: #FFD23F;
            --bg-grid: #F1F3F5;
            --accent-blue: #4ECDC4;
            --accent-purple: #C77DFF;
            --accent-coral: #FF6B9D;
            /* Новая цветовая схема для активности */
            --lime-green: #D4ED4A;
            --light-green: #98D98E;
            --medium-green: #3CB371;
            --swamp-green: #2F5233;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--neobrut-lightgray);
            color: var(--neobrut-darkgray);
            min-height: 100vh;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overflow-x: hidden;
            width: 100%;
        }

        /* Предотвращение свайп-навигации в мобильных браузерах */
        html.no-swipe-navigation,
        html.no-swipe-navigation body {
            overscroll-behavior-x: none;
            touch-action: pan-y pinch-zoom;
        }

        /* Глобальное скрытие scrollbar для всех элементов */
        *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Глобальный фон на весь экран */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('fantasy-bg-new.jpg') center/cover no-repeat;
            z-index: -1;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        /* Верхняя секция с прокруткой тренировок */
        .workout-section {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-bottom: 4px solid var(--neobrut-black);
            padding: 0;
            position: relative;
            box-shadow: 8px 8px 0 var(--neobrut-black);
            flex-shrink: 0;
            flex-basis: var(--workout-basis, auto);
            overflow-y: auto;
            min-height: 50px;
            /* Резервируем место под скроллбар чтобы не прыгало при перетаскивании */
            scrollbar-gutter: stable;
            transition: box-shadow 0.15s ease, backdrop-filter 0.15s ease;
        }

        /* Оптимизация при перетаскивании */
        .workout-section.dragging {
            backdrop-filter: none;
            box-shadow: none;
            will-change: --workout-basis;
            contain: strict;
            transition: none;
            z-index: 1;
            overflow-y: hidden;
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .workout-section.dragging * {
            will-change: transform;
            transform: translateZ(0);
        }

        .workout-header {
            padding: 0;
            display: none; /* Скрываем пустой header */
        }

        .workout-title {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
        }

        .workout-counter {
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 8px;
            color: var(--neobrut-black);
            transform: rotate(-2deg);
        }

        /* Контейнер с горизонтальной прокруткой */
        .workout-carousel {
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .workout-track {
            display: flex;
            gap: 20px;
            padding: 0 40px;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
        }

        .workout-track::-webkit-scrollbar {
            display: none;
        }

        /* Блоки тренировок - Квадратные пустые в стиле необрутализма */
        .workout-block {
            flex: 0 0 150px;
            width: 150px;
            height: 150px;
            background: var(--neobrut-white);
            border: 4px solid var(--neobrut-black);
            border-radius: 16px;
            box-shadow:
                8px 8px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0,0,0,0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            opacity: 0.8;
            transform: scale(0.95) rotate(-2deg);
            scroll-snap-align: center;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Базовые элементы */
        .workout-block {
            opacity: 0.8;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .workout-block:hover {
            background: var(--neobrut-white);
            transform: translateY(-2px);
            box-shadow:
                8px 8px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0,0,0,0.1);
        }

        .workout-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-8deg);
            width: 60px;
            height: 60px;
            background: var(--neobrut-orange);
            border: 3px solid var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            color: var(--neobrut-white);
            border-radius: 12px;
            z-index: 2;
        }

        .workout-day {
            position: absolute;
            bottom: 20px;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            letter-spacing: 0.05em;
            text-align: center;
            width: 100%;
        }

        /* Декоративные элементы для пустых блоков */
        .workout-block::before {
            content: '';
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 2px solid var(--neobrut-black);
            border-radius: 50%;
            box-shadow: 2px 2px 0 var(--neobrut-black);
            opacity: 0.8;
        }

      
        /* Todo-список в стиле необрутализма */
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Убираем синюю подсветку для всех интерактивных элементов */
        .todo-list * {
            outline: none !important;
        }

        .todo-list *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Отключаем выделение текста при клике */
        .todo-item,
        .todo-subitem,
        .todo-text,
        .todo-expand,
        .todo-checkbox {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Дополнительно отключаем подсветку при клике на мобильных */
        @media (hover: none) and (pointer: coarse) {
            .todo-item:active,
            .todo-subitem:active,
            .todo-expand:active {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--neobrut-lightgray);
            border: 3px solid var(--neobrut-black);
            box-shadow: 5px 5px 0 var(--neobrut-black);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .todo-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0 var(--neobrut-black);
        }

        .todo-item.completed {
            opacity: 0.7;
            background: var(--success-green);
        }

        .todo-checkbox {
            position: relative;
            width: 24px;
            height: 24px;
            margin-right: 15px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .todo-checkbox input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .checkbox-visual {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .todo-checkbox input:checked ~ .checkbox-visual {
            background: var(--neobrut-yellow);
            transform: rotate(-5deg);
        }

        .checkbox-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 14px;
            height: 10px;
            border-left: 3px solid var(--neobrut-black);
            border-bottom: 3px solid var(--neobrut-black);
            transition: transform 0.2s;
        }

        .todo-checkbox input:checked ~ .checkbox-checkmark {
            transform: translate(-50%, -50%) rotate(-45deg) scale(1);
        }

        .todo-text {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            user-select: none;
            cursor: pointer;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Исключаем время из зачеркивания */
        .todo-item.completed .todo-text .task-time-inline {
            text-decoration: none !important;
            display: inline-block;
        }

        .task-time {
            font-size: 11px;
            color: var(--accent-blue);
            margin-left: 8px;
            white-space: nowrap;
            font-weight: 500;
        }

        .task-time-inline {
            font-size: 13px;
            color: var(--neobrut-black);
            opacity: 0.9;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Подпункты */
        .todo-sublist {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            display: none; /* Скрыты по умолчанию */
        }

        .todo-sublist.expanded {
            display: block;
        }

        .todo-subitem {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-gray);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
            font-size: 14px;
        }

        .todo-subitem:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-subitem .todo-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            margin-top: 1px;
        }

        .todo-subitem .checkbox-visual {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .todo-subitem .checkbox-checkmark {
            width: 10px;
            height: 8px;
            border-width: 2px;
        }

        .todo-subitem .todo-text {
            font-size: 14px;
            font-weight: 500;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .todo-subitem.completed {
            opacity: 0.7;
            background: var(--success-green) !important;
        }

        .todo-subitem.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Маркер для подпунктов */
        .todo-bullet {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--neobrut-gray);
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            margin-top: 6px;
        }

        /* Кнопка раскрытия */
        .todo-expand {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            margin-left: 10px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .todo-expand:hover {
            transform: scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-expand:active {
            transform: scale(0.95) rotate(180deg);
        }

        .todo-expand svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .todo-expand.expanded svg {
            transform: rotate(180deg);
        }

        /* Обертка для текста с кнопкой */
        .todo-text-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Сдвинутый влево текст без чекбокса */
        .todo-text-shifted {
            justify-content: flex-start;
            margin-left: 0;
        }

        .todo-text-shifted .todo-text {
            flex: 1;
            cursor: pointer;
        }

        /* Сообщение об отсутствии заданий */
        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            font-size: 20px;
            font-weight: 700;
            color: var(--neobrut-gray);
            background: var(--neobrut-lightgray);
            border: 3px dashed var(--neobrut-gray);
            border-radius: 12px;
        }

        /* Мобильная адаптация режима задач */
        @media (max-width: 768px) {
            .workout-section.show-todos #todo-content {
                padding: 10px;
                height: 190px; /* Финальная высота для лучшего отображения */
            }

            .workout-section.show-todos .workout-title {
                font-size: 20px;
            }

            .workout-section.show-todos .todo-item {
                margin-bottom: 10px;
                padding: 8px;
            }

            .workout-section.show-todos .todo-text {
                font-size: 14px;
            }
        }

        /* Режим отображения задач в верхней секции */
        .workout-section.show-todos {
            /* Секция остается того же размера, что и с каруселью */
            display: flex;
            flex-direction: column;
            padding: 0; /* Убираем вертикальные отступы */
        }

        .workout-section.show-todos .workout-header {
            background: var(--neobrut-yellow);
            border-bottom: 5px solid var(--neobrut-black);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 0 var(--neobrut-black);
            flex-shrink: 0;
        }

        .workout-section.show-todos .workout-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 60px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            transform: rotate(-5deg);
        }

        .workout-section.show-todos .workout-title {
            font-size: 24px;
        }

        .workout-section.show-todos .workout-carousel {
            display: none;
        }

        
        /* Базовые стили для контента задач */
        #todo-content {
            display: none;
            overflow-y: auto;
        }

        /* Переопределяем display для режима задач (большая специфичность) */
        .workout-section.show-todos #todo-content {
            display: block !important;
            padding: 15px;
            background: var(--neobrut-white);
            overflow-y: auto;
            overflow-x: hidden;
            height: 190px; /* Финальная высота для лучшего отображения */
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
            /* Убираем flex чтобы height работал */
            flex: none;
        }

        /* Уменьшаем размер элементов задач в компактном режиме */
        .workout-section.show-todos .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .workout-section.show-todos .todo-text {
            font-size: 16px;
        }

        .workout-section.show-todos .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
        }

        .workout-section.show-todos .checkbox-visual {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .workout-section.show-todos .checkbox-checkmark {
            width: 12px;
            height: 10px;
            border-width: 2px;
        }

        .todos-back-btn {
            width: 40px;
            height: 40px;
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.2s;
            transform: rotate(0deg);
        }

        .todos-back-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--neobrut-orange);
        }

        .todos-back-btn:active {
            transform: rotate(90deg) scale(0.95) translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Overlay модальное окно для задач */
        .todo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-bottom: 4px solid var(--neobrut-black);
        }

        .todo-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .todo-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .todo-modal-header {
            background: var(--neobrut-yellow);
            padding: 7.5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .todo-modal-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin: 0;
        }

        .todo-modal-close {
            width: 20px;
            height: 20px;
            background: var(--neobrut-red);
            border: 1.5px solid var(--neobrut-black);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
            transition: all 0.2s;
        }

        .todo-modal-close:hover {
            transform: scale(1.1);
            background: var(--neobrut-orange);
        }

        .todo-modal-close:active {
            transform: scale(0.95) translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .todo-modal-content {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
            /* Резервируем место под скроллбар чтобы не прыгало при ресайзе */
            scrollbar-gutter: stable;
        }

        /* Уменьшаем все элементы задач внутри модального окна на 5% (почти полный размер) */
        .todo-modal-content {
            transform: scale(0.95);
            transform-origin: top left;
            height: 105%;
        }

        .todo-modal-content .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .todo-modal-content .todo-text {
            font-size: 16px;
            line-height: 1.3;
        }

        .todo-modal-content .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
            border-width: 3px;
            border-radius: 6px;
        }

        .todo-modal-content .todo-checkbox::after {
            top: -3px;
            left: 3px;
            width: 8px;
            height: 15px;
            border-width: 3px;
            border-radius: 2px;
        }

        .todo-modal-content .subtask-list {
            margin-left: 32px;
            margin-top: 8px;
        }

        .todo-modal-content .subtask-item {
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 14px;
            border-width: 2px;
            border-radius: 8px;
        }

        .todo-modal-content .todo-expand {
            width: 14px;
            height: 14px;
            margin-left: 5px;
            border-width: 1.5px;
            border-radius: 4px;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
        }

        .todo-modal-content .chevron {
            width: 0;
            height: 0;
            border-left: 4px solid var(--neobrut-black);
            border-top: 2.5px solid transparent;
            border-bottom: 2.5px solid transparent;
            margin-top: 3px;
            transition: transform 0.2s;
        }

        .todo-modal-content .todo-bullet {
            width: 4px;
            height: 4px;
            margin-right: 4px;
            margin-top: 3px;
        }

        /* ===== КАРТОЧКА УПРАЖНЕНИЯ ===== */
        .exercise-card {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 200;
            display: flex;
            flex-direction: column;
            /* Скрыта по умолчанию - не перехватывает клики и не видна */
            visibility: hidden;
            pointer-events: none;
            /* GPU-ускорение: translate3d создаёт отдельный слой */
            transform: translate3d(100%, 0, 0);
            /* will-change подсказывает браузеру оптимизировать transform */
            will-change: transform;
            /* Плавная spring-анимация на CPU (cubic-bezier) */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        visibility 0s linear 0.4s;
        }

        .exercise-card.show {
            /* Видима и интерактивна когда открыта */
            visibility: visible;
            pointer-events: auto;
            transform: translate3d(0, 0, 0);
            /* Показываем сразу без задержки */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .exercise-card.hide {
            transform: translate3d(-100%, 0, 0);
        }

        .exercise-card-header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--neobrut-black);
            /* 3D объём через многослойные тени (GPU) */
            box-shadow:
                0 4px 0 var(--neobrut-black),
                0 6px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
            /* Фиксируем слой для оптимизации */
            transform: translate3d(0, 0, 0);
        }

        .exercise-card-title {
            font-size: 13px;
            font-weight: 900;
            color: var(--neobrut-white);
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .exercise-card-close {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Многослойные тени для 3D эффекта */
            box-shadow:
                3px 3px 0 var(--neobrut-black),
                0 4px 8px rgba(0, 0, 0, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            /* GPU-ускорённые трансформации */
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            flex-shrink: 0;
            will-change: transform;
        }

        .exercise-card-close:hover {
            /* Только трансформация, без layout изменений */
            transform: translate3d(0, -1px, 0) scale(1.05);
            background: linear-gradient(135deg, #ff8c00 0%, #ff7b00 100%);
            box-shadow:
                4px 4px 0 var(--neobrut-black),
                0 6px 12px rgba(0, 0, 0, 0.25),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .exercise-card-close:active {
            /* Нажатие - сдвиг вниз и уменьшение */
            transform: translate3d(1px, 2px, 0) scale(0.95);
            box-shadow:
                1px 1px 0 var(--neobrut-black),
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .exercise-card-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            /* Резервируем место под скроллбар чтобы не прыгало при ресайзе */
            scrollbar-gutter: stable;
            /* Оптимизация скролла через GPU */
            transform: translate3d(0, 0, 0);
        }

        .exercise-text {
            font-size: 17px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            line-height: 1.6;
            flex: 1;
            /* Анимация появления текста */
            animation: textFadeIn 0.3s ease-out;
            /* Подсвечка для глубины */
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        @keyframes textFadeIn {
            from {
                opacity: 0;
                transform: translate3d(0, 10px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .exercise-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-top: 3px solid var(--neobrut-black);
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            /* Внутренняя тень для углубления */
            box-shadow:
                inset 0 4px 8px rgba(0, 0, 0, 0.05),
                0 -4px 12px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
            transform: translate3d(0, 0, 0);
        }

        .exercise-dots {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .exercise-dot {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%);
            border-radius: 50%;
            /* GPU-ускорённая трансформация */
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
                        background 0.3s ease,
                        box-shadow 0.3s ease;
            /* Лёгкая тень для объёма */
            box-shadow:
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.1);
            will-change: transform;
        }

        .exercise-dot.active {
            /* Увеличение активной точки через transform */
            transform: translate3d(0, 0, 0) scale(1.6);
            background: linear-gradient(135deg, #ffffff 0%, #f1f3f5 100%);
            border: 3px solid var(--neobrut-black);
            /* Более яркая тень для акцента */
            box-shadow:
                inset 0 -3px 6px rgba(0, 0, 0, 0.15),
                inset 0 3px 6px rgba(255, 255, 255, 0.8),
                0 0 0 4px rgba(74, 144, 226, 0.15),
                0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .exercise-dot.completed {
            background: linear-gradient(135deg, #00f5a0 0%, #00d47a 100%);
            box-shadow:
                inset 0 -2px 4px rgba(0, 0, 0, 0.15),
                inset 0 2px 4px rgba(255, 255, 255, 0.4),
                0 2px 6px rgba(0, 245, 160, 0.4);
            /* Анимация завершения */
            animation: dotPulse 0.4s ease-out;
        }

        @keyframes dotPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Кнопка-галочка с круговым прогрессом */
        .exercise-check-btn {
            width: 44px;
            height: 44px;
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
            /* Оптимизация: создаём отдельный слой */
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        .exercise-check-svg {
            width: 100%;
            height: 100%;
            /* GPU-ускорённый transform */
            transform: rotate(-90deg) translate3d(0, 0, 0);
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.15));
        }

        .exercise-check-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 3.5;
        }

        .exercise-check-progress {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 3.5;
            stroke-linecap: round;
            /* Плавная анимация прогресса */
            transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .exercise-check-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            /* GPU-ускорённый центрирование */
            transform: translate3d(-50%, -50%, 0);
            font-size: 20px;
            font-weight: 900;
            color: var(--neobrut-black);
            pointer-events: none;
            /* Плавная анимация цвета и масштаба */
            transition: color 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .exercise-check-btn.completed .exercise-check-icon {
            color: var(--success-green);
            transform: translate3d(-50%, -50%, 0) scale(1.2);
            /* Тень для зелёной галочки */
            filter: drop-shadow(0 0 8px rgba(0, 245, 160, 0.6));
        }

        /* Hover эффект для кнопки галочки */
        .exercise-check-btn:hover {
            transform: translate3d(0, -2px, 0) scale(1.05);
        }

        .exercise-check-btn:active {
            transform: translate3d(0, 1px, 0) scale(0.95);
        }

        /* Индикатор количества упражнений (например, 2/5) */
        .exercise-counter {
            font-size: 11px;
            font-weight: 800;
            color: var(--neobrut-white);
            opacity: 0.95;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            /* Внутренняя тень для глубины */
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* ===== КОНЕЦ КАРТОЧКИ УПРАЖНЕНИЯ ===== */

        /* Горизонтальный разделитель с кнопкой */
        .divider {
            height: 4px;
            background: var(--neobrut-black);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .divider-button {
            width: 60px;
            height: 20px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            cursor: pointer;
            transition: background 0.2s ease, box-shadow 0.2s ease;
            z-index: 1;
            will-change: transform;
            touch-action: none;
        }

        .divider-button:hover {
            transform: translate(-50%, -50%) scale(1.05);
            background: var(--neobrut-orange);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .divider-button:active {
            transform: translate(-50%, -50%) scale(0.95);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Нижняя секция с активностью */
        .activity-section {
            padding: 10px 15px;
            background: linear-gradient(
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.3)
            );
            display: flex;
            flex-direction: column;
            flex: 1;
            box-shadow: 0 -4px 0 var(--neobrut-black);
            min-height: 0;
            position: relative;
        }

        .activity-header {
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 0;
            position: relative;
        }

        .activity-title {
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
            margin: 0;
            padding: 6px 12px 0 12px;
            z-index: 1;
        }

        .activity-legend {
            display: flex;
            gap: 10px;
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Вертикальная сетка активности */
        .activity-grid-vertical {
            background: rgba(255, 255, 255, 0.7);
            border: 4px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 6px 6px 0 var(--neobrut-black);
            margin-top: 0;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            height: 100%;
            pointer-events: auto;
        }

        /* Мобильная адаптация */
        @media (max-width: 480px) {
            .activity-grid-vertical {
                padding: 12px;
                min-height: 200px;
                height: 100%;
                margin-top: 0;
            }
        }

        /* Слайдер для календарей */
        .activity-slider {
            display: flex;
            gap: 0;
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            pointer-events: auto;
        }

        .calendar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease-out;
            pointer-events: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .calendar-container:nth-child(1) {
            transform: translateX(-100%);
        }

        .calendar-container:nth-child(2) {
            transform: translateX(0);
            z-index: 1;
        }

        .calendar-container:nth-child(3) {
            transform: translateX(100%);
        }

        .calendar-container.empty-calendar {
            opacity: 0.3;
        }

        .calendar-container.empty-calendar .calendar-months {
            pointer-events: none;
        }

        /* Секция заданий */
        .calendar-container.tasks-calendar {
            overflow: hidden;
        }

        .tasks-container {
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
        }

        /* Виджет дня задачи */
        .task-day-widget {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .task-day-widget:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--neobrut-black);
        }

        .task-day-widget:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .task-day-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .task-day-name {
            font-size: 16px;
            font-weight: 900;
            color: var(--neobrut-black);
            text-transform: uppercase;
        }

        .task-day-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--neobrut-gray);
        }

        /* Контейнер круга сложности */
        .task-difficulty-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-difficulty-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--neobrut-gray);
        }

        /* SVG круг сложности */
        .task-difficulty-circle {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .task-difficulty-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .task-difficulty-circle .circle-bg {
            fill: none;
            stroke: var(--bg-grid);
            stroke-width: 4;
        }

        .task-difficulty-circle .circle-progress {
            fill: none;
            stroke: var(--neobrut-orange);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .calendar-wrapper {
            overflow: visible;
            height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .calendar-months {
            height: 100%;
            overflow-y: visible;
            overflow-x: visible;
        }

        .calendar-month {
            margin-bottom: 12px;
        }

        .calendar-month-header {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 6px;
            color: var(--neobrut-black);
            background: rgba(255, 190, 11, 0.8);
            border: 3px solid var(--neobrut-black);
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: inline-block;
            transform: rotate(-1deg);
        }

        .calendar-week {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            overflow: visible;
            width: 100%;
        }

        .calendar-weekday {
            font-size: 10px;
            font-weight: 700;
            color: var(--neobrut-gray);
            flex: 1;
            text-align: center;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .activity-cell {
            flex: 1;
            height: 18px;
            min-width: 0;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            cursor: default;
            transition: all 0.2s;
            position: relative;
            touch-action: manipulation;
        }

        /* Эффекты для ячеек с активностью */
        .activity-cell:not(.empty) {
            cursor: pointer;
        }

        .activity-cell:not(.empty):hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            z-index: 10;
        }

        .activity-cell:not(.empty):active {
            transform: translateY(0) scale(0.98);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .activity-cell.empty {
            background: transparent;
            border-color: transparent;
            cursor: default;
        }

        .activity-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        /* Уровни активности - Зеленая градация */
        .activity-cell[data-activity="none"] {
            background: var(--neobrut-lightgray);
        }

        .activity-cell[data-activity="low"] {
            background: var(--lime-green);
        }

        .activity-cell[data-activity="medium"] {
            background: var(--light-green);
        }

        .activity-cell[data-activity="high"] {
            background: var(--medium-green);
        }

        .activity-cell[data-activity="max"] {
            background: var(--swamp-green);
        }

        .activity-cell .date-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 700;
            color: var(--neobrut-black);
            opacity: 0.7;
        }

        /* Делаем текущий день постоянно выпирающим (3D-эффект) */
        .activity-cell.today {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border: 2px solid var(--neobrut-black);
            z-index: 10;
        }

        /* Для текущего дня убираем эффекты наведения и нажатия */
        .activity-cell.today:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .activity-cell.today:active {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        /* Исключаем пустые ячейки из 3D-эффекта */
        .activity-cell.today.empty {
            transform: none;
            box-shadow: none;
            border: 2px solid transparent;
        }

        /* Нижняя панель с элементами управления */
        .year-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reset-btn {
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            padding: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            color: var(--neobrut-white);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 0 var(--neobrut-black);
            background: #FF0040;
        }

        .reset-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .year-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .current-year {
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            background: var(--neobrut-blue);
            padding: 8px 16px;
            border: 3px solid var(--neobrut-black);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        /* Контейнер для GitHub-стиль таблицы */
        .contribution-graph {
            font-size: 10px;
            color: #57606a;
            position: relative;
        }

        /* Стили для SVG элементов - GitHub стиль */
        .contribution-calendar {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .calendar-graph {
            padding: 5px 0 0;
            text-align: center;
        }

        .calendar-graph svg {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Месяцы */
        .month-label {
            font-size: 10px;
            fill: var(--neobrut-gray);
            font-weight: 600;
        }

        /* Дни недели */
        .day-label {
            font-size: 9px;
            fill: var(--neobrut-gray);
            font-weight: 500;
            text-anchor: start;
        }

        /* Ячейки активности */
        .contribution-day {
            shape-rendering: geometricPrecision;
            stroke: rgba(27, 31, 35, 0.04);
            stroke-width: 1px;
            rx: 2;
            ry: 2;
        }

        .contribution-day:hover {
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 2px;
        }

        /* Уровни активности - Яркие цвета необрутализма */
        .contribution-day[data-level="0"] {
            fill: var(--neobrut-lightgray);
            stroke: var(--neobrut-gray);
        }

        .contribution-day[data-level="1"] {
            fill: var(--warning-yellow);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="2"] {
            fill: var(--neobrut-orange);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="3"] {
            fill: var(--neobrut-pink);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="4"] {
            fill: var(--accent-purple);
            stroke: var(--neobrut-black);
        }

        /* Сегодняшний день */
        .contribution-day.today {
            stroke: var(--neobrut-orange);
            stroke-width: 2px;
        }

        /* Tooltip */
        .tip {
            position: absolute;
            z-index: 100;
            font-size: 11px;
            line-height: 1.4;
            font-weight: 400;
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 5px 8px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tip.show {
            opacity: 1;
        }

        /* Мобильная оптимизация для очень маленьких экранов */
        @media (max-width: 390px) {
            .workout-title {
                font-size: 20px;
            }

            .activity-title {
                font-size: 18px;
            }

            .workout-block {
                flex: 0 0 130px;
                width: 130px;
                height: 130px;
            }
        }

        /* Отключаем hover-эффекты на мобильных устройствах при свайпе */
        @media (hover: none) and (pointer: coarse) {
            .workout-block:hover {
                background: var(--neobrut-white);
                box-shadow:
                    6px 6px 0 var(--neobrut-black),
                    inset 2px 2px 0 rgba(0,0,0,0.1);
            }
        }

        /* Анимация появления */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-section,
        .activity-section {
            animation: slideIn 0.5s ease-out;
        }

        .activity-section {
            animation-delay: 0.1s;
        }

        /* Tooltip для дня активности */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(45, 52, 54, 0.2);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--neobrut-darkgray);
        }

        .day-cell:hover .tooltip {
            opacity: 1;
        }

        /* AI Chat Modal стили */
        .ai-chat-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .ai-chat-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .ai-chat-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-header {
            background: var(--neobrut-white);
            padding: 25px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            cursor: grab;
            touch-action: pan-y;
        }

        .ai-chat-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-chat-header:active {
            cursor: grabbing;
        }

        .ai-chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            margin: 0;
        }

        .ai-chat-close,
        .ai-chat-clear {
            width: 30px;
            height: 30px;
            background: var(--neobrut-white);
            border: 1px solid var(--neobrut-gray);
            border-radius: 4px;
            font-size: 16px;
            font-weight: 400;
            color: var(--neobrut-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-chat-clear:hover {
            background: var(--neobrut-red);
            color: white;
            border-color: var(--neobrut-black);
        }

        .ai-chat-close {
            display: none; /* Скрываем кнопку закрытия */
        }

        .ai-chat-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            background: var(--neobrut-white);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            animation: messageSlide 0.2s ease-out;
        }

        .message:last-child {
            border-bottom: none;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--neobrut-darkgray);
            word-wrap: break-word;
        }

        .user-message {
            background: rgba(78, 205, 196, 0.1);
        }

        .user-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.5);
        }

        .ai-message .message-content {
            color: #333;
        }

        .message-content p {
            margin: 0;
        }

        /* Стили для форматированного AI контента */
        .ai-message .message-content h3 {
            color: var(--accent-blue);
            margin: 12px 0 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .ai-message .message-content strong {
            color: var(--neobrut-darkgray);
            font-weight: 600;
        }

        .ai-message .message-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item {
            margin: 8px 0 8px 20px;
            position: relative;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-size: 1.2em;
            top: -2px;
        }

        .ai-message .message-content span[style*="font-size: 1.2em"] {
            vertical-align: middle;
        }

        .chat-input-container {
            display: flex;
            padding: 16px 20px;
            background: var(--neobrut-white);
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 400;
            background: var(--neobrut-white);
            outline: none;
            margin-right: 12px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--neobrut-gray);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-send {
            width: auto;
            min-width: 60px;
            height: 36px;
            background: var(--neobrut-black);
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0 16px;
        }

        .chat-send:hover {
            background: #333;
        }

        .chat-send:active {
            background: #000;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }

        /* Typing Indicator Styles */
        .typing-indicator {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dots .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ===== НЕОБРУТАЛИСТИЧЕСКИЙ ЧАТ В СЛАЙДЕРЕ ===== */

        /* Контейнер чата в календаре */
        .calendar-container.chat-calendar {
            background: transparent;
        }

        .calendar-container.chat-calendar .calendar-wrapper {
            background: transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-wrapper {
            padding: 0;
            overflow: hidden;
        }

        /* Сообщения чата */
        .chat-wrapper .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px 12px 12px;
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-wrapper .message {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 14px;
            animation: messageSlideIn 0.2s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateX(-10px) rotate(-2deg);
            }
            to {
                opacity: 1;
                transform: translateX(0) rotate(0);
            }
        }

        .chat-wrapper .message.user-message {
            background: var(--neobrut-blue);
            transform: rotate(0deg);
            align-self: flex-end;
        }

        .chat-wrapper .message.user-message .message-content {
            color: var(--neobrut-white);
        }

        .chat-wrapper .message.ai-message {
            background: var(--neobrut-white);
            transform: rotate(0deg);
        }

        .chat-wrapper .message.ai-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .chat-wrapper .message-content {
            font-size: 13px;
            line-height: 1.4;
        }

        .chat-wrapper .message-content p {
            margin: 0;
        }

        /* Стили для форматированного контента AI */
        .chat-wrapper .ai-message .message-content h3 {
            color: var(--neobrut-purple);
            margin: 8px 0 6px;
            font-weight: 800;
            font-size: 14px;
        }

        .chat-wrapper .ai-message .message-content strong {
            color: var(--neobrut-black);
            font-weight: 700;
        }

        .chat-wrapper .ai-message .message-content .ai-list-item {
            margin: 6px 0 6px 16px;
            position: relative;
            line-height: 1.4;
        }

        .chat-wrapper .ai-message .message-content .ai-list-item:before {
            content: "▸";
            position: absolute;
            left: -12px;
            color: var(--neobrut-orange);
            font-weight: 900;
        }

        /* Typing indicator */
        .chat-wrapper .typing-indicator {
            background: var(--neobrut-cream);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            width: fit-content;
        }

        .chat-wrapper .typing-dots .dot {
            background-color: var(--neobrut-black);
            border: 1px solid var(--neobrut-black);
        }

        /* Область ввода */
        .chat-input-area {
            background: transparent;
            border-top: 4px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .chat-input-row {
            display: flex;
            gap: 8px;
            padding: 8px 12px 12px;
        }

        .chat-input-neobrut {
            flex: 1;
            padding: 10px 14px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-darkgray);
            outline: none;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.1s;
        }

        .chat-input-neobrut:focus {
            box-shadow: 4px 4px 0 var(--neobrut-black);
            transform: translate(-1px, -1px);
        }

        .chat-input-neobrut::placeholder {
            color: var(--neobrut-gray);
        }

        .chat-send-neobrut {
            width: 42px;
            height: 42px;
            background: var(--neobrut-black);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .chat-send-neobrut:hover {
            background: var(--neobrut-blue);
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .chat-send-neobrut:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .chat-send-neobrut span {
            display: block;
            transform: translateX(2px);
        }

        /* Скроллбар для сообщений */
        .chat-wrapper .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-wrapper .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-wrapper .chat-messages::-webkit-scrollbar-thumb {
            background: var(--neobrut-black);
            border-radius: 3px;
        }

        /* ===== КОНЕЦ НЕОБРУТАЛИСТИЧЕСКОГО ЧАТА ===== */

        /* ===== STREAK АНИМАЦИЯ (как в Duolingo) ===== */
        .streak-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
        }

        .streak-overlay.show {
            animation: fadeIn 0.3s ease forwards;
        }

        .streak-overlay.hide {
            animation: fadeOut 0.5s ease forwards;
        }

        .streak-fire {
            font-size: 120px;
            line-height: 1;
            animation: fireScale 0.6s ease-out forwards;
            filter: drop-shadow(0 0 30px rgba(255, 150, 50, 0.8));
        }

        .streak-fire.glow {
            animation: fireScale 0.6s ease-out forwards, fireGlow 0.8s ease-in-out 0.6s 3;
        }

        .streak-number {
            font-size: 72px;
            font-weight: 900;
            color: var(--neobrut-black);
            text-shadow: 4px 4px 0 var(--neobrut-yellow);
            margin-top: 10px;
            opacity: 0;
            animation: numberSlide 0.5s ease-out 0.3s forwards;
        }

        .streak-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--neobrut-darkgray);
            margin-top: 5px;
            opacity: 0;
            animation: textSlide 0.5s ease-out 0.4s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fireScale {
            0% { transform: scale(0) rotate(-10deg); }
            50% { transform: scale(1.3) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes fireGlow {
            0%, 100% { filter: drop-shadow(0 0 30px rgba(255, 150, 50, 0.8)); }
            50% { filter: drop-shadow(0 0 60px rgba(255, 100, 0, 1)); }
        }

        @keyframes numberSlide {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes textSlide {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* ===== КОНЕЦ STREAK АНИМАЦИИ ===== */

        /* ===== DASHBOARD STRIP (Верхняя панель) ===== */
        .dashboard-strip {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: transparent;
            height: 100%;
            overflow-y: auto;
        }

        .strip-main {
            background: linear-gradient(135deg, var(--neobrut-orange), var(--neobrut-red));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .strip-day-info {
            color: var(--neobrut-white);
        }

        .strip-day {
            font-size: 11px;
            font-weight: 700;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .strip-date {
            font-size: 24px;
            font-weight: 900;
            line-height: 1;
            margin-top: 2px;
        }

        .strip-streak {
            text-align: right;
        }

        .streak-icon {
            font-size: 28px;
            line-height: 1;
        }

        .streak-count {
            font-size: 13px;
            font-weight: 900;
            color: var(--neobrut-white);
        }

        .strip-progress {
            background: linear-gradient(135deg, var(--neobrut-blue), var(--neobrut-purple));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .strip-progress-content {
            flex: 1;
        }

        .strip-progress-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .strip-progress-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--neobrut-white);
            line-height: 1;
        }

        .strip-progress-sub {
            font-size: 13px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
        }

        .strip-progress-chart {
            flex-shrink: 0;
        }

        /* ===== AI COMMENT BLOCK ===== */
        .ai-comment {
            background: linear-gradient(135deg, var(--neobrut-purple), var(--neobrut-blue));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 14px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .ai-comment:hover {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0 var(--neobrut-black);
        }

        .ai-comment:active {
            transform: translate(1px, 1px);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .ai-comment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
            pointer-events: none;
        }

        .ai-comment-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--neobrut-white);
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        /* Typing cursor effect */
        .ai-comment-text.typing::after {
            content: '';
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--neobrut-white);
            margin-left: 2px;
            animation: blink-cursor 0.8s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink-cursor {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Dark gray blinking dots */
        .ai-comment-typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 4px;
        }

        .ai-comment-typing-dot {
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: typing-blink 1.4s infinite ease-in-out both;
        }

        .ai-comment-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-comment-typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .ai-comment-typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typing-blink {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }
            40% { transform: scale(1); opacity: 0.5; }
        }

        .ai-comment-loading {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
        }

        .ai-comment-loading-dot {
            width: 7px;
            height: 7px;
            background: var(--neobrut-white);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .ai-comment-loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-comment-loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .ai-comment-loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ===== ФИКСИРОВАННОЕ СООТНОШЕНИЕ ЭКРАНА ===== */
        body {
            height: 100vh;
            overflow: hidden;
        }

        .workout-section {
            height: 40%;
            overflow-y: auto;
        }

        .activity-section {
            height: 60%;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- Верхняя панель с прогрессом (Dashboard Strip) -->
    <div class="workout-section">
        <div class="dashboard-strip" id="dashboard-strip">
            <!-- Дата и серия -->
            <div class="strip-main">
                <div class="strip-day-info">
                    <div class="strip-day" id="strip-day">Загрузка...</div>
                    <div class="strip-date" id="strip-date">День 1</div>
                </div>
                <div class="strip-streak">
                    <div class="streak-icon">🔥</div>
                    <div class="streak-count" id="streak-count">0 дней</div>
                </div>
            </div>

            <!-- Прогресс -->
            <div class="strip-progress">
                <div class="strip-progress-content">
                    <div class="strip-progress-label">Сегодня</div>
                    <div class="strip-progress-value" id="strip-progress-value">0%</div>
                    <div class="strip-progress-sub" id="strip-progress-sub">День 1 из 7</div>
                </div>
                <div class="strip-progress-chart">
                    <svg width="50" height="50" viewBox="0 0 36 36">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <path id="strip-progress-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#fff" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>

            <!-- AI Комментарий -->
            <div class="ai-comment" id="ai-comment">
                <div class="ai-comment-text" id="ai-comment-text">
                    Загрузка AI комментария...
                </div>
            </div>
        </div>

        <!-- Overlay модальное окно для задач -->
        <div class="todo-overlay" id="todo-overlay">
            <div class="todo-modal">
                <div class="todo-modal-header">
                    <h1 class="todo-modal-title" id="todo-modal-title">День 1 - Задания</h1>
                    <button class="todo-modal-close" id="todo-modal-close">×</button>
                </div>
                <div class="todo-modal-content" id="todo-modal-content">
                    <!-- Задачи будут вставлены сюда -->
                </div>

                <!-- Карточка упражнения -->
                <div class="exercise-card" id="exercise-card">
                    <div class="exercise-card-header">
                        <h1 class="exercise-card-title" id="exercise-card-title">Задание - Упражнение 1/5</h1>
                        <span class="exercise-counter" id="exercise-counter">1/5</span>
                        <button class="exercise-card-close" id="exercise-card-close">×</button>
                    </div>
                    <div class="exercise-card-content">
                        <div class="exercise-text" id="exercise-text">
                            Текст упражнения...
                        </div>
                    </div>
                    <div class="exercise-card-footer">
                        <div class="exercise-dots" id="exercise-dots">
                            <!-- Точки будут добавлены динамически -->
                        </div>
                        <div class="exercise-check-btn" id="exercise-check-btn">
                            <svg class="exercise-check-svg" viewBox="0 0 36 36">
                                <defs>
                                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#00f5a0"/>
                                        <stop offset="100%" stop-color="#00d47a"/>
                                    </linearGradient>
                                </defs>
                                <circle class="exercise-check-bg" cx="18" cy="18" r="15"></circle>
                                <circle class="exercise-check-progress" cx="18" cy="18" r="15"
                                        stroke-dasharray="94.2" stroke-dashoffset="94.2"></circle>
                            </svg>
                            <span class="exercise-check-icon" id="exercise-check-icon">✓</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Горизонтальная линия-разделитель с кнопкой -->
    <div class="divider">
        <div class="divider-button"></div>
    </div>

    <!-- Нижняя секция с активностью -->
    <div class="activity-section">
        <div class="activity-header">
            <h2 class="activity-title">Активность</h2>
        </div>

        <!-- Вертикальный календарь активности -->
        <div class="activity-grid-vertical">
            <div class="activity-slider">
                <!-- AI Чат слева -->
                <div class="calendar-container chat-calendar">
                    <div class="calendar-wrapper chat-wrapper">
                        <div class="chat-messages" id="slider-chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-row">
                                <input type="text" class="chat-input-neobrut" id="slider-chat-input" placeholder="Спроси меня что угодно...">
                                <button class="chat-send-neobrut" id="slider-chat-send">
                                    <span>→</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Основной календарь -->
                <div class="calendar-container">
                    <div class="calendar-wrapper">
                        <div class="calendar-months" id="calendar-months">
                            <!-- Месяцы генерируются JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Секция заданий -->
                <div class="calendar-container tasks-calendar">
                    <div class="calendar-wrapper">
                        <div class="tasks-container" id="tasks-container">
                            <!-- Виджеты дней генерируются JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tooltip для активности -->
            <div class="tip" id="activity-tooltip"></div>

            <!-- Overlay модальное окно для AI чата -->
            <div class="ai-chat-overlay" id="ai-chat-overlay">
                <div class="ai-chat-modal">
                    <div class="ai-chat-header">
                        <h1 class="ai-chat-title">AI Ассистент</h1>
                        <div class="ai-chat-controls">
                            <button class="ai-chat-clear" id="ai-chat-clear" title="Очистить историю">🗑️</button>
                            <button class="ai-chat-close" id="ai-chat-close">×</button>
                        </div>
                    </div>
                    <div class="ai-chat-content">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Введите ваше сообщение...">
                            <button class="chat-send" id="chat-send">Отправить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>

    <script>
        // === API KEY PARTS (base64 encoded, split for security) ===
        // Part 1: API key prefix (sk-or-v1-5b6bf592b)
        const API_KEY_PART_1 = "c2stb3ItdjEtNWI2YmY1OTJi";
        // Part 2: Mid section (99573770c98430ba1a)
        const API_KEY_PART_2 = "OTk1NzM3NzBjOTg0MzBiYTFh";
        // Part 3: Hash section (4fc82d2d65380c41fe)
        const API_KEY_PART_3 = "NGZjODJkMmQ2NTM4MGM0MWZl";
        // Part 4: Final section (91c06d79a8ef9b9275e==)
        const API_KEY_PART_4 = "OTFjMDZkNzlhOGVmOWI5Mjc1ZQ==";

        // Other app constants (obfuscated)
        const APP_VERSION = "ZGVlcHNlZWsvZGVlcHNlZWstdjMuMg==";

        // API Key assembly and decode function
        function getConnectionString() {
            const encoded = API_KEY_PART_1 + API_KEY_PART_2 + API_KEY_PART_3 + API_KEY_PART_4;
            return atob(encoded);
        }

        const AI_MODEL = 'google/gemini-2.0-flash-001';

        // Динамическое формирование URL API
        function getAPIBaseURL() {
            return 'https://openrouter.ai/api/v1/chat/completions';
        }

        // Простая функция проверки
        function validateConfig() {
            return true; // Для простоты
        }

        // Инициализация приложения
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0 = Январь, 11 = Декабрь
        let activityData = {};
        let selectedWorkout = 1;
        let todoData = {}; // Хранение состояния todo-списков

        // Переменные для карточки упражнения
        let currentTask = null; // Текущая задача с упражнениями
        let currentExerciseIndex = 0; // Индекс текущего упражнения
        let exerciseCardVisible = false; // Видна ли карточка упражнения


        // Инициализация todo-списков с упражнениями
        function initializeTodoLists() {
            todoData = {
                1: [
                    {
                        id: 'task-1',
                        text: 'Утренняя растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-1-1', text: 'Наклоны головы в стороны - 5 раз в каждую сторону', completed: false },
                            { id: 'ex-1-2', text: 'Круговые движения плечами - 10 раз вперёд, 10 назад', completed: false },
                            { id: 'ex-1-3', text: 'Наклоны туловища в стороны - 10 раз в каждую сторону', completed: false },
                            { id: 'ex-1-4', text: 'Растяжка задней поверхности бедра - 20 секунд на ногу', completed: false }
                        ]
                    },
                    {
                        id: 'task-2',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-2-1', text: 'Отжимания - 1 подход: 15 раз', completed: false },
                            { id: 'ex-2-2', text: 'Отжимания - 2 подход: 12 раз', completed: false },
                            { id: 'ex-2-3', text: 'Отжимания - 3 подход: 10 раз', completed: false },
                            { id: 'ex-2-4', text: 'Отдых между подходами - 1 минута', isRest: true, completed: false },
                            { id: 'ex-2-5', text: 'Отжимания - 4 подход: макс. количество раз', completed: false }
                        ]
                    },
                    {
                        id: 'task-3',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-3-1', text: 'Классические скручивания - 20 раз', completed: false },
                            { id: 'ex-3-2', text: 'Подъём ног лёжа - 15 раз', completed: false },
                            { id: 'ex-3-3', text: 'Планка - 30 секунд', completed: false },
                            { id: 'ex-3-4', text: 'Боковая планка - 20 секунд каждую сторону', completed: false }
                        ]
                    },
                    {
                        id: 'task-4',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-4-1', text: 'Приседания - 1 подход: 20 раз', completed: false },
                            { id: 'ex-4-2', text: 'Приседания - 2 подход: 15 раз', completed: false },
                            { id: 'ex-4-3', text: 'Отдых - 1 минута', isRest: true, completed: false },
                            { id: 'ex-4-4', text: 'Приседания - 3 подход: макс. количество раз', completed: false }
                        ]
                    },
                    {
                        id: 'task-5',
                        text: 'Ходьба',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-5-1', text: 'Прогулка на свежем воздухе - 20 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-6',
                        text: 'Здоровый завтрак',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-6-1', text: 'Съесть белковый завтрак (яйца, творог или омлет)', completed: false },
                            { id: 'ex-6-2', text: 'Выпить стакан воды', completed: false },
                            { id: 'ex-6-3', text: 'Добавить овощи или фрукты', completed: false }
                        ]
                    }
                ],
                2: [
                    {
                        id: 'task-7',
                        text: 'Утренняя зарядка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-7-1', text: 'Разминка плеч - круговые движения 10 раз', completed: false },
                            { id: 'ex-7-2', text: 'Разминка ног - махи ногой 10 раз каждой', completed: false },
                            { id: 'ex-7-3', text: 'Разминка таза - вращения тазом 10 раз', completed: false },
                            { id: 'ex-7-4', text: 'Лёгкая растяжка всего тела - 1 минута', completed: false }
                        ]
                    },
                    {
                        id: 'task-8',
                        text: 'Тяга гантелей',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-8-1', text: 'Тяга гантелей в наклоне - 1 подход: 12 раз', completed: false },
                            { id: 'ex-8-2', text: 'Тяга гантелей в наклоне - 2 подход: 10 раз', completed: false },
                            { id: 'ex-8-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-8-4', text: 'Тяга гантелей в наклоне - 3 подход: 8 раз', completed: false }
                        ]
                    },
                    {
                        id: 'task-9',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-9-1', text: 'Скручивания с поворотом - 15 раз каждую сторону', completed: false },
                            { id: 'ex-9-2', text: 'Велосипед - 20 раз', completed: false },
                            { id: 'ex-9-3', text: 'Обратные скручивания - 15 раз', completed: false },
                            { id: 'ex-9-4', text: 'Планка - 40 секунд', completed: false }
                        ]
                    },
                    {
                        id: 'task-10',
                        text: 'Выпады',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-10-1', text: 'Выпады вперёд - 10 раз каждая нога', completed: false },
                            { id: 'ex-10-2', text: 'Выпады назад - 8 раз каждая нога', completed: false },
                            { id: 'ex-10-3', text: 'Отдых - 1 минута', isRest: true, completed: false },
                            { id: 'ex-10-4', text: 'Боковые выпады - 8 раз каждая сторона', completed: false }
                        ]
                    },
                    {
                        id: 'task-11',
                        text: 'Бег трусцой',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-11-1', text: 'Разминка перед бегом - 3 минуты', completed: false },
                            { id: 'ex-11-2', text: 'Бег - 15 минут в умеренном темпе', completed: false },
                            { id: 'ex-11-3', text: 'Заминка - ходьба 3 минуты', completed: false }
                        ]
                    },
                    {
                        id: 'task-12',
                        text: 'Растяжка после тренировки',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-12-1', text: 'Растяжка квадрицепса - 30 секунд каждая нога', completed: false },
                            { id: 'ex-12-2', text: 'Растяжка бицепса бедра - 30 секунд каждая нога', completed: false },
                            { id: 'ex-12-3', text: 'Растяжка икр - 20 секунд каждая нога', completed: false }
                        ]
                    }
                ],
                3: [
                    {
                        id: 'task-13',
                        text: 'Разогрев перед тренировкой',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-13-1', text: 'Лёгкий jog на месте - 2 минуты', completed: false },
                            { id: 'ex-13-2', text: 'Вращения руками - 15 раз вперёд, 15 назад', completed: false },
                            { id: 'ex-13-3', text: 'Махи ногами - 10 раз каждой ногой', completed: false },
                            { id: 'ex-13-4', text: 'Разогрев суставов - 1 минута', completed: false }
                        ]
                    },
                    {
                        id: 'task-14',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-14-1', text: 'Растяжка шеи - по 10 секунд в каждую сторону', completed: false },
                            { id: 'ex-14-2', text: 'Растяжка плеч - 20 секунд', completed: false },
                            { id: 'ex-14-3', text: 'Растяжка спины - поза кошка 30 секунд', completed: false },
                            { id: 'ex-14-4', text: 'Растяжка бёдер - бабочка 30 секунд', completed: false }
                        ]
                    },
                    {
                        id: 'task-15',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-15-1', text: 'Широкие отжимания - 1 подход: 12 раз', completed: false },
                            { id: 'ex-15-2', text: 'Обычные отжимания - 2 подход: 15 раз', completed: false },
                            { id: 'ex-15-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-15-4', text: 'Узкие отжимания - 3 подход: 10 раз', completed: false },
                            { id: 'ex-15-5', text: 'Отжимания с хлопком - макс. количество', completed: false }
                        ]
                    },
                    {
                        id: 'task-16',
                        text: 'Обратные отжимания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-16-1', text: 'Обратные отжимания от стула - 1 подход: 12 раз', completed: false },
                            { id: 'ex-16-2', text: 'Обратные отжимания от стула - 2 подход: 10 раз', completed: false },
                            { id: 'ex-16-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-16-4', text: 'Обратные отжимания от пола - 3 подход: 8 раз', completed: false }
                        ]
                    },
                    {
                        id: 'task-17',
                        text: 'Пресс с весом',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-17-1', text: 'Скручивания с весом - 15 раз', completed: false },
                            { id: 'ex-17-2', text: 'Русский твист с весом - 20 раз', completed: false },
                            { id: 'ex-17-3', text: 'Планка с весом - 45 секунд', completed: false },
                            { id: 'ex-17-4', text: 'Боковая планка с весом - 25 секунд каждая сторона', completed: false }
                        ]
                    },
                    {
                        id: 'task-18',
                        text: 'Кардио финиши',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-18-1', text: 'Бёрпи - 3 подхода по 10 раз', completed: false },
                            { id: 'ex-18-2', text: 'Отдых между подходами - 60 секунд', isRest: true, completed: false },
                            { id: 'ex-18-3', text: 'Скалолаз - 3 подхода по 20 раз', completed: false }
                        ]
                    }
                ],
                4: [
                    {
                        id: 'task-19',
                        text: 'Разогрев',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-19-1', text: 'Прыжки на месте - 1 минута', completed: false },
                            { id: 'ex-19-2', text: 'Вращения туловища - 20 раз', completed: false },
                            { id: 'ex-19-3', text: 'Махи ногами - 15 раз каждой ногой', completed: false }
                        ]
                    },
                    {
                        id: 'task-20',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-20-1', text: 'Классические приседания - 1 подход: 20 раз', completed: false },
                            { id: 'ex-20-2', text: 'Приседания с широкой постановкой - 2 подход: 15 раз', completed: false },
                            { id: 'ex-20-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-20-4', text: 'Приседания плие - 3 подход: 12 раз', completed: false },
                            { id: 'ex-20-5', text: 'Приседания на одной ноге - 6 раз каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-21',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-21-1', text: 'Классическая планка - 45 секунд', completed: false },
                            { id: 'ex-21-2', text: 'Боковая планка левая - 30 секунд', completed: false },
                            { id: 'ex-21-3', text: 'Боковая планка правая - 30 секунд', completed: false },
                            { id: 'ex-21-4', text: 'Планка с подъёмом ноги - 20 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-22',
                        text: 'Выпады с весом',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-22-1', text: 'Выпады с гантелями - 10 раз каждая нога', completed: false },
                            { id: 'ex-22-2', text: 'Обратные выпады - 12 раз каждая нога', completed: false },
                            { id: 'ex-22-3', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-22-4', text: 'Болгарские выпады - 8 раз каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-23',
                        text: 'Ягодичные упражнения',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-23-1', text: 'Ягодичный мост - 20 раз', completed: false },
                            { id: 'ex-23-2', text: 'Ягодичный мост с одной ногой - 10 раз каждая нога', completed: false },
                            { id: 'ex-23-3', text: 'Махи ногой назад стоя - 15 раз каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-24',
                        text: 'Растяжка ног',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-24-1', text: 'Растяжка квадрицепса - 30 секунд каждая нога', completed: false },
                            { id: 'ex-24-2', text: 'Растяжка приводящих мышц - 30 секунд', completed: false },
                            { id: 'ex-24-3', text: 'Растяжка икроножных мышц - 30 секунд', completed: false }
                        ]
                    }
                ],
                5: [
                    {
                        id: 'task-25',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-25-1', text: 'Прогулка на свежем воздухе - 30 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-26',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-26-1', text: 'Разминка - ходьба 5 минут', completed: false },
                            { id: 'ex-26-2', text: 'Бег в умеренном темпе - 20 минут', completed: false },
                            { id: 'ex-26-3', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-26-4', text: 'Интервальный бег - 5×1 минута быстро/1 минута медленно', completed: false },
                            { id: 'ex-26-5', text: 'Заминка - ходьба 5 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-27',
                        text: 'Гигиеничес процедуры',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-27-1', text: 'Контрастный душ - 3 цикла горячая/холодная вода', completed: false },
                            { id: 'ex-27-2', text: 'Чистка зубов и уход за полостью рта', completed: false },
                            { id: 'ex-27-3', text: 'Увлажнение кожи', completed: false }
                        ]
                    },
                    {
                        id: 'task-28',
                        text: 'Отжимания на время',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-28-1', text: 'Отжимания за 60 секунд - максимальное количество', completed: false },
                            { id: 'ex-28-2', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-28-3', text: 'Отжимания за 45 секунд - максимальное количество', completed: false },
                            { id: 'ex-28-4', text: 'Отдых - 90 секунд', isRest: true, completed: false },
                            { id: 'ex-28-5', text: 'Отжимания за 30 секунд - максимальное количество', completed: false }
                        ]
                    },
                    {
                        id: 'task-29',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-29-1', text: 'Альпинист - 3 подхода по 20 раз', completed: false },
                            { id: 'ex-29-2', text: 'Ножницы - 3 подхода по 25 раз', completed: false },
                            { id: 'ex-29-3', text: 'Планка - 60 секунд', completed: false }
                        ]
                    },
                    {
                        id: 'task-30',
                        text: 'Растяжка и восстановление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-30-1', text: 'Полная растяжка тела - 5 минут', completed: false },
                            { id: 'ex-30-2', text: 'Дыхательные упражнения - 2 минуты', completed: false }
                        ]
                    }
                ],
                6: [
                    {
                        id: 'task-31',
                        text: 'Утренняя йога',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-31-1', text: 'Приветствие солнцу - 3 раунда', completed: false },
                            { id: 'ex-31-2', text: 'Поза собаки мордой вниз - 30 секунд', completed: false },
                            { id: 'ex-31-3', text: 'Поза warrior - 30 секунд каждая сторона', completed: false },
                            { id: 'ex-31-4', text: 'Поза треугольника - 30 секунд каждая сторона', completed: false },
                            { id: 'ex-31-5', text: 'Поза дерева - 20 секунд каждая нога', completed: false }
                        ]
                    },
                    {
                        id: 'task-32',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-32-1', text: 'Дыхание 4-7-8 - 5 минут', completed: false },
                            { id: 'ex-32-2', text: 'Сканирование тела - 5 минут', completed: false },
                            { id: 'ex-32-3', text: 'Созерцание - 5 минут тишины', completed: false }
                        ]
                    },
                    {
                        id: 'task-33',
                        text: 'Лёгкая тренировка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-33-1', text: 'Разогрев - 3 минуты', completed: false },
                            { id: 'ex-33-2', text: 'Отжимания - 2 подхода по 15 раз', completed: false },
                            { id: 'ex-33-3', text: 'Приседания - 2 подхода по 20 раз', completed: false },
                            { id: 'ex-33-4', text: 'Планка - 45 секунд', completed: false }
                        ]
                    },
                    {
                        id: 'task-34',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-34-1', text: 'Прогулка в парке - 40 минут', completed: false },
                            { id: 'ex-34-2', text: 'Во время прогулки: делайте глубокие вдохи', completed: false }
                        ]
                    },
                    {
                        id: 'task-35',
                        text: 'Растяжка перед сном',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-35-1', text: 'Растяжка шеи и плеч - 2 минуты', completed: false },
                            { id: 'ex-35-2', text: 'Растяжка спины - поза ребёнка 1 минута', completed: false },
                            { id: 'ex-35-3', text: 'Растяжка ног - лёжа на спине 2 минуты', completed: false }
                        ]
                    }
                ],
                7: [
                    {
                        id: 'task-36',
                        text: 'Утренняя активность',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-36-1', text: 'Лёгкая jog - 10 минут', completed: false }
                        ]
                    },
                    {
                        id: 'task-37',
                        text: 'Финальный тест',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-37-1', text: 'Отжимания - макс. количество за 2 минуты', completed: false },
                            { id: 'ex-37-2', text: 'Отдых - 3 минуты', isRest: true, completed: false },
                            { id: 'ex-37-3', text: 'Приседания - макс. количество за 2 минуты', completed: false },
                            { id: 'ex-37-4', text: 'Отдых - 2 минуты', isRest: true, completed: false },
                            { id: 'ex-37-5', text: 'Планка - максимальное время', completed: false }
                        ]
                    },
                    {
                        id: 'task-38',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-38-1', text: 'Длительная прогулка - 45-60 минут', completed: false },
                            { id: 'ex-38-2', text: 'Наслаждайтесь природой, не спешите', completed: false }
                        ]
                    },
                    {
                        id: 'task-39',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-39-1', text: 'Почитайте книгу - 20 минут', completed: false },
                            { id: 'ex-39-2', text: 'Запишите главную мысль из прочитанного', completed: false }
                        ]
                    },
                    {
                        id: 'task-40',
                        text: 'Планирование',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-40-1', text: 'Подведите итоги недели', completed: false },
                            { id: 'ex-40-2', text: 'Запланируйте цели на следующую неделю', completed: false }
                        ]
                    },
                    {
                        id: 'task-41',
                        text: 'Растяжка и расслабление',
                        completed: false,
                        completedAt: null,
                        exercises: [
                            { id: 'ex-41-1', text: 'Полная растяжка всего тела - 10 минут', completed: false },
                            { id: 'ex-41-2', text: 'Медитация на благодарность - 5 минут', completed: false }
                        ]
                    }
                ]
            };

            // Загружаем сохраненные состояния из localStorage
            loadTodoStates();
        }


        // Дополнительные метаданные приложения
        const METADATA_PREFIX = "NGZjODJkMmQ2NTM4MGM0MWZl";

        // Загрузка состояний todo из localStorage с упражнениями
        function loadTodoStates() {
            const saved = localStorage.getItem('fitTrackerTodos');
            if (saved) {
                try {
                    const states = JSON.parse(saved);
                    Object.keys(states).forEach(day => {
                        if (todoData[day]) {
                            todoData[day].forEach(task => {
                                const taskState = states[day] && states[day][task.id];
                                if (taskState) {
                                    task.completed = taskState.completed || false;
                                    task.completedAt = taskState.completedAt || null;
                                    // Загружаем состояние упражнений
                                    if (task.exercises && taskState.exercises) {
                                        task.exercises.forEach(ex => {
                                            const exState = taskState.exercises[ex.id];
                                            if (exState) {
                                                ex.completed = exState.completed || false;
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    });
                    console.log('Состояния todo и упражнений загружены из localStorage');
                } catch (e) {
                    console.error('Error loading todo states:', e);
                }
            }
        }

        // Сохранение состояний todo в localStorage с упражнениями
        function saveTodoStates() {
            const states = {};
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    states[day] = {};
                    todoData[day].forEach(task => {
                        const taskState = {
                            completed: task.completed || false,
                            completedAt: task.completedAt || null
                        };
                        // Сохраняем состояние упражнений
                        if (task.exercises) {
                            taskState.exercises = {};
                            task.exercises.forEach(ex => {
                                taskState.exercises[ex.id] = {
                                    completed: ex.completed || false
                                };
                            });
                        }
                        states[day][task.id] = taskState;
                    });
                }
            });
            localStorage.setItem('fitTrackerTodos', JSON.stringify(states));
        }

        // Проверка, все ли упражнения в задаче выполнены
        function areAllExercisesCompleted(task) {
            if (!task.exercises || task.exercises.length === 0) return true;
            // Учитываем только упражнения, которые не являются отдыхом (или все, если все отдых)
            const activeExercises = task.exercises.filter(ex => !ex.isRest);
            if (activeExercises.length === 0) return true; // Все упражнения - отдых
            return activeExercises.every(ex => ex.completed);
        }

        // Получить количество выполненных упражнений (без учёта отдыха)
        function getCompletedExerciseCount(task) {
            if (!task.exercises) return 0;
            return task.exercises.filter(ex => !ex.isRest && ex.completed).length;
        }

        // Получить общее количество упражнений (без учёта отдыха)
        function getTotalExerciseCount(task) {
            if (!task.exercises) return 0;
            return task.exercises.filter(ex => !ex.isRest).length;
        }

        // Создание HTML для todo-списка с новой логикой
        function createTodoHtml(todos) {
            if (!todos || todos.length === 0) {
                return '<div class="no-tasks">Задания не найдены</div>';
            }

            let html = '<ul class="todo-list">';

            todos.forEach(task => {
                const taskCompletedClass = task.completed ? 'completed' : '';
                const allExercisesCompleted = areAllExercisesCompleted(task);
                const hasExercises = task.exercises && task.exercises.length > 0;

                // Если задача уже выполнена или все упражнения выполнены, показываем чекбокс
                // Иначе показываем только текст задачи
                let taskContent = '';

                if (task.completed || allExercisesCompleted || !hasExercises) {
                    // Показываем чекбокс
                    taskContent = `
                        <div class="todo-checkbox">
                            <input type="checkbox"
                                   id="${task.id}"
                                   data-task-id="${task.id}"
                                   ${task.completed ? 'checked' : ''}
                                   onchange="toggleTask('${task.id}')">
                            <div class="checkbox-visual"></div>
                            <div class="checkbox-checkmark"></div>
                        </div>
                        <div class="todo-text-wrapper">
                            <div class="todo-text" onclick="toggleTask('${task.id}')">
                                ${task.text}${task.completed && task.completedAt ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Показываем только текст без чекбокса (текст сдвинут влево)
                    taskContent = `
                        <div class="todo-text-wrapper todo-text-shifted">
                            <div class="todo-text" onclick="openExerciseCard('${task.id}')">
                                ${task.text}
                            </div>
                        </div>
                    `;
                }

                html += `
                    <li class="todo-item ${taskCompletedClass}">
                        ${taskContent}
                    </li>
                `;
            });

            html += '</ul>';
            return html;
        }

        // ===== ФУНКЦИИ КАРТОЧКИ УПРАЖНЕНИЯ =====

        // Найти задачу по ID во всех днях
        function findTaskById(taskId) {
            for (let day = 1; day <= 7; day++) {
                if (todoData[day]) {
                    const task = todoData[day].find(t => t.id === taskId);
                    if (task) return task;
                }
            }
            return null;
        }

        // Открыть карточку упражнения
        function openExerciseCard(taskId) {
            const task = findTaskById(taskId);
            if (!task || !task.exercises || task.exercises.length === 0) {
                console.error('Задача не найдена или не имеет упражнений');
                return;
            }

            currentTask = task;
            currentExerciseIndex = 0;
            exerciseCardVisible = true;

            renderExerciseCard();

            // Показать карточку с анимацией
            const exerciseCard = document.getElementById('exercise-card');
            exerciseCard.classList.add('show');
            exerciseCard.classList.remove('hide');

            // Настроить свайп навигацию
            setupExerciseCardSwipe();
        }

        // Закрыть карточку упражнения
        function closeExerciseCard() {
            const exerciseCard = document.getElementById('exercise-card');
            exerciseCard.classList.remove('show');
            exerciseCard.classList.add('hide');

            setTimeout(() => {
                exerciseCardVisible = false;
                currentTask = null;
                currentExerciseIndex = 0;
            }, 250);

            // Перерендерить список задач чтобы обновить отображение
            setTimeout(() => {
                const currentWorkoutDay = getCurrentWorkoutDay();
                const todoHtml = createTodoHtml(todoData[currentWorkoutDay]);
                document.getElementById('todo-modal-content').innerHTML = todoHtml;
            }, 300);
        }

        // Отрендерить карточку упражнения
        function renderExerciseCard() {
            if (!currentTask) return;

            const exercise = currentTask.exercises[currentExerciseIndex];
            if (!exercise) return;

            // Заголовок: "Задание - Упражнение X/Y"
            const totalExercises = currentTask.exercises.length;
            document.getElementById('exercise-card-title').textContent =
                `${currentTask.text} - ${currentExerciseIndex + 1}/${totalExercises}`;
            document.getElementById('exercise-counter').textContent =
                `${currentExerciseIndex + 1}/${totalExercises}`;

            // Текст упражнения
            document.getElementById('exercise-text').textContent = exercise.text;

            // Обновить точки
            renderExerciseDots();

            // Обновить кнопку-галочку
            updateExerciseCheckButton();
        }

        // Отрендерить точки упражнений
        function renderExerciseDots() {
            const dotsContainer = document.getElementById('exercise-dots');
            dotsContainer.innerHTML = '';

            currentTask.exercises.forEach((ex, index) => {
                const dot = document.createElement('div');
                dot.className = 'exercise-dot';

                if (index === currentExerciseIndex) {
                    dot.classList.add('active');
                }

                if (ex.completed) {
                    dot.classList.add('completed');
                }

                dotsContainer.appendChild(dot);
            });
        }

        // Обновить кнопку-галочку
        function updateExerciseCheckButton() {
            const exercise = currentTask.exercises[currentExerciseIndex];
            const checkBtn = document.getElementById('exercise-check-btn');
            const checkIcon = document.getElementById('exercise-check-icon');
            const progressCircle = checkBtn.querySelector('.exercise-check-progress');

            const totalExercises = getTotalExerciseCount(currentTask);
            const completedCount = getCompletedExerciseCount(currentTask);

            // Вычислить процент прогресса
            const progress = totalExercises > 0 ? (completedCount / totalExercises) * 100 : 0;
            const circumference = 2 * Math.PI * 15; // r = 15
            const offset = circumference - (progress / 100) * circumference;

            progressCircle.style.strokeDashoffset = offset;

            if (exercise.completed) {
                checkBtn.classList.add('completed');
                checkIcon.textContent = '✓';
            } else {
                checkBtn.classList.remove('completed');
                checkIcon.textContent = '✓';
            }
        }

        // Переключить статус выполнения упражнения
        function toggleExercise() {
            if (!currentTask) return;

            const exercise = currentTask.exercises[currentExerciseIndex];
            exercise.completed = !exercise.completed;

            // Сохранить прогресс
            saveTodoStates();

            // Обновить отображение
            updateExerciseCheckButton();
            renderExerciseDots();

            // Если все упражнения выполнены, закрыть карточку
            if (areAllExercisesCompleted(currentTask)) {
                setTimeout(() => {
                    closeExerciseCard();
                }, 500);
            }
        }

        // Перейти к следующему упражнению
        function nextExercise() {
            if (!currentTask) return;

            if (currentExerciseIndex < currentTask.exercises.length - 1) {
                currentExerciseIndex++;
                renderExerciseCard();
            }
        }

        // Перейти к предыдущему упражнению
        function prevExercise() {
            if (!currentTask) return;

            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
                renderExerciseCard();
            }
        }

        // Глобальные переменные для свайпа (объявлены один раз)
        let exerciseSwipeState = {
            startX: 0,
            currentX: 0,
            isDragging: false,
            hasSwiped: false // Флаг, чтобы предотвратить множественные свайпы за один жест
        };

        // Настроить свайп навигацию для карточки упражнения
        function setupExerciseCardSwipe() {
            const exerciseCard = document.getElementById('exercise-card');
            const SWIPE_THRESHOLD = 50;

            // Сброс состояния при открытии новой карточки
            exerciseSwipeState = {
                startX: 0,
                currentX: 0,
                isDragging: false,
                hasSwiped: false
            };

            const handleTouchStart = (e) => {
                // Игнорируем если кликнули на кнопки или интерактивные элементы
                if (e.target.closest('.exercise-card-close') || e.target.closest('.exercise-check-btn')) {
                    return;
                }
                exerciseSwipeState.startX = e.touches[0].clientX;
                exerciseSwipeState.currentX = exerciseSwipeState.startX;
                exerciseSwipeState.isDragging = true;
                exerciseSwipeState.hasSwiped = false;
            };

            const handleTouchMove = (e) => {
                if (!exerciseSwipeState.isDragging) return;
                exerciseSwipeState.currentX = e.touches[0].clientX;
            };

            const handleTouchEnd = () => {
                if (!exerciseSwipeState.isDragging) return;

                const diff = exerciseSwipeState.currentX - exerciseSwipeState.startX;

                // Проверяем: порог пройден И ещё не было свайпа в этом жесте
                if (Math.abs(diff) > SWIPE_THRESHOLD && !exerciseSwipeState.hasSwiped) {
                    exerciseSwipeState.hasSwiped = true; // Блокируем повторные свайпы

                    if (diff < 0) {
                        nextExercise(); // Свайп влево - следующее
                    } else {
                        prevExercise(); // Свайп вправо - предыдущее
                    }
                }

                exerciseSwipeState.isDragging = false;
            };

            const handleMouseDown = (e) => {
                // Игнорируем если кликнули на кнопки или интерактивные элементы
                if (e.target.closest('.exercise-card-close') || e.target.closest('.exercise-check-btn')) {
                    return;
                }
                exerciseSwipeState.startX = e.clientX;
                exerciseSwipeState.currentX = exerciseSwipeState.startX;
                exerciseSwipeState.isDragging = true;
                exerciseSwipeState.hasSwiped = false;
            };

            const handleMouseMove = (e) => {
                if (!exerciseSwipeState.isDragging) return;
                exerciseSwipeState.currentX = e.clientX;
            };

            const handleMouseUp = () => {
                if (!exerciseSwipeState.isDragging) return;

                const diff = exerciseSwipeState.currentX - exerciseSwipeState.startX;

                // Проверяем: порог пройден И ещё не было свайпа в этом жесте
                if (Math.abs(diff) > SWIPE_THRESHOLD && !exerciseSwipeState.hasSwiped) {
                    exerciseSwipeState.hasSwiped = true; // Блокируем повторные свайпы

                    if (diff < 0) {
                        nextExercise(); // Свайп влево - следующее
                    } else {
                        prevExercise(); // Свайп вправо - предыдущее
                    }
                }

                exerciseSwipeState.isDragging = false;
            };

            // Клонируем ноду чтобы удалить ВСЕ обработчики событий
            const newExerciseCard = exerciseCard.cloneNode(true);
            exerciseCard.parentNode.replaceChild(newExerciseCard, exerciseCard);

            // Получаем обновлённую ссылку
            const updatedExerciseCard = document.getElementById('exercise-card');

            // Добавляем обработчики свайпа на чистый элемент
            updatedExerciseCard.addEventListener('touchstart', handleTouchStart, { passive: true });
            updatedExerciseCard.addEventListener('touchmove', handleTouchMove, { passive: true });
            updatedExerciseCard.addEventListener('touchend', handleTouchEnd);
            updatedExerciseCard.addEventListener('mousedown', handleMouseDown);
            updatedExerciseCard.addEventListener('mousemove', handleMouseMove);
            updatedExerciseCard.addEventListener('mouseup', handleMouseUp);

            // Восстанавливаем обработчики кнопок после клонирования
            const exerciseCardClose = document.getElementById('exercise-card-close');
            const exerciseCheckBtn = document.getElementById('exercise-check-btn');

            exerciseCardClose.addEventListener('click', closeExerciseCard);
            exerciseCheckBtn.addEventListener('click', toggleExercise);
        }

        // ===== КОНЕЦ ФУНКЦИЙ КАРТОЧКИ УПРАЖНЕНИЯ =====

        // ===== СИНХРОНИЗАЦИЯ ДАТ =====

        // Получить дату начала программы (когда выполнена первая задача)
        function getStartDate() {
            const saved = localStorage.getItem('fitTrackerStartDate');
            if (saved) {
                return new Date(saved);
            }
            return null;
        }

        // Установить дату начала программы
        function setStartDate(date) {
            localStorage.setItem('fitTrackerStartDate', date.toISOString());
            console.log('Установлена дата начала программы:', date.toLocaleDateString('ru-RU'));
        }

        // Получить название дня недели для тренировочного дня
        function getWorkoutDayName(workoutDay) {
            const startDate = getStartDate();
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];

            if (!startDate) {
                // Если дата начала не установлена, возвращаем просто "День X"
                return `День ${workoutDay}`;
            }

            // Вычисляем дату для этого тренировочного дня
            const dayOffset = workoutDay - 1;
            const workoutDate = new Date(startDate);
            workoutDate.setDate(startDate.getDate() + dayOffset);

            // Получаем день недели
            return dayNames[workoutDate.getDay()];
        }

        // Получить текущий день тренировки на основе календарной даты
        function getCurrentWorkoutDay() {
            const startDate = getStartDate();
            if (!startDate) {
                return 1; // По умолчанию День 1, если стартовая дата не установлена
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);

            // Вычисляем разницу в днях
            const diffTime = today - start;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // День тренировки = смещение + 1
            const workoutDay = diffDays + 1;

            // Ограничиваем максимум 7 днями
            return Math.min(Math.max(workoutDay, 1), 7);
        }

        // Получение даты для дня тренировки (на основе стартовой даты)
        function getWorkoutDate(workoutDay) {
            const startDate = getStartDate();

            if (!startDate) {
                // Если стартовая дата не установлена, используем старую логику
                const today = new Date();
                const dayOffset = workoutDay - 1;
                const workoutDate = new Date(today);
                workoutDate.setDate(today.getDate() + dayOffset);
                console.log(`День ${workoutDay} -> ${workoutDate.toLocaleDateString('ru-RU')} (смещение: ${dayOffset} дней)`);
                return workoutDate;
            }

            // Новая логика: День 1 = startDate, День 2 = startDate + 1 день, и т.д.
            const dayOffset = workoutDay - 1;
            const workoutDate = new Date(startDate);
            workoutDate.setDate(startDate.getDate() + dayOffset);

            console.log(`День ${workoutDay} -> ${workoutDate.toLocaleDateString('ru-RU')} (от ${startDate.toLocaleDateString('ru-RU')}, смещение: ${dayOffset} дней)`);

            return workoutDate;
        }

        // Проверка и запись активности на основе процентов выполнения
        function checkAndRecordActivity() {
            const currentWorkoutDay = getCurrentWorkoutDay();

            // Проверяем, есть ли todo для текущего дня тренировки
            if (todoData[currentWorkoutDay]) {
                // Получаем правильную дату для дня тренировки
                const workoutDate = getWorkoutDate(currentWorkoutDay);

                // Рассчитываем общий процент выполнения для текущего дня
                const percentage = calculateCompletionPercentage(currentWorkoutDay);
                console.log(`День ${currentWorkoutDay}: процент выполнения = ${percentage}%`);

                // Определяем уровень активности на основе процента
                let activityLevel = 'none';
                if (percentage >= 100) {
                    activityLevel = 'max';
                } else if (percentage >= 75) {
                    activityLevel = 'high';
                } else if (percentage >= 50) {
                    activityLevel = 'medium';
                } else if (percentage >= 25) {
                    activityLevel = 'low';
                }

                // Обновляем активность для правильной даты
                const dateKey = formatDateKey(workoutDate);
                const oldActivity = activityData[dateKey] || 'none';

                console.log(`Активность на ${workoutDate.toLocaleDateString('ru-RU')}: ${oldActivity} -> ${activityLevel}`);

                // Обновляем только если активность изменилась
                if (oldActivity !== activityLevel) {
                    activityData[dateKey] = activityLevel;
                    saveActivityData();

                    // Обновляем календарь, если он показывает год даты тренировки
                    if (currentYear === workoutDate.getFullYear()) {
                        renderActivityGrid();

                        // Добавляем анимацию при увеличении активности
                        if (activityLevel !== 'none' && oldActivity === 'none') {
                            const targetCell = document.querySelector(`[data-date="${dateKey}"]`);
                            if (targetCell) {
                                // Сначала обновляем data-activity для применения нового цвета
                                targetCell.dataset.activity = activityLevel;
                                // Затем добавляем анимацию
                                targetCell.style.transform = 'translateY(-10px) scale(1.2) rotate(5deg)';

                                setTimeout(() => {
                                    targetCell.style.transform = '';
                                }, 300);
                            }
                        }
                    }
                }
            }
        }

        // Расчёт текущей серии (streak)
        function calculateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayKey = formatDateKey(today);

            let streak = 0;
            let checkDate = new Date(today);
            let checkedToday = false;

            // Проверяем сегодняшнюю активность
            const todayActivity = activityData[todayKey];
            if (todayActivity && todayActivity !== 'none') {
                streak++;
                checkedToday = true;
            }

            // Если сегодня нет активности, проверяем вчерашний день
            // Если вчера была активность - streak продолжается
            if (!checkedToday) {
                checkDate.setDate(checkDate.getDate() - 1);
                const yesterdayKey = formatDateKey(checkDate);
                const yesterdayActivity = activityData[yesterdayKey];

                if (!yesterdayActivity || yesterdayActivity === 'none') {
                    // Если вчера тоже не было активности - streak = 0
                    return 0;
                }
                // Вчера была активность - продолжаем считать дальше назад
            }

            // Считаем подряд идущие дни назад от проверенной даты
            while (true) {
                checkDate.setDate(checkDate.getDate() - 1);
                const dateKey = formatDateKey(checkDate);
                const activity = activityData[dateKey];

                if (activity && activity !== 'none') {
                    streak++;
                } else {
                    break;
                }

                // Ограничиваем чтобы не уйти в бесконечность
                if (streak > 3650) break;
            }

            return streak;
        }

        // Показ анимации streak (как в Duolingo)
        function showStreakAnimation() {
            const today = new Date();
            const todayKey = formatDateKey(today);

            // Проверяем, показывали ли уже сегодня
            const lastShown = localStorage.getItem('fitTrackerStreakLastShown');
            if (lastShown === todayKey) {
                return; // Уже показывали сегодня
            }

            // Вычисляем текущий streak
            const streak = calculateStreak();

            // Показываем только если streak > 0
            if (streak === 0) {
                // Сохраняем что проверили сегодня, но не показываем
                localStorage.setItem('fitTrackerStreakLastShown', todayKey);
                return;
            }

            // Создаём элементы анимации
            const overlay = document.createElement('div');
            overlay.className = 'streak-overlay';

            const fire = document.createElement('div');
            fire.className = 'streak-fire glow';
            fire.textContent = '🔥';

            const number = document.createElement('div');
            number.className = 'streak-number';
            number.textContent = streak;

            const text = document.createElement('div');
            text.className = 'streak-text';
            const dayWord = streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней');
            text.textContent = `${dayWord} подряд!`;

            overlay.appendChild(fire);
            overlay.appendChild(number);
            overlay.appendChild(text);
            document.body.appendChild(overlay);

            // Показываем анимацию
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });

            // Вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                setTimeout(() => {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }, 300);
            }

            // Скрываем и удаляем через 2.5 секунды
            setTimeout(() => {
                overlay.classList.remove('show');
                overlay.classList.add('hide');
            }, 2500);

            // Удаляем из DOM после анимации
            setTimeout(() => {
                overlay.remove();
            }, 3000);

            // Сохраняем дату показа
            localStorage.setItem('fitTrackerStreakLastShown', todayKey);
        }

        // Переключение состояния задачи
        function toggleTask(taskId) {
            // Ищем задачу по ID
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.id === taskId) {
                            const now = new Date();

                            if (!task.completed) {
                                // Задача только что выполнена - записываем время
                                task.completed = true;
                                task.completedAt = now.toISOString();

                                // Если это первая выполненная задача - сохраняем дату начала программы
                                if (!getStartDate()) {
                                    setStartDate(now);
                                    console.log('Первая задача выполнена! Установлена дата начала программы.');
                                }

                                // Слабая вибрация как фидбек
                                if (window.Telegram?.WebApp?.HapticFeedback) {
                                    Telegram.WebApp.HapticFeedback.selectionChanged();
                                }
                            } else {
                                // Задача отменена - убираем время выполнения
                                task.completed = false;
                                task.completedAt = null;
                            }

                            const checkbox = document.getElementById(taskId);
                            if (checkbox) {
                                checkbox.checked = task.completed;

                                // Обновляем текст задачи с временем
                                const todoText = checkbox.closest('.todo-item').querySelector('.todo-text');
                                if (todoText) {
                                    const timeText = task.completed && task.completedAt
                                        ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>`
                                        : '';
                                    todoText.innerHTML = `${task.text}${timeText}`;
                                }

                                const todoItem = checkbox.closest('.todo-item');
                                if (todoItem) {
                                    todoItem.classList.toggle('completed', task.completed);
                                }
                            }
                        }
                    });
                }
            });

            // Сохраняем состояния
            saveTodoStates();

            // Проверяем процент выполнения и записываем активность
            checkAndRecordActivity();

            // Обновляем dashboard strip
            updateDashboardStrip();

            // Обновляем AI комментарий если нужно
            updateAIComment();
        }

        // Переключение видимости подпунктов

        // ===== DASHBOARD STRIP ФУНКЦИИ =====

        // Обновление dashboard strip с актуальными данными
        function updateDashboardStrip() {
            const today = new Date();
            const streak = calculateStreak();
            const currentWorkoutDay = getCurrentWorkoutDay();
            const percentage = calculateCompletionPercentage(currentWorkoutDay);

            // Обновляем дату - показываем только день тренировки, а не календарную дату
            document.getElementById('strip-day').textContent = '';
            document.getElementById('strip-date').textContent = `День ${currentWorkoutDay}`;

            // Обновляем серию
            document.getElementById('streak-count').textContent = `${streak} ${streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней')}`;

            // Обновляем прогресс
            document.getElementById('strip-progress-value').textContent = `${percentage}%`;
            document.getElementById('strip-progress-sub').textContent = `День ${currentWorkoutDay} из 7`;

            // Обновляем круговой прогресс
            const progressCircle = document.getElementById('strip-progress-circle');
            progressCircle.setAttribute('stroke-dasharray', `${percentage}, 100`);
        }

        // ===== AI КОММЕНТАРИЙ ФУНКЦИИ =====

        let lastAICommentUpdate = null;
        let lastAICommentPercentage = -1;
        const AI_COMMENT_UPDATE_INTERVAL = 15 * 60 * 1000; // 15 минут
        const AI_COMMENT_PERCENTAGE_THRESHOLDS = [0, 25, 50, 75, 100];

        // Проверка нужно ли обновить AI комментарий
        function shouldUpdateAIComment(percentage) {
            const now = Date.now();

            // Если еще не было обновления - обновляем
            if (!lastAICommentUpdate) return true;

            // Если прошло 15+ минут - обновляем
            if (now - lastAICommentUpdate > AI_COMMENT_UPDATE_INTERVAL) return true;

            // Если процент изменился до порогового значения - обновляем
            for (const threshold of AI_COMMENT_PERCENTAGE_THRESHOLDS) {
                if (percentage >= threshold && lastAICommentPercentage < threshold) {
                    return true;
                }
            }

            return false;
        }

        // Функция анимации печати текста
        let typingTimeout = null;
        function typeTextWithAnimation(element, text, speed = 30) {
            // Очищаем предыдущую анимацию
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            element.textContent = '';
            element.classList.add('typing');

            let index = 0;
            const dots = '<span class="ai-comment-typing-dots"><span class="ai-comment-typing-dot"></span><span class="ai-comment-typing-dot"></span><span class="ai-comment-typing-dot"></span></span>';

            function type() {
                if (index < text.length) {
                    element.textContent = text.substring(0, index + 1);
                    // Добавляем точки пока печатается
                    if (index < text.length - 1) {
                        element.innerHTML += dots;
                    }
                    index++;
                    typingTimeout = setTimeout(type, speed);
                } else {
                    element.classList.remove('typing');
                    element.textContent = text;
                }
            }

            type();
        }

        // Ручное обновление AI комментария по клику
        async function refreshAIComment() {
            const commentElement = document.getElementById('ai-comment-text');
            const currentWorkoutDay = getCurrentWorkoutDay();
            const percentage = calculateCompletionPercentage(currentWorkoutDay);
            const streak = calculateStreak();

            // Показываем индикатор загрузки
            commentElement.innerHTML = `
                <div class="ai-comment-loading">
                    <span>Анализирую прогресс</span>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                </div>
            `;

            try {
                // Генерируем новый комментарий
                const comment = await generateAICommentForDashboard(percentage, streak);

                // Анимируем появление текста
                typeTextWithAnimation(commentElement, comment, 25);

                // Обновляем время и процент
                lastAICommentUpdate = Date.now();
                lastAICommentPercentage = percentage;

                // Кешируем в localStorage
                localStorage.setItem('fitTrackerAIComment', JSON.stringify({
                    comment,
                    timestamp: lastAICommentUpdate,
                    percentage: lastAICommentPercentage
                }));

                // Вибрация
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.selectionChanged();
                }
            } catch (error) {
                console.error('Error refreshing AI comment:', error);
                commentElement.textContent = getFallbackComment(percentage, streak);
            }
        }

        // Генерация AI комментария для dashboard
        async function updateAIComment(skipAnimation = false) {
            const currentWorkoutDay = getCurrentWorkoutDay();
            const percentage = calculateCompletionPercentage(currentWorkoutDay);
            const streak = calculateStreak();

            // Проверяем нужно ли обновлять
            if (!shouldUpdateAIComment(percentage) && !skipAnimation) {
                return; // Используем закешированный комментарий
            }

            // Показываем индикатор загрузки
            const commentElement = document.getElementById('ai-comment-text');
            commentElement.innerHTML = `
                <div class="ai-comment-loading">
                    <span>Анализирую прогресс</span>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                </div>
            `;

            // Генерируем комментарий
            const comment = await generateAICommentForDashboard(percentage, streak);

            // Анимируем появление текста
            typeTextWithAnimation(commentElement, comment, 25);

            // Сохраняем время обновления и процент
            lastAICommentUpdate = Date.now();
            lastAICommentPercentage = percentage;

            // Кешируем в localStorage
            localStorage.setItem('fitTrackerAIComment', JSON.stringify({
                comment,
                timestamp: lastAICommentUpdate,
                percentage: lastAICommentPercentage
            }));
        }

        // Генерация AI комментария через API
        async function generateAICommentForDashboard(percentage, streak) {
            const currentWorkoutDay = getCurrentWorkoutDay();
            const today = new Date();
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const dayName = dayNames[today.getDay()];

            // Подсчитываем выполненные и оставшиеся задачи
            const todos = todoData[currentWorkoutDay] || [];
            const completedCount = todos.filter(t => t.completed).length;
            const totalCount = todos.length;
            const remainingCount = totalCount - completedCount;

            const systemPrompt = `Ты — мотивирующий фитнес-тренер AI. Ты даёшь короткие, энерджичные комментарии на русском языке (макс 120 символов).
Правила:
- Будь дружелюбным и мотивирующим
- Используй эмодзи (не более 2)
- Адаптируй тон под прогресс пользователя
- Упоминай конкретные цифры (процент, серия, задачи)
- Никогда не повторяйся

Контекст:
- День: ${currentWorkoutDay} из 7
- Процент выполнения: ${percentage}%
- Серия: ${streak} дней
- Выполнено задач: ${completedCount}/${totalCount}
- Осталось: ${remainingCount} задач`;

            try {
                const response = await fetch(getAPIBaseURL(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getConnectionString()}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'FitTracker AI'
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: 'Дай мотивирующий комментарий на основе текущего прогресса.' }
                        ],
                        max_tokens: 150,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const comment = data.choices[0]?.message?.content?.trim() || getFallbackComment(percentage, streak);
                return comment;
            } catch (error) {
                console.error('AI Comment error:', error);
                return getFallbackComment(percentage, streak);
            }
        }

        // Fallback комментарии если API недоступен
        function getFallbackComment(percentage, streak) {
            const comments = [
                { min: 0, max: 24, text: `Начинаем с вдоха! ${streak > 0 ? streak + ' дней серии — отличный старт!' : 'Первый шаг самый важный!'}` },
                { min: 25, max: 49, text: `Хороший старт! ${percentage}% выполнено, продолжайте! 💪` },
                { min: 50, max: 74, text: `Половина позади! ${streak} дней подряд — отличная дисциплина! 🔥` },
                { min: 75, max: 99, text: `Почти у цели! ${percentage}% — финиш прям впереди! 🚀` },
                { min: 100, max: 100, text: `Отлично! Все задачи выполнены! ${streak} дней серии — невероятно! 🏆` }
            ];

            const comment = comments.find(c => percentage >= c.min && percentage <= c.max);
            return comment ? comment.text : comments[0].text;
        }

        // Загрузка закешированного AI комментария
        function loadCachedAIComment() {
            const cached = localStorage.getItem('fitTrackerAIComment');
            if (cached) {
                try {
                    const { comment, timestamp, percentage } = JSON.parse(cached);
                    const commentElement = document.getElementById('ai-comment-text');
                    if (commentElement) {
                        commentElement.textContent = comment;
                    }
                    lastAICommentUpdate = timestamp;
                    lastAICommentPercentage = percentage;
                } catch (e) {
                    console.error('Error loading cached AI comment:', e);
                }
            }
        }

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            initializeApp();
        });

            function initializeApp() {
            loadActivityData();
            initializeTodoLists();

            // Устанавливаем выбранный день тренировки на основе текущей календарной даты
            selectedWorkout = getCurrentWorkoutDay();
            console.log('Текущий день тренировки:', selectedWorkout);

            renderActivityGrid();
            renderTaskDayWidgets();
            setupEventListeners();
            setupModalListeners();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();

            // Показываем streak анимацию при первом входе за день
            showStreakAnimation();

            // Обновляем dashboard strip
            updateDashboardStrip();

            // Загружаем закешированный AI комментарий и генерируем новый если нужно
            loadCachedAIComment();
            updateAIComment();
        }

        // Сброс всей активности (для перехода на новую систему)
        function resetAllActivity() {
            activityData = {};
            localStorage.removeItem('fitTrackerActivity');
            // saveActivityData(); // Не нужно, мы и так удаляем из localStorage
        }

        // Загрузка данных активности
        function loadActivityData() {
            const saved = localStorage.getItem('fitTrackerActivity');
            if (saved) {
                try {
                    activityData = JSON.parse(saved);
                    // Миграция старых числовых значений в новые текстовые
                    const migrationMap = { 0: 'none', 30: 'low', 60: 'medium', 90: 'high', 120: 'max' };
                    let migrated = false;
                    Object.keys(activityData).forEach(key => {
                        if (typeof activityData[key] === 'number') {
                            activityData[key] = migrationMap[activityData[key]] || 'none';
                            migrated = true;
                        }
                    });
                    if (migrated) {
                        saveActivityData();
                    }
                } catch (e) {
                    activityData = {};
                }
            }
        }

        // Сохранение данных активности
        function saveActivityData() {
            localStorage.setItem('fitTrackerActivity', JSON.stringify(activityData));
        }

        // Рендеринг блоков тренировок
        function renderWorkoutBlocks() {
            const track = document.getElementById('workout-track');
            track.innerHTML = '';

            // Перебираем дни 1-7 вместо устаревшего workoutProgram
            for (let day = 1; day <= 7; day++) {
                const block = document.createElement('div');
                block.className = 'workout-block';
                block.dataset.day = day;

                // Создаем пустой блок только с номером дня
                block.innerHTML = `
                    <div class="workout-number">${day}</div>
                `;

                block.addEventListener('click', () => {
                    selectedWorkout = day;
                    openWorkoutModal({ day });
                });
                track.appendChild(block);
            }

            // Центрируем на выбранной тренировке при инициализации
            setTimeout(() => {
                const currentBlock = track.querySelector(`[data-day="${selectedWorkout}"]`);
                if (currentBlock) {
                    currentBlock.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }, 100);
        }

        // Генерация виджетов дней для секции заданий
        function renderTaskDayWidgets() {
            const tasksContainer = document.getElementById('tasks-container');
            if (!tasksContainer) return;

            tasksContainer.innerHTML = '';

            // Сложности для каждого дня (в процентах)
            const dayDifficulties = {
                1: 70,
                2: 65,
                3: 80,
                4: 60,
                5: 70,
                6: 72,
                7: 53
            };

            // Перебираем дни 1-7 вместо устаревшего workoutProgram
            for (let day = 1; day <= 7; day++) {
                const difficulty = dayDifficulties[day] || 50;
                const widget = document.createElement('div');
                widget.className = 'task-day-widget';
                widget.dataset.day = day;

                // Вычисляем параметры SVG круга
                const radius = 16;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (difficulty / 100) * circumference;

                widget.innerHTML = `
                    <div class="task-day-info">
                        <div class="task-day-name">${getWorkoutDayName(day)}</div>
                        <div class="task-day-label">День ${day}</div>
                    </div>
                    <div class="task-difficulty-container">
                        <div class="task-difficulty-label">Сложность</div>
                        <div class="task-difficulty-circle">
                            <svg viewBox="0 0 40 40">
                                <circle class="circle-bg" cx="20" cy="20" r="${radius}"></circle>
                                <circle class="circle-progress" cx="20" cy="20" r="${radius}"
                                        stroke-dasharray="${circumference}"
                                        stroke-dashoffset="${offset}"></circle>
                            </svg>
                        </div>
                    </div>
                `;

                // При клике открываем модальное окно с задачами
                widget.addEventListener('click', () => {
                    selectedWorkout = day;
                    openWorkoutModal({ day });
                });

                tasksContainer.appendChild(widget);
            }
        }


        // ===== НОВЫЕ ФУНКЦИИ ДЛЯ ПРОЦЕНТНОЙ СИСТЕМЫ =====

        // Расчет процента выполнения для отдельной задачи
        
        // Расчет общего процента выполнения для дня
        function calculateCompletionPercentage(day) {
            const tasks = todoData[day];
            if (!tasks || tasks.length === 0) return 0;

            const completedTasks = tasks.filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / tasks.length) * 100);

            console.log(`День ${day}: ${completedTasks}/${tasks.length} задач выполнено = ${percentage}%`);
            return percentage;
        }

        // Обновление состояния родительской задачи на основе подзадач
        function updateParentTaskCompletion(taskId) {
            // Ищем родительскую задачу, содержащую эту подзадачу
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.subtasks) {
                            const subtask = task.subtasks.find(st => st.id === taskId);
                            if (subtask) {
                                // Обновляем состояние родительской задачи
                                const percentage = getTaskCompletionPercentage(task);
                                const newCompletedState = percentage === 100;

                                // Обновляем состояние в данных
                                task.completed = newCompletedState;
                                console.log(`Родительская задача "${task.text}" ${newCompletedState ? 'активирована' : 'деактивирована'} через подзадачи`);

                                // Обновляем UI родительской задачи
                                const parentCheckbox = document.getElementById(task.id);
                                if (parentCheckbox) {
                                    parentCheckbox.checked = newCompletedState;
                                    const todoItem = parentCheckbox.closest('.todo-item');
                                    if (todoItem) {
                                        todoItem.classList.toggle('completed', newCompletedState);
                                    }
                                }
                            }
                        }
                    });
                }
            });
            // Сохраняем обновленные состояния
            saveTodoStates();
        }

        
        // ===== КОНЕЦ НОВЫХ ФУНКЦИЙ =====

        // Проверка выполнения тренировки
        function checkWorkoutCompleted(day) {
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 7 : today.getDay(); // Воскресенье = 7
            return day <= currentDay && getActivityForDate(new Date()) !== 'none';
        }

        // Рендеринг вертикального календаря активности
        function renderActivityGrid(isForward = true) {
            const container = document.getElementById('calendar-months');
            const tooltip = document.getElementById('activity-tooltip');
            const calendarWrapper = document.querySelector('.calendar-wrapper');

            // Если контейнер не пустой, анимируем смену года
            if (container.children.length > 0) {
                // Анимируем исчезновение
                calendarWrapper.style.transform = isForward ? 'translateX(-50px)' : 'translateX(50px)';
                calendarWrapper.style.opacity = '0';

                setTimeout(() => {
                    renderCalendarContent(container, tooltip, calendarWrapper, isForward);
                }, 150);
            } else {
                renderCalendarContent(container, tooltip, calendarWrapper, isForward);
            }
        }

        // Функция для рендеринга контента календаря
        function renderCalendarContent(container, tooltip, calendarWrapper, isForward) {
            // Очищаем контейнер
            container.innerHTML = '';

            const today = new Date();
            const todayKey = formatDateKey(today);

            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const weekDays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

            // Генерируем месяцы
            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(currentYear, month, 1);
                const lastDay = new Date(currentYear, month + 1, 0);
                const numDays = lastDay.getDate();

                // Создаем контейнер для месяца
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                // Добавляем ID для текущего месяца
                if (month === today.getMonth() && currentYear === today.getFullYear()) {
                    monthDiv.id = 'current-month';
                }

                // Заголовок месяца
                const monthHeader = document.createElement('div');
                monthHeader.className = 'calendar-month-header';
                monthHeader.style.cursor = 'pointer';
                monthHeader.textContent = monthNames[month];
                monthHeader.addEventListener('click', () => {
                    if (confirm('Сбросить ВЕСЬ прогресс?\n\nВся активность и все выполненные задачи будут удалены.')) {
                        resetAllProgress();
                    }
                });
                monthDiv.appendChild(monthHeader);

                // Создаем заголовки дней недели
                const weekHeader = document.createElement('div');
                weekHeader.className = 'calendar-week';

                for (let i = 0; i < 7; i++) {
                    const dayLabel = document.createElement('div');
                    dayLabel.className = 'calendar-weekday';
                    dayLabel.textContent = weekDays[i];
                    weekHeader.appendChild(dayLabel);
                }
                monthDiv.appendChild(weekHeader);

                // Определяем день недели первого дня месяца
                let firstDayOfWeek = firstDay.getDay();
                firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // ПН=0, ВСК=6

                // Создаем ячейки дней
                let currentDay = 1;
                let weekDiv;

                while (currentDay <= numDays) {
                    weekDiv = document.createElement('div');
                    weekDiv.className = 'calendar-week';

                    // Заполняем неделю
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const cell = document.createElement('div');

                        if (currentDay === 1 && dayOfWeek < firstDayOfWeek) {
                            // Пустые ячейки до начала месяца
                            cell.className = 'activity-cell empty';
                        } else if (currentDay <= numDays) {
                            // Ячейка с днем
                            const currentDate = new Date(currentYear, month, currentDay);
                            const dateKey = formatDateKey(currentDate);
                            const activity = getActivityForDate(currentDate);

                            cell.className = 'activity-cell';
                            cell.dataset.date = dateKey;
                            cell.dataset.activity = activity;

                            if (dateKey === todayKey) {
                                cell.classList.add('today');
                            }

                            // Добавляем номер дня
                            const dateNumber = document.createElement('span');
                            dateNumber.className = 'date-number';
                            dateNumber.textContent = currentDay;
                            cell.appendChild(dateNumber);

                            // Обработчики событий
                            cell.addEventListener('mouseenter', (e) => {
                                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                                const dateString = currentDate.toLocaleDateString('ru-RU', options);
                                const activityLabels = {
                                    'none': 'нет активности',
                                    'low': 'минимальная активность',
                                    'medium': 'средняя активность',
                                    'high': 'высокая активность',
                                    'max': 'максимальная активность'
                                };
                                const activityText = activityLabels[activity] || 'нет активности';
                                tooltip.innerHTML = `
                                    <strong>${dateString}</strong><br>
                                    ${activityText}${dateKey === todayKey ? '<br><em>(Сегодня)</em>' : ''}
                                `;
                                tooltip.classList.add('show');

                                const rect = e.target.getBoundingClientRect();
                                const containerRect = e.target.closest('.activity-grid-vertical').getBoundingClientRect();
                                tooltip.style.left = (rect.left - containerRect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                                tooltip.style.top = (rect.top - containerRect.top - tooltip.offsetHeight - 10) + 'px';
                            });

                            cell.addEventListener('mouseleave', () => {
                                tooltip.classList.remove('show');
                            });

                            currentDay++;
                        } else {
                            // Пустые ячейки в конце месяца
                            cell.className = 'activity-cell empty';
                        }

                        weekDiv.appendChild(cell);
                    }

                    monthDiv.appendChild(weekDiv);
                }

                container.appendChild(monthDiv);
            }

            // Анимируем появление
            if (calendarWrapper) {
                calendarWrapper.style.transform = 'translateX(0)';
                calendarWrapper.style.opacity = '1';
            }

            // Прокручиваем к текущему месяцу с задержкой
            setTimeout(() => {
                const currentMonthElement = document.getElementById('current-month');
                if (currentMonthElement) {
                    currentMonthElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 300); // Небольшая задержка для завершения анимации
        }

        
        // Получение активности для даты
        function getActivityForDate(date) {
            const key = formatDateKey(date);
            return activityData[key] || 'none';
        }

        // Функция для сброса активности за определенную дату
        function resetActivityForDate(date) {
            const dateKey = formatDateKey(date);

            // Удаляем активность за эту дату
            delete activityData[dateKey];
            saveActivityData();

            // Сбрасываем todos для дней тренировок, которые соответствуют этой дате
            Object.keys(todoData).forEach(day => {
                const workoutDate = getWorkoutDate(parseInt(day));
                if (formatDateKey(workoutDate) === dateKey) {
                    // Сбрасываем все задачи для этого дня
                    todoData[day].forEach(task => {
                        task.completed = false;
                        // Сбрасываем все подзадачи
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                    saveTodoStates();

                    // Если режим задач открыт для этого дня, обновляем его
                    const workoutSection = document.querySelector('.workout-section');
                    if (workoutSection.classList.contains('show-todos') && selectedWorkout === day) {
                        const todoContent = document.getElementById('todo-content');
                        todoContent.innerHTML = createTodoHtml(todoData[day]);
                    }
                }
            });

            // Перерисовываем календарь
            renderActivityGrid();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();
        }

        // Функция для полного сброса всего прогресса
        function resetAllProgress() {
            // Очищаем всю активность
            activityData = {};
            saveActivityData();

            // Сбрасываем все задачи
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        task.completed = false;
                        task.completedAt = null;
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                }
            });
            saveTodoStates();

            // Перерисовываем UI
            renderActivityGrid();
            renderWorkoutBlocks();

            // Обновляем модалку если открыта
            const todoContent = document.getElementById('todo-content');
            if (todoContent && selectedWorkout) {
                todoContent.innerHTML = createTodoHtml(todoData[selectedWorkout] || []);
            }

            // Вибрация подтверждения
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        // Форматирование ключа даты
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Форматирование даты для отображения
        function formatDate(date) {
            return `${date.getDate()} ${['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][date.getMonth()]}`;
        }

  
  
        // Функции для режима отображения задач
        function openWorkoutModal(workout) {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalContent = document.getElementById('todo-modal-content');
            const todoModalTitle = document.getElementById('todo-modal-title');

            // Получаем номер дня (поддерживает как старый формат {day}, так и просто число)
            const dayNumber = typeof workout === 'object' ? workout.day : workout;

            // Устанавливаем заголовок с динамическим названием дня
            const dayName = getWorkoutDayName(dayNumber);
            todoModalTitle.textContent = `День ${dayNumber} (${dayName}) - Задания`;

            // Отображаем todo-список для этого дня
            const dayTodos = todoData[dayNumber];
            todoModalContent.innerHTML = createTodoHtml(dayTodos);

            // Показываем overlay с анимацией
            todoOverlay.style.display = 'block';
            setTimeout(() => {
                todoOverlay.classList.add('show');
            }, 10);

            // Блокируем прокрутку карусели
            const workoutTrack = document.getElementById('workout-track');
            workoutTrack.style.overflow = 'hidden';
            workoutTrack.style.pointerEvents = 'none';

            // Запоминаем текущий выбранный день
            selectedWorkout = workout.day;
        }

        function closeWorkoutModal() {
            const todoOverlay = document.getElementById('todo-overlay');
            const workoutTrack = document.getElementById('workout-track');

            // Скрываем overlay с анимацией
            todoOverlay.classList.remove('show');
            setTimeout(() => {
                todoOverlay.style.display = 'none';
            }, 300);

            // Восстанавливаем прокрутку карусели
            workoutTrack.style.overflow = 'auto';
            workoutTrack.style.pointerEvents = 'auto';

            // Прокручиваем к выбранному дню
            const currentBlock = workoutTrack.querySelector(`[data-day="${selectedWorkout}"]`);
            if (currentBlock) {
                currentBlock.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        // Добавим обработчики для модального окна
        function setupModalListeners() {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalClose = document.getElementById('todo-modal-close');
            const exerciseCardClose = document.getElementById('exercise-card-close');
            const exerciseCheckBtn = document.getElementById('exercise-check-btn');

            // Закрытие по клику на крестик (сначала закрываем карточку упражнения, потом модальное окно)
            todoModalClose.addEventListener('click', () => {
                if (exerciseCardVisible) {
                    closeExerciseCard();
                } else {
                    closeWorkoutModal();
                }
            });

            // Закрытие карточки упражнения по её кресту
            exerciseCardClose.addEventListener('click', closeExerciseCard);

            // Кнопка-галочка для завершения упражнения
            exerciseCheckBtn.addEventListener('click', toggleExercise);

            // Закрытие по клику на заголовок (только если это не кнопка)
            const todoModalHeader = document.querySelector('.todo-modal-header');
            todoModalHeader.addEventListener('click', (e) => {
                if (e.target === todoModalHeader) {
                    if (exerciseCardVisible) {
                        closeExerciseCard();
                    } else {
                        closeWorkoutModal();
                    }
                }
            });

            // Закрытие по клавише Escape
            document.addEventListener('keydown', (e) => {
                const todoOverlay = document.getElementById('todo-overlay');
                if (e.key === 'Escape' && todoOverlay.classList.contains('show')) {
                    if (exerciseCardVisible) {
                        closeExerciseCard();
                    } else {
                        closeWorkoutModal();
                    }
                }
            });
        }

        // Установка обработчиков событий
        function setupEventListeners() {
            // Клик на AI комментарий для обновления
            const aiCommentElement = document.getElementById('ai-comment');
            if (aiCommentElement) {
                aiCommentElement.addEventListener('click', () => {
                    refreshAIComment();
                });
            }

            // Прокрутка с клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && selectedWorkout > 1) {
                    selectWorkout(selectedWorkout - 1);
                } else if (e.key === 'ArrowRight' && selectedWorkout < 7) {
                    selectWorkout(selectedWorkout + 1);
                }
            });

            // ===== СЛАЙДЕР: ЧАТ (0) - КАЛЕНДАРЬ (1) - ЗАДАНИЯ (2) =====
            let currentSlide = 1; // 0 = чат слева, 1 = календарь по центру, 2 = задания справа
            const activitySlider = document.querySelector('.activity-slider');
            const calendarContainers = document.querySelectorAll('.calendar-container');

            // Функция для переключения слайдов
            function switchSlide(targetSlide) {
                if (targetSlide < 0 || targetSlide > 2) return;

                currentSlide = targetSlide;
                calendarContainers.forEach((container, index) => {
                    const offset = index - currentSlide;
                    container.style.transform = `translateX(${offset * 110}%)`;
                    container.style.zIndex = index === currentSlide ? '2' : '1';
                });

                // Фокус на поле ввода при открытии чата
                if (currentSlide === 0) {
                    setTimeout(() => {
                        const chatInput = document.getElementById('slider-chat-input');
                        if (chatInput) chatInput.focus();
                    }, 300);
                }
            }

            // Инициализация начальных стилей для контейнеров
            calendarContainers.forEach((container, index) => {
                const offset = index - currentSlide;
                container.style.transform = `translateX(${offset * 110}%)`;
                container.style.zIndex = index === currentSlide ? '2' : '1';
            });

            // Элементы, с которых НЕ должен начинаться свайп
            const noSwipeElements = new Set([
                'chat-input-neobrut',
                'chat-send-neobrut'
            ]);

            // Проверка - можно ли свайпать с этого элемента
            function canSwipeFrom(target) {
                if (noSwipeElements.has(target.className)) {
                    return false;
                }
                let parent = target.parentElement;
                while (parent) {
                    if (noSwipeElements.has(parent.className)) {
                        return false;
                    }
                    if (parent.classList && parent.classList.contains('activity-cell')) {
                        return false;
                    }
                    parent = parent.parentElement;
                }
                return true;
            }

            // Обработчики для touch свайпов
            let touchStartX = 0;
            let isSwiping = false;

            activitySlider.addEventListener('touchstart', (e) => {
                if (!canSwipeFrom(e.target)) return;
                touchStartX = e.touches[0].clientX;
                isSwiping = false;
            }, { passive: true });

            activitySlider.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;
                const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                if (deltaX > 20) {
                    isSwiping = true;
                    e.preventDefault();
                }
            }, { passive: false });

            activitySlider.addEventListener('touchend', (e) => {
                if (!isSwiping) {
                    touchStartX = 0;
                    return;
                }
                const diff = touchStartX - e.changedTouches[0].clientX;
                touchStartX = 0;
                isSwiping = false;

                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        // Свайп влево → следующий слайд
                        if (currentSlide < 2) switchSlide(currentSlide + 1);
                    } else {
                        // Свайп вправо → предыдущий слайд
                        if (currentSlide > 0) switchSlide(currentSlide - 1);
                    }
                }
            });

            // Свайп мышью для десктопа
            let mouseStartX = 0;
            let mouseIsDown = false;

            activitySlider.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('activity-cell') ||
                    e.target.closest('.activity-cell') ||
                    e.target.classList.contains('chat-input-neobrut') ||
                    e.target.closest('.chat-input-neobrut')) {
                    return;
                }
                mouseStartX = e.clientX;
                mouseIsDown = true;
            });

            activitySlider.addEventListener('mousemove', (e) => {
                if (!mouseIsDown) return;
                const deltaX = Math.abs(e.clientX - mouseStartX);
                if (deltaX > 20) {
                    isSwiping = true;
                }
            });

            activitySlider.addEventListener('mouseup', (e) => {
                if (!mouseIsDown) return;
                if (isSwiping) {
                    const diff = mouseStartX - e.clientX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0) {
                            if (currentSlide < 2) switchSlide(currentSlide + 1);
                        } else {
                            if (currentSlide > 0) switchSlide(currentSlide - 1);
                        }
                    }
                }
                mouseIsDown = false;
                isSwiping = false;
            });

            activitySlider.addEventListener('mouseleave', () => {
                mouseIsDown = false;
                isSwiping = false;
            });

            // Устанавливаем обработчики для модального окна
            setupModalListeners();
        }

        // AI Chat функции
        let chatHistory = [];
        let conversationContext = {
            userName: null,
            userLevel: 'beginner',
            lastWorkoutDay: null,
            totalWorkouts: 0,
            currentStreak: 0
        };

        function openAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.classList.add('show');
                // Фокус на поле ввода
                const chatInput = document.getElementById('chat-input');
                chatInput.focus();

                // Прогрев AI - быстрый запрос для инициализации
                if (chatHistory.length === 2) { // Только при первом открытии
                    generateAIResponse("👋").catch(() => {}); // Silent fail
                }
            }, 10);
        }

        function closeAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        // Переменные для свайпа закрытия чата
        let chatTouchStartY = 0;
        let chatTouchEndY = 0;
        let chatIsSwipingDown = false;
        const chatSwipeThreshold = 80; // Минимальная дистанция свайпа
        const chatHeaderHeightRatio = 0.2; // 20% высоты чата - зона свайпа

        // Универсальная функция для добавления сообщения в оба контейнера
        function addMessageToContainer(containerId, content, isUser = false) {
            const messagesContainer = document.getElementById(containerId);
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message ai-message';

            // Проверяем, является ли контент HTML (для AI сообщений)
            const isHTML = !isUser && content.includes('<');

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${isHTML ? content : `<p>${content}</p>`}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Прокрутка к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessage(content, isUser = false) {
            // Добавляем в overlay чат
            addMessageToContainer('chat-messages', content, isUser);
            // Добавляем в slider чат
            addMessageToContainer('slider-chat-messages', content, isUser);

            // Сохраняем в историю в формате OpenRouter
            chatHistory.push({
                role: isUser ? 'user' : 'assistant',
                content: content
            });

            // Ограничиваем историю последними 30 сообщениями
            if (chatHistory.length > 30) {
                chatHistory = chatHistory.slice(-30);
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Функция для отправки сообщения из slider чата
        async function sendSliderMessage() {
            const chatInput = document.getElementById('slider-chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendSliderMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Форматирование ответа AI для лучшей читаемости
        function formatAIResponse(text) {
            // Разделяем текст на абзацы
            let formatted = text
                // Заменяем множественные переносы строк на одиночные
                .replace(/\n{3,}/g, '\n\n')
                // Оборачиваем эмодзи в спаны
                .replace(/([\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2600-\u27BF])/g,
                    '<span style="font-size: 1.2em; margin-right: 4px;">$&</span>')
                // Форматируем заголовки (строки начинающиеся с #)
                .replace(/^(#{1,3})\s+(.+)$/gm, '<h3 style="color: var(--accent-blue); margin: 12px 0 8px; font-weight: 600;">$2</h3>')
                // Форматируем жирный текст
                .replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--neobrut-darkgray);">$1</strong>')
                // Форматируем списки (строки начинающиеся с -)
                .replace(/^(\s*[-•*]\s+(.+))$/gm, '<div class="ai-list-item">• $2</div>')
                // Форматируем нумерованные списки
                .replace(/^(\s*\d+\.\s+.+)$/gm, '<div class="ai-list-item">$1</div>')
                // Разбиваем на параграфы
                .split('\n\n')
                .map(paragraph => paragraph.trim())
                .filter(paragraph => paragraph.length > 0)
                .map(paragraph => {
                    // Если параграф начинается с <h3> или <div>, оставляем как есть
                    if (paragraph.startsWith('<h3>') || paragraph.startsWith('<div class="ai-list-item">')) {
                        return paragraph;
                    }
                    // Иначе оборачиваем в параграф
                    return `<p style="margin: 10px 0; line-height: 1.6;">${paragraph}</p>`;
                })
                .join('\n');

            return formatted;
        }

        async function generateAIResponse(userMessage) {
            const currentWorkoutDay = getCurrentWorkoutDay();
            const today = new Date();
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const dayName = dayNames[today.getDay()];
            const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const monthName = monthNames[today.getMonth()];
            const dateString = `${dayName}, ${today.getDate()} ${monthName} ${today.getFullYear()}`;

            try {
                // Добавляем индикатор набора текста
                showTypingIndicator();

                const response = await fetch(getAPIBaseURL(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getConnectionString()}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'FitTracker AI'
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            {
                                role: "system",
                                content: `Ты - AI фитнес-ассистент FitTracker AI. Помогай пользователю с тренировками так, как считаешь нужным в каждой ситуации. Сам решай, что уместно: объяснить технику, дать совет, поддержать или просто ответить на вопрос. Будь дружелюбным и проявляй участие.

                                БАЗОВЫЕ ПРАВИЛА:
                                - Отвечай тепло, но коротко по делу
                                - СТРОГОЕ ОГРАНИЧЕНИЕ ПО ЭМОДЗИ: НЕ используй эмодзи в 60-70% ответов. Только 1 эмодзи на ответ, и только когда это действительно уместно. В большинстве случаев отвечай вообще без эмодзи.

                                СЕГОДНЯ: ${dateString}
                                Тренировочный день: ${currentWorkoutDay}/7 (${getWorkoutDayName(currentWorkoutDay)})

                                ВСЕ ЗАДАНИЯ ПО ДНЯМ:
                                ${Object.keys(todoData).map(day => {
                                    const dayNum = parseInt(day);
                                    const tasks = todoData[day] || [];
                                    const completed = tasks.filter(t => t.completed).length;
                                    return `День ${dayNum} (${getWorkoutDayName(dayNum)}): ${completed}/${tasks.length} выполнено`;
                                }).join('\\n')}

                                ЗАДАЧИ НА КАЖДЫЙ ДЕНЬ:
                                ${Object.keys(todoData).map(day => {
                                    const dayNum = parseInt(day);
                                    const tasks = todoData[day] || [];
                                    return `\\n--- День ${dayNum} (${getWorkoutDayName(dayNum)}) ---` +
                                        (tasks.length > 0 ? tasks.map(t => `${t.completed ? '✅' : '⏳'} ${t.text}`).join('\\n') : 'Нет задач');
                                }).join('\\n')}

                                Выполнение сегодня: ${calculateCompletionPercentage(currentWorkoutDay)}%
                                Активных дней: ${Object.keys(activityData).filter(date => activityData[date] && activityData[date] !== 'none').length}
                                Время: ${new Date().toLocaleString('ru-RU')}`
                            },
                            ...chatHistory.slice(-10), // Последние 10 сообщений для контекста
                            {
                                role: "user",
                                content: userMessage
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.9,
                        top_p: 0.95,
                        frequency_penalty: 0.3,
                        presence_penalty: 0.6
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Response Error:', errorText);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.error) {
                    console.error('API Error:', data.error);
                    throw new Error(`API Error: ${data.error.message || data.error.type}`);
                }

                const aiMessage = data.choices[0]?.message?.content || "Извините, произошла ошибка. Попробуйте еще раз.";

                hideTypingIndicator();
                return formatAIResponse(aiMessage.trim());
            } catch (error) {
                console.error('AI API Error:', error);
                hideTypingIndicator();
                // Fallback ответы при ошибке API
                const fallbackResponses = [
                    "Произошла ошибка подключения. Давайте я помогу своими силами!",
                    "Не удалось связаться с AI. Попробуйте еще раз через минуту.",
                    "Кажется, проблема с соединением. Продолжайте тренироваться, а я скоро вернусь!"
                ];
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }
        }

        function showTypingIndicator() {
            // Показываем в обоих контейнерах
            ['chat-messages', 'slider-chat-messages'].forEach(containerId => {
                const messagesContainer = document.getElementById(containerId);
                if (!messagesContainer) return;

                // Удаляем существующий индикатор если есть
                const existing = messagesContainer.querySelector('.typing-indicator');
                if (existing) existing.remove();

                const typingDiv = document.createElement('div');
                typingDiv.className = 'message typing-indicator';
                typingDiv.id = `typing-indicator-${containerId}`;
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="typing-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function hideTypingIndicator() {
            // Удаляем из обоих контейнеров
            ['chat-messages', 'slider-chat-messages'].forEach(containerId => {
                const typingIndicator = document.getElementById(`typing-indicator-${containerId}`);
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            });
        }

        // Дополнительные функции AI чата

        // Очистка истории чата
        function clearChatHistory() {
            chatHistory = [];
            const welcomeMessage = `
                <div class="message">
                    <div class="message-content">
                        <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                    </div>
                </div>
            `;

            // Очищаем оба контейнера
            const overlayMessages = document.getElementById('chat-messages');
            const sliderMessages = document.getElementById('slider-chat-messages');

            if (overlayMessages) overlayMessages.innerHTML = welcomeMessage;
            if (sliderMessages) sliderMessages.innerHTML = welcomeMessage;
        }

        // Функция для получения умного совета на основе прогресса
        async function getSmartTip() {
            const currentWorkoutDay = getCurrentWorkoutDay();
            const completion = calculateCompletionPercentage(currentWorkoutDay);
            let tipType = 'general';

            if (completion === 100) {
                tipType = 'motivation';
            } else if (completion > 50) {
                tipType = 'encouragement';
            } else if (completion > 0) {
                tipType = 'continuation';
            } else {
                tipType = 'start';
            }

            const prompt = `Дай короткий мотивирующий совет (${tipType}) для дня ${currentWorkoutDay}. Максимально 50 слов.`;
            return await generateAIResponse(prompt);
        }

        // Инициализация AI чата
        document.addEventListener('DOMContentLoaded', () => {
            // ===== Обработчики для OVERLAY чата (старый) =====
            const aiChatClose = document.getElementById('ai-chat-close');
            if (aiChatClose) {
                aiChatClose.addEventListener('click', closeAIChat);
            }

            // Обработчик очистки чата
            const aiChatClear = document.getElementById('ai-chat-clear');
            if (aiChatClear) {
                aiChatClear.addEventListener('click', () => {
                    if (confirm('Очистить всю историю чата?')) {
                        clearChatHistory();
                    }
                });
            }

            // Обработчик отправки сообщения для overlay чата
            const chatSend = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');

            if (chatSend) {
                chatSend.addEventListener('click', sendMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // ===== Обработчики для SLIDER чата =====
            const sliderChatSend = document.getElementById('slider-chat-send');
            const sliderChatInput = document.getElementById('slider-chat-input');

            if (sliderChatSend) {
                sliderChatSend.addEventListener('click', sendSliderMessage);
            }

            if (sliderChatInput) {
                sliderChatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendSliderMessage();
                    }
                });
            }

            // Обработчики свайпа для закрытия чата
            const aiChatOverlay = document.getElementById('ai-chat-overlay');
            if (aiChatOverlay) {
                aiChatOverlay.addEventListener('touchstart', (e) => {
                    const chatHeader = e.target.closest('.ai-chat-header');
                    if (chatHeader) {
                        chatTouchStartY = e.touches[0].clientY;
                        chatIsSwipingDown = false;
                    }
                }, { passive: true });

                aiChatOverlay.addEventListener('touchmove', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchY = e.touches[0].clientY;
                    const deltaY = touchY - chatTouchStartY;

                    // Проверяем, что свайп вниз
                    if (deltaY > 20) {
                        chatIsSwipingDown = true;

                        // Применяем трансформацию для визуальной обратной связи
                        const transform = Math.min(deltaY * 0.5, 100);
                        aiChatOverlay.style.transform = `translateY(${transform}px)`;
                        aiChatOverlay.style.opacity = 1 - (deltaY / 300);

                        // Предотвращаем скролл сообщений во время свайпа
                        e.preventDefault();
                    }
                }, { passive: false });

                aiChatOverlay.addEventListener('touchend', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchEndY = e.changedTouches[0].clientY;
                    const deltaY = touchEndY - chatTouchStartY;

                    // Сбрасываем стили
                    aiChatOverlay.style.transform = '';
                    aiChatOverlay.style.opacity = '';

                    // Проверяем, достаточно ли сильный свайп вниз для закрытия
                    if (deltaY > chatSwipeThreshold && chatIsSwipingDown) {
                        closeAIChat();
                    }

                    // Сбрасываем переменные
                    chatTouchStartY = 0;
                    chatTouchEndY = 0;
                    chatIsSwipingDown = false;
                }, { passive: true });
            }
        });

        // Функционал перетаскивания разделителя с плавной интерполяцией
        let isDragging = false;
        let startY = 0;
        let startTopHeight = 0;
        let rafId = null;
        let currentY = 0;

        // Переменные для плавной интерполяции (lerp)
        let targetHeight = 0;
        let currentHeight = 0;
        const lerpFactor = 0.18; // Плавное отставание для минимизации лагов

        // Кэшированные измерения для производительности
        let cachedMeasurements = {
            minTopHeight: 60,
            minBottomHeight: 200,
            dividerHeight: 0,
            viewportHeight: 0
        };

        const dividerButton = document.querySelector('.divider-button');
        const workoutSection = document.querySelector('.workout-section');
        const activitySection = document.querySelector('.activity-section');
        const divider = document.querySelector('.divider');

        // Кэшируем dayLabels (делаем один раз при инициализации)
        let cachedDayLabels = null;
        let hasCalendarChecked = false;

        // Устанавливаем начальную высоту после загрузки страницы
        setTimeout(() => {
            const viewportHeight = window.innerHeight;
            const baseHeight = 160;
            const additionalHeight = viewportHeight * 0.05;
            const initialHeight = baseHeight + additionalHeight;
            currentHeight = initialHeight;
            targetHeight = initialHeight;
            workoutSection.style.setProperty('--workout-basis', initialHeight + 'px');
        }, 100);

        // Кэшируем измерения при начале перетаскивания
        function cacheMeasurements() {
            cachedMeasurements.viewportHeight = window.innerHeight;
            cachedMeasurements.dividerHeight = divider.getBoundingClientRect().height;

            if (!hasCalendarChecked) {
                cachedDayLabels = document.querySelectorAll('.calendar-weekday, .day-label');
                hasCalendarChecked = true;
            }

            if (cachedDayLabels && cachedDayLabels.length > 0) {
                cachedMeasurements.minBottomHeight = cachedMeasurements.viewportHeight * 0.40;
            } else {
                const activityHeader = activitySection.querySelector('.activity-header');
                const headerHeight = activityHeader ? activityHeader.getBoundingClientRect().height : 60;
                cachedMeasurements.minBottomHeight = headerHeight + 250;
            }
        }

        // Вычисляем целевую высоту с ограничениями
        function calculateTargetHeight(clientY) {
            const deltaY = clientY - startY;
            let height = startTopHeight + deltaY;
            height = Math.max(cachedMeasurements.minTopHeight, height);
            height = Math.min(
                cachedMeasurements.viewportHeight - cachedMeasurements.dividerHeight - cachedMeasurements.minBottomHeight,
                height
            );
            return height;
        }

        // Плавная интерполяция (lerp)
        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }

        // Функция обновления через RAF (работает на 60fps автоматически)
        function updateFrame() {
            // Плавно двигаем текущую высоту к цели
            currentHeight = lerp(currentHeight, targetHeight, lerpFactor);

            // Применяем текущую высоту
            workoutSection.style.setProperty('--workout-basis', currentHeight + 'px');

            // Продолжаем цикл пока перетаскиваем
            if (isDragging) {
                rafId = requestAnimationFrame(updateFrame);
            }
        }

        // Обновляем целевую позицию
        function updateSizes(clientY) {
            currentY = clientY;
            targetHeight = calculateTargetHeight(clientY);
        }

        // Обработчики для мыши
        dividerButton.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            currentY = e.clientY;
            startTopHeight = workoutSection.getBoundingClientRect().height;
            currentHeight = startTopHeight;
            targetHeight = startTopHeight;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            workoutSection.classList.add('dragging');
            cacheMeasurements();
            // Запускаем постоянный цикл
            rafId = requestAnimationFrame(updateFrame);
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSizes(e.clientY);
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                workoutSection.classList.remove('dragging');
                // Финальное обновление до точной позиции
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
                // Плавно доводим до конечной позиции
                const finishAnimation = () => {
                    const diff = Math.abs(targetHeight - currentHeight);
                    if (diff > 0.5) {
                        currentHeight = lerp(currentHeight, targetHeight, 0.2);
                        workoutSection.style.setProperty('--workout-basis', currentHeight + 'px');
                        requestAnimationFrame(finishAnimation);
                    } else {
                        workoutSection.style.setProperty('--workout-basis', targetHeight + 'px');
                    }
                };
                finishAnimation();
            }
        });

        // Обработчики для touch (мобильные устройства)
        dividerButton.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            currentY = e.touches[0].clientY;
            startTopHeight = workoutSection.getBoundingClientRect().height;
            currentHeight = startTopHeight;
            targetHeight = startTopHeight;
            workoutSection.classList.add('dragging');
            cacheMeasurements();
            // Запускаем постоянный цикл
            rafId = requestAnimationFrame(updateFrame);
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            updateSizes(e.touches[0].clientY);
        }, { passive: false });

        document.addEventListener('touchend', () => {
            isDragging = false;
            workoutSection.classList.remove('dragging');
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            // Финальная доводка
            const finishAnimation = () => {
                const diff = Math.abs(targetHeight - currentHeight);
                if (diff > 0.5) {
                    currentHeight = lerp(currentHeight, targetHeight, 0.2);
                    workoutSection.style.setProperty('--workout-basis', currentHeight + 'px');
                    requestAnimationFrame(finishAnimation);
                } else {
                    workoutSection.style.setProperty('--workout-basis', targetHeight + 'px');
                }
            };
            finishAnimation();
        });

        // Предотвращаем выделение текста при клике на кнопку
        dividerButton.addEventListener('selectstart', (e) => {
            e.preventDefault();
        });
    </script>
</body>

</html>