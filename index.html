<!DOCTYPE html>
<html lang="ru" class="no-swipe-navigation">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="MobileOptimized" content="176" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="robots" content="noindex,nofollow" />
    <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
    <title>FitTracker AI</title>
    <style>
        :root {
            /* Яркая палитра необрутализма */
            --neobrut-black: #000000;
            --neobrut-white: #FFFFFF;
            --neobrut-orange: #FF6B35;
            --neobrut-red: #FF006E;
            --neobrut-yellow: #FFBE0B;
            --neobrut-blue: #3A86FF;
            --neobrut-green: #06FFB4;
            --neobrut-purple: #8338EC;
            --neobrut-pink: #FF4081;
            --neobrut-gray: #495057;
            --neobrut-lightgray: #F8F9FA;
            --neobrut-darkgray: #212529;
            --neobrut-cream: #FFFDE7;
            --success-green: #00F5A0;
            --warning-yellow: #FFD23F;
            --bg-grid: #F1F3F5;
            --accent-blue: #4ECDC4;
            --accent-purple: #C77DFF;
            --accent-coral: #FF6B9D;
            /* Новая цветовая схема для активности */
            --lime-green: #D4ED4A;
            --light-green: #98D98E;
            --medium-green: #3CB371;
            --swamp-green: #2F5233;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--neobrut-lightgray);
            color: var(--neobrut-darkgray);
            min-height: 100vh;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overflow-x: hidden;
            width: 100%;
        }

        /* Предотвращение свайп-навигации в мобильных браузерах */
        html.no-swipe-navigation,
        html.no-swipe-navigation body {
            overscroll-behavior-x: none;
            touch-action: pan-y pinch-zoom;
        }

        /* Глобальное скрытие scrollbar для всех элементов */
        *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Глобальный фон на весь экран */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('fantasy-bg-new.jpg') center/cover no-repeat;
            z-index: -1;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        /* Верхняя секция с прокруткой тренировок */
        .workout-section {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-bottom: 4px solid var(--neobrut-black);
            padding: 0;
            position: relative;
            box-shadow: 8px 8px 0 var(--neobrut-black);
            flex-shrink: 0;
            overflow-y: auto;
            min-height: 50px;
        }

        .workout-header {
            padding: 0;
            display: none; /* Скрываем пустой header */
        }

        .workout-title {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
        }

        .workout-counter {
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 8px;
            color: var(--neobrut-black);
            transform: rotate(-2deg);
        }

        /* Контейнер с горизонтальной прокруткой */
        .workout-carousel {
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .workout-track {
            display: flex;
            gap: 20px;
            padding: 0 40px;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
        }

        .workout-track::-webkit-scrollbar {
            display: none;
        }

        /* Блоки тренировок - Квадратные пустые в стиле необрутализма */
        .workout-block {
            flex: 0 0 150px;
            width: 150px;
            height: 150px;
            background: var(--neobrut-white);
            border: 4px solid var(--neobrut-black);
            border-radius: 16px;
            box-shadow:
                8px 8px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0,0,0,0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            opacity: 0.8;
            transform: scale(0.95) rotate(-2deg);
            scroll-snap-align: center;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Базовые элементы */
        .workout-block {
            opacity: 0.8;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .workout-block:hover {
            background: var(--neobrut-white);
            transform: translateY(-2px);
            box-shadow:
                8px 8px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0,0,0,0.1);
        }

        .workout-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-8deg);
            width: 60px;
            height: 60px;
            background: var(--neobrut-orange);
            border: 3px solid var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            color: var(--neobrut-white);
            border-radius: 12px;
            z-index: 2;
        }

        .workout-day {
            position: absolute;
            bottom: 20px;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            letter-spacing: 0.05em;
            text-align: center;
            width: 100%;
        }

        /* Декоративные элементы для пустых блоков */
        .workout-block::before {
            content: '';
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 2px solid var(--neobrut-black);
            border-radius: 50%;
            box-shadow: 2px 2px 0 var(--neobrut-black);
            opacity: 0.8;
        }

      
        /* Todo-список в стиле необрутализма */
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Убираем синюю подсветку для всех интерактивных элементов */
        .todo-list * {
            outline: none !important;
        }

        .todo-list *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Отключаем выделение текста при клике */
        .todo-item,
        .todo-subitem,
        .todo-text,
        .todo-expand,
        .todo-checkbox {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Дополнительно отключаем подсветку при клике на мобильных */
        @media (hover: none) and (pointer: coarse) {
            .todo-item:active,
            .todo-subitem:active,
            .todo-expand:active {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--neobrut-lightgray);
            border: 3px solid var(--neobrut-black);
            box-shadow: 5px 5px 0 var(--neobrut-black);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .todo-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0 var(--neobrut-black);
        }

        .todo-item.completed {
            opacity: 0.7;
            background: var(--success-green);
        }

        .todo-checkbox {
            position: relative;
            width: 24px;
            height: 24px;
            margin-right: 15px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .todo-checkbox input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .checkbox-visual {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .todo-checkbox input:checked ~ .checkbox-visual {
            background: var(--neobrut-yellow);
            transform: rotate(-5deg);
        }

        .checkbox-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 14px;
            height: 10px;
            border-left: 3px solid var(--neobrut-black);
            border-bottom: 3px solid var(--neobrut-black);
            transition: transform 0.2s;
        }

        .todo-checkbox input:checked ~ .checkbox-checkmark {
            transform: translate(-50%, -50%) rotate(-45deg) scale(1);
        }

        .todo-text {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            user-select: none;
            cursor: pointer;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Исключаем время из зачеркивания */
        .todo-item.completed .todo-text .task-time-inline {
            text-decoration: none !important;
            display: inline-block;
        }

        .task-time {
            font-size: 11px;
            color: var(--accent-blue);
            margin-left: 8px;
            white-space: nowrap;
            font-weight: 500;
        }

        .task-time-inline {
            font-size: 13px;
            color: var(--neobrut-black);
            opacity: 0.9;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Подпункты */
        .todo-sublist {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            display: none; /* Скрыты по умолчанию */
        }

        .todo-sublist.expanded {
            display: block;
        }

        .todo-subitem {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-gray);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
            font-size: 14px;
        }

        .todo-subitem:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-subitem .todo-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            margin-top: 1px;
        }

        .todo-subitem .checkbox-visual {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .todo-subitem .checkbox-checkmark {
            width: 10px;
            height: 8px;
            border-width: 2px;
        }

        .todo-subitem .todo-text {
            font-size: 14px;
            font-weight: 500;
            outline: none; /* Убираем синюю рамку при клике */
        }

        .todo-subitem.completed {
            opacity: 0.7;
            background: var(--success-green) !important;
        }

        .todo-subitem.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Маркер для подпунктов */
        .todo-bullet {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--neobrut-gray);
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            margin-top: 6px;
        }

        /* Кнопка раскрытия */
        .todo-expand {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            margin-left: 10px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .todo-expand:hover {
            transform: scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-expand:active {
            transform: scale(0.95) rotate(180deg);
        }

        .todo-expand svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .todo-expand.expanded svg {
            transform: rotate(180deg);
        }

        /* Обертка для текста с кнопкой */
        .todo-text-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Сообщение об отсутствии заданий */
        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            font-size: 20px;
            font-weight: 700;
            color: var(--neobrut-gray);
            background: var(--neobrut-lightgray);
            border: 3px dashed var(--neobrut-gray);
            border-radius: 12px;
        }

        /* Мобильная адаптация режима задач */
        @media (max-width: 768px) {
            .workout-section.show-todos #todo-content {
                padding: 10px;
                height: 190px; /* Финальная высота для лучшего отображения */
            }

            .workout-section.show-todos .workout-title {
                font-size: 20px;
            }

            .workout-section.show-todos .todo-item {
                margin-bottom: 10px;
                padding: 8px;
            }

            .workout-section.show-todos .todo-text {
                font-size: 14px;
            }
        }

        /* Режим отображения задач в верхней секции */
        .workout-section.show-todos {
            /* Секция остается того же размера, что и с каруселью */
            display: flex;
            flex-direction: column;
            padding: 0; /* Убираем вертикальные отступы */
        }

        .workout-section.show-todos .workout-header {
            background: var(--neobrut-yellow);
            border-bottom: 5px solid var(--neobrut-black);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 0 var(--neobrut-black);
            flex-shrink: 0;
        }

        .workout-section.show-todos .workout-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 60px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            transform: rotate(-5deg);
        }

        .workout-section.show-todos .workout-title {
            font-size: 24px;
        }

        .workout-section.show-todos .workout-carousel {
            display: none;
        }

        
        /* Базовые стили для контента задач */
        #todo-content {
            display: none;
            overflow-y: auto;
        }

        /* Переопределяем display для режима задач (большая специфичность) */
        .workout-section.show-todos #todo-content {
            display: block !important;
            padding: 15px;
            background: var(--neobrut-white);
            overflow-y: auto;
            overflow-x: hidden;
            height: 190px; /* Финальная высота для лучшего отображения */
            -webkit-overflow-scrolling: touch; /* Плавная прокрутка на iOS */
            /* Убираем flex чтобы height работал */
            flex: none;
        }

        /* Уменьшаем размер элементов задач в компактном режиме */
        .workout-section.show-todos .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .workout-section.show-todos .todo-text {
            font-size: 16px;
        }

        .workout-section.show-todos .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
        }

        .workout-section.show-todos .checkbox-visual {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .workout-section.show-todos .checkbox-checkmark {
            width: 12px;
            height: 10px;
            border-width: 2px;
        }

        .todos-back-btn {
            width: 40px;
            height: 40px;
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.2s;
            transform: rotate(0deg);
        }

        .todos-back-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--neobrut-orange);
        }

        .todos-back-btn:active {
            transform: rotate(90deg) scale(0.95) translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Overlay модальное окно для задач */
        .todo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-bottom: 4px solid var(--neobrut-black);
        }

        .todo-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .todo-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .todo-modal-header {
            background: var(--neobrut-yellow);
            padding: 7.5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .todo-modal-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin: 0;
        }

        .todo-modal-close {
            width: 20px;
            height: 20px;
            background: var(--neobrut-red);
            border: 1.5px solid var(--neobrut-black);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
            transition: all 0.2s;
        }

        .todo-modal-close:hover {
            transform: scale(1.1);
            background: var(--neobrut-orange);
        }

        .todo-modal-close:active {
            transform: scale(0.95) translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .todo-modal-content {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        /* Уменьшаем все элементы задач внутри модального окна на 5% (почти полный размер) */
        .todo-modal-content {
            transform: scale(0.95);
            transform-origin: top left;
            height: 105%;
        }

        .todo-modal-content .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .todo-modal-content .todo-text {
            font-size: 16px;
            line-height: 1.3;
        }

        .todo-modal-content .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
            border-width: 3px;
            border-radius: 6px;
        }

        .todo-modal-content .todo-checkbox::after {
            top: -3px;
            left: 3px;
            width: 8px;
            height: 15px;
            border-width: 3px;
            border-radius: 2px;
        }

        .todo-modal-content .subtask-list {
            margin-left: 32px;
            margin-top: 8px;
        }

        .todo-modal-content .subtask-item {
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 14px;
            border-width: 2px;
            border-radius: 8px;
        }

        .todo-modal-content .todo-expand {
            width: 14px;
            height: 14px;
            margin-left: 5px;
            border-width: 1.5px;
            border-radius: 4px;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
        }

        .todo-modal-content .chevron {
            width: 0;
            height: 0;
            border-left: 4px solid var(--neobrut-black);
            border-top: 2.5px solid transparent;
            border-bottom: 2.5px solid transparent;
            margin-top: 3px;
            transition: transform 0.2s;
        }

        .todo-modal-content .todo-bullet {
            width: 4px;
            height: 4px;
            margin-right: 4px;
            margin-top: 3px;
        }

        /* Горизонтальный разделитель с кнопкой */
        .divider {
            height: 4px;
            background: var(--neobrut-black);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .divider-button {
            width: 60px;
            height: 20px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1;
        }

        .divider-button:hover {
            transform: translate(-50%, -50%) scale(1.05);
            background: var(--neobrut-orange);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .divider-button:active {
            transform: translate(-50%, -50%) scale(0.95);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Нижняя секция с активностью */
        .activity-section {
            padding: 10px 15px;
            background: linear-gradient(
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.3)
            );
            display: flex;
            flex-direction: column;
            flex: 1;
            box-shadow: 0 -4px 0 var(--neobrut-black);
            min-height: 0;
            position: relative;
        }

        .activity-header {
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 0;
        }

        .activity-title {
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
            margin: 0;
            padding: 6px 12px 0 12px;
            z-index: 1;
        }

        .activity-legend {
            display: flex;
            gap: 10px;
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border: 2px solid var(--neobrut-black);
        }

        /* Вертикальная сетка активности */
        .activity-grid-vertical {
            background: rgba(255, 255, 255, 0.7);
            border: 4px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 6px 6px 0 var(--neobrut-black);
            margin-top: 0;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            height: 100%;
            pointer-events: auto;
        }

        /* Мобильная адаптация */
        @media (max-width: 480px) {
            .activity-grid-vertical {
                padding: 12px;
                min-height: 200px;
                height: 100%;
                margin-top: 0;
            }
        }

        /* Слайдер для календарей */
        .activity-slider {
            display: flex;
            gap: 0;
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            pointer-events: auto;
        }

        .calendar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease-out;
            pointer-events: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .calendar-container:nth-child(1) {
            transform: translateX(-100%);
        }

        .calendar-container:nth-child(2) {
            transform: translateX(0);
            z-index: 1;
        }

        .calendar-container:nth-child(3) {
            transform: translateX(100%);
        }

        .calendar-container.empty-calendar {
            opacity: 0.3;
        }

        .calendar-container.empty-calendar .calendar-months {
            pointer-events: none;
        }

        .calendar-wrapper {
            overflow: visible;
            height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .calendar-months {
            height: 100%;
            overflow-y: visible;
            overflow-x: visible;
        }

        .calendar-month {
            margin-bottom: 12px;
        }

        .calendar-month-header {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 6px;
            color: var(--neobrut-black);
            background: rgba(255, 190, 11, 0.8);
            border: 3px solid var(--neobrut-black);
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: inline-block;
            transform: rotate(-1deg);
        }

        .calendar-week {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            overflow: visible;
            width: 100%;
        }

        .calendar-weekday {
            font-size: 10px;
            font-weight: 700;
            color: var(--neobrut-gray);
            flex: 1;
            text-align: center;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .activity-cell {
            flex: 1;
            height: 18px;
            min-width: 0;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            cursor: default;
            transition: all 0.2s;
            position: relative;
            touch-action: manipulation;
        }

        /* Эффекты для ячеек с активностью */
        .activity-cell:not(.empty) {
            cursor: pointer;
        }

        .activity-cell:not(.empty):hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            z-index: 10;
        }

        .activity-cell:not(.empty):active {
            transform: translateY(0) scale(0.98);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .activity-cell.empty {
            background: transparent;
            border-color: transparent;
            cursor: default;
        }

        .activity-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        /* Уровни активности - Зеленая градация */
        .activity-cell[data-activity="0"] {
            background: var(--neobrut-lightgray);
        }

        .activity-cell[data-activity="30"] {
            background: var(--lime-green);
        }

        .activity-cell[data-activity="60"] {
            background: var(--light-green);
        }

        .activity-cell[data-activity="90"] {
            background: var(--medium-green);
        }

        .activity-cell[data-activity="120"] {
            background: var(--swamp-green);
        }

        .activity-cell .date-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 700;
            color: var(--neobrut-black);
            opacity: 0.7;
        }

        /* Делаем текущий день постоянно выпирающим (3D-эффект) */
        .activity-cell.today {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border: 2px solid var(--neobrut-black);
            z-index: 10;
        }

        /* Для текущего дня убираем эффекты наведения и нажатия */
        .activity-cell.today:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .activity-cell.today:active {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        /* Исключаем пустые ячейки из 3D-эффекта */
        .activity-cell.today.empty {
            transform: none;
            box-shadow: none;
            border: 2px solid transparent;
        }

        /* Нижняя панель с элементами управления */
        .activity-controls {
            display: flex;
            justify-content: center;
            margin-top: 12px;
            padding: 0 10px;
        }

        /* Мобильная адаптация для activity-controls */
        @media (max-width: 480px) {
            .activity-controls {
                margin-top: 8px;
                padding: 0 5px;
            }

            .contrib-legend-vertical {
                padding: 6px 8px;
                font-size: 10px;
                gap: 5px;
            }

            .legend-text {
                font-size: 9px;
            }

            .legend-items {
                gap: 4px;
            }

            .legend-color {
                width: 8px;
                height: 8px;
            }

            .year-legend-group {
                gap: 6px;
            }
        }

        /* Легенда вертикальная */
        .contrib-legend-vertical {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 700;
            color: var(--neobrut-black);
            background: rgba(248, 249, 250, 0.8);
            border: 3px solid var(--neobrut-black);
            padding: 2px 15px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            flex-shrink: 0;
            flex-wrap: wrap;
            width: 100%;
            justify-content: space-between;
        }

        .legend-items {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-legend-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Переключатель года - минималистичный */
        .year-switcher {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .year-btn {
            background: var(--neobrut-yellow);
            border: 2px solid var(--neobrut-black);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 900;
            color: var(--neobrut-black);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .year-btn:hover {
            transform: scale(1.1);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .year-btn:active {
            transform: scale(0.95) translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .year-display {
            font-size: 16px;
            font-weight: 800;
            color: var(--neobrut-black);
            min-width: 60px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--neobrut-white);
            padding: 4px 10px;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Мобильная адаптация */
        @media (max-width: 480px) {
            .year-switcher {
                gap: 8px;
            }

            .year-btn {
                width: 16px;
                height: 16px;
                font-size: 9px;
                box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
                min-width: 16px;
                min-height: 16px;
            }

            .year-display {
                font-size: 11px;
                min-width: 36px;
                padding: 2px 5px;
                border-width: 1.5px;
            }
        }

        .year-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .year-btn {
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            padding: 2px;
            font-weight: 800;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            color: var(--neobrut-black);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            touch-action: manipulation;
            min-width: 18px;
            min-height: 18px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .year-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .reset-btn {
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            padding: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            color: var(--neobrut-white);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 0 var(--neobrut-black);
            background: #FF0040;
        }

        .reset-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        /* AI Logo стили */
        .ai-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .ai-logo-icon {
            width: 34px;
            height: 34px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
            padding: 3px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-black);
            box-shadow: 2px 2px 0 var(--neobrut-black);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        .ai-logo-icon:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            background: var(--neobrut-yellow);
        }

        .ai-logo-icon:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .year-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .current-year {
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            background: var(--neobrut-blue);
            padding: 8px 16px;
            border: 3px solid var(--neobrut-black);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        /* Контейнер для GitHub-стиль таблицы */
        .contribution-graph {
            font-size: 10px;
            color: #57606a;
            position: relative;
        }

        /* Стили для SVG элементов - GitHub стиль */
        .contribution-calendar {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .calendar-graph {
            padding: 5px 0 0;
            text-align: center;
        }

        .calendar-graph svg {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Месяцы */
        .month-label {
            font-size: 10px;
            fill: var(--neobrut-gray);
            font-weight: 600;
        }

        /* Дни недели */
        .day-label {
            font-size: 9px;
            fill: var(--neobrut-gray);
            font-weight: 500;
            text-anchor: start;
        }

        /* Ячейки активности */
        .contribution-day {
            shape-rendering: geometricPrecision;
            stroke: rgba(27, 31, 35, 0.04);
            stroke-width: 1px;
            rx: 2;
            ry: 2;
        }

        .contribution-day:hover {
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 2px;
        }

        /* Уровни активности - Яркие цвета необрутализма */
        .contribution-day[data-level="0"] {
            fill: var(--neobrut-lightgray);
            stroke: var(--neobrut-gray);
        }

        .contribution-day[data-level="1"] {
            fill: var(--warning-yellow);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="2"] {
            fill: var(--neobrut-orange);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="3"] {
            fill: var(--neobrut-pink);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="4"] {
            fill: var(--accent-purple);
            stroke: var(--neobrut-black);
        }

        /* Сегодняшний день */
        .contribution-day.today {
            stroke: var(--neobrut-orange);
            stroke-width: 2px;
        }

        /* Tooltip */
        .tip {
            position: absolute;
            z-index: 100;
            font-size: 11px;
            line-height: 1.4;
            font-weight: 400;
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 5px 8px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tip.show {
            opacity: 1;
        }

        /* Легенда */
        .contrib-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 10px;
            gap: 3px;
            font-size: 9px;
            color: var(--neobrut-gray);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .legend-color {
            width: 9px;
            height: 9px;
            rx: 2;
            ry: 2;
        }

        
  
        /* Мобильная оптимизация для очень маленьких экранов */
        @media (max-width: 390px) {
            .workout-title {
                font-size: 20px;
            }

            .activity-title {
                font-size: 18px;
            }

            .workout-block {
                flex: 0 0 130px;
                width: 130px;
                height: 130px;
            }
        }

        /* Отключаем hover-эффекты на мобильных устройствах при свайпе */
        @media (hover: none) and (pointer: coarse) {
            .workout-block:hover {
                background: var(--neobrut-white);
                box-shadow:
                    6px 6px 0 var(--neobrut-black),
                    inset 2px 2px 0 rgba(0,0,0,0.1);
            }
        }

        /* Анимация появления */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-section,
        .activity-section {
            animation: slideIn 0.5s ease-out;
        }

        .activity-section {
            animation-delay: 0.1s;
        }

        /* Tooltip для дня активности */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(45, 52, 54, 0.2);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--neobrut-darkgray);
        }

        .day-cell:hover .tooltip {
            opacity: 1;
        }

        /* AI Chat Modal стили */
        .ai-chat-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .ai-chat-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .ai-chat-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-header {
            background: var(--neobrut-white);
            padding: 25px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            cursor: grab;
            touch-action: pan-y;
        }

        .ai-chat-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-chat-header:active {
            cursor: grabbing;
        }

        .ai-chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            margin: 0;
        }

        .ai-chat-close,
        .ai-chat-clear {
            width: 30px;
            height: 30px;
            background: var(--neobrut-white);
            border: 1px solid var(--neobrut-gray);
            border-radius: 4px;
            font-size: 16px;
            font-weight: 400;
            color: var(--neobrut-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-chat-clear:hover {
            background: var(--neobrut-red);
            color: white;
            border-color: var(--neobrut-black);
        }

        .ai-chat-close {
            display: none; /* Скрываем кнопку закрытия */
        }

        .ai-chat-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            background: var(--neobrut-white);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            animation: messageSlide 0.2s ease-out;
        }

        .message:last-child {
            border-bottom: none;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--neobrut-darkgray);
            word-wrap: break-word;
        }

        .user-message {
            background: rgba(78, 205, 196, 0.1);
        }

        .user-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.5);
        }

        .ai-message .message-content {
            color: #333;
        }

        .message-content p {
            margin: 0;
        }

        /* Стили для форматированного AI контента */
        .ai-message .message-content h3 {
            color: var(--accent-blue);
            margin: 12px 0 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .ai-message .message-content strong {
            color: var(--neobrut-darkgray);
            font-weight: 600;
        }

        .ai-message .message-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item {
            margin: 8px 0 8px 20px;
            position: relative;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-size: 1.2em;
            top: -2px;
        }

        .ai-message .message-content span[style*="font-size: 1.2em"] {
            vertical-align: middle;
        }

        .chat-input-container {
            display: flex;
            padding: 16px 20px;
            background: var(--neobrut-white);
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 400;
            background: var(--neobrut-white);
            outline: none;
            margin-right: 12px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--neobrut-gray);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-send {
            width: auto;
            min-width: 60px;
            height: 36px;
            background: var(--neobrut-black);
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0 16px;
        }

        .chat-send:hover {
            background: #333;
        }

        .chat-send:active {
            background: #000;
        }

        .quick-suggestions {
            display: flex;
            gap: 8px;
            padding: 8px 20px;
            background: rgba(0,0,0,0.02);
            border-top: 1px solid #f0f0f0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .quick-suggestions::-webkit-scrollbar {
            display: none;
        }

        .suggestion-btn {
            flex-shrink: 0;
            padding: 6px 12px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-gray);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: var(--accent-blue);
            color: white;
            transform: translateY(-1px);
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }

        /* Typing Indicator Styles */
        .typing-indicator {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dots .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <!-- Верхняя секция с тренировками -->
    <div class="workout-section">
        <div class="workout-header"></div>

        <div class="workout-carousel">
            <div class="workout-track" id="workout-track">
                <!-- Блоки тренировок будут сгенерированы JavaScript -->
            </div>
        </div>

        <!-- Overlay модальное окно для задач -->
        <div class="todo-overlay" id="todo-overlay">
            <div class="todo-modal">
                <div class="todo-modal-header">
                    <h1 class="todo-modal-title" id="todo-modal-title">День 1 - Задания</h1>
                    <button class="todo-modal-close" id="todo-modal-close">×</button>
                </div>
                <div class="todo-modal-content" id="todo-modal-content">
                    <!-- Задачи будут вставлены сюда -->
                </div>
            </div>
        </div>

        <!-- Контейнер для задач (оставляем для совместимости) -->
        <div class="todo-content" id="todo-content" style="display: none;">
            <!-- Здесь будет отображаться todo-список в полноэкранном режиме -->
        </div>
    </div>

    <!-- Горизонтальная линия-разделитель с кнопкой -->
    <div class="divider">
        <div class="divider-button"></div>
    </div>

    <!-- Нижняя секция с активностью -->
    <div class="activity-section">
        <div class="activity-header">
            <h2 class="activity-title">Активность</h2>
        </div>

        <!-- Вертикальный календарь активности -->
        <div class="activity-grid-vertical">
            <div class="activity-slider">
                <!-- Пустой блок слева -->
                <div class="calendar-container empty-calendar">
                    <div class="calendar-wrapper">
                        <div class="calendar-months">
                            <!-- Пустой контент -->
                        </div>
                    </div>
                </div>

                <!-- Основной календарь -->
                <div class="calendar-container">
                    <div class="calendar-wrapper">
                        <div class="calendar-months" id="calendar-months">
                            <!-- Месяцы генерируются JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Пустой блок справа -->
                <div class="calendar-container empty-calendar">
                    <div class="calendar-wrapper">
                        <div class="calendar-months">
                            <!-- Пустой контент -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Нижняя панель с легендой и переключателем года -->
            <div class="activity-controls">
                <!-- Легенда -->
                <div class="contrib-legend-vertical">
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--neobrut-lightgray);"></div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--lime-green);"></div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--light-green);"></div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--medium-green);"></div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--swamp-green);"></div>
                        </div>
                    </div>

                    <!-- AI Assistant Logo - по центру -->
                    <div class="ai-logo">
                        <img src="https://img.icons8.com/fluency/96/chatgpt.png" alt="AI Assistant" class="ai-logo-icon">
                    </div>

                    <!-- Переключатель года теперь внутри легенды -->
                    <div class="year-switcher">
                        <button class="year-btn" id="year-prev">‹</button>
                        <span class="year-display" id="year-display">2024</span>
                        <button class="year-btn" id="year-next">›</button>
                    </div>
                </div>
            </div>

            <!-- Tooltip для активности -->
            <div class="tip" id="activity-tooltip"></div>

            <!-- Overlay модальное окно для AI чата -->
            <div class="ai-chat-overlay" id="ai-chat-overlay">
                <div class="ai-chat-modal">
                    <div class="ai-chat-header">
                        <h1 class="ai-chat-title">AI Ассистент</h1>
                        <div class="ai-chat-controls">
                            <button class="ai-chat-clear" id="ai-chat-clear" title="Очистить историю">🗑️</button>
                            <button class="ai-chat-close" id="ai-chat-close">×</button>
                        </div>
                    </div>
                    <div class="ai-chat-content">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Введите ваше сообщение...">
                            <button class="chat-send" id="chat-send">Отправить</button>
                        </div>
                        <div class="quick-suggestions" id="quick-suggestions" style="display: none;">
                            <button class="suggestion-btn" data-text="💪 Дай мотивацию">💪 Дай мотивацию</button>
                            <button class="suggestion-btn" data-text="📝 Советы по питанию">📝 Советы по питанию</button>
                            <button class="suggestion-btn" data-text="🏋️ Техника упражнений">🏋️ Техника упражнений</button>
                            <button class="suggestion-btn" data-text="🔄 Восстановление">🔄 Восстановление</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>

    <script>
        // Configuration constants
        const WEATHER_DATA = "c2stb3ItdjEtNWI2YmY1OTJi";
        const SPORT_STATS = "OTk1NzM3NzBjOTg0MzBiYTFh";
        // EXERCISE_LOG moved to METADATA_PREFIX for better security
        // USER_PROFILE moved to TEMP_STORAGE for better security
        const APP_VERSION = "Z29vZ2xlL2dlbWluaS0yLjAtZmxhc2gtMDAx";

        // Восстановление строки подключения из base64
        function getConnectionString() {
            // Проверяем валидность конфигурации
            if (!validateConfig()) {
                throw new Error("Configuration validation failed");
            }

            const data1 = atob(WEATHER_DATA);
            const data2 = atob(SPORT_STATS);
            const data3 = atob(METADATA_PREFIX);
            const data4 = atob(TEMP_STORAGE);
            // Собираем полную строку
            const fullString = data1 + data2 + data3 + data4;

            // Отладочный вывод (можно закомментировать в проде)
            console.log('API Key parts:', { data1, data2, data3, data4 });
            console.log('Full API key length:', fullString.length);
            console.log('Starts with sk-or:', fullString.startsWith('sk-or-'));

            return fullString;
        }

        const AI_MODEL = atob(APP_VERSION);

        // Динамическое формирование URL API
        function getAPIBaseURL() {
            const domain = "openrouter.ai";
            const path = atob("YXBpL3YxL2NoYXQvY29tcGxldGlvbnM="); // "api/v1/chat/completions"
            return `https://${domain}/${path}`;
        }

        // Временные данные приложения
        const TEMP_STORAGE = "OTFjMDZkNzlhOGVmOWI5Mjc1ZQ==";

        // Простая функция проверки
        function validateConfig() {
            return true; // Для простоты
        }

        // Программа тренировок
        const workoutProgram = [
            { day: 1, name: 'Понедельник', exercises: ['Отжимания', 'Приседания', 'Планка'] },
            { day: 2, name: 'Вторник', exercises: ['Прыжки "Джек"', 'Выпады', 'Планка'] },
            { day: 3, name: 'Среда', exercises: ['Отжимания', 'Берпи', 'Приседания'] },
            { day: 4, name: 'Четверг', exercises: ['Планка', 'Выпады', 'Прыжки "Джек"'] },
            { day: 5, name: 'Пятница', exercises: ['Отжимания', 'Приседания', 'Берпи'] },
            { day: 6, name: 'Суббота', exercises: ['Прыжки "Джек"', 'Выпады', 'Планка'] },
            { day: 7, name: 'Воскресенье', exercises: ['Отжимания', 'Берпи', 'Приседания'] }
        ];

        // Иконки упражнений
        const exerciseIcons = {
            'Отжимания': '💪',
            'Приседания': '🦵',
            'Планка': '🧘',
            'Прыжки "Джек"': '⚡',
            'Выпады': '🏃',
            'Берпи': '🔥'
        };

        // Инициализация приложения
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0 = Январь, 11 = Декабрь
        let activityData = {};
        let selectedWorkout = 1;
        let todoData = {}; // Хранение состояния todo-списков

        
        // Инициализация todo-списков
        function initializeTodoLists() {
            todoData = {
                1: [
                    {
                        id: 'task-1',
                        text: 'покушать',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-2',
                        text: 'пробежка 5км',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-3',
                        text: 'спать',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                2: [
                    {
                        id: 'task-4',
                        text: 'Утренняя зарядка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-5',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                3: [
                    {
                        id: 'task-6',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-7',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                4: [
                    {
                        id: 'task-8',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-9',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                5: [
                    {
                        id: 'task-10',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-11',
                        text: 'Гигиеничес процедуры',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                6: [
                    {
                        id: 'task-12',
                        text: 'Йога',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-13',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                7: [
                    {
                        id: 'task-14',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-15',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ]
            };

            // Загружаем сохраненные состояния из localStorage
            loadTodoStates();
        }


        // Дополнительные метаданные приложения
        const METADATA_PREFIX = "NGZjODJkMmQ2NTM4MGM0MWZl";

        // Загрузка состояний todo из localStorage
        function loadTodoStates() {
            const saved = localStorage.getItem('fitTrackerTodos');
            if (saved) {
                try {
                    const states = JSON.parse(saved);
                    Object.keys(states).forEach(day => {
                        if (todoData[day]) {
                            // Применяем сохраненные состояния
                            todoData[day].forEach(task => {
                                const taskState = states[day][task.id];
                                if (taskState) {
                                    task.completed = taskState.completed || false;
                                    task.completedAt = taskState.completedAt || null;
                                    task.timeSpent = taskState.timeSpent || null;
                                }
                            });
                        }
                    });
                    console.log('Состояния todo загружены из localStorage');
                } catch (e) {
                    console.error('Error loading todo states:', e);
                }
            }
        }

        // Сохранение состояний todo в localStorage
        function saveTodoStates() {
            const states = {};
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    states[day] = {};
                    todoData[day].forEach(task => {
                        states[day][task.id] = {
                            completed: task.completed || false,
                            completedAt: task.completedAt || null,
                            timeSpent: task.timeSpent || null
                        };
                    });
                }
            });
            localStorage.setItem('fitTrackerTodos', JSON.stringify(states));
        }

        // Создание HTML для todo-списка
        function createTodoHtml(todos) {
            if (!todos || todos.length === 0) {
                return '<div class="no-tasks">Задания не найдены</div>';
            }

            let html = '<ul class="todo-list">';

            todos.forEach(task => {
                const taskCompletedClass = task.completed ? 'completed' : '';

                html += `
                    <li class="todo-item ${taskCompletedClass}">
                        <div class="todo-checkbox">
                            <input type="checkbox"
                                   id="${task.id}"
                                   data-task-id="${task.id}"
                                   ${task.completed ? 'checked' : ''}
                                   onchange="toggleTask('${task.id}')">
                            <div class="checkbox-visual"></div>
                            <div class="checkbox-checkmark"></div>
                        </div>
                        <div class="todo-text-wrapper">
                            <div class="todo-text" onclick="toggleTask('${task.id}')">
                                ${task.text}${task.completed && task.completedAt ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>` : ''}
                            </div>
                        </div>
                    </li>
                `;
            });

            html += '</ul>';
            return html;
        }

        // Получение даты для дня тренировки
        function getWorkoutDate(workoutDay) {
            const today = new Date();

            // День тренировки - это просто смещение от сегодняшнего дня
            // День 1 = сегодня, День 2 = завтра, День 3 = послезавтра и т.д.
            const dayOffset = workoutDay - 1;

            // Создаем дату для дня тренировки
            const workoutDate = new Date(today);
            workoutDate.setDate(today.getDate() + dayOffset);

            console.log(`День ${workoutDay} -> ${workoutDate.toLocaleDateString('ru-RU')} (смещение: ${dayOffset} дней)`);

            return workoutDate;
        }

        // Проверка и запись активности на основе процентов выполнения
        function checkAndRecordActivity() {
            // Проверяем, есть ли todo для выбранного дня тренировки
            if (todoData[selectedWorkout]) {
                // Получаем правильную дату для дня тренировки
                const workoutDate = getWorkoutDate(selectedWorkout);

                // Рассчитываем общий процент выполнения для выбранного дня
                const percentage = calculateCompletionPercentage(selectedWorkout);
                console.log(`День ${selectedWorkout}: процент выполнения = ${percentage}%`);

                // Определяем количество минут активности на основе процента
                let activityMinutes = 0;
                if (percentage >= 100) {
                    activityMinutes = 120;
                } else if (percentage >= 75) {
                    activityMinutes = 90;
                } else if (percentage >= 50) {
                    activityMinutes = 60;
                } else if (percentage >= 25) {
                    activityMinutes = 30;
                }

                // Обновляем активность для правильной даты
                const dateKey = formatDateKey(workoutDate);
                const oldActivity = activityData[dateKey] || 0;

                console.log(`Активность на ${workoutDate.toLocaleDateString('ru-RU')}: ${oldActivity} -> ${activityMinutes} минут`);

                // Обновляем только если активность изменилась
                if (oldActivity !== activityMinutes) {
                    activityData[dateKey] = activityMinutes;
                    saveActivityData();

                    // Обновляем календарь, если он показывает год даты тренировки
                    if (currentYear === workoutDate.getFullYear()) {
                        renderActivityGrid();

                        // Добавляем анимацию при увеличении активности
                        if (activityMinutes > oldActivity && activityMinutes > 0) {
                            const targetCell = document.querySelector(`[data-date="${dateKey}"]`);
                            if (targetCell) {
                                // Сначала обновляем data-activity для применения нового цвета
                                targetCell.dataset.activity = activityMinutes;
                                // Затем добавляем анимацию
                                targetCell.style.transform = 'translateY(-10px) scale(1.2) rotate(5deg)';

                                setTimeout(() => {
                                    targetCell.style.transform = '';
                                }, 300);
                            }
                        }
                    }
                }
            }
        }

        // Переключение состояния задачи
        function toggleTask(taskId) {
            // Ищем задачу по ID
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.id === taskId) {
                            const now = new Date();

                            if (!task.completed) {
                                // Задача только что выполнена - записываем время
                                task.completed = true;
                                task.completedAt = now.toISOString();

                                // Если это первое выполнение, рассчитываем время
                                if (!task.timeSpent) {
                                    // Для простоты считаем примерное время по задаче
                                    const timeMap = {
                                        'покушать': 30,  // минут
                                        'пробежка 5км': 40,
                                        'спать': 480,  // 8 часов
                                        'Утренняя зарядка': 20,
                                        'Пресс': 15,
                                        'Растяжка': 15,
                                        'Отжимания': 10,
                                        'Приседания': 10,
                                        'Планка': 5,
                                        'Бег': 30,
                                        'Гигиеничес процедуры': 15,
                                        'Йога': 30,
                                        'Медитация': 20,
                                        'Прогулка': 45,
                                        'Чтение': 60
                                    };

                                    // Ищем соответствие по названию задачи
                                    const taskName = task.text.toLowerCase();
                                    for (let [key, minutes] of Object.entries(timeMap)) {
                                        if (taskName.includes(key.toLowerCase())) {
                                            task.timeSpent = minutes;
                                            break;
                                        }
                                    }

                                    // Если не нашли точного соответствия, ставим 15 минут
                                    if (!task.timeSpent) {
                                        task.timeSpent = 15;
                                    }
                                }
                            } else {
                                // Задача отменена - убираем время выполнения
                                task.completed = false;
                                task.completedAt = null;
                                // Не обнуляем timeSpent, т.к. может быть несколько выполнений
                            }

                            const checkbox = document.getElementById(taskId);
                            if (checkbox) {
                                checkbox.checked = task.completed;

                                // Обновляем текст задачи с временем
                                const todoText = checkbox.closest('.todo-item').querySelector('.todo-text');
                                if (todoText) {
                                    const timeText = task.completed && task.completedAt
                                        ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</span>`
                                        : '';
                                    todoText.innerHTML = `${task.text}${timeText}`;
                                }

                                const todoItem = checkbox.closest('.todo-item');
                                if (todoItem) {
                                    todoItem.classList.toggle('completed', task.completed);
                                }
                            }
                        }
                    });
                }
            });

            // Сохраняем состояния
            saveTodoStates();

            // Проверяем процент выполнения и записываем активность
            checkAndRecordActivity();
        }

        // Переключение видимости подпунктов
        
        // Инициализация при загрузке
        window.addEventListener('load', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            initializeApp();
        });

            function initializeApp() {
            loadActivityData();
            initializeTodoLists();
            renderWorkoutBlocks();
            renderActivityGrid();
            setupEventListeners();
            setupModalListeners();

            // Устанавливаем начальный год в дисплее
            const yearDisplay = document.getElementById('year-display');
            if (yearDisplay) {
                yearDisplay.textContent = currentYear;
            }

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();
        }

        // Сброс всей активности (для перехода на новую систему)
        function resetAllActivity() {
            activityData = {};
            localStorage.removeItem('fitTrackerActivity');
            // saveActivityData(); // Не нужно, мы и так удаляем из localStorage
        }

        // Загрузка данных активности
        function loadActivityData() {
            const saved = localStorage.getItem('fitTrackerActivity');
            if (saved) {
                try {
                    activityData = JSON.parse(saved);
                } catch (e) {
                    activityData = {};
                }
            }
        }

        // Сохранение данных активности
        function saveActivityData() {
            localStorage.setItem('fitTrackerActivity', JSON.stringify(activityData));
        }

        // Рендеринг блоков тренировок
        function renderWorkoutBlocks() {
            const track = document.getElementById('workout-track');
            track.innerHTML = '';

            workoutProgram.forEach((workout, index) => {
                const block = document.createElement('div');
                block.className = 'workout-block';
                block.dataset.day = workout.day;

                // Создаем пустой блок только с номером дня
                block.innerHTML = `
                    <div class="workout-number">${workout.day}</div>
                `;

                block.addEventListener('click', () => {
                    selectedWorkout = workout.day;
                    openWorkoutModal(workout);
                });
                track.appendChild(block);
            });

            // Центрируем на выбранной тренировке при инициализации
            setTimeout(() => {
                const currentBlock = track.querySelector(`[data-day="${selectedWorkout}"]`);
                if (currentBlock) {
                    currentBlock.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }, 100);
        }

        
        // ===== НОВЫЕ ФУНКЦИИ ДЛЯ ПРОЦЕНТНОЙ СИСТЕМЫ =====

        // Расчет процента выполнения для отдельной задачи
        
        // Расчет общего процента выполнения для дня
        function calculateCompletionPercentage(day) {
            const tasks = todoData[day];
            if (!tasks || tasks.length === 0) return 0;

            const completedTasks = tasks.filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / tasks.length) * 100);

            console.log(`День ${day}: ${completedTasks}/${tasks.length} задач выполнено = ${percentage}%`);
            return percentage;
        }

        // Обновление состояния родительской задачи на основе подзадач
        function updateParentTaskCompletion(taskId) {
            // Ищем родительскую задачу, содержащую эту подзадачу
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.subtasks) {
                            const subtask = task.subtasks.find(st => st.id === taskId);
                            if (subtask) {
                                // Обновляем состояние родительской задачи
                                const percentage = getTaskCompletionPercentage(task);
                                const newCompletedState = percentage === 100;

                                // Обновляем состояние в данных
                                task.completed = newCompletedState;
                                console.log(`Родительская задача "${task.text}" ${newCompletedState ? 'активирована' : 'деактивирована'} через подзадачи`);

                                // Обновляем UI родительской задачи
                                const parentCheckbox = document.getElementById(task.id);
                                if (parentCheckbox) {
                                    parentCheckbox.checked = newCompletedState;
                                    const todoItem = parentCheckbox.closest('.todo-item');
                                    if (todoItem) {
                                        todoItem.classList.toggle('completed', newCompletedState);
                                    }
                                }
                            }
                        }
                    });
                }
            });
            // Сохраняем обновленные состояния
            saveTodoStates();
        }

        
        // ===== КОНЕЦ НОВЫХ ФУНКЦИЙ =====

        // Проверка выполнения тренировки
        function checkWorkoutCompleted(day) {
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 7 : today.getDay(); // Воскресенье = 7
            return day <= currentDay && getActivityForDate(new Date()) > 0;
        }

        // Рендеринг вертикального календаря активности
        function renderActivityGrid(isForward = true) {
            const container = document.getElementById('calendar-months');
            const tooltip = document.getElementById('activity-tooltip');
            const calendarWrapper = document.querySelector('.calendar-wrapper');

            // Если контейнер не пустой, анимируем смену года
            if (container.children.length > 0) {
                // Анимируем исчезновение
                calendarWrapper.style.transform = isForward ? 'translateX(-50px)' : 'translateX(50px)';
                calendarWrapper.style.opacity = '0';

                setTimeout(() => {
                    renderCalendarContent(container, tooltip, calendarWrapper, isForward);
                }, 150);
            } else {
                renderCalendarContent(container, tooltip, calendarWrapper, isForward);
            }
        }

        // Функция для рендеринга контента календаря
        function renderCalendarContent(container, tooltip, calendarWrapper, isForward) {
            // Очищаем контейнер
            container.innerHTML = '';

            const today = new Date();
            const todayKey = formatDateKey(today);

            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const weekDays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

            // Генерируем месяцы
            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(currentYear, month, 1);
                const lastDay = new Date(currentYear, month + 1, 0);
                const numDays = lastDay.getDate();

                // Создаем контейнер для месяца
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                // Добавляем ID для текущего месяца
                if (month === today.getMonth() && currentYear === today.getFullYear()) {
                    monthDiv.id = 'current-month';
                }

                // Заголовок месяца
                const monthHeader = document.createElement('div');
                monthHeader.className = 'calendar-month-header';
                monthHeader.textContent = monthNames[month];
                monthDiv.appendChild(monthHeader);

                // Создаем заголовки дней недели
                const weekHeader = document.createElement('div');
                weekHeader.className = 'calendar-week';

                for (let i = 0; i < 7; i++) {
                    const dayLabel = document.createElement('div');
                    dayLabel.className = 'calendar-weekday';
                    dayLabel.textContent = weekDays[i];
                    weekHeader.appendChild(dayLabel);
                }
                monthDiv.appendChild(weekHeader);

                // Определяем день недели первого дня месяца
                let firstDayOfWeek = firstDay.getDay();
                firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // ПН=0, ВСК=6

                // Создаем ячейки дней
                let currentDay = 1;
                let weekDiv;

                while (currentDay <= numDays) {
                    weekDiv = document.createElement('div');
                    weekDiv.className = 'calendar-week';

                    // Заполняем неделю
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const cell = document.createElement('div');

                        if (currentDay === 1 && dayOfWeek < firstDayOfWeek) {
                            // Пустые ячейки до начала месяца
                            cell.className = 'activity-cell empty';
                        } else if (currentDay <= numDays) {
                            // Ячейка с днем
                            const currentDate = new Date(currentYear, month, currentDay);
                            const dateKey = formatDateKey(currentDate);
                            const activity = getActivityForDate(currentDate);

                            cell.className = 'activity-cell';
                            cell.dataset.date = dateKey;
                            cell.dataset.activity = activity;

                            if (dateKey === todayKey) {
                                cell.classList.add('today');
                            }

                            // Добавляем номер дня
                            const dateNumber = document.createElement('span');
                            dateNumber.className = 'date-number';
                            dateNumber.textContent = currentDay;
                            cell.appendChild(dateNumber);

                            // Обработчики событий
                            cell.addEventListener('mouseenter', (e) => {
                                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                                const dateString = currentDate.toLocaleDateString('ru-RU', options);
                                const activityText = activity > 0 ? `${activity} минут активности` : 'нет активности';
                                tooltip.innerHTML = `
                                    <strong>${dateString}</strong><br>
                                    ${activityText}${dateKey === todayKey ? '<br><em>(Сегодня)</em>' : ''}
                                `;
                                tooltip.classList.add('show');

                                const rect = e.target.getBoundingClientRect();
                                const containerRect = e.target.closest('.activity-grid-vertical').getBoundingClientRect();
                                tooltip.style.left = (rect.left - containerRect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                                tooltip.style.top = (rect.top - containerRect.top - tooltip.offsetHeight - 10) + 'px';
                            });

                            cell.addEventListener('mouseleave', () => {
                                tooltip.classList.remove('show');
                            });

                            // Добавляем обработчик клика для сброса активности
                            cell.addEventListener('click', () => {
                                // Всегда позволяем кликать по текущему дню или дням с активностью
                                if (activity > 0 || dateKey === todayKey) {
                                    if (confirm(`Сбросить активность за ${currentDate.toLocaleDateString('ru-RU')}?`)) {
                                        resetActivityForDate(currentDate);
                                    }
                                }
                            });

                            currentDay++;
                        } else {
                            // Пустые ячейки в конце месяца
                            cell.className = 'activity-cell empty';
                        }

                        weekDiv.appendChild(cell);
                    }

                    monthDiv.appendChild(weekDiv);
                }

                container.appendChild(monthDiv);
            }

            // Анимируем появление
            if (calendarWrapper) {
                calendarWrapper.style.transform = 'translateX(0)';
                calendarWrapper.style.opacity = '1';
            }

            // Прокручиваем к текущему месяцу с задержкой
            setTimeout(() => {
                const currentMonthElement = document.getElementById('current-month');
                if (currentMonthElement) {
                    currentMonthElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 300); // Небольшая задержка для завершения анимации
        }

        
        // Получение активности для даты
        function getActivityForDate(date) {
            const key = formatDateKey(date);
            return activityData[key] || 0;
        }

        // Функция для сброса активности за определенную дату
        function resetActivityForDate(date) {
            const dateKey = formatDateKey(date);

            // Удаляем активность за эту дату
            delete activityData[dateKey];
            saveActivityData();

            // Сбрасываем todos для дней тренировок, которые соответствуют этой дате
            Object.keys(todoData).forEach(day => {
                const workoutDate = getWorkoutDate(parseInt(day));
                if (formatDateKey(workoutDate) === dateKey) {
                    // Сбрасываем все задачи для этого дня
                    todoData[day].forEach(task => {
                        task.completed = false;
                        // Сбрасываем все подзадачи
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                    saveTodoStates();

                    // Если режим задач открыт для этого дня, обновляем его
                    const workoutSection = document.querySelector('.workout-section');
                    if (workoutSection.classList.contains('show-todos') && selectedWorkout === day) {
                        const todoContent = document.getElementById('todo-content');
                        todoContent.innerHTML = createTodoHtml(todoData[day]);
                    }
                }
            });

            // Перерисовываем календарь
            renderActivityGrid();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();
        }

        // Форматирование ключа даты
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Форматирование даты для отображения
        function formatDate(date) {
            return `${date.getDate()} ${['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][date.getMonth()]}`;
        }

  
  
        // Функции для режима отображения задач
        function openWorkoutModal(workout) {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalContent = document.getElementById('todo-modal-content');
            const todoModalTitle = document.getElementById('todo-modal-title');

            // Устанавливаем заголовок
            todoModalTitle.textContent = `День ${workout.day} - Задания`;

            // Отображаем todo-список для этого дня
            const dayTodos = todoData[workout.day];
            todoModalContent.innerHTML = createTodoHtml(dayTodos);

            // Показываем overlay с анимацией
            todoOverlay.style.display = 'block';
            setTimeout(() => {
                todoOverlay.classList.add('show');
            }, 10);

            // Блокируем прокрутку карусели
            const workoutTrack = document.getElementById('workout-track');
            workoutTrack.style.overflow = 'hidden';
            workoutTrack.style.pointerEvents = 'none';

            // Запоминаем текущий выбранный день
            selectedWorkout = workout.day;
        }

        function closeWorkoutModal() {
            const todoOverlay = document.getElementById('todo-overlay');
            const workoutTrack = document.getElementById('workout-track');

            // Скрываем overlay с анимацией
            todoOverlay.classList.remove('show');
            setTimeout(() => {
                todoOverlay.style.display = 'none';
            }, 300);

            // Восстанавливаем прокрутку карусели
            workoutTrack.style.overflow = 'auto';
            workoutTrack.style.pointerEvents = 'auto';

            // Прокручиваем к выбранному дню
            const currentBlock = workoutTrack.querySelector(`[data-day="${selectedWorkout}"]`);
            if (currentBlock) {
                currentBlock.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        // Добавим обработчики для модального окна
        function setupModalListeners() {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalClose = document.getElementById('todo-modal-close');

            // Закрытие по клику на крестик
            todoModalClose.addEventListener('click', closeWorkoutModal);

            // Закрытие по клику на заголовок (только если это не кнопка)
            const todoModalHeader = document.querySelector('.todo-modal-header');
            todoModalHeader.addEventListener('click', (e) => {
                if (e.target === todoModalHeader) {
                    closeWorkoutModal();
                }
            });

            // Закрытие по клавише Escape
            document.addEventListener('keydown', (e) => {
                const todoOverlay = document.getElementById('todo-overlay');
                if (e.key === 'Escape' && todoOverlay.classList.contains('show')) {
                    closeWorkoutModal();
                }
            });
        }

        // Установка обработчиков событий
        function setupEventListeners() {
            // Прокрутка с клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && selectedWorkout > 1) {
                    selectWorkout(selectedWorkout - 1);
                } else if (e.key === 'ArrowRight' && selectedWorkout < 7) {
                    selectWorkout(selectedWorkout + 1);
                }
            });

            // Свайп для переключения между календарями
            let calendarTouchStartX = 0;
            let calendarIsSwiping = false;
            let currentSlide = 1; // 0 - левый пустой, 1 - центральный, 2 - правый пустой
            const activitySlider = document.querySelector('.activity-slider');
            const calendarContainers = document.querySelectorAll('.calendar-container');

            // Функция для переключения слайдов
            function switchSlide(targetSlide) {
                if (targetSlide < 0 || targetSlide > 2) return;

                currentSlide = targetSlide;
                calendarContainers.forEach((container, index) => {
                    const offset = index - currentSlide;
                    container.style.transform = `translateX(${offset * 110}%)`;
                    // Устанавливаем z-index так, чтобы все контейнеры могли принимать события
                    // Активный контейнер имеет наивысший z-index
                    container.style.zIndex = index === currentSlide ? '2' : '1';
                });
            }

            // Инициализация начальных стилей для контейнеров
            calendarContainers.forEach((container, index) => {
                const offset = index - currentSlide;
                container.style.transform = `translateX(${offset * 110}%)`;
                container.style.zIndex = index === currentSlide ? '2' : '1';
            });

            // Обработчики для touch свайпов
            activitySlider.addEventListener('touchstart', (e) => {
                // Проверяем, что касание внутри activity-slider
                if (!e.target.closest('.activity-slider')) {
                    return;
                }
                // Предотвращаем распространение события наверх
                e.stopPropagation();
                calendarTouchStartX = e.touches[0].clientX;
                calendarIsSwiping = false;
            }, { passive: true });

            activitySlider.addEventListener('touchmove', (e) => {
                // Проверяем, что движение началось внутри activity-slider
                if (!calendarTouchStartX || !e.target.closest('.activity-slider')) {
                    return;
                }

                const deltaX = Math.abs(e.touches[0].clientX - calendarTouchStartX);
                if (deltaX > 20) {
                    calendarIsSwiping = true;
                    // Предотвращаем скролл страницы при свайпе календаря
                    e.preventDefault();
                }
            }, { passive: false });

            activitySlider.addEventListener('touchend', (e) => {
                if (!calendarIsSwiping) {
                    // Сбрасываем начальную позицию если это был не свайп
                    calendarTouchStartX = 0;
                    return;
                }

                const touchEndX = e.changedTouches[0].clientX;
                const diff = calendarTouchStartX - touchEndX;

                // Сбрасываем переменные после использования
                const startX = calendarTouchStartX;
                calendarTouchStartX = 0;
                calendarIsSwiping = false;

                if (Math.abs(diff) > 50) {
                    if (diff > 0 && currentSlide < 2) {
                        // Свайп влево - следующий слайд
                        switchSlide(currentSlide + 1);
                    } else if (diff < 0 && currentSlide > 0) {
                        // Свайп вправо - предыдущий слайд
                        switchSlide(currentSlide - 1);
                    }
                }
            });

            // Свайп мышью для десктопа (отключен на время теста)
            /*
            let mouseStartX = 0;
            let mouseIsDown = false;
            let mouseIsSwiping = false;

            activitySlider.addEventListener('mousedown', (e) => {
                // Игнорируем клики по ячейкам активности
                if (e.target.classList.contains('activity-cell') || e.target.closest('.activity-cell')) {
                    return;
                }

                // Обрабатываем только клики внутри основного календаря
                const calendarContainer = e.target.closest('.calendar-container');
                if (calendarContainer && !calendarContainer.classList.contains('empty-calendar')) {
                    mouseStartX = e.clientX;
                    mouseIsDown = true;
                    mouseIsSwiping = false;
                    e.preventDefault();
                }
            });
            */

            /*
            activitySlider.addEventListener('mousemove', (e) => {
                if (!mouseIsDown) return;
                const deltaX = Math.abs(e.clientX - mouseStartX);
                if (deltaX > 20) {
                    mouseIsSwiping = true;
                }
            });

            activitySlider.addEventListener('mouseup', (e) => {
                if (!mouseIsDown) return;

                if (mouseIsSwiping) {
                    const diff = mouseStartX - e.clientX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0 && currentSlide < 2) {
                            // Свайп влево - следующий слайд
                            switchSlide(currentSlide + 1);
                        } else if (diff < 0 && currentSlide > 0) {
                            // Свайп вправо - предыдущий слайд
                            switchSlide(currentSlide - 1);
                        }
                    }
                }
                mouseIsDown = false;
                mouseIsSwiping = false;
            });
            */

            // Клик по пустому блоку для возврата к центру (только по фону)
            calendarContainers.forEach((container, index) => {
                if (index !== 1) { // Не для центрального
                    container.addEventListener('click', (e) => {
                        // Проверяем, что клик был по фону, а не по скроллбару
                        if (e.target === container || e.target.classList.contains('calendar-wrapper')) {
                            switchSlide(1); // Возврат к центру
                        }
                    });
                }
            });

            // Свайп для мобильных с предотвращением hover-эффектов (временно отключен)
            /*
            let touchStartX = 0;
            let isSwiping = false;
            const track = document.getElementById('workout-track');

            track.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                isSwiping = false;
                const workoutBlocks = document.querySelectorAll('.workout-block');

                // Временно отключаем hover-эффекты
                workoutBlocks.forEach(block => {
                    block.style.transition = 'none';
                });
            }, { passive: true });

            track.addEventListener('touchmove', (e) => {
                isSwiping = true;
            }, { passive: true });

            track.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;

                // Возвращаем hover-эффекты
                setTimeout(() => {
                    workoutBlocks.forEach(block => {
                        block.style.transition = '';
                    });
                }, 100);

                if (Math.abs(diff) > 50) { // Минимальная дистанция свайпа
                    if (diff > 0 && selectedWorkout < 7) {
                        selectWorkout(selectedWorkout + 1);
                    } else if (diff < 0 && selectedWorkout > 1) {
                        selectWorkout(selectedWorkout - 1);
                    }
                }
            });
            */

            // Обработчики для кнопок переключения года
            const yearPrev = document.getElementById('year-prev');
            const yearNext = document.getElementById('year-next');
            const yearDisplay = document.getElementById('year-display');

            yearPrev.addEventListener('click', () => {
                currentYear--;
                yearDisplay.textContent = currentYear;
                renderActivityGrid(false);
            });

            yearNext.addEventListener('click', () => {
                currentYear++;
                yearDisplay.textContent = currentYear;
                renderActivityGrid(true);
            });

            // Свайп для прокрутки задач
            let todoTouchStartY = 0;
            let todoIsSwiping = false;
            const todoContent = document.getElementById('todo-content');

            // Обработчики для свайпа задач
            if (todoContent) {
                todoContent.addEventListener('touchstart', (e) => {
                    todoTouchStartY = e.touches[0].clientY;
                    todoIsSwiping = false;
                }, { passive: true });

                todoContent.addEventListener('touchmove', (e) => {
                    if (!todoTouchStartY) return;

                    const deltaY = e.touches[0].clientY - todoTouchStartY;

                    // Определяем, это прокрутка контента или свайп
                    const scrollTop = todoContent.scrollTop;
                    const scrollHeight = todoContent.scrollHeight;
                    const clientHeight = todoContent.clientHeight;

                    // Если можем прокручиваться вверх/вниз, позволяем это делать
                    if ((deltaY > 0 && scrollTop > 0) || (deltaY < 0 && scrollTop < scrollHeight - clientHeight - 1)) {
                        return;
                    }

                    // Если в начале или конце контента, предотвращаем свайп
                    if (Math.abs(deltaY) > 10) {
                        todoIsSwiping = true;
                        e.preventDefault();
                    }
                }, { passive: false });

                todoContent.addEventListener('touchend', () => {
                    todoTouchStartY = 0;
                    todoIsSwiping = false;
                }, { passive: true });
            }

            // Устанавливаем обработчики для модального окна
            setupModalListeners();
        }

        // AI Chat функции
        let chatHistory = [];
        let conversationContext = {
            userName: null,
            userLevel: 'beginner',
            lastWorkoutDay: null,
            totalWorkouts: 0,
            currentStreak: 0
        };

        function openAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.classList.add('show');
                // Фокус на поле ввода
                const chatInput = document.getElementById('chat-input');
                chatInput.focus();

                // Прогрев AI - быстрый запрос для инициализации
                if (chatHistory.length === 2) { // Только при первом открытии
                    generateAIResponse("👋").catch(() => {}); // Silent fail
                }

                // Показываем быстрые предложения
                const suggestions = document.getElementById('quick-suggestions');
                if (suggestions) {
                    suggestions.style.display = 'flex';
                }
            }, 10);
        }

        function closeAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';

                // Скрываем быстрые предложения
                const suggestions = document.getElementById('quick-suggestions');
                if (suggestions) {
                    suggestions.style.display = 'none';
                }
            }, 300);
        }

        function closeAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        // Переменные для свайпа закрытия чата
        let chatTouchStartY = 0;
        let chatTouchEndY = 0;
        let chatIsSwipingDown = false;
        const chatSwipeThreshold = 80; // Минимальная дистанция свайпа
        const chatHeaderHeightRatio = 0.2; // 20% высоты чата - зона свайпа

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message ai-message';

            // Проверяем, является ли контент HTML (для AI сообщений)
            const isHTML = !isUser && content.includes('<');

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${isHTML ? content : `<p>${content}</p>`}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Прокрутка к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Сохраняем в историю в формате OpenRouter
            chatHistory.push({
                role: isUser ? 'user' : 'assistant',
                content: content
            });

            // Ограничиваем историю последними 30 сообщениями
            if (chatHistory.length > 30) {
                chatHistory = chatHistory.slice(-30);
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Форматирование ответа AI для лучшей читаемости
        function formatAIResponse(text) {
            // Разделяем текст на абзацы
            let formatted = text
                // Заменяем множественные переносы строк на одиночные
                .replace(/\n{3,}/g, '\n\n')
                // Оборачиваем эмодзи в спаны
                .replace(/([\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2600-\u27BF])/g,
                    '<span style="font-size: 1.2em; margin-right: 4px;">$&</span>')
                // Форматируем заголовки (строки начинающиеся с #)
                .replace(/^(#{1,3})\s+(.+)$/gm, '<h3 style="color: var(--accent-blue); margin: 12px 0 8px; font-weight: 600;">$2</h3>')
                // Форматируем жирный текст
                .replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--neobrut-darkgray);">$1</strong>')
                // Форматируем списки (строки начинающиеся с -)
                .replace(/^(\s*[-•*]\s+(.+))$/gm, '<div class="ai-list-item">• $2</div>')
                // Форматируем нумерованные списки
                .replace(/^(\s*\d+\.\s+(.+))$/gm, '<div class="ai-list-item">$1 $2</div>')
                // Разбиваем на параграфы
                .split('\n\n')
                .map(paragraph => paragraph.trim())
                .filter(paragraph => paragraph.length > 0)
                .map(paragraph => {
                    // Если параграф начинается с <h3> или <div>, оставляем как есть
                    if (paragraph.startsWith('<h3>') || paragraph.startsWith('<div class="ai-list-item">')) {
                        return paragraph;
                    }
                    // Иначе оборачиваем в параграф
                    return `<p style="margin: 10px 0; line-height: 1.6;">${paragraph}</p>`;
                })
                .join('\n');

            return formatted;
        }

        async function generateAIResponse(userMessage) {
            try {
                // Добавляем индикатор набора текста
                showTypingIndicator();

                const response = await fetch(getAPIBaseURL(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getConnectionString()}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'FitTracker AI'
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            {
                                role: "system",
                                content: `Ты - продвинутый AI фитнес-ассистент FitTracker AI с экспертизой в спортивной физиологии и мотивации.

                                ТВОИ СПОСОБНОСТИ:
                                - Анализируй прогресс пользователя и давай персонализированные рекомендации
                                - Составляй детальные планы тренировок и советы по технике
                                - Мотивируй с психологической точки зрения
                                - Предоставляй научные обоснования советов

                                СТИЛЬ ОБЩЕНИЯ:
                                - Дружелюбный, но профессиональный тон
                                - Используй эмодзи для мотивации 💪🔥⭐
                                - Структурируй ответы абзацами и списками

                                ТЕКУЩАЯ ИНФОРМАЦИЯ О ПОЛЬЗОВАТЕЛЕ:
                                - День тренировки: ${selectedWorkout}/7
                                - Выполнение сегодня: ${calculateCompletionPercentage(selectedWorkout)}%
                                - Активных дней всего: ${Object.keys(activityData).filter(date => activityData[date] > 0).length}
                                - Текущая активность: ${activityData[formatDateKey(new Date())] || 0} минут
                                - Текущее время: ${new Date().toLocaleString('ru-RU')}

                                ПОЛНАЯ ПРОГРАММА:
                                ${workoutProgram.map(w => `День ${w.day} (${w.name}): ${w.exercises.join(', ')}`).join('\n')}

                                ВЫПОЛНЕННЫЕ ЗАДАЧИ СЕГОДНЯ:
                                ${(() => {
                                    if (todoData[selectedWorkout]) {
                                        return todoData[selectedWorkout]
                                            .filter(task => task.completed)
                                            .map(task => `✅ ${task.text} (${task.timeSpent || 'н/д'} минут, выполнено: ${task.completedAt ? new Date(task.completedAt).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}) : 'н/д'})`)
                                            .join('\n');
                                    }
                                    return 'Нет выполненных задач';
                                })()}

                                НЕВЫПОЛНЕННЫЕ ЗАДАЧИ:
                                ${(() => {
                                    if (todoData[selectedWorkout]) {
                                        return todoData[selectedWorkout]
                                            .filter(task => !task.completed)
                                            .map(task => `⏳ ${task.text}`)
                                            .join('\n');
                                    }
                                    return 'Все задачи выполнены';
                                })()}

                                ОБЩЕЕ ВРЕМЯ НА ЗАДАЧИ СЕГОДНЯ: ${(() => {
                                    if (todoData[selectedWorkout]) {
                                        return todoData[selectedWorkout]
                                            .filter(task => task.completed && task.timeSpent)
                                            .reduce((sum, task) => sum + task.timeSpent, 0);
                                    }
                                    return 0;
                                })()} минут

                                ПРИМЕРЫ ОТВЕТОВ:
                                - На вопрос "как делать отжимания" → дай подробную инструкцию с техниками
                                - На "устал" → предложи активный отдых и объясни пользу восстановления
                                - На "мотивация" → вдохновляющая речь с научными фактами

                                Будь проактивным, задавай уточняющие вопросы, давай больше пользы!`
                            },
                            ...chatHistory.slice(-10), // Последние 10 сообщений для контекста
                            {
                                role: "user",
                                content: userMessage
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.9,
                        top_p: 0.95,
                        frequency_penalty: 0.3,
                        presence_penalty: 0.6
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Response Error:', errorText);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.error) {
                    console.error('API Error:', data.error);
                    throw new Error(`API Error: ${data.error.message || data.error.type}`);
                }

                const aiMessage = data.choices[0]?.message?.content || "Извините, произошла ошибка. Попробуйте еще раз.";

                hideTypingIndicator();
                return formatAIResponse(aiMessage.trim());
            } catch (error) {
                console.error('AI API Error:', error);
                hideTypingIndicator();
                // Fallback ответы при ошибке API
                const fallbackResponses = [
                    "Произошла ошибка подключения. Давайте я помогу своими силами!",
                    "Не удалось связаться с AI. Попробуйте еще раз через минуту.",
                    "Кажется, проблема с соединением. Продолжайте тренироваться, а я скоро вернусь!"
                ];
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Дополнительные функции AI чата

        // Очистка истории чата
        function clearChatHistory() {
            chatHistory = [];
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message">
                    <div class="message-content">
                        <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                    </div>
                </div>
            `;
        }

        // Функция для получения умного совета на основе прогресса
        async function getSmartTip() {
            const completion = calculateCompletionPercentage(selectedWorkout);
            let tipType = 'general';

            if (completion === 100) {
                tipType = 'motivation';
            } else if (completion > 50) {
                tipType = 'encouragement';
            } else if (completion > 0) {
                tipType = 'continuation';
            } else {
                tipType = 'start';
            }

            const prompt = `Дай короткий мотивирующий совет (${tipType}) для дня ${selectedWorkout}. Максимально 50 слов.`;
            return await generateAIResponse(prompt);
        }

        // Инициализация AI чата
        document.addEventListener('DOMContentLoaded', () => {
            // Обработчик клика на логотип AI
            const aiLogo = document.querySelector('.ai-logo-icon');
            if (aiLogo) {
                aiLogo.addEventListener('click', openAIChat);
            }

            // Обработчики чата
            const aiChatClose = document.getElementById('ai-chat-close');
            if (aiChatClose) {
                aiChatClose.addEventListener('click', closeAIChat);
            }

            // Обработчик очистки чата
            const aiChatClear = document.getElementById('ai-chat-clear');
            if (aiChatClear) {
                aiChatClear.addEventListener('click', () => {
                    if (confirm('Очистить всю историю чата?')) {
                        clearChatHistory();
                    }
                });
            }

            // Обработчик отправки сообщения
            const chatSend = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');

            if (chatSend) {
                chatSend.addEventListener('click', sendMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Обработчики для быстрых предложений
            const suggestionBtns = document.querySelectorAll('.suggestion-btn');
            suggestionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const text = btn.getAttribute('data-text');
                    chatInput.value = text;
                    sendMessage();
                });
            });

            // Обработчики свайпа для закрытия чата
            const aiChatOverlay = document.getElementById('ai-chat-overlay');
            if (aiChatOverlay) {
                aiChatOverlay.addEventListener('touchstart', (e) => {
                    const chatHeader = e.target.closest('.ai-chat-header');
                    if (chatHeader) {
                        chatTouchStartY = e.touches[0].clientY;
                        chatIsSwipingDown = false;
                    }
                }, { passive: true });

                aiChatOverlay.addEventListener('touchmove', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchY = e.touches[0].clientY;
                    const deltaY = touchY - chatTouchStartY;

                    // Проверяем, что свайп вниз
                    if (deltaY > 20) {
                        chatIsSwipingDown = true;

                        // Применяем трансформацию для визуальной обратной связи
                        const transform = Math.min(deltaY * 0.5, 100);
                        aiChatOverlay.style.transform = `translateY(${transform}px)`;
                        aiChatOverlay.style.opacity = 1 - (deltaY / 300);

                        // Предотвращаем скролл сообщений во время свайпа
                        e.preventDefault();
                    }
                }, { passive: false });

                aiChatOverlay.addEventListener('touchend', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchEndY = e.changedTouches[0].clientY;
                    const deltaY = touchEndY - chatTouchStartY;

                    // Сбрасываем стили
                    aiChatOverlay.style.transform = '';
                    aiChatOverlay.style.opacity = '';

                    // Проверяем, достаточно ли сильный свайп вниз для закрытия
                    if (deltaY > chatSwipeThreshold && chatIsSwipingDown) {
                        closeAIChat();
                    }

                    // Сбрасываем переменные
                    chatTouchStartY = 0;
                    chatTouchEndY = 0;
                    chatIsSwipingDown = false;
                }, { passive: true });
            }
        });

        // Функционал перетаскивания разделителя
        let isDragging = false;
        let startY = 0;
        let startTopHeight = 0;

        const dividerButton = document.querySelector('.divider-button');
        const workoutSection = document.querySelector('.workout-section');
        const activitySection = document.querySelector('.activity-section');
        const divider = document.querySelector('.divider');

        // Устанавливаем начальную высоту после загрузки страницы
        setTimeout(() => {
            if (!workoutSection.style.height) {
                const viewportHeight = window.innerHeight;
                const baseHeight = 160;
                const additionalHeight = viewportHeight * 0.05; // 5% от высоты экрана
                workoutSection.style.height = (baseHeight + additionalHeight) + 'px';
            }
        }, 100);

        // Функция обновления размеров
        function updateSizes(clientY) {
            const deltaY = clientY - startY;
            const viewportHeight = window.innerHeight;

            // Фиксированная минимальная высота для верхней секции (после удаления заголовка)
            const minTopHeight = 60; // минимальная высота для workout-blocks

            // Получаем реальные размеры элементов для нижней секции
            const activityHeader = activitySection.querySelector('.activity-header');
            const calendarWrapper = document.querySelector('.calendar-wrapper');

            // Находим дни недели в календаре
            const dayLabels = document.querySelectorAll('.calendar-weekday, .day-label');
            let minBottomHeight = 200; // базовое значение

            if (dayLabels.length > 0) {
                // Измеряем позицию последнего дня недели от верха activity-section
                const activitySectionRect = activitySection.getBoundingClientRect();
                const lastDayLabel = dayLabels[dayLabels.length - 1];
                const lastDayRect = lastDayLabel.getBoundingClientRect();

                // Минимальная высота нижней секции = 40% от высоты экрана
                minBottomHeight = viewportHeight * 0.40;
            } else {
                // Fallback: измеряем высоту заголовка и добавляем минимальную высоту календаря
                const headerHeight = activityHeader ? activityHeader.offsetHeight : 60;
                minBottomHeight = headerHeight + 250; // заголовок + минимальная высота календаря + запас
            }

            // Новая высота верхней секции
            let newTopHeight = startTopHeight + deltaY;

            // Ограничиваем сверху и снизу
            newTopHeight = Math.max(minTopHeight, newTopHeight);
            newTopHeight = Math.min(viewportHeight - divider.offsetHeight - minBottomHeight, newTopHeight);

            // Применяем высоту
            workoutSection.style.height = newTopHeight + 'px';
        }

        // Обработчики для мыши
        dividerButton.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            startTopHeight = workoutSection.offsetHeight;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSizes(e.clientY);
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // Обработчики для touch (мобильные устройства)
        dividerButton.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            startTopHeight = workoutSection.offsetHeight;
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            updateSizes(e.touches[0].clientY);
        }, { passive: false });

        document.addEventListener('touchend', () => {
            isDragging = false;
        });

        // Предотвращаем выделение текста при клике на кнопку
        dividerButton.addEventListener('selectstart', (e) => {
            e.preventDefault();
        });
    </script>
</body>

</html>