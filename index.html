<!DOCTYPE html>
<html lang="ru" class="no-swipe-navigation">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="MobileOptimized" content="176" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="robots" content="noindex,nofollow" />
    <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
    <title>FitTracker AI</title>
    <style>
        :root {
            /* Яркая палитра необрутализма */
            --neobrut-black: #000000;
            --neobrut-white: #FFFFFF;
            --neobrut-orange: #FF6B35;
            --neobrut-red: #FF006E;
            --neobrut-yellow: #FFBE0B;
            --neobrut-blue: #3A86FF;
            --neobrut-green: #06FFB4;
            --neobrut-purple: #8338EC;
            --neobrut-pink: #FF4081;
            --neobrut-gray: #495057;
            --neobrut-lightgray: #F8F9FA;
            --neobrut-darkgray: #212529;
            --neobrut-cream: #FFFDE7;
            --success-green: #00F5A0;
            --warning-yellow: #FFD23F;
            --bg-grid: #F1F3F5;
            --accent-blue: #4ECDC4;
            --accent-purple: #C77DFF;
            --accent-coral: #FF6B9D;
            /* Новая цветовая схема для активности */
            --lime-green: #D4ED4A;
            --light-green: #98D98E;
            --medium-green: #3CB371;
            --swamp-green: #2F5233;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--neobrut-lightgray);
            color: var(--neobrut-darkgray);
            min-height: 100vh;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overflow-x: hidden;
            width: 100%;
        }

        /* Предотвращение свайп-навигации в мобильных браузерах */
        html.no-swipe-navigation,
        html.no-swipe-navigation body {
            overscroll-behavior-x: none;
            touch-action: pan-y pinch-zoom;
        }

        /* Глобальное скрытие scrollbar для всех элементов */
        *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Глобальный фон на весь экран */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('fantasy-bg-new.jpg') center/cover no-repeat;
            z-index: -1;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        /* Верхняя секция с прокруткой тренировок */
        .workout-section {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-bottom: 4px solid var(--neobrut-black);
            padding: 0;
            position: relative;
            box-shadow: 8px 8px 0 var(--neobrut-black);
            flex-shrink: 0;
            overflow-y: auto;
            min-height: 50px;
        }

        .workout-header {
            padding: 0;
            display: none;
            /* Скрываем пустой header */
        }

        .workout-title {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
        }

        .workout-counter {
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 800;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 8px;
            color: var(--neobrut-black);
            transform: rotate(-2deg);
        }

        /* Контейнер с горизонтальной прокруткой */
        .workout-carousel {
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .workout-track {
            display: flex;
            gap: 20px;
            padding: 0 40px;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-overflow-scrolling: touch;
            /* Плавная прокрутка на iOS */
        }

        .workout-track::-webkit-scrollbar {
            display: none;
        }

        /* Блоки тренировок - Квадратные пустые в стиле необрутализма */
        .workout-block {
            flex: 0 0 150px;
            width: 150px;
            height: 150px;
            background: var(--neobrut-white);
            border: 4px solid var(--neobrut-black);
            border-radius: 16px;
            box-shadow:
                8px 8px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            opacity: 0.8;
            transform: scale(0.95) rotate(-2deg);
            scroll-snap-align: center;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Базовые элементы */
        .workout-block {
            opacity: 0.8;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .workout-block:hover {
            background: var(--neobrut-white);
            transform: translateY(-2px);
            box-shadow:
                8px 8px 0 var(--neobrut-black),
                inset 2px 2px 0 rgba(0, 0, 0, 0.1);
        }

        .workout-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-8deg);
            width: 60px;
            height: 60px;
            background: var(--neobrut-orange);
            border: 3px solid var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            color: var(--neobrut-white);
            border-radius: 12px;
            z-index: 2;
        }

        .workout-day {
            position: absolute;
            bottom: 20px;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            letter-spacing: 0.05em;
            text-align: center;
            width: 100%;
        }

        /* Декоративные элементы для пустых блоков */
        .workout-block::before {
            content: '';
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 2px solid var(--neobrut-black);
            border-radius: 50%;
            box-shadow: 2px 2px 0 var(--neobrut-black);
            opacity: 0.8;
        }


        /* Todo-список в стиле необрутализма */
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Убираем синюю подсветку для всех интерактивных элементов */
        .todo-list * {
            outline: none !important;
        }

        .todo-list *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Отключаем выделение текста при клике */
        .todo-item,
        .todo-subitem,
        .todo-text,
        .todo-expand,
        .todo-checkbox {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Дополнительно отключаем подсветку при клике на мобильных */
        @media (hover: none) and (pointer: coarse) {

            .todo-item:active,
            .todo-subitem:active,
            .todo-expand:active {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--neobrut-lightgray);
            border: 3px solid var(--neobrut-black);
            box-shadow: 5px 5px 0 var(--neobrut-black);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .todo-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0 var(--neobrut-black);
        }

        .todo-item.completed {
            opacity: 0.7;
            background: var(--success-green);
        }

        .todo-checkbox {
            position: relative;
            width: 24px;
            height: 24px;
            margin-right: 15px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .todo-checkbox input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            outline: none;
            /* Убираем синюю рамку при клике */
        }

        .checkbox-visual {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .todo-checkbox input:checked~.checkbox-visual {
            background: var(--neobrut-yellow);
            transform: rotate(-5deg);
        }

        .checkbox-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 14px;
            height: 10px;
            border-left: 3px solid var(--neobrut-black);
            border-bottom: 3px solid var(--neobrut-black);
            transition: transform 0.2s;
        }

        .todo-checkbox input:checked~.checkbox-checkmark {
            transform: translate(-50%, -50%) rotate(-45deg) scale(1);
        }

        .todo-text {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            user-select: none;
            cursor: pointer;
            outline: none;
            /* Убираем синюю рамку при клике */
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Исключаем время из зачеркивания */
        .todo-item.completed .todo-text .task-time-inline {
            text-decoration: none !important;
            display: inline-block;
        }

        .task-time {
            font-size: 11px;
            color: var(--accent-blue);
            margin-left: 8px;
            white-space: nowrap;
            font-weight: 500;
        }

        .task-time-inline {
            font-size: 13px;
            color: var(--neobrut-black);
            opacity: 0.9;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Подпункты */
        .todo-sublist {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            display: none;
            /* Скрыты по умолчанию */
        }

        .todo-sublist.expanded {
            display: block;
        }

        .todo-subitem {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--neobrut-white);
            border: 2px solid var(--neobrut-gray);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
            font-size: 14px;
        }

        .todo-subitem:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-subitem .todo-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            margin-top: 1px;
        }

        .todo-subitem .checkbox-visual {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .todo-subitem .checkbox-checkmark {
            width: 10px;
            height: 8px;
            border-width: 2px;
        }

        .todo-subitem .todo-text {
            font-size: 14px;
            font-weight: 500;
            outline: none;
            /* Убираем синюю рамку при клике */
        }

        .todo-subitem.completed {
            opacity: 0.7;
            background: var(--success-green) !important;
        }

        .todo-subitem.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.8;
        }

        /* Маркер для подпунктов */
        .todo-bullet {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--neobrut-gray);
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            margin-top: 6px;
        }

        /* Кнопка раскрытия */
        .todo-expand {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            margin-left: 10px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .todo-expand:hover {
            transform: scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .todo-expand:active {
            transform: scale(0.95) rotate(180deg);
        }

        .todo-expand svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .todo-expand.expanded svg {
            transform: rotate(180deg);
        }

        /* Обертка для текста с кнопкой */
        .todo-text-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Сообщение об отсутствии заданий */
        .no-tasks {
            text-align: center;
            padding: 60px 20px;
            font-size: 20px;
            font-weight: 700;
            color: var(--neobrut-gray);
            background: var(--neobrut-lightgray);
            border: 3px dashed var(--neobrut-gray);
            border-radius: 12px;
        }

        /* Мобильная адаптация режима задач */
        @media (max-width: 768px) {
            .workout-section.show-todos #todo-content {
                padding: 10px;
                height: 190px;
                /* Финальная высота для лучшего отображения */
            }

            .workout-section.show-todos .workout-title {
                font-size: 20px;
            }

            .workout-section.show-todos .todo-item {
                margin-bottom: 10px;
                padding: 8px;
            }

            .workout-section.show-todos .todo-text {
                font-size: 14px;
            }
        }

        /* Режим отображения задач в верхней секции */
        .workout-section.show-todos {
            /* Секция остается того же размера, что и с каруселью */
            display: flex;
            flex-direction: column;
            padding: 0;
            /* Убираем вертикальные отступы */
        }

        .workout-section.show-todos .workout-header {
            background: var(--neobrut-yellow);
            border-bottom: 5px solid var(--neobrut-black);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 0 var(--neobrut-black);
            flex-shrink: 0;
        }

        .workout-section.show-todos .workout-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 60px;
            height: 20px;
            background: var(--neobrut-pink);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            transform: rotate(-5deg);
        }

        .workout-section.show-todos .workout-title {
            font-size: 24px;
        }

        .workout-section.show-todos .workout-carousel {
            display: none;
        }


        /* Базовые стили для контента задач */
        #todo-content {
            display: none;
            overflow-y: auto;
        }

        /* Переопределяем display для режима задач (большая специфичность) */
        .workout-section.show-todos #todo-content {
            display: block !important;
            padding: 15px;
            background: var(--neobrut-white);
            overflow-y: auto;
            overflow-x: hidden;
            height: 190px;
            /* Финальная высота для лучшего отображения */
            -webkit-overflow-scrolling: touch;
            /* Плавная прокрутка на iOS */
            /* Убираем flex чтобы height работал */
            flex: none;
        }

        /* Уменьшаем размер элементов задач в компактном режиме */
        .workout-section.show-todos .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .workout-section.show-todos .todo-text {
            font-size: 16px;
        }

        .workout-section.show-todos .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
        }

        .workout-section.show-todos .checkbox-visual {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .workout-section.show-todos .checkbox-checkmark {
            width: 12px;
            height: 10px;
            border-width: 2px;
        }

        .todos-back-btn {
            width: 40px;
            height: 40px;
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.2s;
            transform: rotate(0deg);
        }

        .todos-back-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--neobrut-orange);
        }

        .todos-back-btn:active {
            transform: rotate(90deg) scale(0.95) translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Overlay модальное окно для задач */
        .todo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-bottom: 4px solid var(--neobrut-black);
        }

        .todo-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .todo-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .todo-modal-header {
            background: var(--neobrut-yellow);
            padding: 7.5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .todo-modal-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-black);
            margin: 0;
        }

        .todo-modal-close {
            width: 20px;
            height: 20px;
            background: var(--neobrut-red);
            border: 1.5px solid var(--neobrut-black);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
            transition: all 0.2s;
        }

        .todo-modal-close:hover {
            transform: scale(1.1);
            background: var(--neobrut-orange);
        }

        .todo-modal-close:active {
            transform: scale(0.95) translate(1px, 1px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .todo-modal-content {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        /* Уменьшаем все элементы задач внутри модального окна на 5% (почти полный размер) */
        .todo-modal-content {
            transform: scale(0.95);
            transform-origin: top left;
            height: 105%;
        }

        .todo-modal-content .todo-item {
            margin-bottom: 12px;
            padding: 10px;
            border-width: 2px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        .todo-modal-content .todo-text {
            font-size: 16px;
            line-height: 1.3;
        }

        .todo-modal-content .todo-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 1px;
            border-width: 3px;
            border-radius: 6px;
        }

        .todo-modal-content .todo-checkbox::after {
            top: -3px;
            left: 3px;
            width: 8px;
            height: 15px;
            border-width: 3px;
            border-radius: 2px;
        }

        .todo-modal-content .subtask-list {
            margin-left: 32px;
            margin-top: 8px;
        }

        .todo-modal-content .subtask-item {
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 14px;
            border-width: 2px;
            border-radius: 8px;
        }

        .todo-modal-content .todo-expand {
            width: 14px;
            height: 14px;
            margin-left: 5px;
            border-width: 1.5px;
            border-radius: 4px;
            box-shadow: 1.5px 1.5px 0 var(--neobrut-black);
        }

        .todo-modal-content .chevron {
            width: 0;
            height: 0;
            border-left: 4px solid var(--neobrut-black);
            border-top: 2.5px solid transparent;
            border-bottom: 2.5px solid transparent;
            margin-top: 3px;
            transition: transform 0.2s;
        }

        .todo-modal-content .todo-bullet {
            width: 4px;
            height: 4px;
            margin-right: 4px;
            margin-top: 3px;
        }

        /* Горизонтальный разделитель с кнопкой */
        .divider {
            height: 4px;
            background: var(--neobrut-black);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .divider-button {
            width: 60px;
            height: 20px;
            background: var(--neobrut-yellow);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1;
        }

        .divider-button:hover {
            transform: translate(-50%, -50%) scale(1.05);
            background: var(--neobrut-orange);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .divider-button:active {
            transform: translate(-50%, -50%) scale(0.95);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        /* Нижняя секция с активностью */
        .activity-section {
            padding: 10px 15px;
            background: linear-gradient(rgba(255, 255, 255, 0.2),
                    rgba(255, 255, 255, 0.3));
            display: flex;
            flex-direction: column;
            flex: 1;
            box-shadow: 0 -4px 0 var(--neobrut-black);
            min-height: 0;
            position: relative;
        }

        .activity-header {
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 0;
            position: relative;
        }

        .activity-title {
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--neobrut-black);
            text-shadow:
                1px 1px 0 rgba(255, 255, 255, 0.1),
                2px 2px 0 rgba(0, 0, 0, 0.05),
                3px 3px 0 rgba(0, 0, 0, 0.05),
                4px 4px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-block;
            margin: 0;
            padding: 6px 12px 0 12px;
            z-index: 1;
        }

        .activity-legend {
            display: flex;
            gap: 10px;
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Вертикальная сетка активности */
        .activity-grid-vertical {
            background: rgba(255, 255, 255, 0.7);
            border: 4px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 6px 6px 0 var(--neobrut-black);
            margin-top: 0;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            height: 100%;
            pointer-events: auto;
        }

        /* Мобильная адаптация */
        @media (max-width: 480px) {
            .activity-grid-vertical {
                padding: 12px;
                min-height: 200px;
                height: 100%;
                margin-top: 0;
            }
        }

        /* Слайдер для календарей */
        .activity-slider {
            display: flex;
            gap: 0;
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            pointer-events: auto;
        }

        .calendar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease-out;
            pointer-events: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .calendar-container:nth-child(1) {
            transform: translateX(-100%);
        }

        .calendar-container:nth-child(2) {
            transform: translateX(0);
            z-index: 1;
        }

        .calendar-container:nth-child(3) {
            transform: translateX(100%);
        }

        .calendar-container.empty-calendar {
            opacity: 0.3;
        }

        .calendar-container.empty-calendar .calendar-months {
            pointer-events: none;
        }

        .calendar-wrapper {
            overflow: visible;
            height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .calendar-months {
            height: 100%;
            overflow-y: visible;
            overflow-x: visible;
        }

        .calendar-month {
            margin-bottom: 12px;
        }

        .calendar-month-header {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 6px;
            color: var(--neobrut-black);
            background: rgba(255, 190, 11, 0.8);
            border: 3px solid var(--neobrut-black);
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: inline-block;
            transform: rotate(-1deg);
        }

        .calendar-week {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
            overflow: visible;
            width: 100%;
        }

        .calendar-weekday {
            font-size: 10px;
            font-weight: 700;
            color: var(--neobrut-gray);
            flex: 1;
            text-align: center;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .activity-cell {
            flex: 1;
            height: 18px;
            min-width: 0;
            border: 2px solid var(--neobrut-black);
            border-radius: 6px;
            cursor: default;
            transition: all 0.2s;
            position: relative;
            touch-action: manipulation;
        }

        /* Эффекты для ячеек с активностью */
        .activity-cell:not(.empty) {
            cursor: pointer;
        }

        .activity-cell:not(.empty):hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            z-index: 10;
        }

        .activity-cell:not(.empty):active {
            transform: translateY(0) scale(0.98);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .activity-cell.empty {
            background: transparent;
            border-color: transparent;
            cursor: default;
        }

        .activity-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        /* Уровни активности - Зеленая градация */
        .activity-cell[data-activity="none"] {
            background: var(--neobrut-lightgray);
        }

        .activity-cell[data-activity="low"] {
            background: var(--lime-green);
        }

        .activity-cell[data-activity="medium"] {
            background: var(--light-green);
        }

        .activity-cell[data-activity="high"] {
            background: var(--medium-green);
        }

        .activity-cell[data-activity="max"] {
            background: var(--swamp-green);
        }

        .activity-cell .date-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 700;
            color: var(--neobrut-black);
            opacity: 0.7;
        }

        /* Делаем текущий день постоянно выпирающим (3D-эффект) */
        .activity-cell.today {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border: 2px solid var(--neobrut-black);
            z-index: 10;
        }

        /* Для текущего дня убираем эффекты наведения и нажатия */
        .activity-cell.today:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .activity-cell.today:active {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        /* Исключаем пустые ячейки из 3D-эффекта */
        .activity-cell.today.empty {
            transform: none;
            box-shadow: none;
            border: 2px solid transparent;
        }

        /* Нижняя панель с элементами управления */
        .year-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reset-btn {
            background: var(--neobrut-red);
            border: 3px solid var(--neobrut-black);
            padding: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            color: var(--neobrut-white);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 0 var(--neobrut-black);
            background: #FF0040;
        }

        .reset-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 var(--neobrut-black);
        }

        .year-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .current-year {
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--neobrut-black);
            background: var(--neobrut-blue);
            padding: 8px 16px;
            border: 3px solid var(--neobrut-black);
            box-shadow: 3px 3px 0 var(--neobrut-black);
            border-radius: 8px;
        }

        /* Контейнер для GitHub-стиль таблицы */
        .contribution-graph {
            font-size: 10px;
            color: #57606a;
            position: relative;
        }

        /* Стили для SVG элементов - GitHub стиль */
        .contribution-calendar {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .calendar-graph {
            padding: 5px 0 0;
            text-align: center;
        }

        .calendar-graph svg {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Месяцы */
        .month-label {
            font-size: 10px;
            fill: var(--neobrut-gray);
            font-weight: 600;
        }

        /* Дни недели */
        .day-label {
            font-size: 9px;
            fill: var(--neobrut-gray);
            font-weight: 500;
            text-anchor: start;
        }

        /* Ячейки активности */
        .contribution-day {
            shape-rendering: geometricPrecision;
            stroke: rgba(27, 31, 35, 0.04);
            stroke-width: 1px;
            rx: 2;
            ry: 2;
        }

        .contribution-day:hover {
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 2px;
        }

        /* Уровни активности - Яркие цвета необрутализма */
        .contribution-day[data-level="0"] {
            fill: var(--neobrut-lightgray);
            stroke: var(--neobrut-gray);
        }

        .contribution-day[data-level="1"] {
            fill: var(--warning-yellow);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="2"] {
            fill: var(--neobrut-orange);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="3"] {
            fill: var(--neobrut-pink);
            stroke: var(--neobrut-black);
        }

        .contribution-day[data-level="4"] {
            fill: var(--accent-purple);
            stroke: var(--neobrut-black);
        }

        /* Сегодняшний день */
        .contribution-day.today {
            stroke: var(--neobrut-orange);
            stroke-width: 2px;
        }

        /* Tooltip */
        .tip {
            position: absolute;
            z-index: 100;
            font-size: 11px;
            line-height: 1.4;
            font-weight: 400;
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 5px 8px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tip.show {
            opacity: 1;
        }

        /* Мобильная оптимизация для очень маленьких экранов */
        @media (max-width: 390px) {
            .workout-title {
                font-size: 20px;
            }

            .activity-title {
                font-size: 18px;
            }

            .workout-block {
                flex: 0 0 130px;
                width: 130px;
                height: 130px;
            }
        }

        /* Отключаем hover-эффекты на мобильных устройствах при свайпе */
        @media (hover: none) and (pointer: coarse) {
            .workout-block:hover {
                background: var(--neobrut-white);
                box-shadow:
                    6px 6px 0 var(--neobrut-black),
                    inset 2px 2px 0 rgba(0, 0, 0, 0.1);
            }
        }

        /* Анимация появления */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .workout-section,
        .activity-section {
            animation: slideIn 0.5s ease-out;
        }

        .activity-section {
            animation-delay: 0.1s;
        }

        /* Tooltip для дня активности */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neobrut-darkgray);
            color: var(--neobrut-white);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(45, 52, 54, 0.2);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--neobrut-darkgray);
        }

        .day-cell:hover .tooltip {
            opacity: 1;
        }

        /* AI Chat Modal стили */
        .ai-chat-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--neobrut-white);
            z-index: 100;
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .ai-chat-overlay.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .ai-chat-modal {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--neobrut-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-header {
            background: var(--neobrut-white);
            padding: 25px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            cursor: grab;
            touch-action: pan-y;
        }

        .ai-chat-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-chat-header:active {
            cursor: grabbing;
        }

        .ai-chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--neobrut-darkgray);
            margin: 0;
        }

        .ai-chat-close,
        .ai-chat-clear {
            width: 30px;
            height: 30px;
            background: var(--neobrut-white);
            border: 1px solid var(--neobrut-gray);
            border-radius: 4px;
            font-size: 16px;
            font-weight: 400;
            color: var(--neobrut-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-chat-clear:hover {
            background: var(--neobrut-red);
            color: white;
            border-color: var(--neobrut-black);
        }

        .ai-chat-close {
            display: none;
            /* Скрываем кнопку закрытия */
        }

        .ai-chat-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            background: var(--neobrut-white);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            animation: messageSlide 0.2s ease-out;
        }

        .message:last-child {
            border-bottom: none;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--neobrut-darkgray);
            word-wrap: break-word;
        }

        .user-message {
            background: rgba(78, 205, 196, 0.1);
        }

        .user-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.5);
        }

        .ai-message .message-content {
            color: #333;
        }

        .message-content p {
            margin: 0;
        }

        /* Стили для форматированного AI контента */
        .ai-message .message-content h3 {
            color: var(--accent-blue);
            margin: 12px 0 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .ai-message .message-content strong {
            color: var(--neobrut-darkgray);
            font-weight: 600;
        }

        .ai-message .message-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item {
            margin: 8px 0 8px 20px;
            position: relative;
            line-height: 1.6;
        }

        .ai-message .message-content .ai-list-item:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-size: 1.2em;
            top: -2px;
        }

        .ai-message .message-content span[style*="font-size: 1.2em"] {
            vertical-align: middle;
        }

        .chat-input-container {
            display: flex;
            padding: 16px 20px;
            background: var(--neobrut-white);
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 400;
            background: var(--neobrut-white);
            outline: none;
            margin-right: 12px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--neobrut-gray);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-send {
            width: auto;
            min-width: 60px;
            height: 36px;
            background: var(--neobrut-black);
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0 16px;
        }

        .chat-send:hover {
            background: #333;
        }

        .chat-send:active {
            background: #000;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }

        /* Typing Indicator Styles */
        .typing-indicator {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dots .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.5;
            }

            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ===== НЕОБРУТАЛИСТИЧЕСКИЙ ЧАТ В СЛАЙДЕРЕ ===== */

        /* Контейнер чата в календаре */
        .calendar-container.chat-calendar {
            background: transparent;
        }

        .calendar-container.chat-calendar .calendar-wrapper {
            background: transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-wrapper {
            padding: 0;
            overflow: hidden;
        }

        /* Сообщения чата */
        .chat-wrapper .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px 12px 12px;
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }

        .chat-wrapper .message {
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 14px;
            animation: messageSlideIn 0.2s ease-out;
            flex-shrink: 0;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateX(-10px) rotate(-2deg);
            }

            to {
                opacity: 1;
                transform: translateX(0) rotate(0);
            }
        }

        .chat-wrapper .message.user-message {
            background: var(--neobrut-blue);
            transform: rotate(1deg);
            align-self: flex-end;
        }

        .chat-wrapper .message.user-message .message-content {
            color: var(--neobrut-white);
        }

        .chat-wrapper .message.ai-message {
            background: var(--neobrut-white);
            transform: rotate(-1deg);
            width: fit-content;
            max-width: 85%;
        }

        .chat-wrapper .message.ai-message .message-content {
            color: var(--neobrut-darkgray);
        }

        .chat-wrapper .message-content {
            font-size: 13px;
            line-height: 1.4;
        }

        .chat-wrapper .message-content p {
            margin: 0;
        }

        /* Стили для форматированного контента AI */
        .chat-wrapper .ai-message .message-content h3 {
            color: var(--neobrut-purple);
            margin: 8px 0 6px;
            font-weight: 800;
            font-size: 14px;
        }

        .chat-wrapper .ai-message .message-content strong {
            color: var(--neobrut-black);
            font-weight: 700;
        }

        .chat-wrapper .ai-message .message-content .ai-list-item {
            margin: 6px 0 6px 16px;
            position: relative;
            line-height: 1.4;
        }

        .chat-wrapper .ai-message .message-content .ai-list-item:before {
            content: "▸";
            position: absolute;
            left: -12px;
            color: var(--neobrut-orange);
            font-weight: 900;
        }

        /* Typing indicator */
        .chat-wrapper .typing-indicator {
            background: var(--neobrut-cream);
            border: 3px solid var(--neobrut-black);
            box-shadow: 4px 4px 0 var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            width: fit-content;
        }

        .chat-wrapper .typing-dots .dot {
            background-color: var(--neobrut-black);
            border: 1px solid var(--neobrut-black);
        }

        /* Область ввода */
        .chat-input-area {
            background: transparent;
            border-top: 4px solid var(--neobrut-black);
            flex-shrink: 0;
        }

        .chat-input-row {
            display: flex;
            gap: 8px;
            padding: 8px 12px 12px;
        }

        .chat-input-neobrut {
            flex: 1;
            padding: 10px 14px;
            background: var(--neobrut-white);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            color: var(--neobrut-darkgray);
            outline: none;
            box-shadow: 3px 3px 0 var(--neobrut-black);
            transition: all 0.1s;
        }

        .chat-input-neobrut:focus {
            box-shadow: 4px 4px 0 var(--neobrut-black);
            transform: translate(-1px, -1px);
        }

        .chat-input-neobrut::placeholder {
            color: var(--neobrut-gray);
        }

        .chat-send-neobrut {
            width: 42px;
            height: 42px;
            background: var(--neobrut-black);
            border: 3px solid var(--neobrut-black);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 900;
            color: var(--neobrut-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .chat-send-neobrut:hover {
            background: var(--neobrut-blue);
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 var(--neobrut-black);
        }

        .chat-send-neobrut:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .chat-send-neobrut span {
            display: block;
            transform: translateX(2px);
        }

        /* Скроллбар для сообщений */
        .chat-wrapper .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-wrapper .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-wrapper .chat-messages::-webkit-scrollbar-thumb {
            background: var(--neobrut-black);
            border-radius: 3px;
        }

        /* ===== КОНЕЦ НЕОБРУТАЛИСТИЧЕСКОГО ЧАТА ===== */

        /* ===== STREAK АНИМАЦИЯ (как в Duolingo) ===== */
        .streak-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
        }

        .streak-overlay.show {
            animation: fadeIn 0.3s ease forwards;
        }

        .streak-overlay.hide {
            animation: fadeOut 0.5s ease forwards;
        }

        .streak-fire {
            font-size: 120px;
            line-height: 1;
            animation: fireScale 0.6s ease-out forwards;
            filter: drop-shadow(0 0 30px rgba(255, 150, 50, 0.8));
        }

        .streak-fire.glow {
            animation: fireScale 0.6s ease-out forwards, fireGlow 0.8s ease-in-out 0.6s 3;
        }

        .streak-number {
            font-size: 72px;
            font-weight: 900;
            color: var(--neobrut-black);
            text-shadow: 4px 4px 0 var(--neobrut-yellow);
            margin-top: 10px;
            opacity: 0;
            animation: numberSlide 0.5s ease-out 0.3s forwards;
        }

        .streak-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--neobrut-darkgray);
            margin-top: 5px;
            opacity: 0;
            animation: textSlide 0.5s ease-out 0.4s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes fireScale {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            50% {
                transform: scale(1.3) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes fireGlow {

            0%,
            100% {
                filter: drop-shadow(0 0 30px rgba(255, 150, 50, 0.8));
            }

            50% {
                filter: drop-shadow(0 0 60px rgba(255, 100, 0, 1));
            }
        }

        @keyframes numberSlide {
            0% {
                transform: translateY(30px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes textSlide {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ===== КОНЕЦ STREAK АНИМАЦИИ ===== */

        /* ===== DASHBOARD STRIP (Верхняя панель) ===== */
        .dashboard-strip {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: transparent;
            height: 100%;
            overflow-y: auto;
        }

        .strip-main {
            background: linear-gradient(135deg, var(--neobrut-orange), var(--neobrut-red));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .strip-day-info {
            color: var(--neobrut-white);
        }

        .strip-day {
            font-size: 11px;
            font-weight: 700;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .strip-date {
            font-size: 24px;
            font-weight: 900;
            line-height: 1;
            margin-top: 2px;
        }

        .strip-streak {
            text-align: right;
        }

        .streak-icon {
            font-size: 28px;
            line-height: 1;
        }

        .streak-count {
            font-size: 13px;
            font-weight: 900;
            color: var(--neobrut-white);
        }

        .strip-progress {
            background: linear-gradient(135deg, var(--neobrut-blue), var(--neobrut-purple));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .strip-progress-content {
            flex: 1;
        }

        .strip-progress-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .strip-progress-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--neobrut-white);
            line-height: 1;
        }

        .strip-progress-sub {
            font-size: 13px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 2px;
        }

        .strip-progress-chart {
            flex-shrink: 0;
        }

        /* ===== AI COMMENT BLOCK ===== */
        .ai-comment {
            background: linear-gradient(135deg, var(--neobrut-purple), var(--neobrut-blue));
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 14px 16px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            position: relative;
            overflow: hidden;
        }

        .ai-comment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
            pointer-events: none;
        }

        .ai-comment-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--neobrut-white);
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .ai-comment-loading {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
        }

        .ai-comment-loading-dot {
            width: 7px;
            height: 7px;
            background: var(--neobrut-white);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .ai-comment-loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .ai-comment-loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .ai-comment-loading-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0.6);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ===== ПОГОДНЫЙ БЛОК ===== */
        .weather-ai-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .weather-block {
            background: linear-gradient(135deg, #87CEEB, #4A90D9);
            border: 3px solid var(--neobrut-black);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 4px 4px 0 var(--neobrut-black);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 80px;
            height: 85px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .weather-block:hover {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0 var(--neobrut-black);
        }

        .weather-block:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .weather-content {
            display: flex;
            align-items: center;
            gap: 2px;
            position: relative;
        }

        .weather-icon {
            font-size: 32px;
            line-height: 1;
            z-index: 1;
        }

        .weather-temp {
            font-size: 24px;
            font-weight: 900;
            color: var(--neobrut-black);
            position: absolute;
            bottom: 2px;
            right: 4px;
            z-index: 4;
            line-height: 1;
        }

        .weather-temp::after {
            content: '°';
            font-size: 16px;
        }

        .weather-loading {
            font-size: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .weather-night {
            background: linear-gradient(135deg, #4A5568, #2D3748);
        }

        .weather-night .weather-temp {
            color: var(--neobrut-white);
        }

        /* ===== МОДАЛЬНОЕ ОКНО ГЕОЛОКАЦИИ ===== */
        .geo-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .geo-modal-overlay.show {
            display: flex;
        }

        .geo-modal {
            background: var(--neobrut-white);
            border: 4px solid var(--neobrut-black);
            box-shadow: 8px 8px 0 var(--neobrut-black);
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            text-align: center;
            animation: geoModalSlide 0.3s ease-out;
        }

        @keyframes geoModalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .geo-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .geo-modal-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--neobrut-black);
            margin: 0 0 16px 0;
        }

        .geo-modal-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--neobrut-darkgray);
            margin: 0 0 12px 0;
        }

        .geo-modal-subtext {
            font-size: 13px;
            line-height: 1.4;
            color: #666;
            margin: 0 0 20px 0;
        }

        .geo-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .geo-modal-btn {
            flex: 1;
            padding: 12px 16px;
            border: 3px solid var(--neobrut-black);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s;
        }

        .geo-modal-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--neobrut-black);
        }

        .geo-modal-btn-deny {
            background: var(--neobrut-white);
            color: var(--neobrut-black);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .geo-modal-btn-deny:hover {
            background: #f0f0f0;
        }

        .geo-modal-btn-allow {
            background: var(--neobrut-blue);
            color: var(--neobrut-white);
            box-shadow: 3px 3px 0 var(--neobrut-black);
        }

        .geo-modal-btn-allow:hover {
            background: #5dade2;
        }

        .ai-comment {
            flex: 1;
        }

        /* ===== ФИКСИРОВАННОЕ СООТНОШЕНИЕ ЭКРАНА ===== */
        body {
            height: 100vh;
            overflow: hidden;
        }

        .workout-section {
            height: 40%;
            overflow-y: auto;
        }

        .activity-section {
            height: 60%;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <!-- Верхняя панель с прогрессом (Dashboard Strip) -->
    <div class="workout-section">
        <div class="dashboard-strip" id="dashboard-strip">
            <!-- Дата и серия -->
            <div class="strip-main">
                <div class="strip-day-info">
                    <div class="strip-day" id="strip-day">Загрузка...</div>
                    <div class="strip-date" id="strip-date">День 1</div>
                </div>
                <div class="strip-streak">
                    <div class="streak-icon">🔥</div>
                    <div class="streak-count" id="streak-count">0 дней</div>
                </div>
            </div>

            <!-- Прогресс -->
            <div class="strip-progress">
                <div class="strip-progress-content">
                    <div class="strip-progress-label">Сегодня</div>
                    <div class="strip-progress-value" id="strip-progress-value">0%</div>
                    <div class="strip-progress-sub" id="strip-progress-sub">День 1 из 7</div>
                </div>
                <div class="strip-progress-chart">
                    <svg width="50" height="50" viewBox="0 0 36 36">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3" />
                        <path id="strip-progress-circle"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke="#fff" stroke-width="3" stroke-dasharray="0, 100"
                            stroke-linecap="round" />
                    </svg>
                </div>
            </div>

            <!-- AI Комментарий -->
            <div class="ai-comment" id="ai-comment">
                <div class="ai-comment-text" id="ai-comment-text">
                    Загрузка AI комментария...
                </div>
            </div>

            <!-- ПОГОДА -->
            <div class="weather-block" id="weather-block" title="Нажмите для обновления">
                <div class="weather-content">
                    <div class="weather-icon" id="weather-icon">🌤️</div>
                </div>
                <div class="weather-temp" id="weather-temp">--</div>
            </div>
        </div>

        <!-- Overlay модальное окно для задач -->
        <div class="todo-overlay" id="todo-overlay">
            <div class="todo-modal">
                <div class="todo-modal-header">
                    <h1 class="todo-modal-title" id="todo-modal-title">День 1 - Задания</h1>
                    <button class="todo-modal-close" id="todo-modal-close">×</button>
                </div>
                <div class="todo-modal-content" id="todo-modal-content">
                    <!-- Задачи будут вставлены сюда -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для запроса геолокации -->
    <div class="geo-modal-overlay" id="geo-modal-overlay">
        <div class="geo-modal">
            <div class="geo-modal-icon">📍</div>
            <h2 class="geo-modal-title">Доступ к геолокации</h2>
            <p class="geo-modal-text">
                Чтобы показывать точную погоду в твоём городе и давать персонализированные рекомендации от ИИ, нам нужен
                доступ к геолокации.
            </p>
            <p class="geo-modal-subtext">Это поможет ИИ учитывать погодные условия при составлении тренировочного плана
                🌤️</p>
            <div class="geo-modal-buttons">
                <button class="geo-modal-btn geo-modal-btn-deny" id="geo-modal-deny">Запретить</button>
                <button class="geo-modal-btn geo-modal-btn-allow" id="geo-modal-allow">Разрешить</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Горизонтальная линия-разделитель с кнопкой -->
    <div class="divider">
        <div class="divider-button"></div>
    </div>

    <!-- Нижняя секция с активностью -->
    <div class="activity-section">
        <div class="activity-header">
            <h2 class="activity-title">Активность</h2>
        </div>

        <!-- Вертикальный календарь активности -->
        <div class="activity-grid-vertical">
            <div class="activity-slider">
                <!-- AI Чат слева -->
                <div class="calendar-container chat-calendar">
                    <div class="calendar-wrapper chat-wrapper">
                        <div class="chat-messages" id="slider-chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-row">
                                <input type="text" class="chat-input-neobrut" id="slider-chat-input"
                                    placeholder="Спроси меня что угодно...">
                                <button class="chat-send-neobrut" id="slider-chat-send">
                                    <span>→</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Основной календарь -->
                <div class="calendar-container">
                    <div class="calendar-wrapper">
                        <div class="calendar-months" id="calendar-months">
                            <!-- Месяцы генерируются JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Пустой блок справа -->
                <div class="calendar-container empty-calendar">
                    <div class="calendar-wrapper">
                        <div class="calendar-months">
                            <!-- Пустой контент -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tooltip для активности -->
            <div class="tip" id="activity-tooltip"></div>

            <!-- Overlay модальное окно для AI чата -->
            <div class="ai-chat-overlay" id="ai-chat-overlay">
                <div class="ai-chat-modal">
                    <div class="ai-chat-header">
                        <h1 class="ai-chat-title">AI Ассистент</h1>
                        <div class="ai-chat-controls">
                            <button class="ai-chat-clear" id="ai-chat-clear" title="Очистить историю">🗑️</button>
                            <button class="ai-chat-close" id="ai-chat-close">×</button>
                        </div>
                    </div>
                    <div class="ai-chat-content">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message">
                                <div class="message-content">
                                    <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input"
                                placeholder="Введите ваше сообщение...">
                            <button class="chat-send" id="chat-send">Отправить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // === API KEY PARTS (base64 encoded, split for security) ===
        // Part 1: API key prefix (sk-or-v1-5b6bf592b)
        const API_KEY_PART_1 = "c2stb3ItdjEtNWI2YmY1OTJi";
        // Part 2: Mid section (99573770c98430ba1a)
        const API_KEY_PART_2 = "OTk1NzM3NzBjOTg0MzBiYTFh";
        // Part 3: Hash section (4fc82d2d65380c41fe)
        const API_KEY_PART_3 = "NGZjODJkMmQ2NTM4MGM0MWZl";
        // Part 4: Final section (91c06d79a8ef9b9275e==)
        const API_KEY_PART_4 = "OTFjMDZkNzlhOGVmOWI5Mjc1ZQ==";

        // Other app constants (obfuscated)
        const APP_VERSION = "ZGVlcHNlZWsvZGVlcHNlZWstdjMuMg==";

        // API Key assembly and decode function
        function getConnectionString() {
            const encoded = API_KEY_PART_1 + API_KEY_PART_2 + API_KEY_PART_3 + API_KEY_PART_4;
            return atob(encoded);
        }

        const AI_MODEL = 'google/gemini-2.0-flash-001';

        // Динамическое формирование URL API
        function getAPIBaseURL() {
            return 'https://openrouter.ai/api/v1/chat/completions';
        }

        // Простая функция проверки
        function validateConfig() {
            return true; // Для простоты
        }

        // Программа тренировок
        const workoutProgram = [
            { day: 1, name: 'Понедельник', exercises: ['Отжимания', 'Приседания', 'Планка'] },
            { day: 2, name: 'Вторник', exercises: ['Прыжки "Джек"', 'Выпады', 'Планка'] },
            { day: 3, name: 'Среда', exercises: ['Отжимания', 'Берпи', 'Приседания'] },
            { day: 4, name: 'Четверг', exercises: ['Планка', 'Выпады', 'Прыжки "Джек"'] },
            { day: 5, name: 'Пятница', exercises: ['Отжимания', 'Приседания', 'Берпи'] },
            { day: 6, name: 'Суббота', exercises: ['Прыжки "Джек"', 'Выпады', 'Планка'] },
            { day: 7, name: 'Воскресенье', exercises: ['Отжимания', 'Берпи', 'Приседания'] }
        ];

        // Иконки упражнений
        const exerciseIcons = {
            'Отжимания': '💪',
            'Приседания': '🦵',
            'Планка': '🧘',
            'Прыжки "Джек"': '⚡',
            'Выпады': '🏃',
            'Берпи': '🔥'
        };

        // Инициализация приложения
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0 = Январь, 11 = Декабрь
        let activityData = {};
        let selectedWorkout = 1;
        let todoData = {}; // Хранение состояния todo-списков


        // Инициализация todo-списков
        function initializeTodoLists() {
            todoData = {
                1: [
                    {
                        id: 'task-1',
                        text: 'покушать',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-2',
                        text: 'пробежка 5км',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-3',
                        text: 'спать',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                2: [
                    {
                        id: 'task-4',
                        text: 'Утренняя зарядка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-5',
                        text: 'Пресс',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                3: [
                    {
                        id: 'task-6',
                        text: 'Растяжка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-7',
                        text: 'Отжимания',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                4: [
                    {
                        id: 'task-8',
                        text: 'Приседания',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-9',
                        text: 'Планка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                5: [
                    {
                        id: 'task-10',
                        text: 'Бег',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-11',
                        text: 'Гигиеничес процедуры',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                6: [
                    {
                        id: 'task-12',
                        text: 'Йога',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-13',
                        text: 'Медитация',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ],
                7: [
                    {
                        id: 'task-14',
                        text: 'Прогулка',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    },
                    {
                        id: 'task-15',
                        text: 'Чтение',
                        completed: false,
                        completedAt: null,
                        timeSpent: null
                    }
                ]
            };

            // Загружаем сохраненные состояния из localStorage
            loadTodoStates();
        }


        // Дополнительные метаданные приложения
        const METADATA_PREFIX = "NGZjODJkMmQ2NTM4MGM0MWZl";

        // Загрузка состояний todo из localStorage
        function loadTodoStates() {
            const saved = localStorage.getItem('fitTrackerTodos');
            if (saved) {
                try {
                    const states = JSON.parse(saved);
                    Object.keys(states).forEach(day => {
                        if (todoData[day]) {
                            // Применяем сохраненные состояния
                            todoData[day].forEach(task => {
                                const taskState = states[day][task.id];
                                if (taskState) {
                                    task.completed = taskState.completed || false;
                                    task.completedAt = taskState.completedAt || null;
                                    task.timeSpent = taskState.timeSpent || null;
                                }
                            });
                        }
                    });
                    console.log('Состояния todo загружены из localStorage');
                } catch (e) {
                    console.error('Error loading todo states:', e);
                }
            }
        }

        // Сохранение состояний todo в localStorage
        function saveTodoStates() {
            const states = {};
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    states[day] = {};
                    todoData[day].forEach(task => {
                        states[day][task.id] = {
                            completed: task.completed || false,
                            completedAt: task.completedAt || null,
                            timeSpent: task.timeSpent || null
                        };
                    });
                }
            });
            localStorage.setItem('fitTrackerTodos', JSON.stringify(states));
        }

        // Создание HTML для todo-списка
        function createTodoHtml(todos) {
            if (!todos || todos.length === 0) {
                return '<div class="no-tasks">Задания не найдены</div>';
            }

            let html = '<ul class="todo-list">';

            todos.forEach(task => {
                const taskCompletedClass = task.completed ? 'completed' : '';

                html += `
                    <li class="todo-item ${taskCompletedClass}">
                        <div class="todo-checkbox">
                            <input type="checkbox"
                                   id="${task.id}"
                                   data-task-id="${task.id}"
                                   ${task.completed ? 'checked' : ''}
                                   onchange="toggleTask('${task.id}')">
                            <div class="checkbox-visual"></div>
                            <div class="checkbox-checkmark"></div>
                        </div>
                        <div class="todo-text-wrapper">
                            <div class="todo-text" onclick="toggleTask('${task.id}')">
                                ${task.text}${task.completed && task.completedAt ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</span>` : ''}
                            </div>
                        </div>
                    </li>
                `;
            });

            html += '</ul>';
            return html;
        }

        // Получение даты для дня тренировки
        function getWorkoutDate(workoutDay) {
            const today = new Date();

            // День тренировки - это просто смещение от сегодняшнего дня
            // День 1 = сегодня, День 2 = завтра, День 3 = послезавтра и т.д.
            const dayOffset = workoutDay - 1;

            // Создаем дату для дня тренировки
            const workoutDate = new Date(today);
            workoutDate.setDate(today.getDate() + dayOffset);

            console.log(`День ${workoutDay} -> ${workoutDate.toLocaleDateString('ru-RU')} (смещение: ${dayOffset} дней)`);

            return workoutDate;
        }

        // Проверка и запись активности на основе процентов выполнения
        function checkAndRecordActivity() {
            // Проверяем, есть ли todo для выбранного дня тренировки
            if (todoData[selectedWorkout]) {
                // Получаем правильную дату для дня тренировки
                const workoutDate = getWorkoutDate(selectedWorkout);

                // Рассчитываем общий процент выполнения для выбранного дня
                const percentage = calculateCompletionPercentage(selectedWorkout);
                console.log(`День ${selectedWorkout}: процент выполнения = ${percentage}%`);

                // Определяем уровень активности на основе процента
                let activityLevel = 'none';
                if (percentage >= 100) {
                    activityLevel = 'max';
                } else if (percentage >= 75) {
                    activityLevel = 'high';
                } else if (percentage >= 50) {
                    activityLevel = 'medium';
                } else if (percentage >= 25) {
                    activityLevel = 'low';
                }

                // Обновляем активность для правильной даты
                const dateKey = formatDateKey(workoutDate);
                const oldActivity = activityData[dateKey] || 'none';

                console.log(`Активность на ${workoutDate.toLocaleDateString('ru-RU')}: ${oldActivity} -> ${activityLevel}`);

                // Обновляем только если активность изменилась
                if (oldActivity !== activityLevel) {
                    activityData[dateKey] = activityLevel;
                    saveActivityData();

                    // Обновляем календарь, если он показывает год даты тренировки
                    if (currentYear === workoutDate.getFullYear()) {
                        renderActivityGrid();

                        // Добавляем анимацию при увеличении активности
                        if (activityLevel !== 'none' && oldActivity === 'none') {
                            const targetCell = document.querySelector(`[data-date="${dateKey}"]`);
                            if (targetCell) {
                                // Сначала обновляем data-activity для применения нового цвета
                                targetCell.dataset.activity = activityLevel;
                                // Затем добавляем анимацию
                                targetCell.style.transform = 'translateY(-10px) scale(1.2) rotate(5deg)';

                                setTimeout(() => {
                                    targetCell.style.transform = '';
                                }, 300);
                            }
                        }
                    }
                }
            }
        }

        // Расчёт текущей серии (streak)
        function calculateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayKey = formatDateKey(today);

            let streak = 0;
            let checkDate = new Date(today);
            let checkedToday = false;

            // Проверяем сегодняшнюю активность
            const todayActivity = activityData[todayKey];
            if (todayActivity && todayActivity !== 'none') {
                streak++;
                checkedToday = true;
            }

            // Если сегодня нет активности, проверяем вчерашний день
            // Если вчера была активность - streak продолжается
            if (!checkedToday) {
                checkDate.setDate(checkDate.getDate() - 1);
                const yesterdayKey = formatDateKey(checkDate);
                const yesterdayActivity = activityData[yesterdayKey];

                if (!yesterdayActivity || yesterdayActivity === 'none') {
                    // Если вчера тоже не было активности - streak = 0
                    return 0;
                }
                // Вчера была активность - продолжаем считать дальше назад
            }

            // Считаем подряд идущие дни назад от проверенной даты
            while (true) {
                checkDate.setDate(checkDate.getDate() - 1);
                const dateKey = formatDateKey(checkDate);
                const activity = activityData[dateKey];

                if (activity && activity !== 'none') {
                    streak++;
                } else {
                    break;
                }

                // Ограничиваем чтобы не уйти в бесконечность
                if (streak > 3650) break;
            }

            return streak;
        }

        // Показ анимации streak (как в Duolingo)
        function showStreakAnimation() {
            const today = new Date();
            const todayKey = formatDateKey(today);

            // Проверяем, показывали ли уже сегодня
            const lastShown = localStorage.getItem('fitTrackerStreakLastShown');
            if (lastShown === todayKey) {
                return; // Уже показывали сегодня
            }

            // Вычисляем текущий streak
            const streak = calculateStreak();

            // Показываем только если streak > 0
            if (streak === 0) {
                // Сохраняем что проверили сегодня, но не показываем
                localStorage.setItem('fitTrackerStreakLastShown', todayKey);
                return;
            }

            // Создаём элементы анимации
            const overlay = document.createElement('div');
            overlay.className = 'streak-overlay';

            const fire = document.createElement('div');
            fire.className = 'streak-fire glow';
            fire.textContent = '🔥';

            const number = document.createElement('div');
            number.className = 'streak-number';
            number.textContent = streak;

            const text = document.createElement('div');
            text.className = 'streak-text';
            const dayWord = streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней');
            text.textContent = `${dayWord} подряд!`;

            overlay.appendChild(fire);
            overlay.appendChild(number);
            overlay.appendChild(text);
            document.body.appendChild(overlay);

            // Показываем анимацию
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });

            // Вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                setTimeout(() => {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }, 300);
            }

            // Скрываем и удаляем через 2.5 секунды
            setTimeout(() => {
                overlay.classList.remove('show');
                overlay.classList.add('hide');
            }, 2500);

            // Удаляем из DOM после анимации
            setTimeout(() => {
                overlay.remove();
            }, 3000);

            // Сохраняем дату показа
            localStorage.setItem('fitTrackerStreakLastShown', todayKey);
        }

        // Переключение состояния задачи
        function toggleTask(taskId) {
            // Ищем задачу по ID
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.id === taskId) {
                            const now = new Date();

                            if (!task.completed) {
                                // Задача только что выполнена - записываем время
                                task.completed = true;
                                task.completedAt = now.toISOString();
                                // Слабая вибрация как фидбек
                                if (window.Telegram?.WebApp?.HapticFeedback) {
                                    Telegram.WebApp.HapticFeedback.selectionChanged();
                                }
                            } else {
                                // Задача отменена - убираем время выполнения
                                task.completed = false;
                                task.completedAt = null;
                            }

                            const checkbox = document.getElementById(taskId);
                            if (checkbox) {
                                checkbox.checked = task.completed;

                                // Обновляем текст задачи с временем
                                const todoText = checkbox.closest('.todo-item').querySelector('.todo-text');
                                if (todoText) {
                                    const timeText = task.completed && task.completedAt
                                        ? ` <span class="task-time-inline">${new Date(task.completedAt).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</span>`
                                        : '';
                                    todoText.innerHTML = `${task.text}${timeText}`;
                                }

                                const todoItem = checkbox.closest('.todo-item');
                                if (todoItem) {
                                    todoItem.classList.toggle('completed', task.completed);
                                }
                            }
                        }
                    });
                }
            });

            // Сохраняем состояния
            saveTodoStates();

            // Проверяем процент выполнения и записываем активность
            checkAndRecordActivity();

            // Обновляем dashboard strip
            updateDashboardStrip();

            // Обновляем AI комментарий если нужно
            updateAIComment();
        }

        // Переключение видимости подпунктов

        // ===== DASHBOARD STRIP ФУНКЦИИ =====

        // Обновление dashboard strip с актуальными данными
        function updateDashboardStrip() {
            const today = new Date();
            const streak = calculateStreak();
            const percentage = calculateCompletionPercentage(selectedWorkout);

            // Обновляем дату
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const monthNames = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
            const dayName = dayNames[today.getDay()];
            const day = today.getDate();
            const month = monthNames[today.getMonth()];

            document.getElementById('strip-day').textContent = `${dayName}, ${day} ${month}`;
            document.getElementById('strip-date').textContent = `День ${selectedWorkout}`;

            // Обновляем серию
            document.getElementById('streak-count').textContent = `${streak} ${streak === 1 ? 'день' : (streak >= 2 && streak <= 4 ? 'дня' : 'дней')}`;

            // Обновляем прогресс
            document.getElementById('strip-progress-value').textContent = `${percentage}%`;
            document.getElementById('strip-progress-sub').textContent = `День ${selectedWorkout} из 7`;

            // Обновляем круговой прогресс
            const progressCircle = document.getElementById('strip-progress-circle');
            progressCircle.setAttribute('stroke-dasharray', `${percentage}, 100`);
        }

        // ===== AI КОММЕНТАРИЙ ФУНКЦИИ =====

        let lastAICommentUpdate = null;
        let lastAICommentPercentage = -1;
        const AI_COMMENT_UPDATE_INTERVAL = 15 * 60 * 1000; // 15 минут
        const AI_COMMENT_PERCENTAGE_THRESHOLDS = [0, 25, 50, 75, 100];

        // Проверка нужно ли обновить AI комментарий
        function shouldUpdateAIComment(percentage) {
            const now = Date.now();

            // Если еще не было обновления - обновляем
            if (!lastAICommentUpdate) return true;

            // Если прошло 15+ минут - обновляем
            if (now - lastAICommentUpdate > AI_COMMENT_UPDATE_INTERVAL) return true;

            // Если процент изменился до порогового значения - обновляем
            for (const threshold of AI_COMMENT_PERCENTAGE_THRESHOLDS) {
                if (percentage >= threshold && lastAICommentPercentage < threshold) {
                    return true;
                }
            }

            return false;
        }

        // Генерация AI комментария для dashboard
        async function updateAIComment() {
            const percentage = calculateCompletionPercentage(selectedWorkout);
            const streak = calculateStreak();

            // Проверяем нужно ли обновлять
            if (!shouldUpdateAIComment(percentage)) {
                return; // Используем закешированный комментарий
            }

            // Показываем индикатор загрузки
            const commentElement = document.getElementById('ai-comment-text');
            commentElement.innerHTML = `
                <div class="ai-comment-loading">
                    <span>Анализирую прогресс</span>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                    <div class="ai-comment-loading-dot"></div>
                </div>
            `;

            // Генерируем комментарий
            const comment = await generateAICommentForDashboard(percentage, streak);

            // Обновляем комментарий
            commentElement.textContent = comment;

            // Сохраняем время обновления и процент
            lastAICommentUpdate = Date.now();
            lastAICommentPercentage = percentage;

            // Кешируем в localStorage
            localStorage.setItem('fitTrackerAIComment', JSON.stringify({
                comment,
                timestamp: lastAICommentUpdate,
                percentage: lastAICommentPercentage
            }));
        }

        // Генерация AI комментария через API
        async function generateAICommentForDashboard(percentage, streak) {
            const today = new Date();
            const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const dayName = dayNames[today.getDay()];

            // Подсчитываем выполненные и оставшиеся задачи
            const todos = todoData[selectedWorkout] || [];
            const completedCount = todos.filter(t => t.completed).length;
            const totalCount = todos.length;
            const remainingCount = totalCount - completedCount;

            const systemPrompt = `Ты — мотивирующий фитнес-тренер AI. Ты даёшь короткие, энерджичные комментарии на русском языке (макс 120 символов).
Правила:
- Будь дружелюбным и мотивирующим
- Используй эмодзи (не более 2)
- Адаптируй тон под прогресс пользователя
- Упоминай конкретные цифры (процент, серия, задачи)
- Никогда не повторяйся

Контекст:
- День: ${selectedWorkout} из 7
- Процент выполнения: ${percentage}%
- Серия: ${streak} дней
- Выполнено задач: ${completedCount}/${totalCount}
- Осталось: ${remainingCount} задач`;

            try {
                const response = await fetch(getAPIBaseURL(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getConnectionString()}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'FitTracker AI'
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: 'Дай мотивирующий комментарий на основе текущего прогресса.' }
                        ],
                        max_tokens: 150,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const comment = data.choices[0]?.message?.content?.trim() || getFallbackComment(percentage, streak);
                return comment;
            } catch (error) {
                console.error('AI Comment error:', error);
                return getFallbackComment(percentage, streak);
            }
        }

        // Fallback комментарии если API недоступен
        function getFallbackComment(percentage, streak) {
            const comments = [
                { min: 0, max: 24, text: `Начинаем с вдоха! ${streak > 0 ? streak + ' дней серии — отличный старт!' : 'Первый шаг самый важный!'}` },
                { min: 25, max: 49, text: `Хороший старт! ${percentage}% выполнено, продолжайте! 💪` },
                { min: 50, max: 74, text: `Половина позади! ${streak} дней подряд — отличная дисциплина! 🔥` },
                { min: 75, max: 99, text: `Почти у цели! ${percentage}% — финиш прям впереди! 🚀` },
                { min: 100, max: 100, text: `Отлично! Все задачи выполнены! ${streak} дней серии — невероятно! 🏆` }
            ];

            const comment = comments.find(c => percentage >= c.min && percentage <= c.max);
            return comment ? comment.text : comments[0].text;
        }

        // Загрузка закешированного AI комментария
        function loadCachedAIComment() {
            const cached = localStorage.getItem('fitTrackerAIComment');
            if (cached) {
                try {
                    const { comment, timestamp, percentage } = JSON.parse(cached);
                    const commentElement = document.getElementById('ai-comment-text');
                    if (commentElement) {
                        commentElement.textContent = comment;
                    }
                    lastAICommentUpdate = timestamp;
                    lastAICommentPercentage = percentage;
                } catch (e) {
                    console.error('Error loading cached AI comment:', e);
                }
            }
        }

        // ===== ПОГОДА ЧЕРЕЗ OPEN-METEO =====

        let weatherCache = null;
        let weatherCacheTime = null;
        const WEATHER_CACHE_DURATION = 2 * 60 * 1000; // 2 минуты - обновляем часто

        // WMO код → иконки погоды
        function getWeatherIcon(wmoCode, isNight) {
            const dayIcons = {
                0: '☀️', 1: '🌤️', 2: '⛅', 3: '☁️',
                45: '🌫️', 48: '🌫️',
                51: '🌧️', 53: '🌧️', 55: '🌧️',
                61: '🌧️', 63: '🌧️', 65: '🌧️',
                71: '🌨️', 73: '🌨️', 75: '🌨️', 77: '🌨️',
                80: '🌦️', 81: '🌦️', 82: '🌦️',
                85: '🌨️', 86: '🌨️',
                95: '⛈️', 96: '⛈️', 99: '⛈️'
            };

            const nightIcons = {
                0: '🌙', 1: '☁️', 2: '☁️', 3: '☁️',
                45: '🌫️', 48: '🌫️',
                51: '🌧️', 53: '🌧️', 55: '🌧️',
                61: '🌧️', 63: '🌧️', 65: '🌧️',
                71: '🌨️', 73: '🌨️', 75: '🌨️', 77: '🌨️',
                80: '🌧️', 81: '🌧️', 82: '🌧️',
                85: '🌨️', 86: '🌨️',
                95: '⛈️', 96: '⛈️', 99: '⛈️'
            };

            const icons = isNight ? nightIcons : dayIcons;
            return icons[wmoCode] || (isNight ? '🌙' : '☀️');
        }

        // Проверка ночь ли сейчас
        function isNightTime() {
            const hour = new Date().getHours();
            return hour < 6 || hour >= 21;
        }

        // Загрузка погоды
        async function loadWeather() {
            const now = Date.now();

            // Проверяем кеш
            if (weatherCache && weatherCacheTime && (now - weatherCacheTime < WEATHER_CACHE_DURATION)) {
                updateWeatherUI(weatherCache);
                return;
            }

            // Показываем загрузку
            document.getElementById('weather-icon').innerHTML = '<div class="weather-loading">🔄</div>';

            try {
                // Проверяем - давал ли пользователь разрешение на GPS раньше
                const gpsPermissionGranted = localStorage.getItem('fitTrackerGPSGranted') === 'true';

                let latitude, longitude;

                if (gpsPermissionGranted) {
                    // Пользователь уже давал разрешение - используем GPS
                    try {
                        const position = await getCurrentPosition();
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                        console.log('Weather: Using GPS (cached permission)', latitude, longitude);
                    } catch (gpsError) {
                        // GPS не сработал - fallback на IP
                        console.log('Weather: GPS failed, using IP');
                        const ipLocation = await getIPLocation();
                        latitude = ipLocation.latitude;
                        longitude = ipLocation.longitude;
                    }
                } else {
                    // Первый раз или пользователь не давал разрешение
                    // Проверяем - отклонял ли пользователь раньше
                    const gpsDenied = localStorage.getItem('fitTrackerGPSDenied') === 'true';

                    if (gpsDenied) {
                        // Пользователь уже отклонял - показываем желтый треугольник
                        console.log('Weather: GPS denied by user, showing denied state');
                        showGeoDeniedState();
                        return; // Прерываем загрузку погоды
                    } else {
                        // Пробуем GPS с коротким таймаутом
                        try {
                            const position = await Promise.race([
                                getCurrentPosition(),
                                new Promise((_, reject) =>
                                    setTimeout(() => reject(new Error('GPS timeout')), 2000)
                                )
                            ]);
                            latitude = position.coords.latitude;
                            longitude = position.coords.longitude;
                            // Сохраняем что пользователь дал разрешение
                            localStorage.setItem('fitTrackerGPSGranted', 'true');
                            console.log('Weather: Using GPS (new permission)', latitude, longitude);
                        } catch (gpsError) {
                            // GPS не сработал или пользователь не дал разрешение - показываем желтый треугольник
                            console.log('Weather: GPS denied/timeout, showing denied state');
                            showGeoDeniedState();
                            return; // Прерываем загрузку погоды
                        }
                    }
                }

                console.log('Weather API: Loading for', latitude, longitude);

                // Запрос к Open-Meteo с явным указанием единиц измерения
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius&wind_speed_unit=kmh&precipitation_unit=mm`;
                const response = await fetch(url);
                const data = await response.json();

                console.log('Weather API Response:', data);

                if (!data.current_weather) {
                    throw new Error('Invalid API response structure');
                }

                const weather = {
                    temp: Math.round(data.current_weather.temperature),
                    wmoCode: data.current_weather.weathercode,
                    isNight: isNightTime()
                };

                console.log('Parsed weather:', weather);

                // Кешируем
                weatherCache = weather;
                weatherCacheTime = now;
                localStorage.setItem('fitTrackerWeather', JSON.stringify({
                    weather,
                    timestamp: now
                }));

                updateWeatherUI(weather);
            } catch (error) {
                console.error('Weather load error:', error);
                // Очищаем кеш при ошибке
                weatherCache = null;
                weatherCacheTime = null;
                localStorage.removeItem('fitTrackerWeather');
                // Показываем заглушку
                document.getElementById('weather-icon').textContent = '❓';
                document.getElementById('weather-temp').textContent = '--';
            }
        }

        // Получение геолокации через GPS
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    timeout: 5000,
                    maximumAge: 300000 // 5 минут
                });
            });
        }

        // Показать запрос разрешения на геолокацию
        function showGeoPermissionPrompt() {
            const weatherBlock = document.getElementById('weather-block');

            // Меняем иконку на восклицательный знак
            weatherBlock.classList.add('geo-prompt');
            weatherBlock.innerHTML = `
                <div class="weather-content">
                    <div class="geo-prompt-icon">⚠️</div>
                </div>
                <div class="weather-temp">--</div>
            `;
            weatherBlock.style.cursor = 'pointer';
            // При клике открываем модальное окно
            weatherBlock.onclick = () => {
                openGeoModal();
            };
        }

        // Показать состояние отказа (желтый треугольник)
        function showGeoDeniedState() {
            const weatherBlock = document.getElementById('weather-block');

            // Меняем иконку на желтый треугольник
            weatherBlock.classList.add('geo-denied');
            weatherBlock.innerHTML = `
                <div class="weather-content">
                    <div class="geo-denied-icon">⚠️</div>
                </div>
                <div class="weather-temp">--</div>
            `;
            weatherBlock.style.cursor = 'pointer';
            // При клике открываем модальное окно для повторного запроса
            weatherBlock.onclick = () => {
                openGeoModal();
            };
        }

        // Открыть модальное окно геолокации
        function openGeoModal() {
            const overlay = document.getElementById('geo-modal-overlay');
            overlay.classList.add('show');
        }

        // Закрыть модальное окно геолокации
        function closeGeoModal() {
            const overlay = document.getElementById('geo-modal-overlay');
            overlay.classList.remove('show');
        }

        // Настройка обработчиков для модального окна геолокации
        function setupGeoModalListeners() {
            const allowBtn = document.getElementById('geo-modal-allow');
            const denyBtn = document.getElementById('geo-modal-deny');
            const overlay = document.getElementById('geo-modal-overlay');

            // Клик по "Разрешить"
            allowBtn.addEventListener('click', async () => {
                closeGeoModal();

                // Показываем индикатор загрузки
                const weatherBlock = document.getElementById('weather-block');
                const originalContent = weatherBlock.innerHTML;
                weatherBlock.innerHTML = `
                    <div class="weather-content">
                        <div class="weather-loading">🔄</div>
                    </div>
                    <div class="weather-temp">...</div>
                `;

                try {
                    let latitude, longitude;

                    // Проверяем, работаем ли в Telegram Mini App
                    if (window.Telegram && window.Telegram.WebApp) {
                        const tg = window.Telegram.WebApp;

                        // Используем Telegram API для запроса геолокации
                        if (tg.requestLocation) {
                            // Метод 1: Через Telegram requestLocation (если доступен)
                            await new Promise((resolve, reject) => {
                                tg.requestLocation((locationData) => {
                                    if (locationData && locationData.latitude) {
                                        latitude = locationData.latitude;
                                        longitude = locationData.longitude;
                                        resolve();
                                    } else {
                                        reject(new Error('No location data'));
                                    }
                                });
                            });
                        } else if (tg.openPopup) {
                            // Метод 2: Через Telegram openPopup с кнопкой
                            await new Promise((resolve, reject) => {
                                tg.openPopup({
                                    title: 'Геолокация',
                                    message: 'Нажмите кнопку ниже, чтобы отправить вашу геолокацию',
                                    buttons: [
                                        { id: 'send_location', type: 'default', text: '📍 Отправить локацию' },
                                        { id: 'cancel', type: 'cancel', text: 'Отмена' }
                                    ]
                                }, (buttonId) => {
                                    if (buttonId === 'send_location') {
                                        // После нажатия пробуем получить геолокацию
                                        navigator.geolocation.getCurrentPosition(
                                            (pos) => {
                                                latitude = pos.coords.latitude;
                                                longitude = pos.coords.longitude;
                                                resolve();
                                            },
                                            (err) => {
                                                reject(err);
                                            },
                                            { timeout: 10000, enableHighAccuracy: true }
                                        );
                                    } else {
                                        reject(new Error('User cancelled'));
                                    }
                                });
                            });
                        } else {
                            // Fallback на стандартный API
                            throw new Error('Telegram API not available');
                        }
                    } else {
                        // Не в Telegram - используем стандартный API
                        throw new Error('Not in Telegram');
                    }

                    // Сохраняем успешное получение координат
                    localStorage.setItem('fitTrackerGPSGranted', 'true');
                    localStorage.removeItem('fitTrackerGPSDenied');

                    // Загружаем погоду с новыми координатами
                    await loadWeatherForCoords(latitude, longitude);

                } catch (error) {
                    console.error('GPS permission error:', error);

                    // Если не удалось через Telegram, пробуем стандартный API как fallback
                    try {
                        const position = await getCurrentPosition();
                        localStorage.setItem('fitTrackerGPSGranted', 'true');
                        localStorage.removeItem('fitTrackerGPSDenied');
                        forceRefreshWeather();
                    } catch (fallbackError) {
                        console.error('Fallback also failed:', fallbackError);
                        // Показываем снова состояние отказа
                        showGeoDeniedState();
                        localStorage.setItem('fitTrackerGPSDenied', 'true');
                    }
                }
            });

            // Клик по "Запретить"
            denyBtn.addEventListener('click', () => {
                closeGeoModal();
                localStorage.setItem('fitTrackerGPSDenied', 'true');
                // Оставляем IP-геолокацию
            });

            // Клик по фону - закрывает модальное окно
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeGeoModal();
                }
            });
        }

        // Новая функция для загрузки погоды по координатам
        async function loadWeatherForCoords(latitude, longitude) {
            const weatherBlock = document.getElementById('weather-block');

            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius&wind_speed_unit=kmh&precipitation_unit=mm`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.current_weather) {
                    throw new Error('Invalid API response structure');
                }

                const weather = {
                    temp: Math.round(data.current_weather.temperature),
                    wmoCode: data.current_weather.weathercode,
                    isNight: isNightTime()
                };

                // Кешируем
                weatherCache = weather;
                weatherCacheTime = Date.now();
                localStorage.setItem('fitTrackerWeather', JSON.stringify({
                    weather,
                    timestamp: weatherCacheTime
                }));

                updateWeatherUI(weather);
            } catch (error) {
                console.error('Weather load error:', error);
                showGeoDeniedState();
            }
        }

        // Стили для восклицательного знака
        const geoPromptStyles = document.createElement('style');
        geoPromptStyles.textContent = `
            .geo-prompt {
                background: linear-gradient(135deg, #FFB347, #FF6B6B) !important;
            }

            .geo-prompt .geo-prompt-icon {
                font-size: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                animation: pulse 2s infinite;
            }

            .geo-prompt .weather-temp {
                color: var(--neobrut-white) !important;
            }

            .geo-denied {
                background: linear-gradient(135deg, #FFD700, #FFA500) !important;
            }

            .geo-denied .geo-denied-icon {
                font-size: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                animation: pulse 2s infinite;
            }

            .geo-denied .weather-temp {
                color: var(--neobrut-white) !important;
            }

            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }
        `;
        document.head.appendChild(geoPromptStyles);


        // IP-геолокация (запасной вариант)
        async function getIPLocation() {
            // Пробуем несколько API для надежности
            const apis = [
                {
                    url: 'https://ipapi.co/json/',
                    parse: (data) => ({ lat: data.latitude, lon: data.longitude, city: data.city })
                },
                {
                    url: 'https://ip-api.com/json/',
                    parse: (data) => ({ lat: data.lat, lon: data.lon, city: data.city })
                }
            ];

            for (const api of apis) {
                try {
                    console.log('Trying IP API:', api.url);
                    const response = await fetch(api.url);
                    const data = await response.json();
                    const parsed = api.parse(data);
                    console.log('IP API success:', api.url, parsed);
                    return {
                        latitude: parsed.lat,
                        longitude: parsed.lon,
                        city: parsed.city
                    };
                } catch (error) {
                    console.error('API failed:', api.url, error);
                    continue;
                }
            }

            // Если все API не сработали, возвращаем координаты по умолчанию (Москва)
            console.log('All IP APIs failed, using default location (Moscow)');
            return {
                latitude: 55.7558,
                longitude: 37.6173,
                city: 'Москва'
            };
        }

        // Обновление UI погоды
        function updateWeatherUI(weather) {
            // Всегда проверяем текущее время, а не кэшированное значение
            const currentIsNight = isNightTime();
            const icon = getWeatherIcon(weather.wmoCode, currentIsNight);
            const weatherBlock = document.getElementById('weather-block');

            console.log('updateWeatherUI:', {
                temp: weather.temp,
                wmoCode: weather.wmoCode,
                isNight: currentIsNight,
                icon: icon,
                hour: new Date().getHours()
            });

            document.getElementById('weather-icon').textContent = icon;
            document.getElementById('weather-temp').textContent = weather.temp;

            // Добавляем/убираем класс для ночи
            if (currentIsNight) {
                weatherBlock.classList.add('weather-night');
            } else {
                weatherBlock.classList.remove('weather-night');
            }
        }

        // Функция для принудительного обновления погоды (вызов из консоли)
        window.forceRefreshWeather = function () {
            weatherCache = null;
            weatherCacheTime = null;
            localStorage.removeItem('fitTrackerWeather');
            loadWeather();
        };

        // Загрузка закешированной погоды
        function loadCachedWeather() {
            const cached = localStorage.getItem('fitTrackerWeather');
            if (cached) {
                try {
                    const { weather, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    if (now - timestamp < WEATHER_CACHE_DURATION) {
                        weatherCache = weather;
                        weatherCacheTime = timestamp;
                        updateWeatherUI(weather);
                    }
                } catch (e) {
                    console.error('Error loading cached weather:', e);
                }
            }
        }

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            initializeApp();
        });

        function initializeApp() {
            loadActivityData();
            initializeTodoLists();
            renderActivityGrid();
            setupEventListeners();
            setupModalListeners();
            setupGeoModalListeners();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();

            // Показываем streak анимацию при первом входе за день
            showStreakAnimation();

            // Обновляем dashboard strip
            updateDashboardStrip();

            // Загружаем закешированный AI комментарий и генерируем новый если нужно
            loadCachedAIComment();
            updateAIComment();

            // Загружаем погоду (всегда свежие данные)
            loadWeather();
        }

        // Сброс всей активности (для перехода на новую систему)
        function resetAllActivity() {
            activityData = {};
            localStorage.removeItem('fitTrackerActivity');
            // saveActivityData(); // Не нужно, мы и так удаляем из localStorage
        }

        // Загрузка данных активности
        function loadActivityData() {
            const saved = localStorage.getItem('fitTrackerActivity');
            if (saved) {
                try {
                    activityData = JSON.parse(saved);
                    // Миграция старых числовых значений в новые текстовые
                    const migrationMap = { 0: 'none', 30: 'low', 60: 'medium', 90: 'high', 120: 'max' };
                    let migrated = false;
                    Object.keys(activityData).forEach(key => {
                        if (typeof activityData[key] === 'number') {
                            activityData[key] = migrationMap[activityData[key]] || 'none';
                            migrated = true;
                        }
                    });
                    if (migrated) {
                        saveActivityData();
                    }
                } catch (e) {
                    activityData = {};
                }
            }
        }

        // Сохранение данных активности
        function saveActivityData() {
            localStorage.setItem('fitTrackerActivity', JSON.stringify(activityData));
        }

        // Рендеринг блоков тренировок
        function renderWorkoutBlocks() {
            const track = document.getElementById('workout-track');
            track.innerHTML = '';

            workoutProgram.forEach((workout, index) => {
                const block = document.createElement('div');
                block.className = 'workout-block';
                block.dataset.day = workout.day;

                // Создаем пустой блок только с номером дня
                block.innerHTML = `
                    <div class="workout-number">${workout.day}</div>
                `;

                block.addEventListener('click', () => {
                    selectedWorkout = workout.day;
                    openWorkoutModal(workout);
                });
                track.appendChild(block);
            });

            // Центрируем на выбранной тренировке при инициализации
            setTimeout(() => {
                const currentBlock = track.querySelector(`[data-day="${selectedWorkout}"]`);
                if (currentBlock) {
                    currentBlock.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }, 100);
        }


        // ===== НОВЫЕ ФУНКЦИИ ДЛЯ ПРОЦЕНТНОЙ СИСТЕМЫ =====

        // Расчет процента выполнения для отдельной задачи

        // Расчет общего процента выполнения для дня
        function calculateCompletionPercentage(day) {
            const tasks = todoData[day];
            if (!tasks || tasks.length === 0) return 0;

            const completedTasks = tasks.filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / tasks.length) * 100);

            console.log(`День ${day}: ${completedTasks}/${tasks.length} задач выполнено = ${percentage}%`);
            return percentage;
        }

        // Обновление состояния родительской задачи на основе подзадач
        function updateParentTaskCompletion(taskId) {
            // Ищем родительскую задачу, содержащую эту подзадачу
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        if (task.subtasks) {
                            const subtask = task.subtasks.find(st => st.id === taskId);
                            if (subtask) {
                                // Обновляем состояние родительской задачи
                                const percentage = getTaskCompletionPercentage(task);
                                const newCompletedState = percentage === 100;

                                // Обновляем состояние в данных
                                task.completed = newCompletedState;
                                console.log(`Родительская задача "${task.text}" ${newCompletedState ? 'активирована' : 'деактивирована'} через подзадачи`);

                                // Обновляем UI родительской задачи
                                const parentCheckbox = document.getElementById(task.id);
                                if (parentCheckbox) {
                                    parentCheckbox.checked = newCompletedState;
                                    const todoItem = parentCheckbox.closest('.todo-item');
                                    if (todoItem) {
                                        todoItem.classList.toggle('completed', newCompletedState);
                                    }
                                }
                            }
                        }
                    });
                }
            });
            // Сохраняем обновленные состояния
            saveTodoStates();
        }


        // ===== КОНЕЦ НОВЫХ ФУНКЦИЙ =====

        // Проверка выполнения тренировки
        function checkWorkoutCompleted(day) {
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 7 : today.getDay(); // Воскресенье = 7
            return day <= currentDay && getActivityForDate(new Date()) !== 'none';
        }

        // Рендеринг вертикального календаря активности
        function renderActivityGrid(isForward = true) {
            const container = document.getElementById('calendar-months');
            const tooltip = document.getElementById('activity-tooltip');
            const calendarWrapper = document.querySelector('.calendar-wrapper');

            // Если контейнер не пустой, анимируем смену года
            if (container.children.length > 0) {
                // Анимируем исчезновение
                calendarWrapper.style.transform = isForward ? 'translateX(-50px)' : 'translateX(50px)';
                calendarWrapper.style.opacity = '0';

                setTimeout(() => {
                    renderCalendarContent(container, tooltip, calendarWrapper, isForward);
                }, 150);
            } else {
                renderCalendarContent(container, tooltip, calendarWrapper, isForward);
            }
        }

        // Функция для рендеринга контента календаря
        function renderCalendarContent(container, tooltip, calendarWrapper, isForward) {
            // Очищаем контейнер
            container.innerHTML = '';

            const today = new Date();
            const todayKey = formatDateKey(today);

            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const weekDays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

            // Генерируем месяцы
            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(currentYear, month, 1);
                const lastDay = new Date(currentYear, month + 1, 0);
                const numDays = lastDay.getDate();

                // Создаем контейнер для месяца
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                // Добавляем ID для текущего месяца
                if (month === today.getMonth() && currentYear === today.getFullYear()) {
                    monthDiv.id = 'current-month';
                }

                // Заголовок месяца
                const monthHeader = document.createElement('div');
                monthHeader.className = 'calendar-month-header';
                monthHeader.style.cursor = 'pointer';
                monthHeader.textContent = monthNames[month];
                monthHeader.addEventListener('click', () => {
                    if (confirm('Сбросить ВЕСЬ прогресс?\n\nВся активность и все выполненные задачи будут удалены.')) {
                        resetAllProgress();
                    }
                });
                monthDiv.appendChild(monthHeader);

                // Создаем заголовки дней недели
                const weekHeader = document.createElement('div');
                weekHeader.className = 'calendar-week';

                for (let i = 0; i < 7; i++) {
                    const dayLabel = document.createElement('div');
                    dayLabel.className = 'calendar-weekday';
                    dayLabel.textContent = weekDays[i];
                    weekHeader.appendChild(dayLabel);
                }
                monthDiv.appendChild(weekHeader);

                // Определяем день недели первого дня месяца
                let firstDayOfWeek = firstDay.getDay();
                firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // ПН=0, ВСК=6

                // Создаем ячейки дней
                let currentDay = 1;
                let weekDiv;

                while (currentDay <= numDays) {
                    weekDiv = document.createElement('div');
                    weekDiv.className = 'calendar-week';

                    // Заполняем неделю
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const cell = document.createElement('div');

                        if (currentDay === 1 && dayOfWeek < firstDayOfWeek) {
                            // Пустые ячейки до начала месяца
                            cell.className = 'activity-cell empty';
                        } else if (currentDay <= numDays) {
                            // Ячейка с днем
                            const currentDate = new Date(currentYear, month, currentDay);
                            const dateKey = formatDateKey(currentDate);
                            const activity = getActivityForDate(currentDate);

                            cell.className = 'activity-cell';
                            cell.dataset.date = dateKey;
                            cell.dataset.activity = activity;

                            if (dateKey === todayKey) {
                                cell.classList.add('today');
                            }

                            // Добавляем номер дня
                            const dateNumber = document.createElement('span');
                            dateNumber.className = 'date-number';
                            dateNumber.textContent = currentDay;
                            cell.appendChild(dateNumber);

                            // Обработчики событий
                            cell.addEventListener('mouseenter', (e) => {
                                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                                const dateString = currentDate.toLocaleDateString('ru-RU', options);
                                const activityLabels = {
                                    'none': 'нет активности',
                                    'low': 'минимальная активность',
                                    'medium': 'средняя активность',
                                    'high': 'высокая активность',
                                    'max': 'максимальная активность'
                                };
                                const activityText = activityLabels[activity] || 'нет активности';
                                tooltip.innerHTML = `
                                    <strong>${dateString}</strong><br>
                                    ${activityText}${dateKey === todayKey ? '<br><em>(Сегодня)</em>' : ''}
                                `;
                                tooltip.classList.add('show');

                                const rect = e.target.getBoundingClientRect();
                                const containerRect = e.target.closest('.activity-grid-vertical').getBoundingClientRect();
                                tooltip.style.left = (rect.left - containerRect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                                tooltip.style.top = (rect.top - containerRect.top - tooltip.offsetHeight - 10) + 'px';
                            });

                            cell.addEventListener('mouseleave', () => {
                                tooltip.classList.remove('show');
                            });

                            currentDay++;
                        } else {
                            // Пустые ячейки в конце месяца
                            cell.className = 'activity-cell empty';
                        }

                        weekDiv.appendChild(cell);
                    }

                    monthDiv.appendChild(weekDiv);
                }

                container.appendChild(monthDiv);
            }

            // Анимируем появление
            if (calendarWrapper) {
                calendarWrapper.style.transform = 'translateX(0)';
                calendarWrapper.style.opacity = '1';
            }

            // Прокручиваем к текущему месяцу с задержкой
            setTimeout(() => {
                const currentMonthElement = document.getElementById('current-month');
                if (currentMonthElement) {
                    currentMonthElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 300); // Небольшая задержка для завершения анимации
        }


        // Получение активности для даты
        function getActivityForDate(date) {
            const key = formatDateKey(date);
            return activityData[key] || 'none';
        }

        // Функция для сброса активности за определенную дату
        function resetActivityForDate(date) {
            const dateKey = formatDateKey(date);

            // Удаляем активность за эту дату
            delete activityData[dateKey];
            saveActivityData();

            // Сбрасываем todos для дней тренировок, которые соответствуют этой дате
            Object.keys(todoData).forEach(day => {
                const workoutDate = getWorkoutDate(parseInt(day));
                if (formatDateKey(workoutDate) === dateKey) {
                    // Сбрасываем все задачи для этого дня
                    todoData[day].forEach(task => {
                        task.completed = false;
                        // Сбрасываем все подзадачи
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                    saveTodoStates();

                    // Если режим задач открыт для этого дня, обновляем его
                    const workoutSection = document.querySelector('.workout-section');
                    if (workoutSection.classList.contains('show-todos') && selectedWorkout === day) {
                        const todoContent = document.getElementById('todo-content');
                        todoContent.innerHTML = createTodoHtml(todoData[day]);
                    }
                }
            });

            // Перерисовываем календарь
            renderActivityGrid();

            // Проверяем и обновляем активность на основе текущих состояний задач
            checkAndRecordActivity();
        }

        // Функция для полного сброса всего прогресса
        function resetAllProgress() {
            // Очищаем всю активность
            activityData = {};
            saveActivityData();

            // Сбрасываем все задачи
            Object.keys(todoData).forEach(day => {
                if (todoData[day]) {
                    todoData[day].forEach(task => {
                        task.completed = false;
                        task.completedAt = null;
                        if (task.subtasks) {
                            task.subtasks.forEach(subtask => {
                                subtask.completed = false;
                            });
                        }
                    });
                }
            });
            saveTodoStates();

            // Перерисовываем UI
            renderActivityGrid();
            renderWorkoutBlocks();

            // Обновляем модалку если открыта
            const todoContent = document.getElementById('todo-content');
            if (todoContent && selectedWorkout) {
                todoContent.innerHTML = createTodoHtml(todoData[selectedWorkout] || []);
            }

            // Вибрация подтверждения
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        // Форматирование ключа даты
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Форматирование даты для отображения
        function formatDate(date) {
            return `${date.getDate()} ${['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][date.getMonth()]}`;
        }



        // Функции для режима отображения задач
        function openWorkoutModal(workout) {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalContent = document.getElementById('todo-modal-content');
            const todoModalTitle = document.getElementById('todo-modal-title');

            // Устанавливаем заголовок
            todoModalTitle.textContent = `День ${workout.day} - Задания`;

            // Отображаем todo-список для этого дня
            const dayTodos = todoData[workout.day];
            todoModalContent.innerHTML = createTodoHtml(dayTodos);

            // Показываем overlay с анимацией
            todoOverlay.style.display = 'block';
            setTimeout(() => {
                todoOverlay.classList.add('show');
            }, 10);

            // Блокируем прокрутку карусели
            const workoutTrack = document.getElementById('workout-track');
            workoutTrack.style.overflow = 'hidden';
            workoutTrack.style.pointerEvents = 'none';

            // Запоминаем текущий выбранный день
            selectedWorkout = workout.day;
        }

        function closeWorkoutModal() {
            const todoOverlay = document.getElementById('todo-overlay');
            const workoutTrack = document.getElementById('workout-track');

            // Скрываем overlay с анимацией
            todoOverlay.classList.remove('show');
            setTimeout(() => {
                todoOverlay.style.display = 'none';
            }, 300);

            // Восстанавливаем прокрутку карусели
            workoutTrack.style.overflow = 'auto';
            workoutTrack.style.pointerEvents = 'auto';

            // Прокручиваем к выбранному дню
            const currentBlock = workoutTrack.querySelector(`[data-day="${selectedWorkout}"]`);
            if (currentBlock) {
                currentBlock.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        // Добавим обработчики для модального окна
        function setupModalListeners() {
            const todoOverlay = document.getElementById('todo-overlay');
            const todoModalClose = document.getElementById('todo-modal-close');

            // Закрытие по клику на крестик
            todoModalClose.addEventListener('click', closeWorkoutModal);

            // Закрытие по клику на заголовок (только если это не кнопка)
            const todoModalHeader = document.querySelector('.todo-modal-header');
            todoModalHeader.addEventListener('click', (e) => {
                if (e.target === todoModalHeader) {
                    closeWorkoutModal();
                }
            });

            // Закрытие по клавише Escape
            document.addEventListener('keydown', (e) => {
                const todoOverlay = document.getElementById('todo-overlay');
                if (e.key === 'Escape' && todoOverlay.classList.contains('show')) {
                    closeWorkoutModal();
                }
            });
        }

        // Установка обработчиков событий
        function setupEventListeners() {
            // Прокрутка с клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && selectedWorkout > 1) {
                    selectWorkout(selectedWorkout - 1);
                } else if (e.key === 'ArrowRight' && selectedWorkout < 7) {
                    selectWorkout(selectedWorkout + 1);
                }
            });

            // ===== СЛАЙДЕР: ЧАТ (0) - КАЛЕНДАРЬ (1) - ПУСТО (2) =====
            let calendarTouchStartX = 0;
            let calendarIsSwiping = false;
            let currentSlide = 1; // 0 - чат слева, 1 - календарь по центру, 2 - пусто справа
            const activitySlider = document.querySelector('.activity-slider');
            const calendarContainers = document.querySelectorAll('.calendar-container');

            // Функция для переключения слайдов
            function switchSlide(targetSlide) {
                if (targetSlide < 0 || targetSlide > 2) return;

                currentSlide = targetSlide;
                calendarContainers.forEach((container, index) => {
                    const offset = index - currentSlide;
                    container.style.transform = `translateX(${offset * 110}%)`;
                    // Устанавливаем z-index так, чтобы все контейнеры могли принимать события
                    // Активный контейнер имеет наивысший z-index
                    container.style.zIndex = index === currentSlide ? '2' : '1';
                });

                // Фокус на поле ввода при открытии чата
                if (currentSlide === 0) {
                    setTimeout(() => {
                        const chatInput = document.getElementById('slider-chat-input');
                        if (chatInput) chatInput.focus();
                    }, 300);
                }
            }

            // Инициализация начальных стилей для контейнеров
            calendarContainers.forEach((container, index) => {
                const offset = index - currentSlide;
                container.style.transform = `translateX(${offset * 110}%)`;
                container.style.zIndex = index === currentSlide ? '2' : '1';
            });

            // Элементы, с которых НЕ должен начинаться свайп
            const noSwipeElements = new Set([
                'chat-input-neobrut',
                'chat-send-neobrut'
            ]);

            // Проверка - можно ли свайпать с этого элемента
            function canSwipeFrom(target) {
                // Проверяем классы самого элемента
                if (noSwipeElements.has(target.className)) {
                    return false;
                }
                // Проверяем родительские элементы
                let parent = target.parentElement;
                while (parent) {
                    if (noSwipeElements.has(parent.className)) {
                        return false;
                    }
                    // Для activity-cell - не свайпаем
                    if (parent.classList && parent.classList.contains('activity-cell')) {
                        return false;
                    }
                    parent = parent.parentElement;
                }
                return true;
            }

            // Обработчики для touch свайпов
            activitySlider.addEventListener('touchstart', (e) => {
                // Проверяем, что свайп разрешён с этого элемента
                if (!canSwipeFrom(e.target)) {
                    return;
                }

                calendarTouchStartX = e.touches[0].clientX;
                calendarIsSwiping = false;
            }, { passive: true });

            activitySlider.addEventListener('touchmove', (e) => {
                if (!calendarTouchStartX) return;

                const deltaX = Math.abs(e.touches[0].clientX - calendarTouchStartX);
                if (deltaX > 20) {
                    calendarIsSwiping = true;
                    // Предотвращаем скролл страницы при свайпе
                    e.preventDefault();
                }
            }, { passive: false });

            activitySlider.addEventListener('touchend', (e) => {
                if (!calendarIsSwiping) {
                    calendarTouchStartX = 0;
                    return;
                }

                const touchEndX = e.changedTouches[0].clientX;
                const diff = calendarTouchStartX - touchEndX;

                // Сбрасываем переменные после использования
                calendarTouchStartX = 0;
                calendarIsSwiping = false;

                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        // Свайп влево
                        if (currentSlide === 0) {
                            // Из чата в календарь
                            switchSlide(1);
                        }
                    } else {
                        // Свайп вправо
                        if (currentSlide === 1) {
                            // Из календаря в чат
                            switchSlide(0);
                        } else if (currentSlide === 2) {
                            // Из пусто в календарь
                            switchSlide(1);
                        }
                    }
                }
            });

            // Свайп мышью для десктопа
            let mouseStartX = 0;
            let mouseIsDown = false;
            let mouseIsSwiping = false;

            activitySlider.addEventListener('mousedown', (e) => {
                // Игнорируем клики по ячейкам активности и элементам чата
                if (e.target.classList.contains('activity-cell') ||
                    e.target.closest('.activity-cell') ||
                    e.target.classList.contains('chat-input-neobrut') ||
                    e.target.closest('.chat-input-neobrut')) {
                    return;
                }

                // Обрабатываем клики внутри слайдера
                const sliderContainer = e.target.closest('.calendar-container');
                if (sliderContainer) {
                    mouseStartX = e.clientX;
                    mouseIsDown = true;
                    mouseIsSwiping = false;
                }
            });

            activitySlider.addEventListener('mousemove', (e) => {
                if (!mouseIsDown) return;
                const deltaX = Math.abs(e.clientX - mouseStartX);
                if (deltaX > 20) {
                    mouseIsSwiping = true;
                }
            });

            activitySlider.addEventListener('mouseup', (e) => {
                if (!mouseIsDown) return;

                if (mouseIsSwiping) {
                    const diff = mouseStartX - e.clientX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0) {
                            // Свайп влево
                            if (currentSlide === 0) switchSlide(1);
                        } else {
                            // Свайп вправо
                            if (currentSlide === 1) switchSlide(0);
                            else if (currentSlide === 2) switchSlide(1);
                        }
                    }
                }
                mouseIsDown = false;
                mouseIsSwiping = false;
            });

            activitySlider.addEventListener('mouseleave', () => {
                mouseIsDown = false;
                mouseIsSwiping = false;
            });

            // Клик по пустому блоку справа для возврата к календарю
            calendarContainers.forEach((container, index) => {
                if (index === 2) { // Только для пустого блока справа
                    container.addEventListener('click', () => {
                        switchSlide(1); // Возврат к календарю
                    });
                }
            });

            // Свайп для мобильных с предотвращением hover-эффектов (временно отключен)
            /*
            let touchStartX = 0;
            let isSwiping = false;
            const track = document.getElementById('workout-track');

            track.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                isSwiping = false;
                const workoutBlocks = document.querySelectorAll('.workout-block');

                // Временно отключаем hover-эффекты
                workoutBlocks.forEach(block => {
                    block.style.transition = 'none';
                });
            }, { passive: true });

            track.addEventListener('touchmove', (e) => {
                isSwiping = true;
            }, { passive: true });

            track.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;

                // Возвращаем hover-эффекты
                setTimeout(() => {
                    workoutBlocks.forEach(block => {
                        block.style.transition = '';
                    });
                }, 100);

                if (Math.abs(diff) > 50) { // Минимальная дистанция свайпа
                    if (diff > 0 && selectedWorkout < 7) {
                        selectWorkout(selectedWorkout + 1);
                    } else if (diff < 0 && selectedWorkout > 1) {
                        selectWorkout(selectedWorkout - 1);
                    }
                }
            });
            */

            // Свайп для прокрутки задач
            let todoTouchStartY = 0;
            let todoIsSwiping = false;
            const todoContent = document.getElementById('todo-content');

            // Обработчики для свайпа задач
            if (todoContent) {
                todoContent.addEventListener('touchstart', (e) => {
                    todoTouchStartY = e.touches[0].clientY;
                    todoIsSwiping = false;
                }, { passive: true });

                todoContent.addEventListener('touchmove', (e) => {
                    if (!todoTouchStartY) return;

                    const deltaY = e.touches[0].clientY - todoTouchStartY;

                    // Определяем, это прокрутка контента или свайп
                    const scrollTop = todoContent.scrollTop;
                    const scrollHeight = todoContent.scrollHeight;
                    const clientHeight = todoContent.clientHeight;

                    // Если можем прокручиваться вверх/вниз, позволяем это делать
                    if ((deltaY > 0 && scrollTop > 0) || (deltaY < 0 && scrollTop < scrollHeight - clientHeight - 1)) {
                        return;
                    }

                    // Если в начале или конце контента, предотвращаем свайп
                    if (Math.abs(deltaY) > 10) {
                        todoIsSwiping = true;
                        e.preventDefault();
                    }
                }, { passive: false });

                todoContent.addEventListener('touchend', () => {
                    todoTouchStartY = 0;
                    todoIsSwiping = false;
                }, { passive: true });
            }

            // Устанавливаем обработчики для модального окна
            setupModalListeners();
        }

        // AI Chat функции
        let chatHistory = [];
        let conversationContext = {
            userName: null,
            userLevel: 'beginner',
            lastWorkoutDay: null,
            totalWorkouts: 0,
            currentStreak: 0
        };

        function openAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.classList.add('show');
                // Фокус на поле ввода
                const chatInput = document.getElementById('chat-input');
                chatInput.focus();

                // Прогрев AI - быстрый запрос для инициализации
                if (chatHistory.length === 2) { // Только при первом открытии
                    generateAIResponse("👋").catch(() => { }); // Silent fail
                }
            }, 10);
        }

        function closeAIChat() {
            const overlay = document.getElementById('ai-chat-overlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        // Переменные для свайпа закрытия чата
        let chatTouchStartY = 0;
        let chatTouchEndY = 0;
        let chatIsSwipingDown = false;
        const chatSwipeThreshold = 80; // Минимальная дистанция свайпа
        const chatHeaderHeightRatio = 0.2; // 20% высоты чата - зона свайпа

        // Универсальная функция для добавления сообщения в оба контейнера
        function addMessageToContainer(containerId, content, isUser = false) {
            const messagesContainer = document.getElementById(containerId);
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message ai-message';

            // Проверяем, является ли контент HTML (для AI сообщений)
            const isHTML = !isUser && content.includes('<');

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${isHTML ? content : `<p>${content}</p>`}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Прокрутка к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessage(content, isUser = false) {
            // Добавляем в overlay чат
            addMessageToContainer('chat-messages', content, isUser);
            // Добавляем в slider чат
            addMessageToContainer('slider-chat-messages', content, isUser);

            // Сохраняем в историю в формате OpenRouter
            chatHistory.push({
                role: isUser ? 'user' : 'assistant',
                content: content
            });

            // Ограничиваем историю последними 30 сообщениями
            if (chatHistory.length > 30) {
                chatHistory = chatHistory.slice(-30);
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Функция для отправки сообщения из slider чата
        async function sendSliderMessage() {
            const chatInput = document.getElementById('slider-chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Добавляем сообщение пользователя
            addMessage(message, true);

            // Очищаем поле ввода
            chatInput.value = '';

            // Получаем ответ от AI
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error in sendSliderMessage:', error);
                addMessage("Произошла ошибка. Попробуйте еще раз.", false);
            }
        }

        // Форматирование ответа AI для лучшей читаемости
        function formatAIResponse(text) {
            // Разделяем текст на абзацы
            let formatted = text
                // Заменяем множественные переносы строк на одиночные
                .replace(/\n{3,}/g, '\n\n')
                // Оборачиваем эмодзи в спаны
                .replace(/([\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2600-\u27BF])/g,
                    '<span style="font-size: 1.2em; margin-right: 4px;">$&</span>')
                // Форматируем заголовки (строки начинающиеся с #)
                .replace(/^(#{1,3})\s+(.+)$/gm, '<h3 style="color: var(--accent-blue); margin: 12px 0 8px; font-weight: 600;">$2</h3>')
                // Форматируем жирный текст
                .replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--neobrut-darkgray);">$1</strong>')
                // Форматируем списки (строки начинающиеся с -)
                .replace(/^(\s*[-•*]\s+(.+))$/gm, '<div class="ai-list-item">• $2</div>')
                // Форматируем нумерованные списки
                .replace(/^(\s*\d+\.\s+(.+))$/gm, '<div class="ai-list-item">$1 $2</div>')
                // Разбиваем на параграфы
                .split('\n\n')
                .map(paragraph => paragraph.trim())
                .filter(paragraph => paragraph.length > 0)
                .map(paragraph => {
                    // Если параграф начинается с <h3> или <div>, оставляем как есть
                    if (paragraph.startsWith('<h3>') || paragraph.startsWith('<div class="ai-list-item">')) {
                        return paragraph;
                    }
                    // Иначе оборачиваем в параграф
                    return `<p style="margin: 10px 0; line-height: 1.6;">${paragraph}</p>`;
              })
                .join('\n');

            return formatted;
        }

        async function generateAIResponse(userMessage) {
            try {
                // Добавляем индикатор набора текста
                showTypingIndicator();

                const response = await fetch(getAPIBaseURL(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getConnectionString()}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'FitTracker AI'
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            {
                                role: "system",
                                content: `Ты - AI фитнес-ассистент FitTracker AI.

                                ВАЖНО: Отвечай кратко и по делу. меньше воды. пользователь должен получить достоточно информации

                                ТЕКУЩИЙ ДЕНЬ: ${selectedWorkout}/7 (${workoutProgram[selectedWorkout - 1]?.name || ''})

                                ВСЕ ЗАДАНИЯ ПО ДНЯМ:
                                ${Object.keys(todoData).map(day => {
                                    const dayNum = parseInt(day);
                                    const dayInfo = workoutProgram[dayNum - 1];
                                    const tasks = todoData[day] || [];
                                    const completed = tasks.filter(t => t.completed).length;
                                    return `День ${dayNum} (${dayInfo?.name || ''}): ${completed}/${tasks.length} выполнено`;
                                }).join('\\n')}

                                ЗАДАЧИ НА КАЖДЫЙ ДЕНЬ:
                                ${Object.keys(todoData).map(day => {
                                    const dayNum = parseInt(day);
                                    const dayInfo = workoutProgram[dayNum - 1];
                                    const tasks = todoData[day] || [];
                                    return `\\n--- День ${dayNum} (${dayInfo?.name || ''}) ---` +
                                        (tasks.length > 0 ? tasks.map(t => `${t.completed ? '✅' : '⏳'} ${t.text}`).join('\\n') : 'Нет задач');
                                }).join('\\n')}

                                Выполнение сегодня: ${calculateCompletionPercentage(selectedWorkout)}%
                                Активных дней: ${Object.keys(activityData).filter(date => activityData[date] && activityData[date] !== 'none').length}
                                Время: ${new Date().toLocaleString('ru-RU')}

                                Отвечай кратко, по сути. Используй эмодзи 💪🔥 но только там где это нужно по контексту`
                            },
                            ...chatHistory.slice(-10), // Последние 10 сообщений для контекста
                            {
                                role: "user",
                                content: userMessage
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.9,
                        top_p: 0.95,
                        frequency_penalty: 0.3,
                        presence_penalty: 0.6
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Response Error:', errorText);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.error) {
                    console.error('API Error:', data.error);
                    throw new Error(`API Error: ${data.error.message || data.error.type}`);
                }

                const aiMessage = data.choices[0]?.message?.content || "Извините, произошла ошибка. Попробуйте еще раз.";

                hideTypingIndicator();
                return formatAIResponse(aiMessage.trim());
            } catch (error) {
                console.error('AI API Error:', error);
                hideTypingIndicator();
                // Fallback ответы при ошибке API
                const fallbackResponses = [
                    "Произошла ошибка подключения. Давайте я помогу своими силами!",
                    "Не удалось связаться с AI. Попробуйте еще раз через минуту.",
                    "Кажется, проблема с соединением. Продолжайте тренироваться, а я скоро вернусь!"
                ];
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }
        }

        function showTypingIndicator() {
            // Показываем в обоих контейнерах
            ['chat-messages', 'slider-chat-messages'].forEach(containerId => {
                const messagesContainer = document.getElementById(containerId);
                if (!messagesContainer) return;

                // Удаляем существующий индикатор если есть
                const existing = messagesContainer.querySelector('.typing-indicator');
                if (existing) existing.remove();

                const typingDiv = document.createElement('div');
                typingDiv.className = 'message typing-indicator';
                typingDiv.id = `typing-indicator-${containerId}`;
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="typing-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function hideTypingIndicator() {
            // Удаляем из обоих контейнеров
            ['chat-messages', 'slider-chat-messages'].forEach(containerId => {
                const typingIndicator = document.getElementById(`typing-indicator-${containerId}`);
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            });
        }

        // Дополнительные функции AI чата

        // Очистка истории чата
        function clearChatHistory() {
            chatHistory = [];
            const welcomeMessage = `
                <div class="message">
                    <div class="message-content">
                        <p>Привет! Я ваш AI ассистент. Чем могу помочь?</p>
                    </div>
                </div>
            `;

            // Очищаем оба контейнера
            const overlayMessages = document.getElementById('chat-messages');
            const sliderMessages = document.getElementById('slider-chat-messages');

            if (overlayMessages) overlayMessages.innerHTML = welcomeMessage;
            if (sliderMessages) sliderMessages.innerHTML = welcomeMessage;
        }

        // Функция для получения умного совета на основе прогресса
        async function getSmartTip() {
            const completion = calculateCompletionPercentage(selectedWorkout);
            let tipType = 'general';

            if (completion === 100) {
                tipType = 'motivation';
            } else if (completion > 50) {
                tipType = 'encouragement';
            } else if (completion > 0) {
                tipType = 'continuation';
            } else {
                tipType = 'start';
            }

            const prompt = `Дай короткий мотивирующий совет (${tipType}) для дня ${selectedWorkout}. Максимально 50 слов.`;
            return await generateAIResponse(prompt);
        }

        // Инициализация AI чата
        document.addEventListener('DOMContentLoaded', () => {
            // ===== Обработчики для OVERLAY чата (старый) =====
            const aiChatClose = document.getElementById('ai-chat-close');
            if (aiChatClose) {
                aiChatClose.addEventListener('click', closeAIChat);
            }

            // Обработчик очистки чата
            const aiChatClear = document.getElementById('ai-chat-clear');
            if (aiChatClear) {
                aiChatClear.addEventListener('click', () => {
                    if (confirm('Очистить всю историю чата?')) {
                        clearChatHistory();
                    }
                });
            }

            // Обработчик отправки сообщения для overlay чата
            const chatSend = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');

            if (chatSend) {
                chatSend.addEventListener('click', sendMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // ===== Обработчики для SLIDER чата (новый) =====
            // Обработчик отправки сообщения для slider чата
            const sliderChatSend = document.getElementById('slider-chat-send');
            const sliderChatInput = document.getElementById('slider-chat-input');

            if (sliderChatSend) {
                sliderChatSend.addEventListener('click', sendSliderMessage);
            }

            if (sliderChatInput) {
                sliderChatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendSliderMessage();
                    }
                });
            }

            // Обработчики свайпа для закрытия чата
            const aiChatOverlay = document.getElementById('ai-chat-overlay');
            if (aiChatOverlay) {
                aiChatOverlay.addEventListener('touchstart', (e) => {
                    const chatHeader = e.target.closest('.ai-chat-header');
                    if (chatHeader) {
                        chatTouchStartY = e.touches[0].clientY;
                        chatIsSwipingDown = false;
                    }
                }, { passive: true });

                aiChatOverlay.addEventListener('touchmove', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchY = e.touches[0].clientY;
                    const deltaY = touchY - chatTouchStartY;

                    // Проверяем, что свайп вниз
                    if (deltaY > 20) {
                        chatIsSwipingDown = true;

                        // Применяем трансформацию для визуальной обратной связи
                        const transform = Math.min(deltaY * 0.5, 100);
                        aiChatOverlay.style.transform = `translateY(${transform}px)`;
                        aiChatOverlay.style.opacity = 1 - (deltaY / 300);

                        // Предотвращаем скролл сообщений во время свайпа
                        e.preventDefault();
                    }
                }, { passive: false });

                aiChatOverlay.addEventListener('touchend', (e) => {
                    if (chatTouchStartY === 0) return;

                    const touchEndY = e.changedTouches[0].clientY;
                    const deltaY = touchEndY - chatTouchStartY;

                    // Сбрасываем стили
                    aiChatOverlay.style.transform = '';
                    aiChatOverlay.style.opacity = '';

                    // Проверяем, достаточно ли сильный свайп вниз для закрытия
                    if (deltaY > chatSwipeThreshold && chatIsSwipingDown) {
                        closeAIChat();
                    }

                    // Сбрасываем переменные
                    chatTouchStartY = 0;
                    chatTouchEndY = 0;
                    chatIsSwipingDown = false;
                }, { passive: true });
            }
        });

        // Функционал перетаскивания разделителя
        let isDragging = false;
        let startY = 0;
        let startTopHeight = 0;

        const dividerButton = document.querySelector('.divider-button');
        const workoutSection = document.querySelector('.workout-section');
        const activitySection = document.querySelector('.activity-section');
        const divider = document.querySelector('.divider');

        // Устанавливаем начальную высоту после загрузки страницы
        setTimeout(() => {
            if (!workoutSection.style.height) {
                const viewportHeight = window.innerHeight;
                const baseHeight = 160;
                const additionalHeight = viewportHeight * 0.05; // 5% от высоты экрана
                workoutSection.style.height = (baseHeight + additionalHeight) + 'px';
            }
        }, 100);

        // Функция обновления размеров
        function updateSizes(clientY) {
            const deltaY = clientY - startY;
            const viewportHeight = window.innerHeight;

            // Фиксированная минимальная высота для верхней секции (после удаления заголовка)
            const minTopHeight = 60; // минимальная высота для workout-blocks

            // Получаем реальные размеры элементов для нижней секции
            const activityHeader = activitySection.querySelector('.activity-header');
            const calendarWrapper = document.querySelector('.calendar-wrapper');

            // Находим дни недели в календаре
            const dayLabels = document.querySelectorAll('.calendar-weekday, .day-label');
            let minBottomHeight = 200; // базовое значение

            if (dayLabels.length > 0) {
                // Измеряем позицию последнего дня недели от верха activity-section
                const activitySectionRect = activitySection.getBoundingClientRect();
                const lastDayLabel = dayLabels[dayLabels.length - 1];
                const lastDayRect = lastDayLabel.getBoundingClientRect();

                // Минимальная высота нижней секции = 40% от высоты экрана
                minBottomHeight = viewportHeight * 0.40;
            } else {
                // Fallback: измеряем высоту заголовка и добавляем минимальную высоту календаря
                const headerHeight = activityHeader ? activityHeader.offsetHeight : 60;
                minBottomHeight = headerHeight + 250; // заголовок + минимальная высота календаря + запас
            }

            // Новая высота верхней секции
            let newTopHeight = startTopHeight + deltaY;

            // Ограничиваем сверху и снизу
            newTopHeight = Math.max(minTopHeight, newTopHeight);
            newTopHeight = Math.min(viewportHeight - divider.offsetHeight - minBottomHeight, newTopHeight);

            // Применяем высоту
            workoutSection.style.height = newTopHeight + 'px';
        }

        // Обработчики для мыши
        dividerButton.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            startTopHeight = workoutSection.offsetHeight;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            updateSizes(e.clientY);
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // Обработчики для touch (мобильные устройства)
        dividerButton.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            startTopHeight = workoutSection.offsetHeight;
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            updateSizes(e.touches[0].clientY);
        }, { passive: false });

        document.addEventListener('touchend', () => {
            isDragging = false;
        });

        // Предотвращаем выделение текста при клике на кнопку
        dividerButton.addEventListener('selectstart', (e) => {
            e.preventDefault();
        });
    </script>
</body>

</html>